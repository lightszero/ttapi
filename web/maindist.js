/*! For license information please see maindist.js.LICENSE.txt */
(()=>{"use strict";var t,e;!function(t){t.sleep=function(t){return e=this,i=void 0,n=function*(){return new Promise((e=>setTimeout(e,t)))},new((s=void 0)||(s=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,h)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n};class e{constructor(){this.id=0,this.x=0,this.y=0,this.press=!1,this.move=!1}Clone(){let t=new e;return t.id=this.id,t.x=this.x,t.y=this.y,t.press=this.press,t}}t.InputPoint=e,t.ImageBuffer=class{constructor(){this.width=0,this.height=0,this.gray=!1,this.data=null}}}(t||(t={})),function(e){e.ttimpl_graphics=class{constructor(t,e){this._MainScreenScale=1,this.OnUpdate=null,this.OnResize=null,this.OnRender=null,this._webgl=t,this.c2d=e}GetBackGroundC2D(){return this.c2d}GetWebGL(){return this._webgl}getMainScreenScale(){return this._MainScreenScale}setMainScreenScale(t){this._MainScreenScale=t,this.UpdateScreenSize()}UpdateScreenSize(){let e=this._webgl.canvas;var i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height))}getDeviceScreenWidth(){return this._webgl.canvas.clientWidth}getDeviceScreenHeight(){return this._webgl.canvas.clientHeight}getDevicePixelRadio(){return window.devicePixelRatio}getFinalScale(){return this.getDevicePixelRadio()/this._MainScreenScale}}}(e||(e={}));var i,s=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};!function(e){e.Loader=class{LoadStringAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.text()}))}LoadBinaryAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.arrayBuffer()}))}},e.LoaderEx=class{LoadImageAsync(t){return new Promise(((e,i)=>{let s=new Image;s.src=t;let n=!1;s.onload=t=>{n=!0,e(s)},s.onerror=t=>{n=!0,s=null,i("img error:"+t.toString())}}))}LoadImageDataAsync(e){return s(this,void 0,void 0,(function*(){let i=yield this.LoadImageAsync(e),s=t.graphic.GetBackGroundC2D();return s.canvas.width=i.width,s.canvas.height=i.height,s.clearRect(0,0,i.width,i.height),s.drawImage(i,0,0),s.getImageData(0,0,i.width,i.height)}))}LoadImageDataResizeAsync(e,i,n){return s(this,void 0,void 0,(function*(){let s=yield this.LoadImageAsync(e),o=t.graphic.GetBackGroundC2D();return o.canvas.width=s.width,o.canvas.height=s.height,o.clearRect(0,0,s.width,s.height),o.drawImage(s,0,0,i,n),o.getImageData(0,0,i,n)}))}LoadCustomFont(t,e){return s(this,void 0,void 0,(function*(){const i=new FontFace(t,"url("+e+")");let s=yield i.load();return document.fonts.add(s),s.family}))}}}(i||(i={}));var n,o=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};!function(t){class e{constructor(t,e,i){null!=e&&null==i?(this.loaded=!1,this.initByUrlAsync(t,e)):null!=i&&null==e&&this.initByDataAsync(t,i)}initByUrlAsync(t,e){return o(this,void 0,void 0,(function*(){let i=yield fetch(e),s=yield i.arrayBuffer();this.buffer=yield t.decodeAudioData(s)}))}initByDataAsync(t,e){return o(this,void 0,void 0,(function*(){this.buffer=yield t.decodeAudioData(e),this.loaded=!0}))}}class i{constructor(t,e){let i=new HTMLAudioElement;this.url=i.src=e,i.loop=!0,this.node=t.createMediaElementSource(i),this.loaded=!1,i.onload=()=>{this.loaded=!0},i.loop=!0,i.onended=()=>{null!=this.onEnd&&this.onEnd(this)}}setLoop(t){this.node.mediaElement.loop=t}getLoop(){return this.node.mediaElement.loop}}class s{constructor(t){this.sourceBGM=null,this.inBGM=!1,this.audioContext=t,this.vol=this.audioContext.createGain(),this.vol.gain.value=1,this.vol.connect(this.audioContext.destination)}SetBGM(t){this.inBGM&&(this.inBGM=!1,this.sourceBGM.disconnect(),this.sourceBGM=null),null!=t&&(this.sourceBGM=t.node,this.sourceBGM.connect(this.vol))}setVolume(t){this.vol.gain.value=t}getVolume(){return this.vol.gain.value}PlaySound(t){let e=this.audioContext.createBufferSource();e.buffer=t.buffer,e.connect(this.vol),e.loop=!1,e.start(),null!=t.onEnd&&(e.onended=()=>{t.onEnd(t)})}}t.Channel_Impl=s,t.AudioImpl=class{constructor(){this.channels=[];try{this.audioContext=new AudioContext,console.log("audio Context inited")}catch(t){throw console.error("!Your browser does not support AudioContext"),new Error("!Your browser does not support AudioContext")}this.Init()}GetChannel(t){if(t>16||t<0)throw new Error("error channel id.");for(;this.channels.length<=t;)this.channels.push(null);return null==this.channels[t]&&(this.channels[t]=new s(this.audioContext)),this.channels[t]}CreateBGM(t){return new i(this.audioContext,t)}CreateSound(t){return new e(this.audioContext,t,null)}CreateSoundFromArrayBuffer(t){return new e(this.audioContext,null,t)}Init(){if(null!=this.audioContext){var t=this.audioContext.createBuffer(1,1,22050),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start()}}ReInit(){this.Init()}}}(n||(n={}));var r,h;!function(e){e.Input=class{constructor(t){this._mousepress=!1,this.lasttouchx=-1,this.lasttouchy=-1,this._pressKeys=[],this.points=[],this.ishow=!1,this.Start(t)}Start(t){window.addEventListener("keydown",(t=>{this.UpdateKey(t.code,!0)})),window.addEventListener("keyup",(t=>{this.UpdateKey(t.code,!1)})),window.addEventListener("wheel",(t=>{null!=this.OnWheel&&this.OnWheel(t.deltaX,t.deltaY,t.deltaZ)})),t.addEventListener("mousedown",(t=>{if(0==t.button){if(this.lasttouchx==t.x&&this.lasttouchy==t.y)return console.log("cancel sim mouse"),this.lasttouchx=-1,void(this.lasttouchy=-1);this.UpdateMouse(t,!0,!1),this._mousepress=!0}})),t.addEventListener("mouseup",(t=>{0==t.button&&(this.UpdateMouse(t,!1,!1),this._mousepress=!1)})),t.addEventListener("mousemove",(t=>{0==t.button&&this.UpdateMouse(t,this._mousepress,!0)})),t.addEventListener("touchstart",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!1)})),t.addEventListener("touchmove",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!0)})),t.addEventListener("touchend",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)})),t.addEventListener("touchcancel",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)}))}UpdateMouse(e,i,s){for(;this.points.length<=0;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[0].id=0,this.points[0].press=i,this.points[0].x=e.x,this.points[0].y=e.y,null!=this.OnPoint&&this.OnPoint(0,e.x,e.y,i,s)}UpdatePoint(e,i,s){let n=e.identifier+1;for(;this.points.length<=n;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[n].press=i,this.points[n].x=e.clientX,this.points[n].y=e.clientY,i&&(this.lasttouchx=0|e.clientX,this.lasttouchy=0|e.clientY),null!=this.OnPoint&&this.OnPoint(n,e.clientX,e.clientY,i,s)}UpdateKey(t,e){if(e){if(this._pressKeys.indexOf(t)>=0)return;this._pressKeys.push(t)}else{let e=this._pressKeys.indexOf(t);e>=0&&this._pressKeys.splice(e,1)}null!=this.OnKey&&this.OnKey(t,e)}GetPressKeys(){return this._pressKeys}IsKeyDown(t){return this._pressKeys.indexOf(t)>=0}GetInputPoints(){return this.points}Prompt(e){return i=this,s=arguments,o=function*(e,i="",s=256,n=""){for(var o=0;o<this.points.length;o++)this.points[o].press=!1;let r=i,h=!1,a=document.createElement("div"),l=document.createElement("div");a.style.backgroundColor="#00000070",a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.backgroundColor="#00000070",a.onclick=t=>{},a.onpointerdown=t=>{},a.ontouchstart=t=>{},document.body.appendChild(a),l.style.backgroundColor="#aaaaaa",l.style.borderWidth="2px",l.style.borderColor="#fff",l.style.borderStyle="solid",l.style.position="absolute",l.style.left="25%",l.style.top="35%",l.style.right="25%",l.style.bottom="35%",a.appendChild(l);{let t=document.createElement("span");t.style.position="absolute",t.style.left="25%",t.style.right="25%",t.style.top="100px",t.style.fontFamily=n,t.style.fontSize="32",t.textContent=e,l.appendChild(t);let o=document.createElement("input");o.type="text",o.style.color="#000",o.style.position="absolute",o.style.left="25%",o.style.right="25%",o.style.top="150px",o.value=i,o.maxLength=s,o.style.fontFamily=n,o.style.fontSize="32",l.appendChild(o),o.onchange=()=>{r=o.value};let a=document.createElement("button");a.style.left="25%",a.style.right="25%",a.style.position="absolute",a.style.top="200px",a.textContent="OK",a.style.fontFamily=n,a.style.fontSize="32",a.onclick=()=>{h=!0},l.appendChild(a)}for(;!h;)yield t.sleep(1);return document.body.removeChild(a),r},new((n=void 0)||(n=Promise))((function(t,e){function r(t){try{a(o.next(t))}catch(t){e(t)}}function h(t){try{a(o.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(r,h)}a((o=o.apply(i,s||[])).next())}));var i,s,n,o}}}(r||(r={})),function(t){t.Platform=class{getPlatformName(){return"browser_"+window.navigator.userAgent}}}(h||(h={}));var a=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class l{constructor(){this._loaded=0,this.InitAsync()}Init(){return a(this,void 0,void 0,(function*(){return 0!=this._loaded?1==this._loaded||(this._loaded,!1):(this._loaded=-1,this._loaded=yield m.OpenOrCreateDB("_ttstore_"),this.IsReady())}))}InitAsync(){return a(this,void 0,void 0,(function*(){}))}IsReady(){return 1==this._loaded}GetText(t){return a(this,void 0,void 0,(function*(){return yield m.GetStringValue(t)}))}GetBinary(t){return a(this,void 0,void 0,(function*(){return yield m.GetBinaryValue(t)}))}SaveText(t,e){return a(this,void 0,void 0,(function*(){yield m.SetStringValue(t,e)}))}SaveBinary(t,e){return a(this,void 0,void 0,(function*(){yield m.SetBinaryValue(t,e)}))}SaveDataToLocal(t,e){return a(this,void 0,void 0,(function*(){var i=document.createElement("a");i.download=t,i.style.display="none";var s=new Blob([e]);return i.href=URL.createObjectURL(s),document.body.appendChild(i),i.click(),document.body.removeChild(i),!0}))}}const c="__store__";class m{static DeleteDb(e){return a(this,void 0,void 0,(function*(){let i=indexedDB.deleteDatabase(e),s=0;for(i.onsuccess=()=>{console.log("db delete succ."),s=1},i.onerror=()=>{console.log("db delete error."),s=2};0==s;)yield t.sleep(1)}))}static OpenOrCreateDB(e){return a(this,void 0,void 0,(function*(){let i=0,s=indexedDB.open(e,1);for(s.onsuccess=t=>{console.log("db open"),i=1,this.db=s.result},s.onerror=()=>{console.log(" dbreq.onerror"),i=2,this.db=null},s.onupgradeneeded=t=>{console.log("db onupgradeneeded"),this.db=s.result,this.db.createObjectStore(c,{keyPath:["_id"]}).createIndex("_id","_id",{unique:!0}),console.log(" --create store--")};0==i;)yield t.sleep(1);return i}))}static SetStringValue(e,i){return a(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(c,"readwrite"),n=0,o=s.objectStore(c).put({_id:e,value:i,format:"text"});for(o.onsuccess=t=>{n=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},o.onerror=t=>{n=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==n;)yield t.sleep(1)}))}static SetBinaryValue(e,i){return a(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(c,"readwrite"),n=0,o=s.objectStore(c).put({_id:e,value:i,format:"hex"});for(o.onsuccess=t=>{n=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},o.onerror=t=>{n=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==n;)yield t.sleep(1)}))}static GetValue(e){return a(this,void 0,void 0,(function*(){if(null==this.db)return null;let i=this.db.transaction(c,"readonly").objectStore(c).index("_id").get(e),s=0;for(i.onsuccess=t=>{s=1,console.log("GetValue key:"+e+" data:"+JSON.stringify(i.result))},i.onerror=t=>{s=2,console.log("GetValue Fail key:"+JSON.stringify(i.result))};0==s;)yield t.sleep(1);return i.result}))}static GetBinaryValue(t){return a(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("hex"==e.format)return e.value;throw new Error("format is text.")}))}static GetStringValue(t){return a(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("text"==e.format)return e.value;throw new Error("format is text.")}))}}var _,d,u,p,f,y,v,x,w,A;m.db=null,function(s){s.ttimpl_browser=class{constructor(){this.timerMs=0}Init(s){if(this.webgl=s.getContext("webgl2",{antialias:!1}),null!=this.webgl){let i=new OffscreenCanvas(32,32).getContext("2d",{colorSpace:"srgb",willReadFrequently:!0});t.graphic=new e.ttimpl_graphics(this.webgl,i),this.timerMs=(new Date).getTime(),requestAnimationFrame(this.Update.bind(this))}else console.error("init webgl error.");t.loader=new i.Loader,t.loaderex=new i.LoaderEx,t.audio=new n.AudioImpl,t.input=new r.Input(s),t.platform=new h.Platform,t.store=new l}ReInitAudio(){}SendEnvEventToUser(t,e){}Update(){if(null!=this.webgl){var e=this.webgl.canvas,i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;t.graphic.getDevicePixelRadio(),e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height)),requestAnimationFrame(this.Update.bind(this));var n=(new Date).getTime(),o=(n-this.timerMs)/1e3;this.timerMs=n,null!=t.graphic.OnUpdate&&t.graphic.OnUpdate(o),null!=t.graphic.OnRender&&t.graphic.OnRender()}}}}(_||(_={}));class g{constructor(){this._stateStack=[]}GetLast(){return 0==this._stateStack.length?null:this._stateStack[this._stateStack.length-1]}Count(){return this._stateStack.length}NavigatorTo(t){if(null==t)throw"不可以导航到空状态";this._stateStack.indexOf(t)>=0?this.BackTo(t):this.Push(t)}Back(){if(0==this._stateStack.length)throw"已经是空栈状态";let t=this._stateStack[this._stateStack.length-1];this._stateStack.splice(this._stateStack.length-1,1),t.OnExit(),this._stateStack.length>0&&this._stateStack[this._stateStack.length-1].OnInit(this)}BackTo(t){if(null==t)throw"不可以导航到空状态";let e=this._stateStack.indexOf(t);if(e<0)throw"不存在的栈,无法回退";if(e==this._stateStack.length-1)throw"不能回退到自身";for(;this._stateStack.length>0;){let e=this._stateStack[this._stateStack.length-1];if(this._stateStack.splice(this._stateStack.length-1,1),e==t)return void e.OnInit(this);e.OnExit()}}Push(t){this._stateStack.length>0&&this._stateStack[this._stateStack.length-1].OnExit(),this._stateStack.push(t),t.OnInit(this)}}class b{constructor(t,e,i,s=1){this.R=t,this.G=e,this.B=i,this.A=s}static get White(){return new b(1,1,1,1)}static get Black(){return new b(0,0,0,1)}static get Tran(){return new b(0,0,0,0)}static Mul(t,e){return new b(t.R*e.R,t.G*e.G,t.B*e.B,t.A*e.A)}Clone(){return new b(this.R,this.G,this.B,this.A)}static Lerp(t,e,i){return new b(t.R*(1-i)+e.R*i,t.G*(1-i)+e.G*i,t.B*(1-i)+e.B*i,t.A*(1-i)+e.A*i)}static FromH360(t){let e=b.White,i=t%120/120;i<0&&(i+=1);let s=.5*Math.sin(i*Math.PI);return i>.5&&(s=1-s),t<120?(s<=.5?(e.B=1,e.R=s/(1-s)):(e.R=1,e.B=1*(1-s)/s),e.G=0):t<240?(s<=.5?(e.R=1,e.G=1*s/(1-s)):(e.G=1,e.R=1*(1-s)/s),e.B=0):(e.R=0,s<=.5?(e.G=1,e.B=1*s/(1-s)):(e.B=1,e.G=1*(1-s)/s)),e}}class S{constructor(t,e){this.X=t,this.Y=e}Clone(){return new S(this.X,this.Y)}static get One(){return new S(1,1)}static get Zero(){return new S(0,0)}static Length(t){return Math.sqrt(t.X*t.X+t.Y*t.Y)}static Dist(t,e){return Math.sqrt((t.X-e.X)*(t.X-e.X)+(t.Y-e.Y)*(t.Y-e.Y))}static Dir(t,e){let i=S.Dist(t,e);return new S((e.X-t.X)/i,(e.Y-t.Y)/i)}static Add(t,e){return new S(t.X+e.X,t.Y+e.Y)}static Normal(t){let e=S.Length(t);return new S(t.X/e,t.Y/e)}}class B{constructor(t,e,i){this.X=t,this.Y=e,this.Z=i}Clone(){return new B(this.X,this.Y,this.Z)}static get One(){return new B(1,1,1)}static get Zero(){return new B(0,0,0)}static Add(t,e){return new B(t.X+e.X,t.Y+e.Y,t.Z+e.Z)}}class C{constructor(t,e,i,s){this.X=t,this.Y=e,this.Width=i,this.Height=s}}class R{static Clone(t){return new C(t.X,t.Y,t.Width,t.Height)}static Intersect(t,e){let i=t.X,s=t.X+t.Width,n=t.Y,o=t.Y+t.Height,r=e.X,h=e.Y,a=r+e.Width,l=h+e.Height;if(i>=a||r>=s||n>=l||h>=o)return new C(0,0,0,0);let c=Math.max(i,r),m=Math.max(n,h),_=Math.min(s,a),d=Math.min(o,l);return new C(c,m,_-c,d-m)}}class I{constructor(t,e,i,s){this.XLeft=t,this.YTop=e,this.XRight=i,this.YBottom=s}SetZero(){this.XLeft=0,this.XRight=0,this.YTop=0,this.YBottom=0}}class G{constructor(t,e,i,s){this.U1=t,this.V1=e,this.U2=i,this.V2=s}}!function(t){t[t.R8=0]="R8",t[t.RGBA32=1]="RGBA32",t[t.F_R8=2]="F_R8",t[t.F_RGBA=3]="F_RGBA"}(d||(d={}));class M{IsArray(){return!1}GetLayer(){return 0}constructor(t,e,i,s,n){if(this._webgl=t,this._format=s,this._texobj=t.createTexture(),this._id=M.texid,this._width=e,this._height=i,M.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==d.F_R8||this._format==d.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==d.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==d.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),null==n)this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,null);else{let t=s==d.RGBA32?4:1;if(n.length!=this._width*this._height*t)throw new Error("wrong texSize");this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,n)}}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}ReSize(t,e){this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,t,e,0,this._formatGL,this._typeGL,null),this._width=t,this._height=e}UploadImg(t){this._width=t.width,this._height=t.height,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,this._formatGL,this._typeGL,t)}UploadTexture(t,e,i,s,n){this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texSubImage2D(this._webgl.TEXTURE_2D,0,t,e,i,s,this._formatGL,this._typeGL,n)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}M.texid=1;class T{IsArray(){return!0}GetLayer(){return this._layer}constructor(t,e,i,s,n){this._webgl=t,this._format=n,this._layer=s,this._texobj=t.createTexture(),this._texobj,this._id=M.texid,this._width=e,this._height=i,M.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==d.F_R8||this._format==d.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==d.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==d.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl,this._webgl.texImage3D(this._webgl.TEXTURE_2D_ARRAY,0,this._formatInnerGL,e,i,this._layer,0,this._formatGL,this._typeGL,null)}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}UploadSubTexture(t,e,i,s,n,o){this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._format==d.RGBA32?this._webgl.RGBA:this._webgl.R8,this._webgl.UNSIGNED_BYTE,this._webgl.texSubImage3D(this._webgl.TEXTURE_2D_ARRAY,0,e,i,t,s,n,1,this._formatGL,this._typeGL,o)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}class D{constructor(t){this.rectLimit=[],this._webgl=t,console.log("webgl init size:"+t.canvas.width+","+t.canvas.height)}IsArray(){return!1}GetLayer(){return 0}IsMainOutput(){return!0}Begin(){this._webgl.bindFramebuffer(this._webgl.FRAMEBUFFER,null),this._webgl.viewport(0,0,this.getWidth(),this.getHeight()),this.ResetLimitRect()}Clear(t){this._webgl.clearColor(t.R,t.G,t.B,t.A),this._webgl.clear(this._webgl.COLOR_BUFFER_BIT)}End(){this._webgl.flush()}getID(){return 0}getGLTex(){return null}getFormat(){return d.RGBA32}getWidth(){return this._webgl.canvas.width}getHeight(){return this._webgl.canvas.height}getData(){throw new Error("not spport on MainScreen.")}IsStatic(){return!0}IsTarget(){return!0}UploadTexture(t,e,i,s,n){throw new Error("MainScreen Method not implemented.")}ApplyTexture(t){throw new Error("MainScreen Method not implemented.")}Destory(){throw new Error("MainScreen Method not implemented.")}Resize(t,e){throw new Error("MainScreen Method not implemented.")}PushLimitRect(t){let e=null;if(0==this.rectLimit.length)e=R.Clone(t);else{let i=this.rectLimit[this.rectLimit.length-1];e=R.Intersect(i,t)}this.rectLimit.push(e),this.ResetLimitRect()}PopLimitRect(){this.rectLimit.splice(this.rectLimit.length-1,1),this.ResetLimitRect()}ClearLimitRect(){this.rectLimit.splice(0,this.rectLimit.length),this.ResetLimitRect()}ResetLimitRect(){if(0==this.rectLimit.length)this._webgl.disable(this._webgl.SCISSOR_TEST);else{let t=this.rectLimit[this.rectLimit.length-1];this._webgl.enable(this._webgl.SCISSOR_TEST),this._webgl.scissor(t.X,this.getHeight()-t.Y-t.Height,t.Width,t.Height)}}}class L{constructor(){this.clearcolor=new b(0,0,0,1),this.maintarget=null}Update(t,e){null==this.maintarget&&(this.maintarget=O.GetMainScreen()),t.UpdateDrawLayers(e,u.Main,this.maintarget,0),t.UpdateDrawLayers(e,u.GUI,this.maintarget,0)}Render(t){null==this.maintarget&&(this.maintarget=O.GetMainScreen()),this.maintarget.Begin(),this.maintarget.Clear(this.clearcolor),t.RenderDrawLayers(u.Main,this.maintarget,0),t.RenderDrawLayers(u.GUI,this.maintarget,0),this.maintarget.End()}}!function(t){t[t.ERROR=0]="ERROR",t[t.Main=1]="Main",t[t.GUI=2]="GUI",t[t.PreRender=3]="PreRender",t[t.POSTRender=4]="POSTRender",t[t.CUSTOM=5]="CUSTOM"}(u||(u={}));class P{constructor(){this.LookAt=S.Zero,this.Scale=2,this.limitRect=null,this._viewmatrix=new Float32Array(16),this._projmatrix=new Float32Array(16)}GetViewMatrix(){let t=this._viewmatrix,e=this.Scale,i=this.Scale,s=-this.LookAt.X,n=-this.LookAt.Y;return t[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=n*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this._viewmatrix}GetProjMatrix(t){let e=this._projmatrix,i=2/t.getWidth(),s=2/t.getHeight();return t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,e}}class F{constructor(t){this.camera=new P,this.renders=[],this.numbertag=t}GetTag(){return this.numbertag}GetCamera(){return this.camera}GetRenders(){return this.renders}AddRender(t){this.renders.push(t)}Update(t,e,i){this.lasttarget=e;for(let s=0;s<this.renders.length;s++)this.renders[s].OnUpdate(t,e,this.camera,i)}Render(t,e){if(null!=this.lasttarget){null!=this.camera.limitRect&&t.PushLimitRect(this.camera.limitRect);for(let t=0;t<this.renders.length;t++)this.renders[t].OnRender();null!=this.camera.limitRect&&t.ClearLimitRect()}}}class E{constructor(){this.mapviews={},this.pipeline=new L}AddDrawLayer(t){let e=t.GetTag();null==this.mapviews[e]&&(this.mapviews[e]=[]),this.mapviews[e].push(t)}RemoveDrawLayer(t){let e=t.GetTag(),i=this.GetDrawLayers(e),s=i.indexOf(t);s>=0&&i.splice(s,1)}GetDrawLayers(t){return null==this.mapviews[t]&&(this.mapviews[t]=[]),this.mapviews[t]}UpdateDrawLayers(t,e,i,s){let n=this.GetDrawLayers(e);if(null!=n){for(let e=0;e<n.length;e++)n[e].Update(t,i,s);return n.length}return 0}RenderDrawLayers(t,e,i){let s=this.GetDrawLayers(t);if(null!=s){for(let t=0;t<s.length;t++)s[t].Render(e,i);return s.length}return 0}GetDrawLayerTags(){let t=[];for(let e in this.mapviews)t.push(e);return t}Update(t){this.pipeline.Update(this,t)}Render(){this.pipeline.Render(this)}}class O{static Start(e,i){let s=t.graphic.GetWebGL();K.Init(e),this._mainscreen=new D(s),this._viewlist=new E,this.regevent(),this.SetUserLogic(i)}static regevent(){t.graphic.OnRender=this.OnRender.bind(this),t.graphic.OnUpdate=this.OnUpdate.bind(this),t.graphic.OnResize=this.OnResize.bind(this),t.input.OnPoint=this.OnPoint.bind(this),t.input.OnWheel=this.OnWheel.bind(this),t.input.OnKey=this.OnKey.bind(this)}static Pause(t){this._pause=t}static SetUserLogic(t){null!=this._state&&this._state.OnExit(),this._state=t,null!=this._state&&this._state.OnInit()}static GetViewList(){return this._viewlist}static Fence(){return!this._willfence&&(this._willfence=!0,!0)}static CanFence(){return!this._willfence}static GetFenceID(){return this._fenceid}static GetMainScreen(){return this._mainscreen}static OnUpdate(t){this._pause||(this._viewlist.Update(t),null!=this._state&&this._state.OnUpdate(t))}static OnResize(t,e){this._pause||null!=this._state&&this._state.OnResize(t,e)}static OnRender(){if(this._pause)return;let e=t.graphic.GetWebGL();this._viewlist.Render(),this._willfence&&this.DoFence(e)}static DoFence(t){this._willfence=!1;let e=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush();let i=()=>{let s=t.clientWaitSync(e,0,0);if(s==t.TIMEOUT_EXPIRED||s==t.WAIT_FAILED)return console.log("=>not signed."),void setTimeout(i,0);console.log("=>signed."),t.deleteSync(e),this._willfence=!1,this._fenceid++};setTimeout(i,0)}static OnWheel(t,e,i){if(this._pause)return;let s=this._viewlist.GetDrawLayers(u.GUI);if(null!=s)for(let o=s.length-1;o>=0;o--){let r=!1;var n=s[o].GetCanvas();if(null!=n&&(r=n.OnWheel(null,t,e,i),r))break;if(r)break}null!=this._state&&this._state.OnWheelAfterGUI(t,e,i)}static OnPoint(t,e,i,s,n){if(this._pause)return;let o=this._viewlist.GetDrawLayers(u.GUI);if(null!=o)for(let r=o.length-1;r>=0;r--){let h=!1,a=o[r].GetCanvas();if(null!=a&&(h=a.OnTouch(null,t,s,n,e,i),h))break;if(h)break}null!=this._state&&this._state.OnPointAfterGUI(t,e,i,s,n)}static OnKey(t,e){this._pause||null!=this._state&&this._state.OnKey(t,e)}}O._pause=!1,O._mainscreen=null,O._state=null,O._viewlist=null,O._willfence=!1,O._fenceid=0,function(t){t[t.VertexShader=0]="VertexShader",t[t.FragmentShader=1]="FragmentShader"}(p||(p={})),function(t){t[t.empty=0]="empty",t[t.unknown=1]="unknown",t[t.mat4=2]="mat4",t[t.sampler2D=3]="sampler2D",t[t.block=4]="block",t[t.float=5]="float",t[t.int=6]="int",t[t.vec4=7]="vec4",t[t.ivec4=8]="ivec4"}(f||(f={}));class V{constructor(t,e,i){this.type=t,this.name=e,this.shader=i}}class k{constructor(t,e,i,s,n){this.name=e,this.program=i;var o=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES);for(let e=0;e<o;e++){var r=t.getActiveAttrib(i,e);t.getAttribLocation(i,r.name)}this.uniformInfos={};var h=t.getProgramParameter(i,t.ACTIVE_UNIFORMS);for(let e=0;e<h;e++){var a=t.getActiveUniform(i,e);let s=t.getUniformLocation(this.program,a.name);if(null==s)break;let n=f.empty;switch(a.type){case t.INT:n=f.int;break;case t.FLOAT:n=f.float;break;case 35666:n=f.vec4;break;case 35666:n=f.ivec4;break;case 35676:n=f.mat4;break;case 35678:case 36289:n=f.sampler2D;break;default:throw"ShaderProgram.ctor not supported."+a.type.toString(16)}this.uniformInfos[a.name]={loc:s,locblock:-1,type:n}}var l=t.getProgramParameter(i,t.ACTIVE_UNIFORM_BLOCKS);for(let e=0;e<l;e++){var c=t.getActiveUniformBlockName(i,e);let s=t.getUniformBlockIndex(this.program,c);null==s||s<0||(this.uniformInfos[c]={loc:null,locblock:s,type:f.block})}}AddUniform(t,e,i){if(i==f.block){let s=t.getUniformBlockIndex(this.program,e);if(null==s||s<0)return;this.uniformInfos[e]={loc:null,locblock:s,type:i}}else{let s=t.getUniformLocation(this.program,e);if(null==s)return;this.uniformInfos[e]={loc:s,locblock:-1,type:i}}}}class U{constructor(t=0,e=0,i=0,s=0,n=!1,o=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=t,this._height=e,this._x=i,this._y=s,this._data={},this._rot=n,this._allowRotation=o}static Collide(t,e){return t.collide(e)}static Contain(t,e){return t.contain(e)}area(){return this.width*this.height}collide(t){return t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y}contain(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._dirty++)}get height(){return this._height}set height(t){t!==this._height&&(this._height=t,this._dirty++)}get x(){return this._x}set x(t){t!==this._x&&(this._x=t,this._dirty++)}get y(){return this._y}set y(t){t!==this._y&&(this._y=t,this._dirty++)}get rot(){return this._rot}set rot(t){if(!1!==this._allowRotation&&this._rot!==t){const e=this.width;this.width=this.height,this.height=e,this._rot=t,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(t){this._allowRotation!==t&&(this._allowRotation=t,this._dirty++)}get data(){return this._data}set data(t){null!==t&&t!==this._data&&(this._data=t,"object"==typeof t&&t.hasOwnProperty("allowRotation")&&(this._allowRotation=t.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(t=!0){this._dirty=t?this._dirty+1:0}}(A=y||(y={}))[A.MAX_AREA=0]="MAX_AREA",A[A.MAX_EDGE=1]="MAX_EDGE";class X{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some((t=>t.dirty))}setDirty(t=!0){if(this._dirty=t?this._dirty+1:0,!t)for(let t of this.rects)t.setDirty&&t.setDirty(!1)}}class z extends X{constructor(t=4096,e=4096,i=0,s={}){super(),this.maxWidth=t,this.maxHeight=e,this.padding=i,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:y.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),s),this.width=this.options.smart?0:t,this.height=this.options.smart?0:e,this.border=this.options.border?this.options.border:0,this.freeRects.push(new U(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)),this.stage=new U(this.width,this.height)}add(...t){let e,i;if(1===t.length){if("object"!=typeof t[0])throw new Error("MacrectsBin.add(): Wrong parameters");i=t[0];let e=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==e)return}else{if(e=t.length>2?t[2]:null,this.options.tag&&this.options.exclusiveTag){if(e&&this.tag!==e.tag)return;if(!e&&this.tag)return}i=new U(t[0],t[1]),i.data=e,i.setDirty(!1)}const s=this.place(i);return s&&this.rects.push(s),s}repack(){let t=[];this.reset(),this.rects.sort(((t,e)=>{const i=Math.max(e.width,e.height)-Math.max(t.width,t.height);return 0===i&&t.hash&&e.hash?t.hash>e.hash?-1:1:i}));for(let e of this.rects)this.place(e)||t.push(e);for(let e of t)this.rects.splice(this.rects.indexOf(e),1);return t.length>0?t:void 0}reset(t=!1,e=!1){t&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],e&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new U(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)],this.stage=new U(this.width,this.height),this._dirty=0}clone(){let t=new z(this.maxWidth,this.maxHeight,this.padding,this.options);for(let e of this.rects)t.add(e);return t}place(t){let e,i,s=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;if(!this.options.tag||!this.options.exclusiveTag||this.tag===s){if(i=t.hasOwnProperty("_allowRotation")&&void 0!==t.allowRotation?t.allowRotation:this.options.allowRotation,e=this.findNode(t.width+this.padding,t.height+this.padding,i),e){this.updateBinSize(e);let i=this.freeRects.length,s=0;for(;s<i;)this.splitNode(this.freeRects[s],e)&&(this.freeRects.splice(s,1),i--,s--),s++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,t.x=e.x,t.y=e.y,void 0===t.rot&&(t.rot=!1),t.rot=e.rot?!t.rot:t.rot,this._dirty++,t}if(this.verticalExpand){if(this.updateBinSize(new U(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new U(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(t)}else if(this.updateBinSize(new U(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new U(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(t)}}findNode(t,e,i){let s,n,o,r=Number.MAX_VALUE;for(let h in this.freeRects)n=this.freeRects[h],n.width>=t&&n.height>=e&&(s=this.options.logic===y.MAX_AREA?n.width*n.height-t*e:Math.min(n.width-t,n.height-e),s<r&&(o=new U(t,e,n.x,n.y),r=s)),i&&n.width>=e&&n.height>=t&&(s=this.options.logic===y.MAX_AREA?n.width*n.height-e*t:Math.min(n.height-t,n.width-e),s<r&&(o=new U(e,t,n.x,n.y,!0),r=s));return o}splitNode(t,e){if(!t.collide(e))return!1;if(e.x<t.x+t.width&&e.x+e.width>t.x){if(e.y>t.y&&e.y<t.y+t.height){let i=new U(t.width,e.y-t.y,t.x,t.y);this.freeRects.push(i)}if(e.y+e.height<t.y+t.height){let i=new U(t.width,t.y+t.height-(e.y+e.height),t.x,e.y+e.height);this.freeRects.push(i)}}if(e.y<t.y+t.height&&e.y+e.height>t.y){if(e.x>t.x&&e.x<t.x+t.width){let i=new U(e.x-t.x,t.height,t.x,t.y);this.freeRects.push(i)}if(e.x+e.width<t.x+t.width){let i=new U(t.x+t.width-(e.x+e.width),t.height,e.x+e.width,t.y);this.freeRects.push(i)}}return!0}pruneFreeList(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;let s=this.freeRects[t];for(;e<i;){let n=this.freeRects[e];if(n.contain(s)){this.freeRects.splice(t,1),t--,i--;break}s.contain(n)&&(this.freeRects.splice(e,1),e--,i--),e++}t++}}updateBinSize(t){if(!this.options.smart)return!1;if(this.stage.contain(t))return!1;let e=Math.max(this.width,t.x+t.width-this.padding+this.border),i=Math.max(this.height,t.y+t.height-this.padding+this.border);if(this.options.allowRotation){const s=Math.max(this.width,t.x+t.height-this.padding+this.border),n=Math.max(this.height,t.y+t.width-this.padding+this.border);s*n<e*i&&(e=s,i=n)}return this.options.pot&&(e=Math.pow(2,Math.ceil(Math.log(e)*Math.LOG2E)),i=Math.pow(2,Math.ceil(Math.log(i)*Math.LOG2E))),this.options.square&&(e=i=Math.max(e,i)),!(e>this.maxWidth+this.padding||i>this.maxHeight+this.padding||(this.expandFreeRects(e+this.padding,i+this.padding),this.width=this.stage.width=e,this.height=this.stage.height=i,0))}expandFreeRects(t,e){this.freeRects.forEach(((i,s)=>{i.x+i.width>=Math.min(this.width+this.padding-this.border,t)&&(i.width=t-i.x-this.border),i.y+i.height>=Math.min(this.height+this.padding-this.border,e)&&(i.height=e-i.y-this.border)}),this),this.freeRects.push(new U(t-this.width-this.padding,e-2*this.border,this.width+this.padding-this.border,this.border)),this.freeRects.push(new U(t-2*this.border,e-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter((t=>!(t.width<=0||t.height<=0||t.x<this.border||t.y<this.border))),this.pruneFreeList()}}class N{constructor(){this.index=-1}}class Y{}class W{static CalcElementSpriteStr(t){return t.sizeTL.X+","+t.sizeTL.Y+","+t.sizeRB.X+","+t.sizeRB.Y+t.uvCenter.X+","+t.uvCenter.Y+","+t.uvHalfSize.X+","+t.uvHalfSize.Y+t.uvLayer+","+t.index}static GetElementInstSize(){return 32}static GetFormat_Vertex_Ubo(){if(null==this.inst_ubo){let t=new it("Vertex_InstFull");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,4,!1)),t.vbos[1].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_SHORT,2,!1)),this.inst_ubo=t,t.Update()}return this.inst_ubo}}!function(t){t[t.R2Gray=0]="R2Gray",t[t.R2Alpha=1]="R2Alpha"}(v||(v={})),function(t){t[t.R=0]="R",t[t.GRAY=1]="GRAY",t[t.Alpha=2]="Alpha"}(x||(x={}));class q{constructor(){this.toRgba=v.R2Alpha,this.toR=x.GRAY,this.pivotX=0,this.pivotY=0}CopyPixel(t,e,i,s,n){if(i==d.R8&&this.format==d.R8){let i=this.data[n*this.width+s];t[e]=i}else if(i==d.RGBA32&&this.format==d.RGBA32){let i=this.data[4*(n*this.width+s)+0],o=this.data[4*(n*this.width+s)+1],r=this.data[4*(n*this.width+s)+2],h=this.data[4*(n*this.width+s)+3];t[e]=i,t[e+1]=o,t[e+2]=r,t[e+3]=h}else if(i==d.R8&&this.format==d.RGBA32){let i=0;this.toR==x.R?i=this.data[4*(n*this.width+s)+0]:this.toR==x.GRAY?i=.3*this.data[4*(n*this.width+s)+0]+.6*this.data[4*(n*this.width+s)+1]+.1*this.data[4*(n*this.width+s)+2]:this.toR==x.Alpha&&(i=this.data[4*(n*this.width+s)+3]),t[e]=i}else if(i==d.RGBA32&&this.format==d.R8){let i=this.data[n*this.width+s];this.toRgba==v.R2Gray?(t[e]=i,t[e+1]=i,t[e+2]=i,t[e+3]=255):(t[e]=255,t[e+1]=255,t[e+2]=255,t[e+3]=i)}}ConvertToR(){if(this.format!=d.RGBA32)throw"only rgba can convert to R";let t=new q;t.format=d.R8,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=e*this.width+i;this.CopyPixel(t.data,s,d.R8,i,e)}return t}ConvertToRGBA(){if(this.format!=d.R8)throw"only r8 can convert to Rgba";let t=new q;t.format=d.RGBA32,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=4*(e*this.width+i);this.CopyPixel(t.data,s,d.RGBA32,i,e)}return t}Cut(t,e,i,s){let n=new q;n.format=this.format,n.toRgba=this.toRgba,n.toR=this.toR,n.width=i,n.height=s;let o=d.RGBA32?4:1;n.data=new Uint8Array(i*s*o);for(let r=0;r<s;r++)for(let s=0;s<i;s++){let h=r*i+s,a=(r+e)*this.width+(s+t);1==o?n.data[h]=this.data[a]:(n.data[4*h+0]=this.data[4*a+0],n.data[4*h+1]=this.data[4*a+1],n.data[4*h+2]=this.data[4*a+2],n.data[4*h+3]=this.data[4*a+3])}return n}}class H extends T{constructor(t,e,i,s,n,o=0){super(t,e,i,n,s),this.dirty=!1,this.curlayer=0,this.maxrect=new z(e,i,o),this.pixelbuf=new Uint8Array(e*i*(s==d.RGBA32?4:1)),this.dirty=!1}AddSprite(t,e){let i=this.maxrect.add(t.width,t.height,null);if(null==i&&(this.maxrect.reset(),i=this.maxrect.add(t.width,t.height,null),this.Apply(),this.curlayer++,this.curlayer>=this._layer))throw"AddSprite:Layer 满了";for(let e=0;e<t.height;e++)for(let s=0;s<t.width;s++){let n=(e+i.y)*this._width+(i.x+s);this._format==d.RGBA32?t.CopyPixel(this.pixelbuf,4*n,d.RGBA32,s,e):t.CopyPixel(this.pixelbuf,n,d.R8,s,e)}this.dirty=!0;let s=new N;s.sizeTL=new S(-t.pivotX,-t.pivotY),s.sizeRB=new S(t.width-t.pivotX,t.height-t.pivotY);let n=i.x/this._width,o=i.y/this._height,r=(i.x+t.width)/this._width,h=(i.y+t.height)/this._height;return s.uvCenter=new S(.5*(n+r),.5*(o+h)),s.uvHalfSize=new S(.5*(r-n),.5*(h-o)),s.uvLayer=this.curlayer,s.eff=e,s}Apply(t=!1){(this.dirty||t)&&(this.UploadSubTexture(this.curlayer,0,0,this._width,this._height,this.pixelbuf),this.dirty=!1)}}class j{AddSprite(t,e){return e==Et.RGBA?this.packRGBA.AddSprite(t,e):this.packGray.AddSprite(t,e)}}class J{constructor(t){this.mapName2Index={},this.packTexDuo=t,this.ElemInit(512,512)}InitMat(){this.material=new $(K.GetShaderProgram("default")),this.material.uniformTexs.texRGBA.value=this.packTexDuo.packRGBA,this.material.uniformTexs.texGray.value=this.packTexDuo.packGray,this.materialCut=new $(K.GetShaderProgram("default_cut")),this.materialCut.uniformTexs.texRGBA.value=this.packTexDuo.packRGBA,this.materialCut.uniformTexs.texGray.value=this.packTexDuo.packGray}GetMaterial(){return this.material}GetMaterialCut(){return this.materialCut}ConvertElemToSprite(t){let e=new re(this.material);return e.effect=t.eff,e.uv=new G(t.uvCenter.X-t.uvHalfSize.X,t.uvCenter.Y-t.uvHalfSize.Y,t.uvCenter.X+t.uvHalfSize.X,t.uvCenter.Y+t.uvHalfSize.Y),e.pixelwidth=t.sizeRB.X-t.sizeTL.X,e.pixelheight=t.sizeRB.Y-t.sizeTL.Y,e.pivotX=t.sizeTL.X,e.pivotY=t.sizeTL.Y,e.uvlayer=t.uvLayer,e}ElemInit(e,i){this.elemBufData=new Float32Array(e*i*4);let s=t.graphic.GetWebGL();this.elemTex=new M(s,e,i,d.F_RGBA,null),this.maxElemCount=e/4*i,this.elemCount=0,this.elemDirty=!1}GetElemTex(){return this.elemTex}GetPackTexDuo(){return this.packTexDuo}GetElementCount(){return this.elemCount}GetMaxElementCount(){return this.maxElemCount}WriteElement(t,e){t.index=e;let i=16*e;this.elemBufData[i+0]=t.sizeTL.X,this.elemBufData[i+1]=t.sizeTL.Y,this.elemBufData[i+2]=t.sizeRB.X,this.elemBufData[i+3]=t.sizeRB.Y,this.elemBufData[i+4]=t.uvCenter.X,this.elemBufData[i+5]=t.uvCenter.Y,this.elemBufData[i+6]=t.uvHalfSize.X,this.elemBufData[i+7]=t.uvHalfSize.Y,this.elemBufData[i+8]=t.uvLayer,this.elemBufData[i+11]=t.eff,this.elemDirty=!0}GetElementByIndex(t){let e=16*t,i=new N;return i.index=t,i.sizeTL=new S(0,0),i.sizeRB=new S(0,0),i.uvCenter=new S(0,0),i.uvHalfSize=new S(0,0),i.sizeTL.X=this.elemBufData[e+0],i.sizeTL.Y=this.elemBufData[e+1],i.sizeRB.X=this.elemBufData[e+2],i.sizeRB.Y=this.elemBufData[e+3],i.uvCenter.X=this.elemBufData[e+4],i.uvCenter.Y=this.elemBufData[e+5],i.uvHalfSize.X=this.elemBufData[e+6],i.uvHalfSize.Y=this.elemBufData[e+7],i.uvLayer=this.elemBufData[e+8],i.eff=this.elemBufData[e+11],i}AddSprite(t,e,i){let s=this.packTexDuo.AddSprite(t,e);return this.AddElement(i,s)}AddElement(t,e){let i=this.mapName2Index[t];if(null==i){if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";i=this.elemCount,this.mapName2Index[t]=i,this.elemCount++}return this.WriteElement(e,i),this.GetElementByIndex(i)}AddElementNoname(t){let e=this.elemCount;if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";return e=this.elemCount,this.elemCount++,this.WriteElement(t,e),this.GetElementByIndex(e)}GetElementByName(t){let e=this.mapName2Index[t];return null!=e?this.GetElementByIndex(e):null}ApplyTextureData(){this.packTexDuo.packRGBA.Apply(),this.packTexDuo.packGray.Apply(),this.elemDirty&&(this.elemTex.UploadTexture(0,0,this.elemTex.getWidth(),this.elemTex.getHeight(),this.elemBufData),this.elemDirty=!1)}}class Z{constructor(){this.defFontName="Arail",this.defFontSize=32,this.packedGrayWidth=1024,this.packedGrayHeight=1024,this.packedGrayLayerCount=8,this.packedRGBAWidth=1024,this.packedRGBAHeight=1024,this.packedRGBALayerCount=4}}class K{static Init(e){let i=t.graphic.GetWebGL();this.InitInnerResource(i,e)}static InitInnerResource(t,e){!function(t){var e=K.CompileShader(t,p.VertexShader,"inst_tbo",Zt),i=K.CompileShader(t,p.VertexShader,"inst_ubo",Kt),s=K.CompileShader(t,p.VertexShader,"default",Jt),n=K.CompileShader(t,p.FragmentShader,"default",Qt),o=K.CompileShader(t,p.FragmentShader,"default_cut",$t);null!=s&&null!=n&&K.AddProgram(t,"default",s,n),null!=s&&null!=o&&K.AddProgram(t,"default_cut",s,o);var r=K.CompileShader(t,p.VertexShader,"simple",te),h=K.CompileShader(t,p.FragmentShader,"simple",ie);null!=r&&null!=h&&K.AddProgram(t,"simple",r,h);var a=K.CompileShader(t,p.FragmentShader,"color",ee);null!=r&&null!=a&&K.AddProgram(t,"color",r,a);var l=K.CompileShader(t,p.VertexShader,"feedback",se),c=K.CompileShader(t,p.FragmentShader,"empty",ne);null!=l&&null!=c&&K.AddProgramFeedback(t,"feedback",l,c,["outPos","outNormal"]);var m=K.CompileShader(t,p.FragmentShader,"tiledmap",oe);null!=s&&null!=m&&K.AddProgram(t,"tiledmap",r,m),null!=i&&null!=n&&K.AddProgram(t,"inst_ubo",i,n),null!=e&&null!=n&&K.AddProgram(t,"inst_tbo",e,n)}(t);let i=new j;i.packGray=new H(t,e.packedGrayWidth,e.packedGrayHeight,d.R8,e.packedGrayLayerCount,0),i.packRGBA=new H(t,e.packedRGBAWidth,e.packedRGBAHeight,d.RGBA32,e.packedRGBALayerCount,0),this.packedelem=new J(i),this.packedelem.InitMat(),this.deffont=new he(t,e.defFontName,e.defFontSize,this.packedelem);{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.data=new Uint8Array(64);for(var s=0;s<t.height;s++)for(var n=0;n<t.width;n++)t.data[s*t.width+n]=255;t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"white")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"border")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,255,255,255,255,0,255,255,0,255,0,0,255,0,255,255,0,255,0,0,255,0,255,255,0,255,255,255,255,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"border2")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.data=new Uint8Array([0,0,0,255,255,0,0,0,0,0,255,128,128,255,128,0,0,255,128,0,0,128,255,0,255,128,0,0,0,0,128,255,255,128,0,0,0,0,128,255,0,255,128,0,0,128,255,0,0,128,255,128,128,255,128,0,0,0,0,255,255,0,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"borderr")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.toR=x.Alpha,t.data=new Uint8Array([0,0,0,255,255,0,0,0,0,0,255,255,255,255,0,0,0,255,255,128,128,255,255,0,255,255,128,200,200,128,255,255,255,255,128,200,200,128,255,255,0,255,255,128,128,255,255,0,0,0,255,255,255,255,0,0,0,0,0,255,255,0,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"round")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.toR=x.Alpha,t.data=new Uint8Array([255,255,255,255,255,0,0,0,255,0,128,255,0,0,0,0,255,128,0,128,255,0,0,0,255,255,128,0,128,255,0,0,255,0,255,128,0,128,255,0,0,0,0,255,128,0,128,255,0,0,0,0,255,128,255,0,0,0,0,0,0,255,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"arrow")}{let t=new q;t.format=d.R8,t.width=8,t.height=8,t.toR=x.Alpha,t.data=new Uint8Array([0,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,255,0,0,0,255,0,0,255,255,0,0,255,0,0,255,0,255,0,255,0,0,255,0,0,255,255,0,0,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,Et.GrayAsAlpha,"corner")}this.packedelem.ApplyTextureData()}static GetPackElement(){return this.packedelem}static GetWhiteBlock(){return this.packedelem.GetElementByName("white")}static GetBlock(t){return this.packedelem.GetElementByName(t)}static CreateFont(e,i){return new he(t.graphic.GetWebGL(),e,i,this.packedelem)}static GetDefFont(){return this.deffont}static GetShaderProgram(t){return null==this.programs[t]?null:this.programs[t]}static CompileShader(t,e,i,s){var n=function(t,e,i,s){var n=t.createShader(e==p.VertexShader?t.VERTEX_SHADER:t.FRAGMENT_SHADER);return null==n?(console.error("AddShader error webgl.createShader:"+e+":"+i),null):(t.shaderSource(n,s),t.compileShader(n),0==t.getShaderParameter(n,t.COMPILE_STATUS)?(console.error("AddShader error webgl.compileShader:"+t.getShaderInfoLog(n)+":"+e+":"+i),null):(console.log("AddShader:"+p[e].toString()+":"+i),new V(e,i,n)))}(t,e,i,s);return n}static AddProgram(t,e,i,s){if(null!=this.programs[e])throw"have a shader program:"+e;let n=function(t,e,i,s){var n=t.createProgram();if(null!=n){if(t.attachShader(n,i.shader),t.attachShader(n,s.shader),t.linkProgram(n),0==t.getProgramParameter(n,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+e+" E:"+t.getProgramInfoLog(n)),null;var o=new k(t,e,n,i,s);return console.log("LinkShader:"+e),o}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s);return this.programs[e]=n,n}static AddProgramFeedback(t,e,i,s,n){if(null!=this.programs[e])throw"have a shader program:"+e;let o=function(t,e,i,s,n){var o=t.createProgram();if(null!=o){if(t.attachShader(o,i.shader),t.attachShader(o,s.shader),t.transformFeedbackVaryings(o,n,t.INTERLEAVED_ATTRIBS),t.linkProgram(o),0==t.getProgramParameter(o,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+t.getProgramInfoLog(o)),null;var r=new k(t,e,o,i,s);return console.log("LinkShader:"+e),r}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s,n);return this.programs[e]=o,o}}K.deffont=null,K.programs={};class Q{static GetEmpty(){if(null==this._empty){let e=t.graphic.GetWebGL();this._empty=new Q(e)}return this._empty}static GetMax(){let e=t.graphic.GetWebGL(),i=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE);return null==i?-1:i}constructor(t){this.buf=t.createBuffer()}GetGLBuf(){return this.buf}UploadData(t,e,i){t.bindBuffer(t.UNIFORM_BUFFER,this.buf),t.bufferData(t.UNIFORM_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW)}}class ${constructor(t){this.uniformFloats={},this.uniformInts={},this.uniformMats={},this.uniformTexs={},this.uniformVecs={},this.uniformIVecs={},this.uniformBlocks={};let e=new Float32Array(16);e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1;let i=new Float32Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=0;let s=new Int32Array(4);for(var n in s[0]=0,s[1]=0,s[2]=0,s[3]=0,this.shader=t,t.uniformInfos){let o=t.uniformInfos[n];switch(o.type){case f.sampler2D:this.uniformTexs[n]={loc:o.loc,value:K.GetPackElement().GetPackTexDuo().packRGBA};break;case f.block:this.uniformBlocks[n]={index:o.locblock,value:Q.GetEmpty()};case f.mat4:this.uniformMats[n]={loc:o.loc,value:e};break;case f.vec4:this.uniformVecs[n]={loc:o.loc,value:i};break;case f.ivec4:this.uniformIVecs[n]={loc:o.loc,value:s};break;case f.float:this.uniformFloats[n]={loc:o.loc,value:0};break;case f.int:this.uniformInts[n]={loc:o.loc,value:0}}}}GetShader(){return this.shader}UpdateMatProj(t){let e=new Float32Array(16),i=2/t.getWidth(),s=2/t.getHeight();t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this.uniformMats.matProj.value=e}UpdateMatModel(t=null){null==t&&((t=new Float32Array(16))[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1),this.uniformMats.matModel.value=t}UpdateMatView(t=null){if(null==t){let e=1,i=1,s=0,n=0;(t=new Float32Array(16))[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=n*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1}this.uniformMats.matView.value=t}Apply(t){for(var e in t.disable(t.CULL_FACE),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE),t.useProgram(this.shader.program),this.uniformFloats){let i=this.uniformFloats[e];t.uniform1f(i.loc,i.value)}for(var e in this.uniformInts){let i=this.uniformInts[e];t.uniform1i(i.loc,i.value)}for(var e in this.uniformMats){let i=this.uniformMats[e];t.uniformMatrix4fv(i.loc,!1,i.value)}for(var e in this.uniformVecs){let i=this.uniformVecs[e];t.uniform4fv(i.loc,i.value)}for(var e in this.uniformIVecs){let i=this.uniformIVecs[e];t.uniform4iv(i.loc,i.value)}let i=0;for(var e in this.uniformTexs){let s=this.uniformTexs[e];t.activeTexture(t.TEXTURE0+i);let n=s.value;n.IsArray()?t.bindTexture(t.TEXTURE_2D_ARRAY,n.getGLTex()):t.bindTexture(t.TEXTURE_2D,n.getGLTex()),t.uniform1i(s.loc,i),i++}let s=0;for(var e in this.uniformBlocks){let i=this.uniformBlocks[e];t.bindBufferBase(t.UNIFORM_BUFFER,s,i.value.GetGLBuf()),t.uniformBlockBinding(this.shader.program,i.index,s),s++}}}!function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"}(w||(w={}));class tt{constructor(t,e,i){this.type=t,this.size=e,this.normalize=i}}class et{constructor(){this.vertexAttribDivisor=0,this.atrribs=[]}Update(){this.atrribsCount=this.atrribs.length,this.stride=0,this.hash="";for(var t=0;t<this.atrribs.length;t++){var e=this.atrribs[t];if(e.offset=this.stride,e.type==w.FLOAT)this.stride+=4*e.size;else if(e.type==w.UNSIGNED_BYTE)this.stride+=1*e.size;else if(e.type==w.UNSIGNED_SHORT)this.stride+=2*e.size;else{if(e.type!=w.UNSIGNED_INT)throw"unknown stride";this.stride+=4*e.size}this.hash+=e.type+"("+e.size+");"}}}class it{constructor(t){this.id=t,this.vbos=[]}Update(){this.hash="";for(var t=0;t<this.vbos.length;t++){var e=this.vbos[t];e.Update(),this.hash+="{"+e.hash+"}"}}}class st{static RegFormat(t){t.Update();let e=t;return null==this.vertexFormats[t.hash]?this.vertexFormats[t.hash]=t:e=this.vertexFormats[t.hash],this.vertexFormatsID2Hash[t.id]=t.hash,e}static GetFormat(t){let e=this.vertexFormatsID2Hash[t];return this.vertexFormats[e]}static GetFormat_Vertex_Normal(){if(null==this.vertexFormat_Vertex_Normal){let t=new it("Vertex_Normal");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!0)),this.vertexFormat_Vertex_Normal=this.RegFormat(t)}return this.vertexFormat_Vertex_Normal}static GetFormat_Vertex_Color(){if(null==this.vertexFormat_Vertex_Color){let t=new it("Vertex_Color");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_Color}static GetFormat_Vertex_UV(){if(null==this.vertexFormat_Vertex_UV){let t=new it("Vertex_UV_Color");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),this.vertexFormat_Vertex_UV=this.RegFormat(t)}return this.vertexFormat_Vertex_UV}static GetFormat_Vertex_UV_Color(){if(null==this.vertexFormat_Vertex_UV_Color){let t=new it("Vertex_UV_Color");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color}static GetFormat_Vertex_UV_Color_Ext(){if(null==this.vertexFormat_Vertex_UV_Color_Color2){let t=new it("Vertex_UV_Color_Color2");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,4,!1)),this.vertexFormat_Vertex_UV_Color_Color2=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_Color2}static GetFormat_Vertex_UV_Color_InstPos(){if(null==this.vertexFormat_Vertex_UV_Color_InstPos){let t=new it("Vertex_UV_Color_InstPos");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,3,!1)),this.vertexFormat_Vertex_UV_Color_InstPos=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPos}static GetFormat_Vertex_UV_Color_InstPosNormal(){if(null==this.vertexFormat_Vertex_UV_Color_InstPosNormal){let t=new it("Vertex_UV_Color_InstPosNormal");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[1].atrribs.push(new tt(w.FLOAT,3,!0)),this.vertexFormat_Vertex_UV_Color_InstPosNormal=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}static GetFormat_Vertex_InstFull(){if(null==this.vertexFormat_Vertex_InstFull){let t=new it("Vertex_InstFull");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,4,!1)),t.vbos[1].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_SHORT,2,!1)),this.vertexFormat_Vertex_InstFull=this.RegFormat(t)}return this.vertexFormat_Vertex_InstFull}static GetFormat_Vertex_UV_Color_InstXYZRUVRectColor(){if(null==this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor){let t=new it("Vertex_UV_Color_InstXYZRUVRectColor");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,3,!1)),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[0].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,4,!1)),t.vbos[1].atrribs.push(new tt(w.FLOAT,4,!1)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}}st.vertexFormats={},st.vertexFormatsID2Hash={},st.vertexFormat_Vertex_Normal=null,st.vertexFormat_Vertex_Color=null,st.vertexFormat_Vertex_UV=null,st.vertexFormat_Vertex_UV_Color=null,st.vertexFormat_Vertex_UV_Color_Color2=null,st.vertexFormat_Vertex_UV_Color_InstPos=null,st.vertexFormat_Vertex_UV_Color_InstPosNormal=null,st.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=null,st.vertexFormat_Vertex_InstFull=null;class nt{constructor(){this._vbos=null,this._ebo=null,this._vao=null,this.indexcount=0,this.mode=-1}GetVertexFormat(){return this.vertexFormat}UpdateVertexFormat(t,e){for(null==this._vao&&(this._vao=t.createVertexArray()),null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<e.vbos.length;)this._vbos.push(null);for(;this.vertexcount.length<e.vbos.length;)this.vertexcount.push(0);for(var i=0;i<e.vbos.length;i++)null==this._vbos[i]&&(this._vbos[i]=t.createBuffer());this.vertexFormat=e;{t.bindVertexArray(this._vao);let n=0;for(i=0;i<e.vbos.length;i++){let o=e.vbos[i];t.bindBuffer(t.ARRAY_BUFFER,this._vbos[i]);for(var s=0;s<o.atrribsCount;s++){let e=o.atrribs[s];t.enableVertexAttribArray(n),t.vertexAttribPointer(n,e.size,e.type,e.normalize,o.stride,e.offset),t.vertexAttribDivisor(n,o.vertexAttribDivisor),n++}}for(s=n;s<10;s++)t.disableVertexAttribArray(s);t.bindVertexArray(null)}}SetVertexBuffer(t,e,i,s){for(null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<=e;)this._vbos.push(null);for(;this.vertexcount.length<=e;)this.vertexcount.push(0);this._vbos[e]=i,this.vertexcount[e]=s}SetIndexBuffer(t,e,i,s){this._ebo=e,this.indexcount=s}UploadVertexBuffer(t,e,i,s,n){null==this._vbos[e]&&(this._vbos[e]=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this._vbos[e]),t.bufferData(t.ARRAY_BUFFER,i,s?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,n),this.vertexcount[e]=n/this.vertexFormat.vbos[e].stride,t.bindBuffer(t.ARRAY_BUFFER,null)}UploadIndexBuffer(t,e,i,s){null==this._ebo&&(this._ebo=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,s),this.indexcount=s/2,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}Apply(t){t.bindVertexArray(this._vao),null!=this._ebo&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo)}static DrawMesh(t,e,i){let s=e.mode;-1==s&&(s=t.TRIANGLES),e.Apply(t),i.Apply(t),null==e._ebo?t.drawArrays(s,0,e.vertexcount[0]):t.drawElements(s,e.indexcount,t.UNSIGNED_SHORT,t.ZERO)}static DrawMeshInstanced(t,e,i){let s=e.mode;-1==s&&(s=t.TRIANGLES),e.Apply(t),i.Apply(t),null==e._ebo?t.drawArraysInstanced(s,0,e.vertexcount[0],e.instancecount):t.drawElementsInstanced(s,e.indexcount,t.UNSIGNED_SHORT,t.ZERO,e.instancecount)}}class ot{constructor(){this.canvas=new de,this.lasttag=0}GetGUI(){return this.canvas}OnUpdate(t,e,i,s){this.lasttag=s,this.canvas.target=e,this.canvas.camera=i,this.canvas.OnUpdate(null,t)}OnRender(){0==this.lasttag&&this.canvas.OnRender(null)}}class rt extends F{constructor(t=u.GUI){super(t);let e=new ot;this.canvas=e.canvas,this.GetRenders().push(e);let i=O.GetMainScreen();this.GetCamera().LookAt.X=i.getWidth()/2,this.GetCamera().LookAt.Y=i.getHeight()/2}GetCanvas(){return this.canvas}}class ht extends F{constructor(t,e=u.Main){super(e),this.SetScene(t)}GetScene(){return this.scene}SetScene(t){this.scene=t,this.GetRenders().splice(0),this.AddRender(this.scene)}}var at,lt,ct,mt,_t,dt,ut,pt,ft,yt,vt,xt,wt,At,gt,bt,St,Bt,Ct=function(t,e,i,s,n){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!n)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?n.call(t,i):n?n.value=i:e.set(t,i),i},Rt=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)};const It="0123456789abcdef".split(""),Gt=[-2147483648,8388608,32768,128],Mt=[24,16,8,0],Tt=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],Dt=[];class Lt{constructor(t=!1,e=!1){at.set(this,void 0),lt.set(this,void 0),ct.set(this,void 0),mt.set(this,void 0),_t.set(this,void 0),dt.set(this,void 0),ut.set(this,void 0),pt.set(this,void 0),ft.set(this,void 0),yt.set(this,void 0),vt.set(this,void 0),xt.set(this,void 0),wt.set(this,void 0),At.set(this,void 0),gt.set(this,void 0),bt.set(this,void 0),St.set(this,0),Bt.set(this,void 0),this.init(t,e)}init(t,e){e?(Dt[0]=Dt[16]=Dt[1]=Dt[2]=Dt[3]=Dt[4]=Dt[5]=Dt[6]=Dt[7]=Dt[8]=Dt[9]=Dt[10]=Dt[11]=Dt[12]=Dt[13]=Dt[14]=Dt[15]=0,Ct(this,lt,Dt,"f")):Ct(this,lt,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"f"),t?(Ct(this,dt,3238371032,"f"),Ct(this,ut,914150663,"f"),Ct(this,pt,812702999,"f"),Ct(this,ft,4144912697,"f"),Ct(this,yt,4290775857,"f"),Ct(this,vt,1750603025,"f"),Ct(this,xt,1694076839,"f"),Ct(this,wt,3204075428,"f")):(Ct(this,dt,1779033703,"f"),Ct(this,ut,3144134277,"f"),Ct(this,pt,1013904242,"f"),Ct(this,ft,2773480762,"f"),Ct(this,yt,1359893119,"f"),Ct(this,vt,2600822924,"f"),Ct(this,xt,528734635,"f"),Ct(this,wt,1541459225,"f")),Ct(this,at,Ct(this,Bt,Ct(this,ct,Ct(this,gt,0,"f"),"f"),"f"),"f"),Ct(this,mt,Ct(this,At,!1,"f"),"f"),Ct(this,_t,!0,"f"),Ct(this,bt,t,"f")}update(t){if(Rt(this,mt,"f"))return this;let e;e=t instanceof ArrayBuffer?new Uint8Array(t):t;let i=0;const s=e.length,n=Rt(this,lt,"f");for(;i<s;){let t;if(Rt(this,At,"f")&&(Ct(this,At,!1,"f"),n[0]=Rt(this,at,"f"),n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),"string"!=typeof e)for(t=Rt(this,Bt,"f");i<s&&t<64;++i)n[t>>2]|=e[i]<<Mt[3&t++];else for(t=Rt(this,Bt,"f");i<s&&t<64;++i){let s=e.charCodeAt(i);s<128?n[t>>2]|=s<<Mt[3&t++]:s<2048?(n[t>>2]|=(192|s>>6)<<Mt[3&t++],n[t>>2]|=(128|63&s)<<Mt[3&t++]):s<55296||s>=57344?(n[t>>2]|=(224|s>>12)<<Mt[3&t++],n[t>>2]|=(128|s>>6&63)<<Mt[3&t++],n[t>>2]|=(128|63&s)<<Mt[3&t++]):(s=65536+((1023&s)<<10|1023&e.charCodeAt(++i)),n[t>>2]|=(240|s>>18)<<Mt[3&t++],n[t>>2]|=(128|s>>12&63)<<Mt[3&t++],n[t>>2]|=(128|s>>6&63)<<Mt[3&t++],n[t>>2]|=(128|63&s)<<Mt[3&t++])}Ct(this,St,t,"f"),Ct(this,ct,Rt(this,ct,"f")+(t-Rt(this,Bt,"f")),"f"),t>=64?(Ct(this,at,n[16],"f"),Ct(this,Bt,t-64,"f"),this.hash(),Ct(this,At,!0,"f")):Ct(this,Bt,t,"f")}return Rt(this,ct,"f")>4294967295&&(Ct(this,gt,Rt(this,gt,"f")+(Rt(this,ct,"f")/4294967296|0),"f"),Ct(this,ct,Rt(this,ct,"f")%4294967296,"f")),this}finalize(){if(Rt(this,mt,"f"))return;Ct(this,mt,!0,"f");const t=Rt(this,lt,"f"),e=Rt(this,St,"f");t[16]=Rt(this,at,"f"),t[e>>2]|=Gt[3&e],Ct(this,at,t[16],"f"),e>=56&&(Rt(this,At,"f")||this.hash(),t[0]=Rt(this,at,"f"),t[16]=t[1]=t[2]=t[3]=t[4]=t[5]=t[6]=t[7]=t[8]=t[9]=t[10]=t[11]=t[12]=t[13]=t[14]=t[15]=0),t[14]=Rt(this,gt,"f")<<3|Rt(this,ct,"f")>>>29,t[15]=Rt(this,ct,"f")<<3,this.hash()}hash(){let t=Rt(this,dt,"f"),e=Rt(this,ut,"f"),i=Rt(this,pt,"f"),s=Rt(this,ft,"f"),n=Rt(this,yt,"f"),o=Rt(this,vt,"f"),r=Rt(this,xt,"f"),h=Rt(this,wt,"f");const a=Rt(this,lt,"f");let l,c,m,_,d,u,p,f,y,v;for(let t=16;t<64;++t)_=a[t-15],l=(_>>>7|_<<25)^(_>>>18|_<<14)^_>>>3,_=a[t-2],c=(_>>>17|_<<15)^(_>>>19|_<<13)^_>>>10,a[t]=a[t-16]+l+a[t-7]+c|0;v=e&i;for(let x=0;x<64;x+=4)Rt(this,_t,"f")?(Rt(this,bt,"f")?(p=300032,_=a[0]-1413257819,h=_-150054599|0,s=_+24177077|0):(p=704751109,_=a[0]-210244248,h=_-1521486534|0,s=_+143694565|0),Ct(this,_t,!1,"f")):(l=(t>>>2|t<<30)^(t>>>13|t<<19)^(t>>>22|t<<10),c=(n>>>6|n<<26)^(n>>>11|n<<21)^(n>>>25|n<<7),p=t&e,m=p^t&i^v,u=n&o^~n&r,_=h+c+u+Tt[x]+a[x],d=l+m,h=s+_|0,s=_+d|0),l=(s>>>2|s<<30)^(s>>>13|s<<19)^(s>>>22|s<<10),c=(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7),f=s&t,m=f^s&e^p,u=h&n^~h&o,_=r+c+u+Tt[x+1]+a[x+1],d=l+m,r=i+_|0,i=_+d|0,l=(i>>>2|i<<30)^(i>>>13|i<<19)^(i>>>22|i<<10),c=(r>>>6|r<<26)^(r>>>11|r<<21)^(r>>>25|r<<7),y=i&s,m=y^i&t^f,u=r&h^~r&n,_=o+c+u+Tt[x+2]+a[x+2],d=l+m,o=e+_|0,e=_+d|0,l=(e>>>2|e<<30)^(e>>>13|e<<19)^(e>>>22|e<<10),c=(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7),v=e&i,m=v^e&s^y,u=o&r^~o&h,_=n+c+u+Tt[x+3]+a[x+3],d=l+m,n=t+_|0,t=_+d|0;Ct(this,dt,Rt(this,dt,"f")+t|0,"f"),Ct(this,ut,Rt(this,ut,"f")+e|0,"f"),Ct(this,pt,Rt(this,pt,"f")+i|0,"f"),Ct(this,ft,Rt(this,ft,"f")+s|0,"f"),Ct(this,yt,Rt(this,yt,"f")+n|0,"f"),Ct(this,vt,Rt(this,vt,"f")+o|0,"f"),Ct(this,xt,Rt(this,xt,"f")+r|0,"f"),Ct(this,wt,Rt(this,wt,"f")+h|0,"f")}hex(){this.finalize();const t=Rt(this,dt,"f"),e=Rt(this,ut,"f"),i=Rt(this,pt,"f"),s=Rt(this,ft,"f"),n=Rt(this,yt,"f"),o=Rt(this,vt,"f"),r=Rt(this,xt,"f"),h=Rt(this,wt,"f");let a=It[t>>28&15]+It[t>>24&15]+It[t>>20&15]+It[t>>16&15]+It[t>>12&15]+It[t>>8&15]+It[t>>4&15]+It[15&t]+It[e>>28&15]+It[e>>24&15]+It[e>>20&15]+It[e>>16&15]+It[e>>12&15]+It[e>>8&15]+It[e>>4&15]+It[15&e]+It[i>>28&15]+It[i>>24&15]+It[i>>20&15]+It[i>>16&15]+It[i>>12&15]+It[i>>8&15]+It[i>>4&15]+It[15&i]+It[s>>28&15]+It[s>>24&15]+It[s>>20&15]+It[s>>16&15]+It[s>>12&15]+It[s>>8&15]+It[s>>4&15]+It[15&s]+It[n>>28&15]+It[n>>24&15]+It[n>>20&15]+It[n>>16&15]+It[n>>12&15]+It[n>>8&15]+It[n>>4&15]+It[15&n]+It[o>>28&15]+It[o>>24&15]+It[o>>20&15]+It[o>>16&15]+It[o>>12&15]+It[o>>8&15]+It[o>>4&15]+It[15&o]+It[r>>28&15]+It[r>>24&15]+It[r>>20&15]+It[r>>16&15]+It[r>>12&15]+It[r>>8&15]+It[r>>4&15]+It[15&r];return Rt(this,bt,"f")||(a+=It[h>>28&15]+It[h>>24&15]+It[h>>20&15]+It[h>>16&15]+It[h>>12&15]+It[h>>8&15]+It[h>>4&15]+It[15&h]),a}toString(){return this.hex()}digest(){this.finalize();const t=Rt(this,dt,"f"),e=Rt(this,ut,"f"),i=Rt(this,pt,"f"),s=Rt(this,ft,"f"),n=Rt(this,yt,"f"),o=Rt(this,vt,"f"),r=Rt(this,xt,"f"),h=Rt(this,wt,"f"),a=[t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24&255,i>>16&255,i>>8&255,255&i,s>>24&255,s>>16&255,s>>8&255,255&s,n>>24&255,n>>16&255,n>>8&255,255&n,o>>24&255,o>>16&255,o>>8&255,255&o,r>>24&255,r>>16&255,r>>8&255,255&r];return Rt(this,bt,"f")||a.push(h>>24&255,h>>16&255,h>>8&255,255&h),a}array(){return this.digest()}arrayBuffer(){this.finalize();const t=new ArrayBuffer(Rt(this,bt,"f")?28:32),e=new DataView(t);return e.setUint32(0,Rt(this,dt,"f")),e.setUint32(4,Rt(this,ut,"f")),e.setUint32(8,Rt(this,pt,"f")),e.setUint32(12,Rt(this,ft,"f")),e.setUint32(16,Rt(this,yt,"f")),e.setUint32(20,Rt(this,vt,"f")),e.setUint32(24,Rt(this,xt,"f")),Rt(this,bt,"f")||e.setUint32(28,Rt(this,wt,"f")),t}}at=new WeakMap,lt=new WeakMap,ct=new WeakMap,mt=new WeakMap,_t=new WeakMap,dt=new WeakMap,ut=new WeakMap,pt=new WeakMap,ft=new WeakMap,yt=new WeakMap,vt=new WeakMap,xt=new WeakMap,wt=new WeakMap,At=new WeakMap,gt=new WeakMap,bt=new WeakMap,St=new WeakMap,Bt=new WeakMap,new WeakMap,new WeakMap,new WeakMap,new WeakMap;class Pt{static LoadTextPixel(e,i,s,n,o,r,h){let a=t.graphic.GetBackGroundC2D();a.canvas.width=n,a.canvas.height=o,a.scale(1,1),a.imageSmoothingEnabled=!1,a.shadowBlur=0,a.font=s+"px "+i,a.clearRect(0,0,n,o),a.textBaseline="top",a.textAlign="left",a.fillStyle="#ffffffff",a.globalAlpha=1,a.fillText(e,r,h);let l=a.measureText(e).width;return a.getImageData(0,0,l,o)}}class Ft{static GetFileName(t){if(t.includes("/")){let e=t.lastIndexOf("/");return t.substring(e+1)}if(t.includes("\\")){let e=t.lastIndexOf("\\");return t.substring(e+1)}return t}static GetFirstPath(t){if(t.includes("/")){let e=t.indexOf("/");return e<0?t:t.substring(0,e)}if(t.includes("\\")){let e=t.indexOf("\\");return t.substring(0,e)}return""}static RemoveFirstPath(t){let e=this.GetFirstPath(t);return t.substring(e.length+1)}static GetPathName(t){if(t.includes("/")){let e=t.lastIndexOf("/");return e<0?t:t.substring(0,e)}if(t.includes("\\")){let e=t.lastIndexOf("\\");return t.substring(0,e)}return""}static GetFileNameWithoutExt(t){let e=this.GetFileName(t),i=e.indexOf(".");return i<0?e:e.substring(0,i)}static GetExt(t){let e=this.GetFileName(t);console.log("_getext:"+e);let i=e.indexOf(".");return i<0?"":e.substring(i)}}var Et;!function(t){t[t.RGBA=0]="RGBA",t[t.Gray=1]="Gray",t[t.GrayAsAlpha=4]="GrayAsAlpha"}(Et||(Et={}));class Ot{constructor(){this.x=0,this.y=0,this.z=0,this.r=1,this.g=1,this.b=1,this.a=1,this.u=0,this.v=0,this.uvlayer=0,this.e2=0,this.e3=0,this.eff=0,this.umin=0,this.vmin=0,this.umax=0,this.vmax=0}Clone(){var t=new Ot;return t.x=this.x,t.y=this.y,t.z=this.z,t.u=this.u,t.v=this.v,t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t.uvlayer=this.uvlayer,t.e2=this.e2,t.e3=this.e3,t.eff=this.eff,t.umin=this.umin,t.vmin=this.vmin,t.umax=this.umax,t.vmax=this.vmax,t}}class Vt{constructor(t){this._mesh=null,this._lastmat=null,this._webgl=t,this._target=null,this._lastmat=null,this._buffer=new Uint8Array(2883584),this._bufferView=new DataView(this._buffer.buffer,0,this._buffer.length),this._pointseek=0,this._lastMode=t.TRIANGLES,this._mesh=new nt,this._mesh.UpdateVertexFormat(t,st.GetFormat_Vertex_UV_Color_Ext())}DrawQuads(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+6*i>=65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++){let t=e[4*s+0],i=e[4*s+1],n=e[4*s+2],o=e[4*s+3];t.umin=i.umin=n.umin=o.umin=t.u,t.vmin=i.vmin=n.vmin=o.vmin=t.v,t.umax=i.umax=n.umax=o.umax=o.u,t.vmax=i.vmax=n.vmax=o.vmax=o.v,this._AddBuf(t),this._AddBuf(i),this._AddBuf(n),this._AddBuf(n),this._AddBuf(i),this._AddBuf(o)}}DrawTris(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+3*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++)this._AddBuf(e[3*s+0]),this._AddBuf(e[3*s+1]),this._AddBuf(e[3*s+2])}DrawLines(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.LINES||this._lastmat!=t||this._pointseek+2*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.LINES;for(var s=0;s<i;s++)this._AddBuf(e[2*s+0]),this._AddBuf(e[2*s+1])}DrawPoints(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.POINTS||this._lastmat!=t||this._pointseek+1*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.POINTS;for(var s=0;s<i;s++)this._AddBuf(e[s])}getTarget(){return this._target}getName(){return"Batcher"}ResetMatrix(){this._Render(),this._lastmat.UpdateMatModel(),this._lastmat.UpdateMatView(),this._lastmat.UpdateMatProj(this._target)}ApplyBatch(){this._Render()}ResumeDraw(){this.camera.GetViewMatrix(),null!=this._lastmat&&(this._lastmat.UpdateMatModel(null),this._lastmat.UpdateMatView(this.camera.GetViewMatrix()),this._lastmat.UpdateMatProj(this._target));let t=this._webgl;t.disable(t.CULL_FACE),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE)}BeginDraw(t,e){this._target=t,this.camera=e,this.ResumeDraw()}EndDraw(){this._Render(),this._ApplySingle(null)}_Render(){if(0==this._pointseek)return;let t=this._webgl;this._mesh.mode=this._lastMode,this._mesh.UploadVertexBuffer(t,0,this._buffer,!0,44*this._pointseek),this._pointseek=0,null!=this._lastmat&&nt.DrawMesh(t,this._mesh,this._lastmat)}_AddBuf(t){this._bufferView.setFloat32(44*this._pointseek+0,t.x,!0),this._bufferView.setFloat32(44*this._pointseek+4,t.y,!0),this._bufferView.setFloat32(44*this._pointseek+8,t.z,!0),this._bufferView.setFloat32(44*this._pointseek+12,t.u,!0),this._bufferView.setFloat32(44*this._pointseek+16,t.v,!0),this._bufferView.setUint8(44*this._pointseek+20,255*t.r|0),this._bufferView.setUint8(44*this._pointseek+21,255*t.g|0),this._bufferView.setUint8(44*this._pointseek+22,255*t.b|0),this._bufferView.setUint8(44*this._pointseek+23,255*t.a|0),this._bufferView.setUint8(44*this._pointseek+24,t.uvlayer),this._bufferView.setUint8(44*this._pointseek+25,t.e2),this._bufferView.setUint8(44*this._pointseek+26,t.e3),this._bufferView.setUint8(44*this._pointseek+27,t.eff),this._bufferView.setFloat32(44*this._pointseek+28,t.umin,!0),this._bufferView.setFloat32(44*this._pointseek+32,t.vmin,!0),this._bufferView.setFloat32(44*this._pointseek+36,t.umax,!0),this._bufferView.setFloat32(44*this._pointseek+40,t.vmax,!0),this._pointseek++}_ApplySingle(t){this._lastmat=t,null!=this._lastmat&&(this._lastmat.UpdateMatModel(null),this._lastmat.UpdateMatView(this.camera.GetViewMatrix()),this._lastmat.UpdateMatProj(this._target))}}class kt{constructor(){this.lasttag=0,this.material=new $(K.GetShaderProgram("inst_tbo")),this.material.UpdateMatModel(),this.ElemInstInit();let e=t.graphic.GetWebGL();this.mesh=new nt,this.mesh.UpdateVertexFormat(e,W.GetFormat_Vertex_Ubo()),this.InitDrawMesh(e)}static GetFormat_Vertex_Ubo(){if(null==this.inst_ubo){let t=new it("Vertex_InstFull");t.vbos.push(new et),t.vbos[0].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos.push(new et),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new tt(w.FLOAT,4,!1)),t.vbos[1].atrribs.push(new tt(w.FLOAT,2,!1)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new tt(w.UNSIGNED_SHORT,2,!1)),this.inst_ubo=t,t.Update()}return this.inst_ubo}SetPackElement(t){this.packelem=t,this.material.uniformTexs.texRGBA.value=t.GetPackTexDuo().packRGBA,this.material.uniformTexs.texGray.value=t.GetPackTexDuo().packGray;let e=this.material.uniformTexs.texelem;null!=e&&(e.value=t.GetElemTex())}GetPackElement(){return this.packelem}ElemInstInit(){this.elemInstBufData=new Uint8Array(32768),this.elemInstBufView=new DataView(this.elemInstBufData.buffer),this.elemInstCount=0,this.elemInstDirty=!1}GetElementInstCount(){return this.elemInstCount}ClearElementInst(){this.elemInstCount=0}AddElementInst(t){let e=this.elemInstCount;return this.elemInstCount++,this.WriteElementInst(t,e),e}WriteElementInst(t,e){if(32*e>=this.elemInstBufData.length){let t=new Uint8Array(32*(1024+e));for(let e=0;e<this.elemInstBufData.length;e++)t[e]=this.elemInstBufData[e];this.elemInstBufData=t,this.elemInstBufView=new DataView(this.elemInstBufData.buffer)}let i=32*e;this.elemInstBufView.setFloat32(i+0,t.pos.X,!0),this.elemInstBufView.setFloat32(i+4,t.pos.Y,!0),this.elemInstBufView.setFloat32(i+8,t.pos.Z,!0),this.elemInstBufView.setFloat32(i+12,t.rotate,!0),this.elemInstBufView.setFloat32(i+16,t.scale.X,!0),this.elemInstBufView.setFloat32(i+20,t.scale.Y,!0),this.elemInstBufView.setUint8(i+24,255*t.color.R),this.elemInstBufView.setUint8(i+25,255*t.color.G),this.elemInstBufView.setUint8(i+26,255*t.color.B),this.elemInstBufView.setUint8(i+27,255*t.color.A),this.elemInstBufView.setUint16(i+28,t.instid,!0),this.elemInstDirty=!0}GetElementInst(t){let e=32*t,i=new Y;i.pos=new B(0,0,0),i.scale=new S(0,0),i.color=new b(0,0,0,0),i.pos.X=this.elemInstBufView.getFloat32(e+0,!0),i.pos.Y=this.elemInstBufView.getFloat32(e+4,!0),i.pos.Z=this.elemInstBufView.getFloat32(e+8,!0),i.rotate=this.elemInstBufView.getFloat32(e+12,!0),i.scale.X=this.elemInstBufView.getFloat32(e+16,!0),i.scale.Y=this.elemInstBufView.getFloat32(e+20,!0),i.color.R=this.elemInstBufView.getUint8(e+24)/255,i.color.G=this.elemInstBufView.getUint8(e+25)/255,i.color.B=this.elemInstBufView.getUint8(e+26)/255,i.color.A=this.elemInstBufView.getUint8(e+27)/255;let s=this.elemInstBufView.getUint16(e+28,!0);return i.instid=s,i}InitDrawMesh(t){let e=this.mesh.GetVertexFormat().vbos[0].stride,i=new Uint8Array(6*e),s=new DataView(i.buffer);s.setFloat32(0*e,-1,!0),s.setFloat32(0*e+4,-1,!0),s.setFloat32(1*e,1,!0),s.setFloat32(1*e+4,-1,!0),s.setFloat32(2*e,-1,!0),s.setFloat32(2*e+4,1,!0),s.setFloat32(3*e,-1,!0),s.setFloat32(3*e+4,1,!0),s.setFloat32(4*e,1,!0),s.setFloat32(4*e+4,-1,!0),s.setFloat32(5*e,1,!0),s.setFloat32(5*e+4,1,!0),this.mesh.UploadVertexBuffer(t,0,i,!1,i.byteLength)}GetGUI(){return null}OnUpdate(e,i,s,n){if(0==n){this.lasttag=n;let e=t.graphic.GetWebGL();this.packelem.ApplyTextureData(),this.elemInstDirty&&(this.mesh.UploadVertexBuffer(e,1,this.elemInstBufData,!0,this.elemInstBufData.byteLength),this.elemInstDirty=!1),this.mesh.instancecount=this.elemInstCount,this.material.UpdateMatProj(i),this.material.UpdateMatView(s.GetViewMatrix()),nt.DrawMeshInstanced(e,this.mesh,this.material)}}OnRender(){if(0==this.lasttag){let e=t.graphic.GetWebGL();nt.DrawMeshInstanced(e,this.mesh,this.material)}}}var Ut,Xt,zt,Nt,Yt,Wt,qt,Ht,jt,Jt="#version 300 es\n    precision highp float;\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n    layout(location = 3) in vec4 ext; \n    layout(location = 4) in vec4 uvLimit; \n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    flat out vec4 vUvLimit;//输出给fs的参数2\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void) \n    {\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        vUvLimit = uvLimit;;\n        vExt = int(ext.w);\n        vLayer =int(ext.x);\n    }\n    ",Zt="#version 300 es\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    // layout(std140, column_major) uniform;\n    struct Sprite //结构体的基线是4n的倍数\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        float uvlayer;\n        float empty1;//占位，凑4N\n        float empty2;\n        float eff;\n       \n    };\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n    uniform sampler2D texelem;\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        int ext = int(ext.x);\n        int iuvx = ext%128 *4;\n        int iuvy = ext/128;\n\n        \n        vec4 v0 = texelFetch(texelem,ivec2(iuvx+0,iuvy),0);\n        vec4 v1 = texelFetch(texelem,ivec2(iuvx+1,iuvy),0);\n        vec4 v2 = texelFetch(texelem,ivec2(iuvx+2,iuvy),0);\n        //vec4 v3 =texelFetch(texelem,ivec2(iuvx+3,iuvy),0);\n        \n        Sprite s;\n        s.posLT = v0.xy;\n        s.posRB = v0.zw;\n        s.uvCenter = v1.xy;\n        s.uvHalfSize = v1.zw;\n        s.uvlayer = v2.x;\n        s.eff = v2.w;\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n    \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            //--begin rotate\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n            //--end rorate\n        }\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n       \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.eff);\n        vLayer=int(s.uvlayer);\n    }\n",Kt="#version 300 es\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    layout(std140, column_major) uniform;\n    struct Sprite //\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        vec4 ext;\n    };\n\n    uniform SpritesBlock {//\n        //\n        Sprite data[1023];    \n        int endtag; //\n    } sprites;\n    \n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        Sprite s = sprites.data[int(ext.x)];\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n        //--begin rotate\n       \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n        }\n        //--end rorate\n\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n        \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.ext.w);\n        vLayer=int(s.ext.x);\n    }\n",Qt="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    flat in int vExt;\n    flat in int vLayer;\n        \n    layout(location = 0) out vec4 fragColor;\n\n    \n    uniform sampler2DArray texRGBA;  //从外部设置的参数\n    uniform sampler2DArray texGray;\n    void main(void) \n    {\n        vec4 texc = vExt==0? texture(texRGBA,vec3(vUv,vLayer))\n        : texture(texGray,vec3(vUv,vLayer));\n        vec4 outc = vColor;\n        int effect = vExt;//int(vExt.w);\n        if(effect==0)//rgba model \n        {\n            outc = vColor*texc;\n        }\n        else if(effect==1)//gray model\n        {\n            vec4 c = vec4(texc.r,texc.r,texc.r,1);\n            outc = vColor * c;\n        }\n        else if(effect==4)//gray as alpha model\n        {\n            //outc.a *= texc.r;\n            outc = vColor;\n            outc.a *=texc.r; \n            //outc = vColor * 0.5;\n        }\n        fragColor =  outc;\n        \n    }\n    ",$t="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    flat in vec4 vUvLimit;\n    flat in int vExt;\n    flat in int vLayer;\n        \n    layout(location = 0) out vec4 fragColor;\n\n    \n    uniform sampler2DArray texRGBA;  //从外部设置的参数\n    uniform sampler2DArray texGray;\n    void main(void) \n    {\n        //无奈了，只能用discard来处理了，这个像素下边会多一丢丢，莫名\n        if(vUv.x<vUvLimit.x||vUv.x>vUvLimit.z||vUv.y<vUvLimit.y||vUv.y>vUvLimit.w-(1.0/4096.0))\n        {\n            discard;\n        }\n        vec4 texc = vExt==0? texture(texRGBA,vec3(vUv,vLayer))\n        : texture(texGray,vec3(vUv,vLayer));\n        vec4 outc = vColor;\n        int effect = vExt;//int(vExt.w);\n        if(effect==0)//rgba model \n        {\n            outc = vColor*texc;\n        }\n        else if(effect==1)//gray model\n        {\n            vec4 c = vec4(texc.r,texc.r,texc.r,1);\n            outc = vColor * c;\n        }\n        else if(effect==4)//gray as alpha model\n        {\n            //outc.a *= texc.r;\n            outc = vColor;\n            outc.a *=texc.r; \n            //outc = vColor * 0.5;\n        }\n        fragColor =  outc;\n        \n    }\n    ",te="#version 300 es\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n \n\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    //flat out vec4 vExt;\n    uniform sampler2D tex2;\n    void main(void) \n    {\n        vec4 t1 = texelFetch(tex2,ivec2(0, 0), 0);\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        //vExt = ext;\n    }\n    ",ee="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    //flat in vec4 vExt;\n\n        \n    layout(location = 0) out vec4 fragColor;\n    void main(void) \n    {\n\n        vec4 outc = vColor;\n        fragColor = outc;\n    }\n    ",ie="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    //flat in vec4 vExt;\n\n        \n    layout(location = 0) out vec4 fragColor;\n\n    uniform sampler2D tex;  //从外部设置的参数\n    void main(void) \n    {\n     \n        vec4 texc = texture(tex,vUv);\n        vec4 outc = vColor;\n       \n        outc = vColor * texc;\n       \n        fragColor =  outc;\n    }\n    ",se="#version 300 es\nlayout(location = 0) in vec3 position;//顶点提供的数据\nlayout(location = 1) in vec3 normal;//顶点提供的数据\nout vec3 outPos;\nout vec3 outNormal;\nvoid main(void) \n{\n    outPos = position + normal;\n    outNormal = normal;\n}\n",ne="#version 300 es\n    precision mediump float;//指定浮点型精确度\n   \n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        fragColor =  vec4(0,0,0,1);\n    }\n    ",oe="#version 300 es\n    precision mediump float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n \n    uniform sampler2D texIndex; \n    uniform sampler2D texTile; \n    uniform float   tilesize;\n    uniform vec4     mapinfo;//xy map size, zw=tile texturesize\n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        //抽取TiledIndex\n        vec4 texc = texture(texIndex,vUv);\n        float su =float(int(texc.r*255.0+0.9)); //tileindex x\n        float sv =float(int(texc.g*255.0+0.9)); //tileindex y\n\n        float su2 =float(int(texc.b*255.0+0.9)); //tileindex z\n        float sv2 =float(int(texc.a*255.0+0.9)); //tileindex w\n\n        //计算tileduv\n        float subu = mod(vUv.x * mapinfo.x, 1.0);\n        float subv = mod(vUv.y * mapinfo.y, 1.0);\n        vec2 tilescale =vec2(tilesize,tilesize)/mapinfo.zw;\n        //float tilescaleY =tiledsize/mapinfo.w;\n        vec2 tuv = vec2((su+subu)*tilescale.x,(sv+subv)*tilescale.y);\n        vec2 tuv2 = vec2((su2+subu)*tilescale.x,(sv2+subv)*tilescale.y);\n\n        //合成颜色\n        vec4 ttc = texture(texTile,tuv);\n        vec4 ttc2 = texture(texTile,tuv2);\n \n\n        vec4 outcolor = ttc2.a*ttc2 + (1.0-ttc2.a)*ttc;\n        \n        fragColor = outcolor;\n    }\n    ";class re{constructor(t){this.uvlayer=0,this.material=t,this.effect=Et.RGBA,this.uv=new G(0,0,1,1);let e=t.uniformTexs.tex;null==e&&(e=t.uniformTexs.texRGBA),null==e&&(e=t.uniformTexs.texGray),null!=e?(this.pixelwidth=e.value.getWidth(),this.pixelheight=e.value.getHeight()):(this.pixelwidth=16,this.pixelheight=16),this.uvlayer=0,this.pivotX=0,this.pivotY=0}RenderRectWithLimit(t,e,i,s=null,n=-1){let o=re._rectbuf;for(;o.length<4;)o.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let r=null==s?re._colorbuf:s,h=(e.Width,this.pixelwidth,e.Height,this.pixelheight,e.X),a=e.X+e.Width,l=e.Y,c=e.Y+e.Height,m=this.uv.U1,_=this.uv.V1,d=this.uv.U2,u=this.uv.V2,p=a-h,f=c-l;if(h>=i.X+i.Width||a<i.X||l>=i.Y+i.Height||c<i.Y)h=a=l=c=0;else if(0!=p&&0!=f){let t=h,e=a,s=l,n=c,o=!1;if(h<i.X&&(t=i.X,o=!0),a>i.X+i.Width&&(e=i.X+i.Width,o=!0),l<i.Y&&(s=i.Y,o=!0),c>i.Y+i.Height&&(n=i.Y+i.Height,o=!0),o){let i=d-m,o=u-_;m+=i*((t-h)/p),_+=o*((s-l)/f),d+=i*((e-a)/p),u+=o*((n-c)/f),h=t,l=s,a=e,c=n}}o[0].x=h,o[0].y=l,o[0].u=m,o[0].v=_,o[0].r=r.R,o[0].g=r.G,o[0].b=r.B,o[0].a=r.A,o[0].uvlayer=this.uvlayer,o[0].eff=this.effect,o[1].x=a,o[1].y=l,o[1].u=d,o[1].v=_,o[1].r=r.R,o[1].g=r.G,o[1].b=r.B,o[1].a=r.A,o[1].uvlayer=this.uvlayer,o[1].eff=this.effect,o[2].x=h,o[2].y=c,o[2].u=m,o[2].v=u,o[2].r=r.R,o[2].g=r.G,o[2].b=r.B,o[2].a=r.A,o[2].uvlayer=this.uvlayer,o[2].eff=this.effect,o[3].x=a,o[3].y=c,o[3].u=d,o[3].v=u,o[3].r=r.R,o[3].g=r.G,o[3].b=r.B,o[3].a=r.A,o[3].uvlayer=this.uvlayer,o[3].eff=this.effect,t.DrawQuads(this.material,o,1)}RenderRect(t,e,i=null,s=-1){let n=re._rectbuf;for(;n.length<4;)n.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let o=null==i?re._colorbuf:i;e.Width,this.pixelwidth,e.Height,this.pixelheight,n[0].x=e.X,n[0].y=e.Y,n[0].u=this.uv.U1,n[0].v=this.uv.V1,n[0].r=o.R,n[0].g=o.G,n[0].b=o.B,n[0].a=o.A,n[0].uvlayer=this.uvlayer,n[0].eff=this.effect,n[1].x=e.X+e.Width,n[1].y=e.Y,n[1].u=this.uv.U2,n[1].v=this.uv.V1,n[1].r=o.R,n[1].g=o.G,n[1].b=o.B,n[1].a=o.A,n[1].uvlayer=this.uvlayer,n[1].eff=this.effect,n[2].x=e.X,n[2].y=e.Y+e.Height,n[2].u=this.uv.U1,n[2].v=this.uv.V2,n[2].r=o.R,n[2].g=o.G,n[2].b=o.B,n[2].a=o.A,n[2].uvlayer=this.uvlayer,n[2].eff=this.effect,n[3].x=e.X+e.Width,n[3].y=e.Y+e.Height,n[3].u=this.uv.U2,n[3].v=this.uv.V2,n[3].r=o.R,n[3].g=o.G,n[3].b=o.B,n[3].a=o.A,n[3].uvlayer=this.uvlayer,n[3].eff=this.effect,t.DrawQuads(this.material,n,1)}RenderWithPivot(t,e,i,s=null,n=-1){let o=re._rectbuf;for(;o.length<4;)o.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let r=null==s?re._colorbuf:s,h=e.X-i.X*this.pivotX,a=h+i.X*this.pixelwidth,l=e.Y-i.Y*this.pivotY,c=l+i.Y*this.pixelheight;o[0].x=h,o[0].y=l,o[0].u=this.uv.U1,o[0].v=this.uv.V1,o[0].r=r.R,o[0].g=r.G,o[0].b=r.B,o[0].a=r.A,o[0].uvlayer=this.uvlayer,o[0].eff=this.effect,o[1].x=a,o[1].y=l,o[1].u=this.uv.U2,o[1].v=this.uv.V1,o[1].r=r.R,o[1].g=r.G,o[1].b=r.B,o[1].a=r.A,o[1].uvlayer=this.uvlayer,o[1].eff=this.effect,o[2].x=h,o[2].y=c,o[2].u=this.uv.U1,o[2].v=this.uv.V2,o[2].r=r.R,o[2].g=r.G,o[2].b=r.B,o[2].a=r.A,o[2].uvlayer=this.uvlayer,o[2].eff=this.effect,o[3].x=a,o[3].y=c,o[3].u=this.uv.U2,o[3].v=this.uv.V2,o[3].r=r.R,o[3].g=r.G,o[3].b=r.B,o[3].a=r.A,o[3].uvlayer=this.uvlayer,o[3].eff=this.effect,t.DrawQuads(this.material,o,1)}RenderWithPivotAndRotate(t,e,i,s,n=null,o=-1){let r=re._rectbuf;for(;r.length<4;)r.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let h=null==n?re._colorbuf:n,a=e.X,l=e.X+i.X*this.pixelwidth,c=e.Y,m=e.Y+i.Y*this.pixelheight,_=e.X+this.pivotX*i.X,d=e.Y+this.pivotY*i.Y,u=a-_,p=c-d,f=l-_,y=m-d,v=Math.sin(s),x=Math.cos(s),w=a+u*x-p*v,A=c+u*v+p*x,g=a+f*x-p*v,S=c+f*v+p*x,B=a+u*x-y*v,C=c+u*v+y*x,R=a+f*x-y*v,I=c+f*v+y*x;r[0].x=w,r[0].y=A,r[0].u=this.uv.U1,r[0].v=this.uv.V1,r[0].r=h.R,r[0].g=h.G,r[0].b=h.B,r[0].a=h.A,r[0].uvlayer=this.uvlayer,r[0].eff=this.effect,r[1].x=g,r[1].y=S,r[1].u=this.uv.U2,r[1].v=this.uv.V1,r[1].r=h.R,r[1].g=h.G,r[1].b=h.B,r[1].a=h.A,r[1].uvlayer=this.uvlayer,r[1].eff=this.effect,r[2].x=B,r[2].y=C,r[2].u=this.uv.U1,r[2].v=this.uv.V2,r[2].r=h.R,r[2].g=h.G,r[2].b=h.B,r[2].a=h.A,r[2].uvlayer=this.uvlayer,r[2].eff=this.effect,r[3].x=R,r[3].y=I,r[3].u=this.uv.U2,r[3].v=this.uv.V2,r[3].r=h.R,r[3].g=h.G,r[3].b=h.B,r[3].a=h.A,r[3].uvlayer=this.uvlayer,r[3].eff=this.effect,t.DrawQuads(this.material,r,1)}}re._rectbuf=[];class he{constructor(t,e,i,s){this.fonttex=s,this.fontsize=i,this.fontname=e}GetFont(){return this.fontname}GetFontSize(){return this.fontsize}GetCharSprite(t){let e=this._CacheCharSprite(t);return null!=e&&this.fonttex.ApplyTextureData(),e}_CacheCharSprite(t){let e=String.fromCharCode(t),i=this.fonttex.GetElementByName(e);if(null==i)try{let t=Pt.LoadTextPixel(e,this.fontname,this.fontsize,this.fontsize+2,this.fontsize+2,0,0);if(0==t.height||0==t.width)return null;let s=new q;s.format=d.RGBA32,s.toR=x.Alpha,s.data=t.data,s.width=t.width,s.height=t.height;let n=s.ConvertToR();n.toR=x.Alpha,i=this.fonttex.AddSprite(n,Et.GrayAsAlpha,e)}catch(i){return console.error("cache char error:"+i),null}let s=this.fonttex.ConvertElemToSprite(i);return s.material=this.fonttex.GetMaterialCut(),s}SureText(t){let e=0;for(var i=0;i<t.length;i++){let s=this._CacheCharSprite(t.charCodeAt(i));e+=null!=s?s.pixelwidth:this.fontsize/2}return this.fonttex.ApplyTextureData(),e}RenderText(t,e,i,s,n){let o=0;for(var r=0;r<e.length;r++){let h=this.GetCharSprite(e.charCodeAt(r));if(null!=h){let e=new C(i.X+o,i.Y,h.pixelwidth*s.X,h.pixelheight*s.Y);h.RenderRect(t,e,n),o+=h.pixelwidth*s.X}else o+=this.fontsize/2*s.X}}RenderTextWithLimit(t,e,i,s,n,o){let r=0;for(var h=0;h<e.length;h++){let a=this.GetCharSprite(e.charCodeAt(h));if(null!=a){let e=new C(i.X+r,i.Y,a.pixelwidth*s.X,a.pixelheight*s.Y);a.RenderRectWithLimit(t,e,o,n),r+=a.pixelwidth*s.X}else r+=this.fontsize/2*s.X}}}!function(t){t[t.None=0]="None",t[t.LeftToRight=1]="LeftToRight",t[t.UpToDown=2]="UpToDown",t[t.Both=3]="Both"}(Ut||(Ut={})),function(t){t[t.LeftToRight=0]="LeftToRight",t[t.UpToDown=1]="UpToDown",t[t.RightToLeft=2]="RightToLeft",t[t.DownToUp=3]="DownToUp"}(Xt||(Xt={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(zt||(zt={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(Nt||(Nt={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom"}(Yt||(Yt={}));class ae{Clone(){let t=new ae;return t.radioX1=this.radioX1,t.radioX2=this.radioX2,t.radioY1=this.radioY1,t.radioY2=this.radioY2,t.offsetX1=this.offsetX1,t.offsetX2=this.offsetX2,t.offsetY1=this.offsetY1,t.offsetY2=this.offsetY2,t}getWidth(){if(!this.sizeonly)throw"onlysizeonly can getwidth";return this.offsetX2-this.offsetX1}getHeight(){if(!this.sizeonly)throw"onlysizeonly can getheight";return this.offsetY2-this.offsetY1}setPos(t,e){if(!this.sizeonly)throw"onlysizeonly can setpos";let i=this.getWidth(),s=this.getHeight();this.offsetX1=t,this.offsetY1=e,this.offsetX2=t+i,this.offsetY2=e+s}getFinalRect(t){let e=t.X,i=t.X+t.Width,s=t.Y,n=t.Y+t.Height,o=e+this.radioX1*(i-e)+this.offsetX1,r=s+this.radioY1*(n-s)+this.offsetY1,h=e+this.radioX2*(i-e)+this.offsetX2,a=s+this.radioY2*(n-s)+this.offsetY2;return new C(o,r,h-o,a-r)}getFinalRectScale(t,e){let i=t.X,s=t.X+t.Width,n=t.Y,o=t.Y+t.Height,r=(i+this.radioX1*(s-i)+this.offsetX1)*e,h=(n+this.radioY1*(o-n)+this.offsetY1)*e,a=(i+this.radioX2*(s-i)+this.offsetX2)*e,l=(n+this.radioY2*(o-n)+this.offsetY2)*e;return new C(r,h,a-r,l-h)}SetAsFill(){this.radioX1=0,this.radioY1=0,this.radioX2=1,this.radioY2=1,this.offsetX1=0,this.offsetX2=0,this.offsetY1=0,this.offsetY2=0,this.sizeonly=!1}setBySize(t,e){this.radioX1=0,this.radioY1=0,this.radioX2=0,this.radioY2=0,this.offsetX1=0,this.offsetX2=t,this.offsetY1=0,this.offsetY2=e,this.sizeonly=!0}setByPosAndSize(t,e,i,s){this.radioX1=0,this.radioY1=0,this.radioX2=0,this.radioY2=0,this.offsetX1=t,this.offsetX2=t+i,this.offsetY1=e,this.offsetY2=e+s,this.sizeonly=!0}setByRect(t){this.radioX1=0,this.radioY1=0,this.radioX2=0,this.radioY2=0,this.offsetX1=t.X,this.offsetX2=t.X+t.Width,this.offsetY1=t.Y,this.offsetY2=t.Y+t.Height,this.sizeonly=!0}setHPosByLeftBorder(t,e=0){this.radioX1=0,this.radioX2=0,this.offsetX1=e,this.offsetX2=e+t}setHPosByCenter(t){this.radioX1=.5,this.radioX2=.5,this.offsetX1=-.5*t,this.offsetX2=.5*t,this.sizeonly=!1}setHPosByRightBorder(t,e=0){this.radioX1=1,this.radioX2=1,this.offsetX1=-e-t,this.offsetX2=-e,this.sizeonly=!1}setHPosFill(t=0,e=0){this.radioX1=0,this.radioX2=1,this.offsetX1=t,this.offsetX2=-e,this.sizeonly=!1}setVPosByTopBorder(t,e=0){this.radioY1=0,this.radioY2=0,this.offsetY1=e,this.offsetY2=e+t}setVPosByCenter(t){this.radioY1=.5,this.radioY2=.5,this.offsetY1=-.5*t,this.offsetY2=.5*t,this.sizeonly=!1}setVPosByBottomBorder(t,e=0){this.radioY1=1,this.radioY2=1,this.offsetY1=-e-t,this.offsetY2=-e,this.sizeonly=!1}setVPosFill(t=0,e=0){this.radioY1=0,this.radioY2=1,this.offsetY1=t,this.offsetY2=-e,this.sizeonly=!1}}!function(t){t[t.Element_User=0]="Element_User",t[t.Element_Canvas=1]="Element_Canvas",t[t.Element_Container=2]="Element_Container",t[t.Element_ScreenFixer=3]="Element_ScreenFixer",t[t.Element_CustomRender=4]="Element_CustomRender",t[t.Element_Image=5]="Element_Image",t[t.Element_Image_Scale9=6]="Element_Image_Scale9",t[t.Element_Label=7]="Element_Label",t[t.Element_Button=8]="Element_Button",t[t.Element_DropButton=9]="Element_DropButton",t[t.Element_Joystick=10]="Element_Joystick",t[t.Element_TouchBar=11]="Element_TouchBar",t[t.Element_TextBox_Prompt=12]="Element_TextBox_Prompt",t[t.Element_TextBox_DOM=13]="Element_TextBox_DOM",t[t.Element_DragButton=14]="Element_DragButton",t[t.Element_Overlay=15]="Element_Overlay",t[t.Element_Toggle=16]="Element_Toggle",t[t.Element_Bar=17]="Element_Bar",t[t.Element_ScrollBar=18]="Element_ScrollBar",t[t.Element_Grow=19]="Element_Grow",t[t.Element_Panel=20]="Element_Panel",t[t.Element_Panel_Scroll=21]="Element_Panel_Scroll",t[t.Element_Panel_Split=22]="Element_Panel_Split",t[t.Element_Panel_Scroll_Unlimit=23]="Element_Panel_Scroll_Unlimit",t[t.Element_Group=24]="Element_Group"}(Wt||(Wt={}));class le{constructor(){this._thisid=0,this.Tag=null,this.localRect=new ae,this._parent=null,this.Enable=!0,this._colorFinal=b.White,this.localColor=b.White,le._id++,this._thisid=le._id}GetID(){return this._thisid}GetParent(){return this._parent}GetCanvas(){return null==this._parent?this.GetElementType()==Wt.Element_Canvas?this:null:this._parent.GetElementType()==Wt.Element_Canvas?this._parent:this._parent.GetCanvas()}IsContainer(){return!0}CancelTouch(){}OnTouch(t,e,i,s,n,o){return!1}OnWheel(t,e,i,s){return!1}OnRender(t){}OnUpdate(t,e){null==this._parent?this._colorFinal=this.localColor:this._colorFinal=b.Mul(this._parent.GetFinalColor(),this.localColor)}OnFocus(){}OnUnFocus(){}GetFinalColor(){return this._colorFinal}GetWorldRect(){if(null==this._parent){let t=this.localRect.offsetX1,e=this.localRect.offsetY1,i=this.localRect.offsetX2,s=this.localRect.offsetY2;return new C(t,e,i-t,s-e)}{let t=this._parent.GetWorldRect();return this.localRect.getFinalRect(t)}}getWorldRectScale(t){if(null==this._parent){let e=this.localRect.offsetX1*t,i=this.localRect.offsetY1*t,s=this.localRect.offsetX2*t,n=this.localRect.offsetY2*t;return new C(e,i,s-e,n-i)}{let e=this._parent.GetWorldRect();return this.localRect.getFinalRectScale(e,t)}}}le._id=0,function(t){t[t.NoChange=0]="NoChange",t[t.AddOne=1]="AddOne",t[t.Dirty=2]="Dirty"}(qt||(qt={}));class ce extends le{constructor(){super(),this.childState=qt.NoChange,this.localRect.SetAsFill()}GetChildCount(){return null==this._children?0:this._children.length}ToTop(t){this.RemoveChild(t),this.AddChild(t)}GetChild(t){return null==this._children||t>=this._children.length?null:this._children[t]}IndexOfChild(t){return null==t?-1:this._children.indexOf(t)}InsertChild(t){if(null==this._children&&(this._children=[]),this._children.indexOf(t)>=0)return;let e=t._parent;null!=e&&e.RemoveChild(e),this._children.splice(0,0,t),this.childState==qt.NoChange?this.childState=qt.AddOne:this.childState=qt.Dirty,t._parent=this}AddChild(t){if(null==this._children&&(this._children=[]),this._children.indexOf(t)>=0)return;let e=t._parent;null!=e&&e.RemoveChild(e),this._children.push(t),this.childState==qt.NoChange?this.childState=qt.AddOne:this.childState=qt.Dirty,t._parent=this}RemoveChild(t){if(null==this._children)return;let e=this._children.indexOf(t);e<0||(this._children.splice(e,1),t._parent=null,this.childState=qt.Dirty)}RemoveChildAt(t){if(null==this._children)return;let e=this._children[t];this._children.splice(t,1),e._parent=null,this.childState=qt.Dirty}RemoveChildAll(){if(null!=this._picked&&this.UnPick(),null!=this._children){for(var t=0;t<this._children.length;t++)this._children[t]._parent=null;this._children.splice(0,this._children.length),this.childState=qt.Dirty}}CancelTouch(){if(null!=this._children)for(var t=this._children.length-1;t>=0;t--){let e=this._children[t];e.Enable&&e.CancelTouch()}}OnTouch(t,e,i,s,n,o){if(null!=this._children)for(var r=this._children.length-1;r>=0;r--){let h=this._children[r];if(h.Enable&&h.OnTouch(t,e,i,s,n,o))return!0}return!1}OnWheel(t,e,i,s){if(null!=this._children)for(var n=this._children.length-1;n>=0;n--){let o=this._children[n];if(o.Enable&&o.OnWheel(t,e,i,s))return!0}return!1}OnRender(t){if(null!=this._children)for(var e=0;e<this._children.length;e++){let i=this._children[e];i.Enable&&i.OnRender(t)}}OnUpdate(t,e){if(super.OnUpdate(t,e),null!=this._children)for(var i=0;i<this._children.length;i++){let s=this._children[i];s.Enable&&s.OnUpdate(t,e)}}GetPicked(){return this._picked}Pick(t){var e,i;this._picked!=t&&(null===(e=this._picked)||void 0===e||e.OnUnFocus(),this._picked=t,null===(i=this._picked)||void 0===i||i.OnFocus(),null!=this.OnPick&&this.OnPick(this._picked))}PickAt(t){this.Pick(this._children[t])}UnPick(){var t;null===(t=this._picked)||void 0===t||t.OnUnFocus(),this._picked=null}}class me extends ce{GetElementType(){return Wt.Element_Container}}class _e{constructor(t,e,i,s=0,n=0){this.sprite=e.ConvertElemToSprite(t),this.l=i.XLeft,this.r=i.XRight,this.t=i.YTop,this.b=i.YBottom;let o=(this.sprite.uv.U2-this.sprite.uv.U1)/this.sprite.pixelwidth,r=(this.sprite.uv.V2-this.sprite.uv.V1)/this.sprite.pixelheight,h=this.sprite.uv;if(this.u0=h.U1,this.u3=h.U2,this.u1=this.u0+i.XLeft*o,this.u2=this.u3-i.XRight*o,!(this.u0<=this.u1&&this.u1<this.u2&&this.u2<=this.u3))throw new Error("U尺寸不对，无法形成九宫");if(this.v0=h.V1,this.v3=h.V2,this.v1=this.v0+i.YTop*r,this.v2=this.v3-i.YBottom*r,!(this.v0<=this.v1&&this.v1<this.v2&&this.v2<=this.v3))throw new Error("U尺寸不对，无法形成九宫");0==s&&(s=this.u3-this.u0),0==n&&(n=this.v3-this.v0),this._minwidth=s,this._minheight=n}getElementType(){return Wt.Element_Image_Scale9}getMinWidth(){return this._minwidth}getMinHeight(){return this._minheight}_Render1RectWithLimit(t,e,i,s,n,o,r,h,a=-1){let l=re._rectbuf;for(;l.length<4;)l.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let c=null==h?re._colorbuf:h,m=o.X,_=o.X+o.Width,d=o.Y,u=o.Y+o.Height,p=_-m,f=u-d;if(m>=r.X+r.Width||_<r.X||d>=r.Y+r.Height||u<r.Y)m=_=d=u=0;else if(0!=p&&0!=f){let n=m,o=_,h=d,a=u,l=!1;if(m<r.X&&(n=r.X,l=!0),_>r.X+r.Width&&(o=r.X+r.Width,l=!0),d<r.Y&&(h=r.Y,l=!0),u>r.Y+r.Height&&(a=r.Y+r.Height,l=!0),l){let r=e-t,l=s-i;t+=r*((n-m)/p),i+=l*((h-d)/f),e+=r*((o-_)/p),s+=l*((a-u)/f),m=n,d=h,_=o,u=a}}l[0].x=m,l[0].y=d,l[0].u=t,l[0].v=i,l[0].r=c.R,l[0].g=c.G,l[0].b=c.B,l[0].a=c.A,l[0].uvlayer=this.sprite.uvlayer,l[0].eff=this.sprite.effect,l[1].x=_,l[1].y=d,l[1].u=e,l[1].v=i,l[1].r=c.R,l[1].g=c.G,l[1].b=c.B,l[1].a=c.A,l[1].uvlayer=this.sprite.uvlayer,l[1].eff=this.sprite.effect,l[2].x=m,l[2].y=u,l[2].u=t,l[2].v=s,l[2].r=c.R,l[2].g=c.G,l[2].b=c.B,l[2].a=c.A,l[2].uvlayer=this.sprite.uvlayer,l[2].eff=this.sprite.effect,l[3].x=_,l[3].y=u,l[3].u=e,l[3].v=s,l[3].r=c.R,l[3].g=c.G,l[3].b=c.B,l[3].a=c.A,l[3].uvlayer=this.sprite.uvlayer,l[3].eff=this.sprite.effect,n.DrawQuads(this.sprite.material,l,1)}_Render1Rect(t,e,i,s,n,o,r,h=-1){if(t==e||i==s)return;let a=re._rectbuf;for(;a.length<4;)a.push(new Ot);null==re._colorbuf&&(re._colorbuf=b.White);let l=null==r?re._colorbuf:r;a[0].x=o.X,a[0].y=o.Y,a[0].u=t,a[0].v=i,a[0].r=l.R,a[0].g=l.G,a[0].b=l.B,a[0].a=l.A,a[0].uvlayer=this.sprite.uvlayer,a[0].eff=this.sprite.effect,a[1].x=o.X+o.Width,a[1].y=o.Y,a[1].u=e,a[1].v=i,a[1].r=l.R,a[1].g=l.G,a[1].b=l.B,a[1].a=l.A,a[1].uvlayer=this.sprite.uvlayer,a[1].eff=this.sprite.effect,a[2].x=o.X,a[2].y=o.Y+o.Height,a[2].u=t,a[2].v=s,a[2].r=l.R,a[2].g=l.G,a[2].b=l.B,a[2].a=l.A,a[2].uvlayer=this.sprite.uvlayer,a[2].eff=this.sprite.effect,a[3].x=o.X+o.Width,a[3].y=o.Y+o.Height,a[3].u=e,a[3].v=s,a[3].r=l.R,a[3].g=l.G,a[3].b=l.B,a[3].a=l.A,a[3].uvlayer=this.sprite.uvlayer,a[3].eff=this.sprite.effect,n.DrawQuads(this.sprite.material,a,1)}RenderRect(t,e,i=null,s=-1,n){let o=this.l*n,r=this.r*n,h=this.t*n,a=this.b*n,l=new C(0,0,1,1);l.Y=e.Y,l.Height=h,l.X=e.X,l.Width=o,this._Render1Rect(this.u0,this.u1,this.v0,this.v1,t,l,i,s),l.X=e.X+o,l.Width=e.Width-o-r,this._Render1Rect(this.u1,this.u2,this.v0,this.v1,t,l,i,s),l.X=e.X+e.Width-r,l.Width=r,this._Render1Rect(this.u2,this.u3,this.v0,this.v1,t,l,i,s),l.Y=e.Y+h,l.Height=e.Height-h-a,l.X=e.X,l.Width=o,this._Render1Rect(this.u0,this.u1,this.v1,this.v2,t,l,i,s),l.X=e.X+o,l.Width=e.Width-o-r,this._Render1Rect(this.u1,this.u2,this.v1,this.v2,t,l,i,s),l.X=e.X+e.Width-r,l.Width=r,this._Render1Rect(this.u2,this.u3,this.v1,this.v2,t,l,i,s),l.Y=e.Y+e.Height-a,l.Height=a,l.X=e.X,l.Width=o,this._Render1Rect(this.u0,this.u1,this.v2,this.v3,t,l,i,s),l.X=e.X+o,l.Width=e.Width-o-r,this._Render1Rect(this.u1,this.u2,this.v2,this.v3,t,l,i,s),l.X=e.X+e.Width-r,l.Width=r,this._Render1Rect(this.u2,this.u3,this.v2,this.v3,t,l,i,s)}RenderRectWithLimit(t,e,i,s=null,n=-1,o){let r=this.l*o,h=this.r*o,a=this.t*o,l=this.b*o,c=new C(0,0,1,1);c.Y=e.Y,c.Height=a,c.X=e.X,c.Width=r,this._Render1RectWithLimit(this.u0,this.u1,this.v0,this.v1,t,c,i,s,n),c.X=e.X+r,c.Width=e.Width-r-a,this._Render1RectWithLimit(this.u1,this.u2,this.v0,this.v1,t,c,i,s,n),c.X=e.X+e.Width-h,c.Width=h,this._Render1RectWithLimit(this.u2,this.u3,this.v0,this.v1,t,c,i,s,n),c.Y=e.Y+a,c.Height=e.Height-a-l,c.X=e.X,c.Width=r,this._Render1RectWithLimit(this.u0,this.u1,this.v1,this.v2,t,c,i,s,n),c.X=e.X+r,c.Width=e.Width-r-a,this._Render1RectWithLimit(this.u1,this.u2,this.v1,this.v2,t,c,i,s,n),c.X=e.X+e.Width-h,c.Width=h,this._Render1RectWithLimit(this.u2,this.u3,this.v1,this.v2,t,c,i,s,n),c.Y=e.Y+e.Height-l,c.Height=l,c.X=e.X,c.Width=r,this._Render1RectWithLimit(this.u0,this.u1,this.v2,this.v3,t,c,i,s,n),c.X=e.X+r,c.Width=e.Width-r-a,this._Render1RectWithLimit(this.u1,this.u2,this.v2,this.v3,t,c,i,s,n),c.X=e.X+e.Width-h,c.Width=h,this._Render1RectWithLimit(this.u2,this.u3,this.v2,this.v3,t,c,i,s,n)}}class de extends me{constructor(){super(),this._event=[],this.batcherUI=new Vt(t.graphic.GetWebGL())}FIllTarget(){if(null==this.target)return;this.camera.LookAt.X=this.target.getWidth()/2/this.camera.Scale,this.camera.LookAt.Y=this.target.getHeight()/2/this.camera.Scale;let t=this.target.getWidth()/this.camera.Scale,e=this.target.getHeight()/this.camera.Scale;this.localRect.setByRect(new C(0,0,t,e))}GetElementType(){return Wt.Element_Canvas}OnUpdate(t,e){if(this.Enable&&null!=this.target&&null!=this.camera&&(this.FIllTarget(),super.OnUpdate(this,e),this._event.length>0)){for(let t=0;t<this._event.length;t++)this._event[t]();this._event.splice(0)}}OnRender(t){this.Enable&&null!=this.camera&&null!=this.target&&(this.FIllTarget(),this.batcherUI.BeginDraw(this.target,this.camera),super.OnRender(this),this.batcherUI.EndDraw())}OnTouch(e,i,s,n,o,r){if(null==this.camera)return!1;let h=t.graphic.getFinalScale()/this.camera.Scale,a=o*h,l=r*h;return super.OnTouch(this,i,s,n,a,l)}OnWheel(t,e,i,s){return super.OnWheel(this,e,i,s)}InvokeEvent(t){this._event.push(t)}}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Both=2]="Both"}(Ht||(Ht={}));class ue extends me{constructor(){super(...arguments),this.fillway=Ht.Both,this.halign=Nt.Middle,this.valign=Yt.Middle,this.autosizeASPMax=1,this.autosizeASPMin=1}setAsp(t,e){this.autosizeASPMin=Math.min(t,e),this.autosizeASPMax=Math.max(t,e)}GetElementType(){return Wt.Element_ScreenFixer}OnUpdate(t,e){let i=this.GetParent().GetWorldRect(),s=i.Width/i.Height,n=!1,o=!1;if(s<this.autosizeASPMin?(s=this.autosizeASPMin,n=!0):s>this.autosizeASPMax&&(s=this.autosizeASPMax,o=!0),this.fillway==Ht.Both&&n||this.fillway==Ht.Vertical){this.localRect.setHPosFill();let t=i.Width/s;this.valign==Yt.Top?this.localRect.setVPosByTopBorder(t):this.valign==Yt.Middle?this.localRect.setVPosByCenter(t):this.localRect.setVPosByBottomBorder(t)}if(this.fillway==Ht.Both&&o||this.fillway==Ht.Horizontal){let t=i.Height*s;this.localRect.setVPosFill(),this.halign==Nt.Left?this.localRect.setHPosByLeftBorder(t):this.halign==Nt.Middle?this.localRect.setHPosByCenter(t):this.localRect.setHPosByRightBorder(t)}this.fillway!=Ht.Both||o||n||this.localRect.SetAsFill(),super.OnUpdate(t,e)}}class pe extends le{constructor(){super(),this.keepAspect=!1,this.sprite=Ie.GetWhiteSprite(),this.localRect.setByRect(new C(0,0,100,100))}SetBySprite(t){this.sprite=t}SetByTexture(t){let e=new $(K.GetShaderProgram("simple"));e.uniformTexs.tex.value=t,this.sprite=new re(e)}SetBySpriteElement(t,e){this.sprite=t.ConvertElemToSprite(e)}GetElementType(){return Wt.Element_Image}OnRender(t){if(null!=this.sprite){let o=this.GetWorldRect();if(this.keepAspect){var e=o.Height,i=o.Width,s=this.sprite.pixelheight/this.sprite.pixelwidth,n=e/i;n>s?(o.Height=i*s,o.Y+=(e-o.Height)/2):n<s&&(o.Width=e/s,o.X+=(i-o.Width)/2)}this.sprite.RenderRect(t.batcherUI,o,this._colorFinal,-1)}super.OnRender(t)}}class fe extends le{constructor(t=null){super(),this.scale9=t,null!=t?this.localRect.setByRect(new C(0,0,t.getMinWidth(),t.getMinHeight())):this.localRect.setByRect(new C(0,0,128,128))}GetElementType(){return Wt.Element_Image_Scale9}OnRender(t){null!=this.scale9&&this.scale9.RenderRect(t.batcherUI,this.GetWorldRect(),this._colorFinal,-1,1),super.OnRender(t)}}class ye extends le{constructor(){super(),this.withShadow=!0,this.colorShadow=new b(0,0,0,.5),this.fontScale=new S(1,1),this.fontBorder=1,this.cut=!1,this.halign=Nt.Middle,this.valign=Yt.Middle,this._pos=new S(0,0),this.font=K.GetDefFont();let t=16/this.font.GetFontSize();this.fontBorder=1/t,this.fontScale=new S(t,t),this.valign=Yt.Middle,this.halign=Nt.Middle,this.text="Label",this.localRect.setByRect(new C(0,0,100,16))}GetElementType(){return Wt.Element_Label}GetTextWidth(){return null==this.font?0:this.font.SureText(this.text)*this.fontScale.X}OnRender(t){if(null!=this.font){let e=this.GetWorldRect(),i=this.font.GetFontSize()*this.fontScale.Y,s=this.font.SureText(this.text)*this.fontScale.X;this.halign==Nt.Left?this._pos.X=e.X:this.halign==Nt.Middle?this._pos.X=e.X+(e.Width-s)/2:this.halign==Nt.Right&&(this._pos.X=e.X+(e.Width-s)),this.valign==Yt.Top?this._pos.Y=e.Y:this.valign==Yt.Middle?this._pos.Y=e.Y+(e.Height-i)/2:this.valign==Yt.Bottom&&(this._pos.Y=e.Y+(e.Height-i));let n=this.fontBorder*this.fontScale.Y,o=new S(this.fontScale.X,this.fontScale.Y);this.cut?(this.withShadow&&this.font.RenderTextWithLimit(t.batcherUI,this.text,new S(this._pos.X+n,this._pos.Y+n),o,this.colorShadow,e),this.font.RenderTextWithLimit(t.batcherUI,this.text,this._pos,o,this._colorFinal,e)):(this.withShadow&&this.font.RenderText(t.batcherUI,this.text,new S(this._pos.X+n,this._pos.Y+n),o,this.colorShadow),this.font.RenderText(t.batcherUI,this.text,this._pos,o,this._colorFinal))}super.OnRender(t)}}class ve extends le{constructor(){super(),this.elemNormal=null,this.BindKey=null,this._press=!1,this._keypress=!1,this._pressid=-1,this.OnClick=null,this.OnPressDown=null,this.OnPressUp=null,this.localRect.setByRect(new C(0,0,100,32));let t=new me;{t._parent=this,t.localRect.SetAsFill();let e=new fe(Ie.GetBorderScaleR());t.AddChild(e),e.localColor=new b(1,1,1,1),e.localRect.SetAsFill();let i=new ye;i.localRect.SetAsFill(),i.text="Button",t.AddChild(i)}this.elemNormal=t,this.colorNormal=b.White,this.colorPress=new b(.9,.9,.3,1)}SetText(t){if(null==this.elemNormal||this.elemNormal.GetChildCount()<2)return;let e=this.elemNormal.GetChild(1);null!=e&&e.GetElementType()==Wt.Element_Label&&(e.text=t)}GetElementType(){return Wt.Element_Button}UsePress(t){-1==this._pressid&&(this._pressid=t,this._press=!0)}CancelTouch(){this._press=!1,this._pressid=-1}OnTouch(t,e,i,s,n,o){if(super.OnTouch(t,e,i,s,n,o))return!0;let r=this.GetWorldRect(),h=r.X+r.Width,a=r.Y+r.Height;return 0==this._press&&1==i&&0==s&&n>=r.X&&n<h&&o>=r.Y&&o<a?(this._press=!0,this._pressid=e,console.log("btn down."+e),null!=this.OnPressDown&&t.InvokeEvent((()=>{this.OnPressDown(e)})),!0):1==this._press&&1==i&&this._pressid==e||1==this._press&&0==i&&this._pressid==e&&(this._press=!1,this._pressid=-1,console.log("btn up."+e),null!=this.OnPressUp&&t.InvokeEvent((()=>{this.OnPressUp()})),n>=r.X&&n<h&&o>=r.Y&&o<a)&&(console.log("btn click."),null!=this.OnClick&&t.InvokeEvent((()=>{this.OnClick()})),!0)}OnRender(t){null!=this.elemNormal&&(this.elemNormal._parent=this,this.elemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(e,i){if(super.OnUpdate(e,i),null!=this.BindKey){let e=t.input.IsKeyDown(this.BindKey);this._keypress&&!e?(this._keypress=!1,this._press=!1,null!=this.OnPressDown&&this.OnPressUp()):0==this._keypress&&e&&(this._keypress=!0,this._press=!0,null!=this.OnPressDown&&this.OnPressDown(0))}this._press?null!=this.elemNormal&&(this.elemNormal.localColor=this.colorPress,this.elemNormal.OnUpdate(e,i)):null!=this.elemNormal&&(this.elemNormal.localColor=this.colorNormal,this.elemNormal.OnUpdate(e,i))}}class xe extends le{constructor(){super(),this.ElemNormal=null,this.press=!1,this.pressid=-1,this.OnDragStart=null,this.OnDrag=null,this.OnDragEnd=null,this.localRect.setByRect(new C(0,0,100,100)),this.colorNormal=b.White,this.colorPress=new b(.9,.9,.3,1);let t=new me;{t.localRect.SetAsFill();let e=Ie.CreateGUI_Border();t.AddChild(e),e.localColor=new b(1,1,1,1),e.localRect.SetAsFill();let i=new ye;i.localRect.SetAsFill(),i.text="DragBtn",t.AddChild(i)}this.ElemNormal=t}SetText(t){if(null==this.ElemNormal||this.ElemNormal.GetChildCount()<2)return;let e=this.ElemNormal.GetChild(1);null!=e&&e.GetElementType()==Wt.Element_Label&&(e.text=t)}GetElementType(){return Wt.Element_DragButton}OnTouch(t,e,i,s,n,o){if(super.OnTouch(t,e,i,s,n,o))return!0;let r=this.GetWorldRect(),h=r.X,a=r.Y,l=r.X+r.Width,c=r.Y+r.Height;return 0==this.press&&1==i&&0==s&&n>=h&&n<l&&o>=a&&o<c?(this.press=!0,this.pressid=e,this.dragX=n,this.dragY=o,this.dragOX=this.localRect.offsetX1,this.dragOY=this.localRect.offsetY1,null!=this.OnDragStart&&t.InvokeEvent((()=>{this.OnDragStart(n,o)})),!0):1==this.press&&1==i&&this.pressid==e?(null!=this.OnDrag&&t.InvokeEvent((()=>{this.OnDrag(n,o,this.dragX,this.dragY)})),!0):1==this.press&&0==i&&this.pressid==e&&(this.press=!1,this.pressid=-1,null!=this.OnDragEnd&&t.InvokeEvent((()=>{this.OnDragEnd(n,o)})),!0)}OnRender(t){null!=this.ElemNormal&&(this.ElemNormal._parent=this,this.ElemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(t,e){this.press?null!=this.ElemNormal&&(this.ElemNormal.localColor=this.colorPress,this.ElemNormal.OnUpdate(t,e)):null!=this.ElemNormal&&(this.ElemNormal.localColor=this.colorNormal,this.ElemNormal.OnUpdate(t,e))}}class we extends le{constructor(){super(),this.ids=[],this.localRect.SetAsFill()}GetElementType(){return Wt.Element_Overlay}OnTouch(t,e,i,s,n,o){if(super.OnTouch(t,e,i,s,n,o))return!0;let r=this.GetWorldRect(),h=r.X+r.Width,a=r.Y+r.Height;if(1==i&&0==s&&n>=r.X&&n<h&&o>=r.Y&&o<a)return this.ids.indexOf(e)<0&&this.ids.push(e),null!=this.OnPress&&t.InvokeEvent((()=>{this.OnPress()})),!0;if(1==i&&1==s&&this.ids.indexOf(e)>=0)return!0;if(0==i&&this.ids.indexOf(e)>=0){let t=this.ids.indexOf(e);return this.ids.splice(t,1),!0}return!1}}!function(t){t[t.DoNotScroll=0]="DoNotScroll",t[t.ScrollByTouchDrag=1]="ScrollByTouchDrag",t[t.ScrollByTouchDrag_LoopValue=2]="ScrollByTouchDrag_LoopValue"}(jt||(jt={}));class Ae extends me{constructor(){super(),this.direction=zt.Vertical,this.width=0,this.height=0,this.localRect.SetAsFill()}GetContextWidth(){return this.width}GetContextHeight(){return this.height}GetElementType(){return Wt.Element_Container}OnUpdate(t,e){super.OnUpdate(t,e),this.childState==qt.AddOne?(this.Grow(this._children[this._children.length-1]),this.childState=qt.NoChange):this.childState==qt.Dirty&&(this.UpdateAll(),this.childState=qt.NoChange)}Grow(t){this.direction==zt.Horizontal?(t.localRect.setPos(this.width,0),this.height=Math.max(t.localRect.getHeight(),this.height),this.width+=t.localRect.getWidth()):(t.localRect.setPos(0,this.height),this.width=Math.max(t.localRect.getWidth(),this.width),this.height+=t.localRect.getHeight())}UpdateAll(){this.width=0,this.height=0;for(var t=0;t<this._children.length;t++)this.Grow(this._children[t])}}class ge extends le{constructor(){super(),this.localRect.SetAsFill(),this.container=new me,this.container._parent=this,this.container.localRect.SetAsFill(),this._border=new I(2,2,2,2),this.backElements=[],this.foreElements=[],this.foreElements.push(Ie.CreateGUI_Border())}GetElementType(){return Wt.Element_Panel}getBorder(){return this._border}OnRenderBack(t){if(null!=this.backElements)for(var e=0;e<this.backElements.length;e++)this.backElements[e].Enable&&this.backElements[e].OnRender(t)}OnRenderFore(t){if(null!=this.foreElements)for(var e=0;e<this.foreElements.length;e++)this.foreElements[e].Enable&&this.foreElements[e].OnRender(t)}OnUpdateBack(t,e){if(null!=this.backElements)for(var i=0;i<this.backElements.length;i++){let s=this.backElements[i];s.Enable&&(s._parent=this,s.OnUpdate(t,e))}}OnUpdateFore(t,e){if(null!=this.foreElements)for(var i=0;i<this.foreElements.length;i++){let s=this.foreElements[i];s.Enable&&(s._parent=this,s.OnUpdate(t,e))}}CancelTouchFore(){if(null!=this.foreElements)for(var t=this.foreElements.length-1;t>=0;t--){let e=this.foreElements[t];e.Enable&&e.CancelTouch()}}CancelTouchBack(){if(null!=this.backElements)for(var t=this.backElements.length-1;t>=0;t--){let e=this.backElements[t];e.Enable&&e.CancelTouch()}}OnTouchFore(t,e,i,s,n,o){if(null!=this.foreElements)for(var r=this.foreElements.length-1;r>=0;r--){let h=this.foreElements[r];if(h.Enable&&h.OnTouch(t,e,i,s,n,o))return!0}return!1}OnTouchBack(t,e,i,s,n,o){if(null!=this.backElements)for(var r=this.backElements.length-1;r>=0;r--){let h=this.backElements[r];if(h.Enable&&h.OnTouch(t,e,i,s,n,o))return!0}return!1}OnWheelFore(t,e,i,s){if(null!=this.foreElements)for(var n=this.foreElements.length-1;n>=0;n--){let o=this.foreElements[n];if(o.Enable&&o.OnWheel(t,e,i,s))return!0}return!1}OnWheelBack(t,e,i,s){if(null!=this.backElements)for(var n=this.backElements.length-1;n>=0;n--){let o=this.backElements[n];if(o.Enable&&o.OnWheel(t,e,i,s))return!0}return!1}OnRender(t){this.OnRenderBack(t);let e=t.batcherUI,i=t.camera.Scale,s=this.getWorldRectScale(i);s.X+=this._border.XLeft*i,s.Y+=this._border.YTop*i,s.Width-=(this._border.XLeft+this._border.XRight)*i,s.Height-=(this._border.YTop+this._border.YBottom)*i;let n=e.getTarget(),o=e.camera;e.EndDraw(),n.PushLimitRect(s),e.BeginDraw(n,o),this.container.OnRender(t),e.EndDraw(),n.PopLimitRect(),e.BeginDraw(n,o),this.OnRenderFore(t)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=1,this.container.localRect.radioY2=1,this.container.localRect.offsetX1=this._border.XLeft,this.container.localRect.offsetX2=-this._border.XRight,this.container.localRect.offsetY1=this._border.YTop,this.container.localRect.offsetY2=-this._border.YBottom}OnUpdate(t,e){super.OnUpdate(t,e),this.OnUpdateBack(t,e),this.updateContainerPos(),this.container.OnUpdate(t,e),this.OnUpdateFore(t,e)}CancelTouch(){this.CancelTouchFore(),super.CancelTouch(),this.CancelTouchBack()}OnWheel(t,e,i,s){let n=this.OnWheelFore(t,e,i,s);return n||(n=this.container.OnWheel(t,e,i,s),n||(n=this.OnWheelBack(t,e,i,s),n))}OnTouch(t,e,i,s,n,o){let r=this.OnTouchFore(t,e,i,s,n,o);if(r)return r;if(1==i&&0==s){let t=this.GetWorldRect(),e=t.X+this._border.XLeft,i=t.Y+this._border.YTop,s=t.X+t.Width-this._border.XRight,r=t.Y+t.Height-this._border.YBottom;if(!(n>=e&&n<=s&&o>=i&&o<=r))return!1}return r=this.container.OnTouch(t,e,i,s,n,o),r||(r=this.OnTouchBack(t,e,i,s,n,o),r)}}class be extends ge{constructor(){super(),this.dragDist=32,this.dragDirection=Ut.UpToDown,this._press=!1,this._pressid=0,this._drag=!1,this._dragy=0,this._dragx=0,this.dragout=!0,this.panelOffsetX=this.panelOffsetWantX=0,this.panelOffsetY=this.panelOffsetWantY=0,this.panelWidth=250,this.panelHeight=250,this.container=new Ae,this.container._parent=this,this.container.localRect.SetAsFill()}GetElementType(){return Wt.Element_Panel_Scroll}Scroll(t,e){this.panelOffsetWantX+=t,this.panelOffsetWantY+=e;let i=this.GetWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,n=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-n)&&(this.panelOffsetWantY=-(this.panelHeight-n)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=0,this.container.localRect.radioY2=0,this.container.localRect.offsetX1=this.panelOffsetX,this.container.localRect.offsetY1=this.panelOffsetY,this.container.localRect.offsetX2=this.panelOffsetX+this.panelWidth,this.container.localRect.offsetY2=this.panelOffsetY+this.panelHeight}CancelTouch(){this._press=!1,this._pressid=-1}OnWheel(t,e,i,s){return!!super.OnWheel(t,e,i,s)||(console.log("wheel:"+e+","+i+","+s),this.dragDirection!=Ut.None&&(this.dragDirection==Ut.LeftToRight?(i=0,s=0):this.dragDirection==Ut.UpToDown&&(e=0,s=0),this.Scroll(e,i),!0))}OnTouch(e,i,s,n,o,r){if(this.dragDirection==Ut.None)return super.OnTouch(e,i,s,n,o,r);if(0==this._press&&1==s&&0==n){let t=this.GetWorldRect(),e=t.X+this._border.XLeft,s=t.Y+this._border.YTop,n=t.X+t.Width-this._border.XRight,h=t.Y+t.Height-this._border.YBottom;o>=e&&o<=n&&r>=s&&r<=h&&(this._press=!0,this._pressid=i,this._pressx=o,this._pressy=r)}return this._pressid==i&&1==this._press&&1==s&&1==n&&(this._drag?this._dragPanel(o,r):this._calcDragDist(o,r)>this.dragDist*t.graphic.getDevicePixelRadio()&&(this._drag=!0,this._dragx=this.panelOffsetX,this._dragy=this.panelOffsetY,this._pressy=r,this._pressx=o)),this._pressid==i&&1==this._press&&0==s&&(this._press=!1,this._pressid=0,this._drag=!1),!!this._drag||super.OnTouch(e,i,s,n,o,r)}_calcDragDist(t,e){if(this.dragDirection==Ut.None)return 0;if(this.dragDirection==Ut.LeftToRight)return Math.abs(t-this._pressx);if(this.dragDirection==Ut.UpToDown)return Math.abs(e-this._pressy);let i=t-this._pressx,s=e-this._pressy;return Math.sqrt(i*i+s*s)}_dragPanel(t,e){if(this.dragDirection==Ut.None)return;this.dragDirection!=Ut.UpToDown&&this.dragDirection!=Ut.Both||(this.panelOffsetY=this._dragy+(e-this._pressy)),this.dragDirection!=Ut.LeftToRight&&this.dragDirection!=Ut.Both||(this.panelOffsetX=this._dragx+(t-this._pressx));let i=this.GetWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,n=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX=this.panelOffsetX,this.panelOffsetWantY=this.panelOffsetY,this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-n)&&(this.panelOffsetWantY=-(this.panelHeight-n)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0),0==this.dragout&&(this.panelOffsetX=this.panelOffsetWantX,this.panelOffsetY=this.panelOffsetWantY)}OnUpdate(t,e){0==this._drag&&(this.panelOffsetX=this.panelOffsetX+.5*(this.panelOffsetWantX-this.panelOffsetX),this.panelOffsetY=this.panelOffsetY+.5*(this.panelOffsetWantY-this.panelOffsetY)),super.OnUpdate(t,e),this.panelWidth=this.container.GetContextWidth(),this.panelHeight=this.container.GetContextHeight()}}class Se extends le{constructor(){super(),this.splitSize=16,this.splitPos=.5,this.splitDir=zt.Horizontal,this.splitDir=zt.Horizontal,this.localRect.SetAsFill(),this._panel1=new ge,this._panel1._parent=this,this._panel1.localRect.SetAsFill(),this._panel1.foreElements=[],this._panel1.foreElements.push(Ie.CreateGUI_Border()),this._panel2=new ge,this._panel2._parent=this,this._panel2.localRect.SetAsFill(),this._panel2.foreElements=[],this._panel2.foreElements.push(Ie.CreateGUI_Border()),this._border=new I(1,1,1,1),this._splitButton=new xe,this._splitButton._parent=this,this._splitButton.localRect.SetAsFill(),this._splitButton.OnDragStart=this._ondragstart.bind(this),this._splitButton.OnDrag=this._ondrag.bind(this),this.splitSize=8,this.updateContainerPos(),this.updateSplitBtnPos()}_ondragstart(t,e){this._dragvalue=this.splitPos}_ondrag(t,e,i,s){if(this.splitDir==zt.Horizontal){let e=(t-i)/this.GetWorldRect().Width;this.splitPos=this._dragvalue+e}else{let t=(e-s)/this.GetWorldRect().Height;this.splitPos=this._dragvalue+t}this.splitPos<.1&&(this.splitPos=.1),this.splitPos>.9&&(this.splitPos=.9),this.updateSplitBtnPos()}GetElementType(){return Wt.Element_Panel_Split}getBorder(){return this._border}getSplitButton(){return this._splitButton}OnRender(t){null!=this.backElement&&this.backElement.OnRender(t);let e=t.batcherUI,i=e.getTarget();e.EndDraw(),i.PushLimitRect(this._panel1.getWorldRectScale(t.camera.Scale)),e.ResumeDraw(),this._panel1.OnRender(t),e.EndDraw(),i.PopLimitRect(),i.PushLimitRect(this._panel2.getWorldRectScale(t.camera.Scale)),e.ResumeDraw(),this._panel2.OnRender(t),e.EndDraw(),i.PopLimitRect(),e.ResumeDraw(),this._splitButton.OnRender(t),null!=this.borderElement&&this.borderElement.OnRender(t)}updateSplitBtnPos(){this.splitDir==zt.Horizontal?(this._splitButton.localRect.radioX1=this.splitPos,this._splitButton.localRect.radioX2=this.splitPos,this._splitButton.localRect.radioY1=0,this._splitButton.localRect.radioY2=1,this._splitButton.localRect.offsetX1=.5*-this.splitSize,this._splitButton.localRect.offsetX2=.5*this.splitSize,this._splitButton.localRect.offsetY1=this._border.YTop,this._splitButton.localRect.offsetY2=-this._border.YBottom):(this._splitButton.localRect.radioY1=this.splitPos,this._splitButton.localRect.radioY2=this.splitPos,this._splitButton.localRect.radioX1=0,this._splitButton.localRect.radioX2=1,this._splitButton.localRect.offsetX1=this._border.XLeft,this._splitButton.localRect.offsetX2=this._border.XRight,this._splitButton.localRect.offsetY1=.5*-this.splitSize,this._splitButton.localRect.offsetY2=.5*this.splitSize)}updateContainerPos(){this.splitDir==zt.Horizontal?(this._panel1.localRect.radioX1=0,this._panel1.localRect.radioY1=0,this._panel1.localRect.radioX2=this.splitPos,this._panel1.localRect.radioY2=1,this._panel1.localRect.offsetX1=this._border.XLeft,this._panel1.localRect.offsetX2=-.5*this.splitSize,this._panel1.localRect.offsetY1=this._border.YTop,this._panel1.localRect.offsetY2=-this._border.YBottom,this._panel2.localRect.radioX1=this.splitPos,this._panel2.localRect.radioY1=0,this._panel2.localRect.radioX2=1,this._panel2.localRect.radioY2=1,this._panel2.localRect.offsetX1=.5*this.splitSize,this._panel2.localRect.offsetX2=-this._border.XRight,this._panel2.localRect.offsetY1=this._border.YTop,this._panel2.localRect.offsetY2=-this._border.YBottom):(this._panel1.localRect.radioX1=0,this._panel1.localRect.radioY1=0,this._panel1.localRect.radioX2=1,this._panel1.localRect.radioY2=this.splitPos,this._panel1.localRect.offsetX1=this._border.XLeft,this._panel1.localRect.offsetX2=-this._border.XRight,this._panel1.localRect.offsetY1=this._border.YTop,this._panel1.localRect.offsetY2=-.5*this.splitSize,this._panel2.localRect.radioX1=0,this._panel2.localRect.radioY1=this.splitPos,this._panel2.localRect.radioX2=1,this._panel2.localRect.radioY2=1,this._panel2.localRect.offsetX1=this._border.XLeft,this._panel2.localRect.offsetX2=this._border.XRight,this._panel2.localRect.offsetY1=.5*this.splitSize,this._panel2.localRect.offsetY2=-this._border.YBottom)}OnUpdate(t,e){null!=this.backElement&&(this.backElement._parent=this,this.backElement.localRect.SetAsFill(),this.backElement.OnUpdate(t,e)),this.updateContainerPos(),this.updateSplitBtnPos(),this._panel1.OnUpdate(t,e),this._panel2.OnUpdate(t,e),this._splitButton.OnUpdate(t,e),null!=this.borderElement&&(this.borderElement._parent=this,this.borderElement.localRect.SetAsFill(),this.borderElement.OnUpdate(t,e)),super.OnUpdate(t,e)}OnTouch(t,e,i,s,n,o){let r=!1,h=!1;if(1==i&&0==s){{let t=this._panel1.GetWorldRect(),e=t.X,i=t.Y,s=t.X+t.Width,h=t.Y+t.Height;n>=e&&n<=s&&o>=i&&o<=h||(r=!0)}{let t=this._panel2.GetWorldRect(),e=t.X,i=t.Y,s=t.X+t.Width,r=t.Y+t.Height;n>=e&&n<=s&&o>=i&&o<=r||(h=!0)}}return!!this._splitButton.OnTouch(t,e,i,s,n,o)||!(r||!this._panel1.OnTouch(t,e,i,s,n,o))||!h&&this._panel2.OnTouch(t,e,i,s,n,o)}GetPanel1(){return this._panel1}GetPanel2(){return this._panel2}}class Be extends ge{constructor(){super(),this._border.XLeft=2,this._border.XRight=2,this._border.YTop=17,this._border.YBottom=2,this.foreElements[0].localRect.offsetY1=15;let t=this.titleback=new ge;t.getBorder().XLeft=2,t.getBorder().XRight=2,t.getBorder().YBottom=2,t.getBorder().YTop=2,t.localRect.setHPosFill(),t.localRect.setVPosByTopBorder(16),this.foreElements.push(t);{let e=this.title=new ye;e.text="Group",e.localRect.SetAsFill(),e.halign=Nt.Left,e.fontScale.X*=.5,e.fontScale.Y*=.5,t.container.AddChild(e)}let e=new we;this.backElements.push(e);let i=new pe;i.localColor=b.Black,i.localRect.SetAsFill(),this.backElements.push(i)}GetElementType(){return Wt.Element_Group}}class Ce extends Be{constructor(){super(),this._posbeginx=0,this._posbeginy=0,this._sizebeginw=0,this._sizebeginh=0;{this.titleback.container.RemoveChildAll();let t=new xe;t.localRect.SetAsFill(),this.titleback.container.AddChild(t);{let e=new pe;e.localColor=new b(.5,.5,.5,1),e.localRect.SetAsFill(),t.ElemNormal.AddChild(e)}t.ElemNormal.AddChild(this.title),t.OnDragStart=this.OnBeginDrag.bind(this),t.OnDrag=this.OnDrag.bind(this)}{let t=this._resizer=new xe,e=new pe;e.localRect.SetAsFill(),e.SetBySprite(Ie.GetSprite("corner")),t.ElemNormal.RemoveChildAll(),t.ElemNormal.AddChild(e),t.localRect.setHPosByRightBorder(16,2),t.localRect.setVPosByBottomBorder(16,2),this.foreElements.push(t),t.OnDragStart=this.OnBeginResizeDrag.bind(this),t.OnDrag=this.OnResizeDrag.bind(this)}this.resizeEnable=!1,this.dragEnable=!1,this.autoTop=!0}OnBeginDrag(t,e){this._posbeginx=this.localRect.offsetX1,this._posbeginy=this.localRect.offsetY1,console.log("begin "+t+","+e),this.dragEnable&&this.autoTop&&this._parent.ToTop(this)}OnTouch(t,e,i,s,n,o){let r=this.OnTouchFore(t,e,i,s,n,o);if(!r&&1==i&&0==s){let t=this.GetWorldRect(),e=t.X+this._border.XLeft,i=t.Y+this._border.YTop,s=t.X+t.Width-this._border.XRight,r=t.Y+t.Height-this._border.YBottom;if(!(n>=e&&n<=s&&o>=i&&o<=r))return!1}return r||(r=this.container.OnTouch(t,e,i,s,n,o)),r||(r=this.OnTouchBack(t,e,i,s,n,o)),r&&this.autoTop&&this._parent.ToTop(this),r}OnDrag(t,e,i,s){if(console.log("drag "+t+","+e+","+i+","+s),this.dragEnable){let n=this.localRect.getWidth(),o=this.localRect.getHeight(),r=this._parent.GetWorldRect().Width,h=this._parent.GetWorldRect().Height,a=this._posbeginx+t-i,l=this._posbeginy+e-s;a>r-n&&(a=r-n),a<0&&(a=0),l>h-o&&(l=h-o),l<0&&(l=0),this.localRect.setPos(a,l),this.autoTop&&this._parent.ToTop(this)}}OnBeginResizeDrag(t,e){this._sizebeginw=this.localRect.getWidth(),this._sizebeginh=this.localRect.getHeight()}OnResizeDrag(t,e,i,s){if(this.resizeEnable){let n=this._sizebeginw+(t-i),o=this._sizebeginh+(e-s);this.localRect.offsetX2=this.localRect.offsetX1+n,this.localRect.offsetY2=this.localRect.offsetY1+o}}GetElementType(){return Wt.Element_Group}OnUpdate(t,e){super.OnUpdate(t,e),this._resizer.Enable=this.resizeEnable}}class Re{constructor(){this.items=[]}FillTo(t,e,i=!1){if(null==this.items)return;let s=0;for(var n=0;n<this.items.length;n++)s=Math.max(s,this.AddMenuItem(t,e,this.items[n]));if(i)for(n=0;n<this.items.length;n++)e.GetChild(n).localRect.offsetX2=s}AddMenuItem(t,e,i){let s=new me,n=0;if(null!=i.sprite){n=18;let t=new pe;t.SetBySprite(i.sprite),t.localRect.setByPosAndSize(1,1,16,16),s.AddChild(t)}let o=new ye;o.text=i.label;let r=o.GetTextWidth();o.localRect.setByPosAndSize(n,0,r+4,18),n+=r+4,o.halign=Nt.Left,s.AddChild(o),s.localRect.setBySize(n,18);let h=new we;return s.AddChild(h),h.OnPress=()=>{if(null!=i.submenu){let e=h.GetWorldRect();i.submenu.Show(t,e.X+e.Width/2,e.Y+e.Height/2)}else Re.CloseMenu(t),null!=i.onaction&&i.onaction(i)},e.AddChild(s),n}static CloseMenu(t){if(null==this._menuStack[t.GetID()])return;let e=this._menuStack[t.GetID()];for(var i=0;i<e.container.length;i++)e.canvas.RemoveChild(e.container[i]);e.canvas.RemoveChild(e.back),delete this._menuStack[t.GetID()]}static ShowMenuContainer(t,e){let i=!1;if(null==this._menuStack[t.GetID()]?(this._menuStack[t.GetID()]={canvas:t,container:[e],back:null},i=!0):this._menuStack[t.GetID()].container.push(e),i){let e=new me;t.AddChild(e);let i=new we;i.OnPress=()=>{Re.CloseMenu(t)},e.AddChild(i),this._menuStack[t.GetID()].back=e}}Show(t,e,i){let s=t.GetWorldRect(),n=new me;Re.ShowMenuContainer(t,n),t.AddChild(n);let o=new ge;n.AddChild(o);let r=new pe;o.backElements.splice(0,0,r),r.localColor=new b(0,0,0,.5),r.localRect.SetAsFill();let h=new Ae;this.FillTo(t,h,!0),h.OnUpdate(t,0);let a=h.GetContextWidth(),l=h.GetContextHeight();e>s.Width-a-2&&(e=s.Width-a-2),i>s.Height-l-2&&(i=s.Height-l-2),e<1&&(e=1),i<1&&(i=1),n.localRect.setByPosAndSize(e-1,i-1,a+2,l+2),n.AddChild(h),h.localRect.setByPosAndSize(1,1,a,l),n.OnUpdate(t,0)}}Re._menuStack={};class Ie{static GetWhiteSprite(){if(null==this._spriteWhite){let t=K.GetWhiteBlock();this._spriteWhite=K.GetPackElement().ConvertElemToSprite(t)}return this._spriteWhite}static GetSprite(t){if(null!=this._spriteBuName[t])return this._spriteBuName[t];let e=K.GetBlock(t),i=K.GetPackElement().ConvertElemToSprite(e);return this._spriteBuName[t]=i,i}static GetBorderScale(){return null==this.scale_border&&(this.scale_border=new _e(K.GetBlock("border"),K.GetPackElement(),new I(3,3,3,3))),this.scale_border}static GetBorder2Scale(){return null==this.scale_border2&&(this.scale_border2=new _e(K.GetBlock("border2"),K.GetPackElement(),new I(3,3,3,3))),this.scale_border2}static GetBorderScaleR(){return null==this.scale_borderr&&(this.scale_borderr=new _e(K.GetBlock("borderr"),K.GetPackElement(),new I(3,3,3,3))),this.scale_borderr}static CreateGUI_WhiteSprite(){let t=new pe;return t.localRect.SetAsFill(),t}static CreateGUI_Border(){let t=new fe(this.GetBorderScale());return t.localRect.SetAsFill(),t}static CreateGUI_Border2(){let t=new fe(this.GetBorder2Scale());return t.localRect.SetAsFill(),t}}Ie._spriteWhite=null,Ie._spriteBuName={},Ie.scale_border=null,Ie.scale_border2=null,Ie.scale_borderr=null;var Ge=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class Me{static Load(t,e){return Ge(this,void 0,void 0,(function*(){let i=Ft.GetPathName(t),s=Ft.GetFileName(t),n=this.packages[s];if(null!=n)return n;let o=JSON.parse(yield e.LoadStringAsync(t));return n=yield this.LoadFromJson(o,s,i,e),this.packages[s]=n,n}))}static LoadFromJson(t,e,i,s){return Ge(this,void 0,void 0,(function*(){let n=new Fe(e);if(null!=t.refs){n.refs=[];for(var o=0;o<t.refs.length;o++){let e=t.refs[o];if(null!=this.packages[e])continue;let r=yield this.Load(i+"/"+e,s);n.refs.push(r)}}if(null!=t.pics)for(var r in n.pics={},t.pics){let e=t.pics[r],o=Te.FromText(e);if(null!=o.srcfile){let t=yield this.LoadPic(i+"/"+o.srcfile,s);o.data=t.data,o.width=t.width,o.height=t.height}n.pics[r]=o}if(null!=t.anis)for(var r in n.anis={},t.anis){let e=new De(t.anis[r]);n.anis[r]=e}return n}))}static LoadPic(e,i){return Ge(this,void 0,void 0,(function*(){let s=yield i.LoadBinaryAsync(e),n=new Blob([s]),o=yield t.loaderex.LoadImageDataAsync(URL.createObjectURL(n)),r=new q;return r.data=o.data,r.width=o.width,r.height=o.height,r.format=d.RGBA32,r}))}}Me.packages={};class Te{IsInnerHex(){if(0==this.srcfile.indexOf("hex:")||0==this.srcfile.indexOf("HEX:"))return!0}FillHexSrcName(t){this.srcfile="hex:";for(var e=0;e<t.length;e++){let i=t[e].toString(16);1==i.length?this.srcfile+="0"+i:this.srcfile+=i}}static FromText(t){let e=t,i=0,s=0;if(t.includes(";")){let o=t.split(";");e=o[0];for(var n=1;n<o.length;n++){let t=o[n].split("=");if("pivot"==t[0]){let e=t[1].split(",");i=parseInt(e[0]),s=parseInt(e[1])}}}let o=new Te;if(0==e.indexOf("hex:")||0==e.indexOf("HEX:")){let t=parseInt(e.substring(4,6),16),i=parseInt(e.substring(6,8),16);o.data=new Uint8Array(t*i*4);for(let t=8;t<=e.length-2;t+=2)o.data[t/2-4]=parseInt(e.substring(t,t+2),16);let s=new Lt;s.update(o.data),o.srcfile=s.hex()}else o.srcfile=e,o.data=null;return o.pivotX=i,o.pivotY=s,o}}class De{constructor(t){this.frame=[],this.fps=t.fps,this.loop=t.loop,null==this.fps&&(this.fps=30);let e={};for(let i=0;i<t.frames.length;i++)e[t.frames[i].frameid]=i;if(null==e[0])throw"你至少得指定第一帧吧";let i=-1,s=t.framecount;if(null==s)throw"no ani.framecount value.";for(let n=0;n<s;n++){let s=t.frames[e[n]],o=new Le;if(null==s)o.refframe=i;else{o.refframe=-1,i=n,o.pics=[];for(let t=0;t<s.pics.length;t++){let e=new Pe,i=s.pics[t].split(";");e.name=i[0];for(let t=1;t<i.length;t++){let s=i[t].split("="),n=s[0],o=s[1];if("pos"==n){let t=o.split(",");e.x=parseInt(t[0]),e.y=parseInt(t[1])}else if("scale"==n){let t=o.split(",");e.scaleX=parseInt(t[0]),e.scaleY=parseInt(t[1])}else"rot"==n&&(e.rotate=parseInt(o))}o.pics.push(e)}o.rects=[]}this.frame.push(o)}}}class Le{constructor(){this.refframe=-1,this.pics=null,this.rects=null}}class Pe{constructor(){this.name="",this.cacheobj=null,this.x=0,this.y=0,this.scaleX=1,this.scaleY=1,this.rotate=0}}class Fe{get Name(){return this._name}constructor(t){this._name=t}GetPicKey(t=null,e=null){if(null==e&&(e=[]),null==t&&(t=[]),t.push(this),null!=this.pics)for(var i in this.pics)e.indexOf(i)<0&&e.push(i);if(null!=this.refs)for(var s=0;s<this.refs.length;s++)t.includes(this.refs[s])||this.refs[s].GetPicKey(t,e);return e}GetAniKey(t=null,e=null){if(null==e&&(e=[]),null==t&&(t=[]),t.push(this),null!=this.anis)for(var i in this.anis)e.indexOf(i)<0&&e.push(i);if(null!=this.refs)for(var s=0;s<this.refs.length;s++)t.includes(this.refs[s])||this.refs[s].GetAniKey(t,e);return e}GetPic(t,e=null){if(null!=this.pics&&null!=this.pics[t])return this.pics[t];null==e&&(e=[]),e.push(this);for(var i=0;i<this.refs.length;i++){if(e.includes(this.refs[i]))continue;let s=this.refs[i].GetPic(t);if(null!=s)return s}return null}GetAni(t,e=null){if(null!=this.anis&&null!=this.anis[t])return this.anis[t];null==e&&(e=[]),e.push(this);for(var i=0;i<this.refs.length;i++){if(e.includes(this.refs[i]))continue;let s=this.refs[i].GetAni(t);if(null!=s)return s}return null}}class Ee{constructor(t,e){this.pos=new S(0,0),this.scale=new S(1,1),this.ani=t,this.adapter=e;for(var i=0;i<this.ani.frame.length;i++){let t=this.ani.frame[i];if(null!=t.pics)for(var s=0;s<t.pics.length;s++){let i=e.LoadPic(t.pics[s].name);t.pics[s].cacheobj=i}}this.curframe=0}Update(t){for(this.curframe+=t*this.ani.fps;this.curframe>=this.ani.frame.length;)this.ani.loop?this.curframe-=this.ani.frame.length:this.curframe=this.ani.frame.length-1;let e=0|this.curframe,i=this.ani.frame[e];i.refframe>=0&&(i=this.ani.frame[i.refframe]),this.drawframe=i}Render(){for(var t=0;t<this.drawframe.pics.length;t++){let e=this.drawframe.pics[t];this.adapter.Render(e,this.pos,this.scale)}}}function Oe(t,e){if(!t)throw new Error(e)}function Ve(t){if(null===t)throw new Error;return t}const ke=1e37,Ue=1e-5,Xe=Ue*Ue,ze=.005,Ne=2/180*Math.PI,Ye=.01,We=8/180*Math.PI,qe=.5*Math.PI,He=qe*qe,je=2/180*Math.PI;function Je(t,e=0){const i=new Array(t);for(let s=0;s<t;s++)i[s]=e;return i}function Ze(t,e){const i=new Array(t);for(let s=0;s<t;s++)i[s]=new e;return i}Math.PI,Math.PI;const Ke=2*Math.PI;function Qe(t,e,i){return t<e?e:t>i?i:t}class $e{constructor(t=0,e=0){this.x=t,this.y=e}Clone(){return new $e(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}Add(t){return this.x+=t.x,this.y+=t.y,this}AddXY(t,e){return this.x+=t,this.y+=e,this}Subtract(t){return this.x-=t.x,this.y-=t.y,this}SubtractXY(t,e){return this.x-=t,this.y-=e,this}Scale(t){return this.x*=t,this.y*=t,this}AddScaled(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SubtractScaled(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const{x:t,y:e}=this;return Math.sqrt(t*t+e*e)}LengthSquared(){const{x:t,y:e}=this;return t*t+e*e}Normalize(){const t=this.Length();if(t<Ue)return 0;const e=1/t;return this.x*=e,this.y*=e,t}Rotate(t){const e=Math.cos(t),i=Math.sin(t),{x:s}=this;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this}RotateCosSin(t,e){const{x:i}=this;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return Number.isFinite(this.x)&&Number.isFinite(this.y)}Abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this}GetAbs(t){return t.x=Math.abs(this.x),t.y=Math.abs(this.y),t}Negate(){return this.x=-this.x,this.y=-this.y,this}Skew(){const{x:t}=this;return this.x=-this.y,this.y=t,this}static Min(t,e,i){return i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i}static Max(t,e,i){return i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i}static Clamp(t,e,i,s){return s.x=Qe(t.x,e.x,i.x),s.y=Qe(t.y,e.y,i.y),s}static Rotate(t,e,i){const s=t.x,n=t.y,o=Math.cos(e),r=Math.sin(e);return i.x=o*s-r*n,i.y=r*s+o*n,i}static Dot(t,e){return t.x*e.x+t.y*e.y}static Cross(t,e){return t.x*e.y-t.y*e.x}static CrossVec2Scalar(t,e,i){const s=t.x;return i.x=e*t.y,i.y=-e*s,i}static CrossVec2One(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossScalarVec2(t,e,i){const s=e.x;return i.x=-t*e.y,i.y=t*s,i}static CrossOneVec2(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static Add(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static Subtract(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static Scale(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static AddScaled(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s}static SubtractScaled(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s}static AddCrossScalarVec2(t,e,i,s){const n=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*n,s}static Mid(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static Extents(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static Equals(t,e){return t.x===e.x&&t.y===e.y}static Distance(t,e){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)}static DistanceSquared(t,e){return(t.x-e.x)**2+(t.y-e.y)**2}static Negate(t,e){return e.x=-t.x,e.y=-t.y,e}static Normalize(t,e){const i=t.x**2+t.y**2;if(i>=Xe){const s=1/Math.sqrt(i);e.x=s*t.x,e.y=s*t.y}else e.x=0,e.y=0;return e}static Skew(t,e){const{x:i}=t;return e.x=-t.y,e.y=i,e}}$e.ZERO=new $e,$e.UNITX=new $e(1,0),$e.UNITY=new $e(0,1),$e.s_t0=new $e,$e.s_t1=new $e,$e.s_t2=new $e,$e.s_t3=new $e;class ti{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}Clone(){return new ti(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}Set(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}Negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}Add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}AddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}Subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SubtractXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}Scale(t){return this.x*=t,this.y*=t,this.z*=t,this}static Dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static Cross(t,e,i){const s=t.x,n=t.y,o=t.z,r=e.x,h=e.y,a=e.z;return i.x=n*a-o*h,i.y=o*r-s*a,i.z=s*h-n*r,i}}ti.ZERO=new ti(0,0,0),ti.s_t0=new ti;class ei{constructor(){this.ex=new $e(1,0),this.ey=new $e(0,1)}Clone(){return(new ei).Copy(this)}static FromColumns(t,e){return(new ei).SetColumns(t,e)}static FromScalars(t,e,i,s){return(new ei).SetScalars(t,e,i,s)}static FromAngle(t){return(new ei).SetAngle(t)}SetScalars(t,e,i,s){return this.ex.Set(t,i),this.ey.Set(e,s),this}SetColumns(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}Solve(t,e,i){const s=this.ex.x,n=this.ey.x,o=this.ex.y,r=this.ey.y;let h=s*r-n*o;return 0!==h&&(h=1/h),i.x=h*(r*t-n*e),i.y=h*(s*e-o*t),i}Abs(){return this.ex.Abs(),this.ey.Abs(),this}Inverse(){return this.GetInverse(this),this}Add(t){return this.ex.Add(t.ex),this.ey.Add(t.ey),this}Subtract(t){return this.ex.Subtract(t.ex),this.ey.Subtract(t.ey),this}GetInverse(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,n=this.ey.y;let o=e*n-i*s;return 0!==o&&(o=1/o),t.ex.x=o*n,t.ey.x=-o*i,t.ex.y=-o*s,t.ey.y=o*e,t}GetAbs(t){return t.ex.x=Math.abs(this.ex.x),t.ex.y=Math.abs(this.ex.y),t.ey.x=Math.abs(this.ey.x),t.ey.y=Math.abs(this.ey.y),t}static MultiplyVec2(t,e,i){const s=e.x,n=e.y;return i.x=t.ex.x*s+t.ey.x*n,i.y=t.ex.y*s+t.ey.y*n,i}static TransposeMultiplyVec2(t,e,i){const s=e.x,n=e.y;return i.x=t.ex.x*s+t.ex.y*n,i.y=t.ey.x*s+t.ey.y*n,i}static Add(t,e,i){return i.ex.x=t.ex.x+e.ex.x,i.ex.y=t.ex.y+e.ex.y,i.ey.x=t.ey.x+e.ey.x,i.ey.y=t.ey.y+e.ey.y,i}static Multiply(t,e,i){const s=t.ex.x,n=t.ex.y,o=t.ey.x,r=t.ey.y,h=e.ex.x,a=e.ex.y,l=e.ey.x,c=e.ey.y;return i.ex.x=s*h+o*a,i.ex.y=n*h+r*a,i.ey.x=s*l+o*c,i.ey.y=n*l+r*c,i}static TransposeMultiply(t,e,i){const s=t.ex.x,n=t.ex.y,o=t.ey.x,r=t.ey.y,h=e.ex.x,a=e.ex.y,l=e.ey.x,c=e.ey.y;return i.ex.x=s*h+n*a,i.ex.y=o*h+r*a,i.ey.x=s*l+n*c,i.ey.y=o*l+r*c,i}}ei.IDENTITY=new ei;class ii{constructor(){this.ex=new ti(1,0,0),this.ey=new ti(0,1,0),this.ez=new ti(0,0,1)}Clone(){return(new ii).Copy(this)}SetColumns(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.Set(1,0,0),this.ey.Set(0,1,0),this.ez.Set(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}Add(t){return this.ex.Add(t.ex),this.ey.Add(t.ey),this.ez.Add(t.ez),this}Solve33(t,e,i,s){const n=this.ex.x,o=this.ex.y,r=this.ex.z,h=this.ey.x,a=this.ey.y,l=this.ey.z,c=this.ez.x,m=this.ez.y,_=this.ez.z;let d=n*(a*_-l*m)+o*(l*c-h*_)+r*(h*m-a*c);return 0!==d&&(d=1/d),s.x=d*(t*(a*_-l*m)+e*(l*c-h*_)+i*(h*m-a*c)),s.y=d*(n*(e*_-i*m)+o*(i*c-t*_)+r*(t*m-e*c)),s.z=d*(n*(a*i-l*e)+o*(l*t-h*i)+r*(h*e-a*t)),s}Solve22(t,e,i){const s=this.ex.x,n=this.ey.x,o=this.ex.y,r=this.ey.y;let h=s*r-n*o;return 0!==h&&(h=1/h),i.x=h*(r*t-n*e),i.y=h*(s*e-o*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,n=this.ey.y;let o=e*n-i*s;0!==o&&(o=1/o),t.ex.x=o*n,t.ey.x=-o*i,t.ex.z=0,t.ex.y=-o*s,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=ti.Dot(this.ex,ti.Cross(this.ey,this.ez,ti.s_t0));0!==e&&(e=1/e);const i=this.ex.x,s=this.ey.x,n=this.ez.x,o=this.ey.y,r=this.ez.y,h=this.ez.z;t.ex.x=e*(o*h-r*r),t.ex.y=e*(n*r-s*h),t.ex.z=e*(s*r-n*o),t.ey.x=t.ex.y,t.ey.y=e*(i*h-n*n),t.ey.z=e*(n*s-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*o-s*s)}static MultiplyVec3(t,e,i){const{x:s,y:n,z:o}=e;return i.x=t.ex.x*s+t.ey.x*n+t.ez.x*o,i.y=t.ex.y*s+t.ey.y*n+t.ez.y*o,i.z=t.ex.z*s+t.ey.z*n+t.ez.z*o,i}static MultiplyVec2(t,e,i){const{x:s,y:n}=e;return i.x=t.ex.x*s+t.ey.x*n,i.y=t.ex.y*s+t.ey.y*n,i}}ii.IDENTITY=new ii;class si{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new si).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}Set(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static Multiply(t,e,i){const s=t.s*e.c+t.c*e.s,n=t.c*e.c-t.s*e.s;return i.s=s,i.c=n,i}static TransposeMultiply(t,e,i){const s=t.c*e.s-t.s*e.c,n=t.c*e.c+t.s*e.s;return i.s=s,i.c=n,i}static MultiplyVec2(t,e,i){const s=e.x,n=e.y;return i.x=t.c*s-t.s*n,i.y=t.s*s+t.c*n,i}static TransposeMultiplyVec2(t,e,i){const s=e.x,n=e.y;return i.x=t.c*s+t.s*n,i.y=-t.s*s+t.c*n,i}}si.IDENTITY=new si;class ni{constructor(){this.p=new $e,this.q=new si}Clone(){return(new ni).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.Set(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.Set(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetAngle(){return this.q.GetAngle()}static MultiplyVec2(t,e,i){const s=e.x,n=e.y;return i.x=t.q.c*s-t.q.s*n+t.p.x,i.y=t.q.s*s+t.q.c*n+t.p.y,i}static TransposeMultiplyVec2(t,e,i){const s=e.x-t.p.x,n=e.y-t.p.y;return i.x=t.q.c*s+t.q.s*n,i.y=-t.q.s*s+t.q.c*n,i}static Multiply(t,e,i){return si.Multiply(t.q,e.q,i.q),si.MultiplyVec2(t.q,e.p,i.p).Add(t.p),i}static TransposeMultiply(t,e,i){return si.TransposeMultiply(t.q,e.q,i.q),si.TransposeMultiplyVec2(t.q,$e.Subtract(e.p,t.p,i.p),i.p),i}}ni.IDENTITY=new ni;class oi{constructor(){this.localCenter=new $e,this.c0=new $e,this.c=new $e,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new oi).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const s=i*this.a0+e*this.a;return t.q.Set(s),t.p.Subtract(si.MultiplyVec2(t.q,this.localCenter,$e.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0);this.c0.x+=e*(this.c.x-this.c0.x),this.c0.y+=e*(this.c.y-this.c0.y),this.a0+=e*(this.a-this.a0),this.alpha0=t}Normalize(){const t=Ke*Math.floor(this.a0/Ke);this.a0-=t,this.a-=t}}class ri{constructor(t=.5,e=.5,i=.5,s=1){this.r=t,this.g=e,this.b=i,this.a=s}Clone(){return new ri(this.r,this.g,this.b,this.a)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this}Add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Subtract(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Scale(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mix(t,e){ri.MixColors(this,t,e)}static Add(t,e,i){return i.r=t.r+e.r,i.g=t.g+e.g,i.b=t.b+e.b,i.a=t.a+e.a,i}static Subtract(t,e,i){return i.r=t.r-e.r,i.g=t.g-e.g,i.b=t.b-e.b,i.a=t.a-e.a,i}static Scale(t,e,i){return i.r=t.r*e,i.g=t.g*e,i.b=t.b*e,i.a=t.a*e,i}static MixColors(t,e,i){const s=i*(e.r-t.r),n=i*(e.g-t.g),o=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=s,t.g+=n,t.b+=o,t.a+=r,e.r-=s,e.g-=n,e.b-=o,e.a-=r}}ri.ZERO=new ri(0,0,0,0),ri.RED=new ri(1,0,0),ri.GREEN=new ri(0,1,0),ri.BLUE=new ri(0,0,1),ri.WHITE=new ri(1,1,1),ri.BLACK=new ri(0,0,0);const hi={badBody:new ri(1,0,0),disabledBody:new ri(.5,.5,.3),staticBody:new ri(.5,.9,.5),kinematicBody:new ri(.5,.5,.9),sleepingBody:new ri(.6,.6,.6),body:new ri(.9,.7,.7),pair:new ri(.3,.9,.9),aabb:new ri(.9,.3,.9),joint1:new ri(.7,.7,.7),joint2:new ri(.3,.9,.3),joint3:new ri(.9,.3,.3),joint4:new ri(.3,.3,.9),joint5:new ri(.4,.4,.4),joint6:new ri(.5,.8,.8),joint7:new ri(0,1,0),joint8:new ri(.8,.8,.8),rope:new ri(.4,.5,.7),ropePointG:new ri(.1,.8,.1),ropePointD:new ri(.7,.2,.4)};class ai{constructor(){this.mass=0,this.center=new $e,this.I=0}}var li;!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_circle=0]="e_circle",t[t.e_edge=1]="e_edge",t[t.e_polygon=2]="e_polygon",t[t.e_chain=3]="e_chain",t[t.e_typeCount=4]="e_typeCount"}(li||(li={}));class ci{constructor(t,e){this.m_radius=0,this.m_type=t,this.m_radius=e}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class mi{constructor(){this.m_buffer=Ze(2,$e),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=$e.Dot(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const n=$e.Dot(this.m_vertices[s],t);n>i&&(e=s,i=n)}return e}GetSupportVertex(t){let e=0,i=$e.Dot(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const n=$e.Dot(this.m_vertices[s],t);n>i&&(e=s,i=n)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class _i{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class di{constructor(){this.proxyA=new mi,this.proxyB=new mi,this.transformA=new ni,this.transformB=new ni,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class ui{constructor(){this.pointA=new $e,this.pointB=new $e,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}const pi={calls:0,iters:0,maxIters:0,reset(){this.calls=0,this.iters=0,this.maxIters=0}};class fi{constructor(){this.wA=new $e,this.wB=new $e,this.w=new $e,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class yi{constructor(){this.m_v1=new fi,this.m_v2=new fi,this.m_v3=new fi,this.m_count=0,this.m_vertices=[this.m_v1,this.m_v2,this.m_v3]}ReadCache(t,e,i,s,n){this.m_count=t.count;const o=this.m_vertices;for(let r=0;r<this.m_count;++r){const h=o[r];h.indexA=t.indexA[r],h.indexB=t.indexB[r];const a=e.GetVertex(h.indexA),l=s.GetVertex(h.indexB);ni.MultiplyVec2(i,a,h.wA),ni.MultiplyVec2(n,l,h.wB),$e.Subtract(h.wB,h.wA,h.w),h.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<Ue)&&(this.m_count=0)}if(0===this.m_count){const t=o[0];t.indexA=0,t.indexB=0;const r=e.GetVertex(0),h=s.GetVertex(0);ni.MultiplyVec2(i,r,t.wA),ni.MultiplyVec2(n,h,t.wB),$e.Subtract(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return $e.Negate(this.m_v1.w,t);case 2:{const e=$e.Subtract(this.m_v2.w,this.m_v1.w,t);return $e.Cross(e,$e.Negate(this.m_v1.w,$e.s_t0))>0?$e.CrossOneVec2(e,t):$e.CrossVec2One(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:case 3:default:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}}GetWitnessPoints(t,e){switch(this.m_count){case 0:default:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:default:return 0;case 2:return $e.Distance(this.m_v1.w,this.m_v2.w);case 3:return $e.Cross($e.Subtract(this.m_v2.w,this.m_v1.w,$e.s_t0),$e.Subtract(this.m_v3.w,this.m_v1.w,$e.s_t1))}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=$e.Subtract(e,t,yi.s_e12),s=-$e.Dot(t,i);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);const n=$e.Dot(e,i);if(n<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const o=1/(n+s);this.m_v1.a=n*o,this.m_v2.a=s*o,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,s=$e.Subtract(e,t,yi.s_e12),n=$e.Dot(t,s),o=$e.Dot(e,s),r=-n,h=$e.Subtract(i,t,yi.s_e13),a=$e.Dot(t,h),l=$e.Dot(i,h),c=-a,m=$e.Subtract(i,e,yi.s_e23),_=$e.Dot(e,m),d=$e.Dot(i,m),u=-_,p=$e.Cross(s,h),f=p*$e.Cross(e,i),y=p*$e.Cross(i,t),v=p*$e.Cross(t,e);if(r<=0&&c<=0)return this.m_v1.a=1,void(this.m_count=1);if(o>0&&r>0&&v<=0){const t=1/(o+r);return this.m_v1.a=o*t,this.m_v2.a=r*t,void(this.m_count=2)}if(l>0&&c>0&&y<=0){const t=1/(l+c);return this.m_v1.a=l*t,this.m_v3.a=c*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(o<=0&&u<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(l<=0&&d<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(d>0&&u>0&&f<=0){const t=1/(d+u);return this.m_v2.a=d*t,this.m_v3.a=u*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const x=1/(f+y+v);this.m_v1.a=f*x,this.m_v2.a=y*x,this.m_v3.a=v*x,this.m_count=3}}yi.s_e12=new $e,yi.s_e13=new $e,yi.s_e23=new $e;const vi=new yi,xi=[0,0,0],wi=[0,0,0],Ai=new $e,gi=new $e,bi=new $e,Si=new $e,Bi=new $e;function Ci(t,e,i){++pi.calls;const{proxyA:s,proxyB:n,transformA:o,transformB:r}=i,h=vi;h.ReadCache(e,s,o,n,r);const a=h.m_vertices,l=xi,c=wi;let m=0,_=0;for(;_<20;){m=h.m_count;for(let t=0;t<m;++t)l[t]=a[t].indexA,c[t]=a[t].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;const t=h.GetSearchDirection(gi);if(t.LengthSquared()<Xe)break;const e=a[h.m_count];e.indexA=s.GetSupport(si.TransposeMultiplyVec2(o.q,$e.Negate(t,$e.s_t0),Si)),ni.MultiplyVec2(o,s.GetVertex(e.indexA),e.wA),e.indexB=n.GetSupport(si.TransposeMultiplyVec2(r.q,t,Bi)),ni.MultiplyVec2(r,n.GetVertex(e.indexB),e.wB),$e.Subtract(e.wB,e.wA,e.w),++_,++pi.iters;let i=!1;for(let t=0;t<m;++t)if(e.indexA===l[t]&&e.indexB===c[t]){i=!0;break}if(i)break;++h.m_count}if(pi.maxIters=Math.max(pi.maxIters,_),h.GetWitnessPoints(t.pointA,t.pointB),t.distance=$e.Distance(t.pointA,t.pointB),t.iterations=_,h.WriteCache(e),i.useRadii){const e=s.m_radius,i=n.m_radius;if(t.distance>e+i&&t.distance>Ue){t.distance-=e+i;const s=$e.Subtract(t.pointB,t.pointA,bi);s.Normalize(),t.pointA.AddScaled(e,s),t.pointB.SubtractScaled(i,s)}else{const e=$e.Mid(t.pointA,t.pointB,Ai);t.pointA.Copy(e),t.pointB.Copy(e),t.distance=0}}}var Ri,Ii,Gi;new $e,new yi,new $e,new $e,new $e,new $e,new $e,new $e,function(t){t[t.e_vertex=0]="e_vertex",t[t.e_face=1]="e_face"}(Ri||(Ri={}));class Mi{constructor(){this.m_key=0,this.m_key_invalid=!1,this.m_indexA=0,this.m_indexB=0,this.m_typeA=Ri.e_vertex,this.m_typeB=Ri.e_vertex}get key(){return this.m_key_invalid&&(this.m_key_invalid=!1,this.m_key=this.m_indexA|this.m_indexB<<8|this.m_typeA<<16|this.m_typeB<<24),this.m_key}set key(t){this.m_key=t,this.m_key_invalid=!1,this.m_indexA=255&this.m_key,this.m_indexB=this.m_key>>8&255,this.m_typeA=this.m_key>>16&255,this.m_typeB=this.m_key>>24&255}get indexA(){return this.m_indexA}set indexA(t){this.m_indexA=t,this.m_key_invalid=!0}get indexB(){return this.m_indexB}set indexB(t){this.m_indexB=t,this.m_key_invalid=!0}get typeA(){return this.m_typeA}set typeA(t){this.m_typeA=t,this.m_key_invalid=!0}get typeB(){return this.m_typeB}set typeB(t){this.m_typeB=t,this.m_key_invalid=!0}}class Ti{constructor(){this.cf=new Mi}Copy(t){return this.key=t.key,this}Clone(){return(new Ti).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class Di{constructor(){this.localPoint=new $e,this.normalImpulse=0,this.tangentImpulse=0,this.id=new Ti}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}!function(t){t[t.e_circles=0]="e_circles",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(Ii||(Ii={}));class Li{constructor(){this.points=Ze(2,Di),this.localNormal=new $e,this.localPoint=new $e,this.type=Ii.e_circles,this.pointCount=0}Reset(){for(let t=0;t<2;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=Ii.e_circles,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<2;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new Li).Copy(this)}}class Pi{constructor(){this.normal=new $e,this.points=Ze(2,$e),this.separations=Je(2)}Initialize(t,e,i,s,n){if(0!==t.pointCount)switch(t.type){case Ii.e_circles:{this.normal.Set(1,0);const o=ni.MultiplyVec2(e,t.localPoint,Pi.Initialize_s_pointA),r=ni.MultiplyVec2(s,t.points[0].localPoint,Pi.Initialize_s_pointB);$e.DistanceSquared(o,r)>Xe&&$e.Subtract(r,o,this.normal).Normalize();const h=$e.AddScaled(o,i,this.normal,Pi.Initialize_s_cA),a=$e.SubtractScaled(r,n,this.normal,Pi.Initialize_s_cB);$e.Mid(h,a,this.points[0]),this.separations[0]=$e.Dot($e.Subtract(a,h,$e.s_t0),this.normal);break}case Ii.e_faceA:{si.MultiplyVec2(e.q,t.localNormal,this.normal);const o=ni.MultiplyVec2(e,t.localPoint,Pi.Initialize_s_planePoint);for(let e=0;e<t.pointCount;++e){const r=ni.MultiplyVec2(s,t.points[e].localPoint,Pi.Initialize_s_clipPoint),h=i-$e.Dot($e.Subtract(r,o,$e.s_t0),this.normal),a=$e.AddScaled(r,h,this.normal,Pi.Initialize_s_cA),l=$e.SubtractScaled(r,n,this.normal,Pi.Initialize_s_cB);$e.Mid(a,l,this.points[e]),this.separations[e]=$e.Dot($e.Subtract(l,a,$e.s_t0),this.normal)}break}case Ii.e_faceB:{si.MultiplyVec2(s.q,t.localNormal,this.normal);const o=ni.MultiplyVec2(s,t.localPoint,Pi.Initialize_s_planePoint);for(let s=0;s<t.pointCount;++s){const r=ni.MultiplyVec2(e,t.points[s].localPoint,Pi.Initialize_s_clipPoint),h=n-$e.Dot($e.Subtract(r,o,$e.s_t0),this.normal),a=$e.AddScaled(r,h,this.normal,Pi.Initialize_s_cB),l=$e.SubtractScaled(r,i,this.normal,Pi.Initialize_s_cA);$e.Mid(l,a,this.points[s]),this.separations[s]=$e.Dot($e.Subtract(l,a,$e.s_t0),this.normal)}this.normal.Negate();break}}}}Pi.Initialize_s_pointA=new $e,Pi.Initialize_s_pointB=new $e,Pi.Initialize_s_cA=new $e,Pi.Initialize_s_cB=new $e,Pi.Initialize_s_planePoint=new $e,Pi.Initialize_s_clipPoint=new $e,function(t){t[t.b2_nullState=0]="b2_nullState",t[t.b2_addState=1]="b2_addState",t[t.b2_persistState=2]="b2_persistState",t[t.b2_removeState=3]="b2_removeState"}(Gi||(Gi={}));class Fi{constructor(){this.v=new $e,this.id=new Ti}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class Ei{constructor(){this.p1=new $e,this.p2=new $e,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class Oi{constructor(){this.lowerBound=new $e,this.upperBound=new $e}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return this.lowerBound.IsValid()&&this.upperBound.IsValid()&&this.upperBound.x>=this.lowerBound.x&&this.upperBound.y>=this.lowerBound.y}GetCenter(t){return $e.Mid(this.lowerBound,this.upperBound,t)}GetExtents(t){return $e.Extents(this.lowerBound,this.upperBound,t)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=Math.min(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=Math.max(this.upperBound.x,t.upperBound.x),this.upperBound.y=Math.max(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=Math.min(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=Math.min(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Math.max(t.upperBound.x,e.upperBound.x),this.upperBound.y=Math.max(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return this.lowerBound.x<=t.lowerBound.x&&this.lowerBound.y<=t.lowerBound.y&&t.upperBound.x<=this.upperBound.x&&t.upperBound.y<=this.upperBound.y}RayCast(t,e){let i=-ke,s=ke;const n=e.p1.x,o=e.p1.y,r=e.p2.x-e.p1.x,h=e.p2.y-e.p1.y,a=Math.abs(r),l=Math.abs(h),{normal:c}=t;if(a<Ue){if(n<this.lowerBound.x||this.upperBound.x<n)return!1}else{const t=1/r;let e=(this.lowerBound.x-n)*t,o=(this.upperBound.x-n)*t,h=-1;if(e>o){const t=e;e=o,o=t,h=1}if(e>i&&(c.x=h,c.y=0,i=e),s=Math.min(s,o),i>s)return!1}if(l<Ue){if(o<this.lowerBound.y||this.upperBound.y<o)return!1}else{const t=1/h;let e=(this.lowerBound.y-o)*t,n=(this.upperBound.y-o)*t,r=-1;if(e>n){const t=e;e=n,n=t,r=1}if(e>i&&(c.x=0,c.y=r,i=e),s=Math.min(s,n),i>s)return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function Vi(t,[e,i],s,n,o){let r=0;const h=$e.Dot(s,e.v)-n,a=$e.Dot(s,i.v)-n;if(h<=0&&t[r++].Copy(e),a<=0&&t[r++].Copy(i),h*a<0){const s=h/(h-a),{v:n,id:l}=t[r];n.x=e.v.x+s*(i.v.x-e.v.x),n.y=e.v.y+s*(i.v.y-e.v.y),l.cf.indexA=o,l.cf.indexB=e.id.cf.indexB,l.cf.typeA=Ri.e_vertex,l.cf.typeB=Ri.e_face,++r}return r}const ki=new di,Ui=new _i,Xi=new ui;function zi(t,e,i,s,n,o){const r=ki.Reset();r.proxyA.SetShape(t,e),r.proxyB.SetShape(i,s),r.transformA.Copy(n),r.transformB.Copy(o),r.useRadii=!0;const h=Ui.Reset();h.count=0;const a=Xi.Reset();return Ci(a,h,r),a.distance<1e-4}const Ni={c1:new $e,c2:new $e},Yi={categoryBits:1,maskBits:65535,groupIndex:0};class Wi{constructor(t,e,i,s){this.aabb=new Oi,this.fixture=t,this.childIndex=s,t.m_shape.ComputeAABB(this.aabb,i,s),this.treeNode=e.CreateProxy(this.aabb,this)}}const qi=new Oi,Hi=new Oi,ji=new $e;class Ji{get m_proxyCount(){return this.m_proxies.length}constructor(t,e){var i,s,n,o,r;this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=0,this.m_proxies=[],this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=e.userData,this.m_friction=null!==(i=e.friction)&&void 0!==i?i:.2,this.m_restitution=null!==(s=e.restitution)&&void 0!==s?s:0,this.m_restitutionThreshold=null!==(n=e.restitutionThreshold)&&void 0!==n?n:1,this.m_filter=Object.assign(Object.assign({},Yi),e.filter),this.m_isSensor=null!==(o=e.isSensor)&&void 0!==o&&o,this.m_density=null!==(r=e.density)&&void 0!==r?r:0}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){var e,i,s;this.m_filter.categoryBits=null!==(e=t.categoryBits)&&void 0!==e?e:Yi.categoryBits,this.m_filter.groupIndex=null!==(i=t.groupIndex)&&void 0!==i?i:Yi.groupIndex,this.m_filter.maskBits=null!==(s=t.maskBits)&&void 0!==s?s:Yi.maskBits,this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const{contact:e}=t,i=e.GetFixtureA(),s=e.GetFixtureB();i!==this&&s!==this||e.FlagForFiltering(),t=t.next}const e=this.m_body.GetWorld().m_contactManager.m_broadPhase;for(const t of this.m_proxies)e.TouchProxy(t.treeNode)}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new ai){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetAABB(t){return this.m_proxies[t].aabb}CreateProxies(t,e){Oe(0===this.m_proxies.length),this.m_proxies.length=this.m_shape.GetChildCount();for(let i=0;i<this.m_proxies.length;++i)this.m_proxies[i]=new Wi(this,t,e,i)}DestroyProxies(t){for(const e of this.m_proxies)t.DestroyProxy(e.treeNode);this.m_proxies.length=0}Synchronize(t,e,i){const{c1:s,c2:n}=Ni,o=ji;for(const r of this.m_proxies){const h=qi,a=Hi;this.m_shape.ComputeAABB(h,e,r.childIndex),this.m_shape.ComputeAABB(a,i,r.childIndex),r.aabb.Combine2(h,a),$e.Subtract(a.GetCenter(n),h.GetCenter(s),o),t.MoveProxy(r.treeNode,r.aabb,o)}}}var Zi,Ki;(Ki=Zi||(Zi={}))[Ki.b2_staticBody=0]="b2_staticBody",Ki[Ki.b2_kinematicBody=1]="b2_kinematicBody",Ki[Ki.b2_dynamicBody=2]="b2_dynamicBody";class Qi{constructor(t,e){var i,s,n,o,r,h,a,l,c,m,_,d,u,p;this.m_type=Zi.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_enabledFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new ni,this.m_sweep=new oi,this.m_linearVelocity=new $e,this.m_angularVelocity=0,this.m_force=new $e,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_bulletFlag=null!==(i=t.bullet)&&void 0!==i&&i,this.m_fixedRotationFlag=null!==(s=t.fixedRotation)&&void 0!==s&&s,this.m_autoSleepFlag=null===(n=t.allowSleep)||void 0===n||n,null!==(o=t.awake)&&void 0!==o&&!o||(null!==(r=t.type)&&void 0!==r?r:Zi.b2_staticBody)===Zi.b2_staticBody||(this.m_awakeFlag=!0),this.m_enabledFlag=null===(h=t.enabled)||void 0===h||h,this.m_world=e,this.m_xf.p.Copy(null!==(a=t.position)&&void 0!==a?a:$e.ZERO),this.m_xf.q.Set(null!==(l=t.angle)&&void 0!==l?l:0),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(null!==(c=t.linearVelocity)&&void 0!==c?c:$e.ZERO),this.m_angularVelocity=null!==(m=t.angularVelocity)&&void 0!==m?m:0,this.m_linearDamping=null!==(_=t.linearDamping)&&void 0!==_?_:0,this.m_angularDamping=null!==(d=t.angularDamping)&&void 0!==d?d:0,this.m_gravityScale=null!==(u=t.gravityScale)&&void 0!==u?u:1,this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=null!==(p=t.type)&&void 0!==p?p:Zi.b2_staticBody,this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0}CreateFixture(t){Oe(!this.m_world.IsLocked());const e=new Ji(this,t);if(this.m_enabledFlag){const t=this.m_world.m_contactManager.m_broadPhase;e.CreateProxies(t,this.m_xf)}return e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newContacts=!0,e}DestroyFixture(t){Oe(!this.m_world.IsLocked());let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let s=this.m_contactList;for(;s;){const e=s.contact;s=s.next;const i=e.GetFixtureA(),n=e.GetFixtureB();t!==i&&t!==n||this.m_world.m_contactManager.Destroy(e)}if(this.m_enabledFlag){const e=this.m_world.m_contactManager.m_broadPhase;t.DestroyProxies(e)}t.m_next=null,--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){Oe(!this.m_world.IsLocked()),this.m_xf.q.Set(i),this.m_xf.p.Set(t,e),ni.MultiplyVec2(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;const s=this.m_world.m_contactManager.m_broadPhase;for(let t=this.m_fixtureList;t;t=t.m_next)t.Synchronize(s,this.m_xf,this.m_xf);this.m_world.m_newContacts=!0}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(t){this.m_type!==Zi.b2_staticBody&&($e.Dot(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(t){this.m_type!==Zi.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}GetAngularVelocity(){return this.m_angularVelocity}ApplyForce(t,e,i=!0){this.m_type===Zi.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))}ApplyForceToCenter(t,e=!0){this.m_type===Zi.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}ApplyTorque(t,e=!0){this.m_type===Zi.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}ApplyLinearImpulse(t,e,i=!0){this.m_type===Zi.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))}ApplyLinearImpulseToCenter(t,e=!0){this.m_type===Zi.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}ApplyAngularImpulse(t,e=!0){this.m_type===Zi.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*$e.Dot(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*$e.Dot(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(t){if(Oe(!this.m_world.IsLocked()),this.m_type!==Zi.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*$e.Dot(t.center,t.center),this.m_invI=1/this.m_I);const e=Qi.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),ni.MultiplyVec2(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),$e.AddCrossScalarVec2(this.m_linearVelocity,this.m_angularVelocity,$e.Subtract(this.m_sweep.c,e,$e.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===Zi.b2_staticBody||this.m_type===Zi.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const t=Qi.ResetMassData_s_localCenter.SetZero();for(let e=this.m_fixtureList;e;e=e.m_next){if(0===e.m_density)continue;const i=e.GetMassData(Qi.ResetMassData_s_massData);this.m_mass+=i.mass,t.AddScaled(i.mass,i.center),this.m_I+=i.I}this.m_mass>0&&(this.m_invMass=1/this.m_mass,t.Scale(this.m_invMass)),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*$e.Dot(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const e=Qi.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),ni.MultiplyVec2(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),$e.AddCrossScalarVec2(this.m_linearVelocity,this.m_angularVelocity,$e.Subtract(this.m_sweep.c,e,$e.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return ni.MultiplyVec2(this.m_xf,t,e)}GetWorldVector(t,e){return si.MultiplyVec2(this.m_xf.q,t,e)}GetLocalPoint(t,e){return ni.TransposeMultiplyVec2(this.m_xf,t,e)}GetLocalVector(t,e){return si.TransposeMultiplyVec2(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return $e.AddCrossScalarVec2(this.m_linearVelocity,this.m_angularVelocity,$e.Subtract(t,this.m_sweep.c,$e.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(t){if(Oe(!this.m_world.IsLocked()),this.m_type===t)return;this.m_type=t,this.ResetMassData(),this.m_type===Zi.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_awakeFlag=!1,this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let e=this.m_contactList;for(;e;){const t=e;e=e.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;const i=this.m_world.m_contactManager.m_broadPhase;for(let t=this.m_fixtureList;t;t=t.m_next)for(const e of t.m_proxies)i.TouchProxy(e.treeNode)}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){this.m_type!==Zi.b2_staticBody&&(t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0))}IsAwake(){return this.m_awakeFlag}SetEnabled(t){if(Oe(!this.m_world.IsLocked()),t===this.IsEnabled())return;this.m_enabledFlag=t;const e=this.m_world.m_contactManager.m_broadPhase;if(t){for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies(e,this.m_xf);this.m_world.m_newContacts=!0}else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies(e);let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsEnabled(){return this.m_enabledFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}SynchronizeFixtures(){const t=this.m_world.m_contactManager.m_broadPhase;if(this.m_awakeFlag){const e=Qi.SynchronizeFixtures_s_xf1;e.q.Set(this.m_sweep.a0),si.MultiplyVec2(e.q,this.m_sweep.localCenter,e.p),$e.Subtract(this.m_sweep.c0,e.p,e.p);for(let i=this.m_fixtureList;i;i=i.m_next)i.Synchronize(t,e,this.m_xf)}else for(let e=this.m_fixtureList;e;e=e.m_next)e.Synchronize(t,this.m_xf,this.m_xf)}SynchronizeTransform(){this.m_xf.q.Set(this.m_sweep.a),si.MultiplyVec2(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),$e.Subtract(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(t){return(this.m_type===Zi.b2_dynamicBody||t.m_type===Zi.b2_dynamicBody)&&this.ShouldCollideConnected(t)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.Set(this.m_sweep.a),si.MultiplyVec2(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),$e.Subtract(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}}Qi.SetMassData_s_oldCenter=new $e,Qi.ResetMassData_s_localCenter=new $e,Qi.ResetMassData_s_oldCenter=new $e,Qi.ResetMassData_s_massData=new ai,Qi.SynchronizeFixtures_s_xf1=new ni,new $e,new $e,Ze(4,$e),new ni;const $i={stack:[],t:new $e,r:new $e,v:new $e,abs_v:new $e,segmentAABB:new Oi,subInput:new Ei,combinedAABB:new Oi,aabb:new Oi,fatAABB:new Oi,hugeAABB:new Oi,c:new $e,h:new $e};let ts=0;class es{constructor(){this.aabb=new Oi,this.userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.moved=!1,this.id=ts++}Reset(){this.child1=null,this.child2=null,this.height=-1,this.userData=null}IsLeaf(){return null===this.child1}GetArea(){if(this.IsLeaf())return 0;let t=this.aabb.GetPerimeter();return this.child1&&(t+=this.child1.GetArea()),this.child2&&(t+=this.child2.GetArea()),t}ComputeHeight(){if(this.IsLeaf())return 0;Oe(null!==this.child1&&null!==this.child2);const t=Ve(this.child1).ComputeHeight(),e=Ve(this.child2).ComputeHeight();return 1+Math.max(t,e)}GetMaxBalance(){if(this.height<=1)return 0;const t=Ve(this.child1),e=Ve(this.child2);return Math.max(t.GetMaxBalance(),e.GetMaxBalance(),Math.abs(e.height-t.height))}ShiftOrigin(t){this.height<=1||(Ve(this.child1).ShiftOrigin(t),Ve(this.child2).ShiftOrigin(t),this.aabb.lowerBound.Subtract(t),this.aabb.upperBound.Subtract(t))}}class is{constructor(){this.m_root=null,this.m_freeList=null}Query(t,e){const i=$i.stack;i.length=0;let s=this.m_root;for(;s;){if(s.aabb.TestOverlap(t))if(s.IsLeaf()){if(!e(s))return}else i.push(s.child1),i.push(s.child2);s=i.pop()}}QueryPoint(t,e){const i=$i.stack;i.length=0;let s=this.m_root;for(;s;){if(s.aabb.TestContain(t))if(s.IsLeaf()){if(!e(s))return}else i.push(s.child1),i.push(s.child2);s=i.pop()}}RayCast(t,e){const{p1:i,p2:s}=t,n=$e.Subtract(s,i,$i.r);n.Normalize();const o=$e.CrossOneVec2(n,$i.v),r=o.GetAbs($i.abs_v);let{maxFraction:h}=t;const{segmentAABB:a,subInput:l,c,h:m,t:_}=$i;$e.AddScaled(i,h,$e.Subtract(s,i,_),_),$e.Min(i,_,a.lowerBound),$e.Max(i,_,a.upperBound);const d=$i.stack;d.length=0;let u=this.m_root;for(;u;)if(u.aabb.TestOverlap(a))if(u.aabb.GetCenter(c),u.aabb.GetExtents(m),Math.abs($e.Dot(o,$e.Subtract(i,c,$e.s_t0)))-$e.Dot(r,m)>0)u=d.pop();else{if(u.IsLeaf()){l.p1.Copy(t.p1),l.p2.Copy(t.p2),l.maxFraction=h;const n=e(l,u);if(0===n)return;n>0&&(h=n,$e.AddScaled(i,h,$e.Subtract(s,i,_),_),$e.Min(i,_,a.lowerBound),$e.Max(i,_,a.upperBound))}else d.push(u.child1),d.push(u.child2);u=d.pop()}else u=d.pop()}AllocateNode(){if(null===this.m_freeList)return new es;const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.moved=!1,t}FreeNode(t){t.parent=this.m_freeList,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),s=.1;return i.aabb.lowerBound.Set(t.lowerBound.x-s,t.lowerBound.y-s),i.aabb.upperBound.Set(t.upperBound.x+s,t.upperBound.y+s),i.userData=e,i.height=0,i.moved=!0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){const{fatAABB:s,hugeAABB:n}=$i,o=.1;s.lowerBound.Set(e.lowerBound.x-o,e.lowerBound.y-o),s.upperBound.Set(e.upperBound.x+o,e.upperBound.y+o);const r=4*i.x,h=4*i.y;r<0?s.lowerBound.x+=r:s.upperBound.x+=r,h<0?s.lowerBound.y+=h:s.upperBound.y+=h;const a=t.aabb;if(a.Contains(e)){const t=.4;if(n.lowerBound.Set(s.lowerBound.x-t,e.lowerBound.y-t),n.upperBound.Set(s.upperBound.x+t,e.upperBound.y+t),n.Contains(a))return!1}return this.RemoveLeaf(t),t.aabb.Copy(s),this.InsertLeaf(t),t.moved=!0,!0}InsertLeaf(t){if(null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const{combinedAABB:e,aabb:i}=$i,s=t.aabb;let n=this.m_root;for(;!n.IsLeaf();){const t=Ve(n.child1),o=Ve(n.child2),r=n.aabb.GetPerimeter();e.Combine2(n.aabb,s);const h=e.GetPerimeter(),a=2*h,l=2*(h-r);let c,m,_,d;if(t.IsLeaf()?(i.Combine2(s,t.aabb),c=i.GetPerimeter()+l):(i.Combine2(s,t.aabb),m=t.aabb.GetPerimeter(),_=i.GetPerimeter(),c=_-m+l),o.IsLeaf()?(i.Combine2(s,o.aabb),d=i.GetPerimeter()+l):(i.Combine2(s,o.aabb),m=o.aabb.GetPerimeter(),_=i.GetPerimeter(),d=_-m+l),a<c&&a<d)break;n=c<d?t:o}const o=n.parent,r=this.AllocateNode();r.parent=o,r.userData=null,r.aabb.Combine2(s,n.aabb),r.height=n.height+1,null!==o?(o.child1===n?o.child1=r:o.child2=r,r.child1=n,r.child2=t,n.parent=r,t.parent=r):(r.child1=n,r.child2=t,n.parent=r,t.parent=r,this.m_root=r);let h=t.parent;for(;null!==h;){h=this.Balance(h);const t=Ve(h.child1),e=Ve(h.child2);h.height=1+Math.max(t.height,e.height),h.aabb.Combine2(t.aabb,e.aabb),h=h.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=Ve(t.parent),i=e.parent,s=Ve(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=Ve(t.child1),i=Ve(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+Math.max(e.height,i.height),t=t.parent}}else this.m_root=s,s.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=Ve(t.child1),i=Ve(t.child2),s=i.height-e.height;if(s>1){const s=Ve(i.child1),n=Ve(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>n.height?(i.child2=s,t.child2=n,n.parent=t,t.aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+Math.max(e.height,n.height),i.height=1+Math.max(t.height,s.height)):(i.child2=n,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+Math.max(e.height,s.height),i.height=1+Math.max(t.height,n.height)),i}if(s<-1){const s=Ve(e.child1),n=Ve(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,s.height>n.height?(e.child2=s,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+Math.max(i.height,n.height),e.height=1+Math.max(t.height,s.height)):(e.child2=n,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+Math.max(i.height,s.height),e.height=1+Math.max(t.height,n.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root,e=t.aabb.GetPerimeter();return t.GetArea()/e}GetMaxBalance(){return null===this.m_root?0:this.m_root.GetMaxBalance()}ShiftOrigin(t){var e;null===(e=this.m_root)||void 0===e||e.ShiftOrigin(t)}}class ss{constructor(){this.m_tree=new is,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[],this.m_queryProxy=new es,this.QueryCallback=t=>(t.id===this.m_queryProxy.id||t.moved&&t.id>this.m_queryProxy.id||(this.m_pairBuffer[this.m_pairCount]=t.id<this.m_queryProxy.id?[t,this.m_queryProxy]:[this.m_queryProxy,t],++this.m_pairCount),!0)}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;this.m_queryProxy=e;const i=e.aabb;this.m_tree.Query(i,this.QueryCallback)}for(let e=0;e<this.m_pairCount;++e){const i=this.m_pairBuffer[e];t(Ve(i[0].userData),Ve(i[1].userData))}for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];e&&(e.moved=!1)}this.m_moveCount=0}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}const ns={time:0,maxTime:0,calls:0,iters:0,maxIters:0,rootIters:0,maxRootIters:0,reset(){this.time=0,this.maxTime=0,this.calls=0,this.iters=0,this.maxIters=0,this.rootIters=0,this.maxRootIters=0}},os=new ni,rs=new ni,hs=new $e,as=new $e,ls=new $e,cs=new $e,ms=new $e;var _s,ds;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_failed=1]="e_failed",t[t.e_overlapped=2]="e_overlapped",t[t.e_touching=3]="e_touching",t[t.e_separated=4]="e_separated"}(_s||(_s={})),function(t){t[t.e_points=0]="e_points",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(ds||(ds={}));const us=new _i,ps=new di,fs=new ui,ys=new class{constructor(){this.m_sweepA=new oi,this.m_sweepB=new oi,this.m_type=ds.e_points,this.m_localPoint=new $e,this.m_axis=new $e}Initialize(t,e,i,s,n,o){this.m_proxyA=e,this.m_proxyB=s;const{count:r}=t;this.m_sweepA.Copy(i),this.m_sweepB.Copy(n);const h=this.m_sweepA.GetTransform(os,o),a=this.m_sweepB.GetTransform(rs,o);if(1===r){this.m_type=ds.e_points;const e=this.m_proxyA.GetVertex(t.indexA[0]),i=this.m_proxyB.GetVertex(t.indexB[0]),s=ni.MultiplyVec2(h,e,hs),n=ni.MultiplyVec2(a,i,as);return $e.Subtract(n,s,this.m_axis),this.m_axis.Normalize()}if(t.indexA[0]===t.indexA[1]){this.m_type=ds.e_faceB;const e=this.m_proxyB.GetVertex(t.indexB[0]),i=this.m_proxyB.GetVertex(t.indexB[1]);$e.CrossVec2One($e.Subtract(i,e,$e.s_t0),this.m_axis).Normalize();const s=si.MultiplyVec2(a.q,this.m_axis,ls);$e.Mid(e,i,this.m_localPoint);const n=ni.MultiplyVec2(a,this.m_localPoint,as),o=this.m_proxyA.GetVertex(t.indexA[0]),r=ni.MultiplyVec2(h,o,hs);let l=$e.Dot($e.Subtract(r,n,$e.s_t0),s);return l<0&&(this.m_axis.Negate(),l=-l),l}this.m_type=ds.e_faceA;const l=this.m_proxyA.GetVertex(t.indexA[0]),c=this.m_proxyA.GetVertex(t.indexA[1]);$e.CrossVec2One($e.Subtract(c,l,$e.s_t0),this.m_axis).Normalize();const m=si.MultiplyVec2(h.q,this.m_axis,ls);$e.Mid(l,c,this.m_localPoint);const _=ni.MultiplyVec2(h,this.m_localPoint,hs),d=this.m_proxyB.GetVertex(t.indexB[0]),u=ni.MultiplyVec2(a,d,as);let p=$e.Dot($e.Subtract(u,_,$e.s_t0),m);return p<0&&(this.m_axis.Negate(),p=-p),p}FindMinSeparation(t,e,i){const s=this.m_sweepA.GetTransform(os,i),n=this.m_sweepB.GetTransform(rs,i);switch(this.m_type){case ds.e_points:{const i=si.TransposeMultiplyVec2(s.q,this.m_axis,cs),o=si.TransposeMultiplyVec2(n.q,$e.Negate(this.m_axis,$e.s_t0),ms);t[0]=this.m_proxyA.GetSupport(i),e[0]=this.m_proxyB.GetSupport(o);const r=this.m_proxyA.GetVertex(t[0]),h=this.m_proxyB.GetVertex(e[0]),a=ni.MultiplyVec2(s,r,hs),l=ni.MultiplyVec2(n,h,as);return $e.Dot($e.Subtract(l,a,$e.s_t0),this.m_axis)}case ds.e_faceA:{const i=si.MultiplyVec2(s.q,this.m_axis,ls),o=ni.MultiplyVec2(s,this.m_localPoint,hs),r=si.TransposeMultiplyVec2(n.q,$e.Negate(i,$e.s_t0),ms);t[0]=-1,e[0]=this.m_proxyB.GetSupport(r);const h=this.m_proxyB.GetVertex(e[0]),a=ni.MultiplyVec2(n,h,as);return $e.Dot($e.Subtract(a,o,$e.s_t0),i)}case ds.e_faceB:{const i=si.MultiplyVec2(n.q,this.m_axis,ls),o=ni.MultiplyVec2(n,this.m_localPoint,as),r=si.TransposeMultiplyVec2(s.q,$e.Negate(i,$e.s_t0),cs);e[0]=-1,t[0]=this.m_proxyA.GetSupport(r);const h=this.m_proxyA.GetVertex(t[0]),a=ni.MultiplyVec2(s,h,hs);return $e.Dot($e.Subtract(a,o,$e.s_t0),i)}default:return t[0]=-1,e[0]=-1,0}}Evaluate(t,e,i){const s=this.m_sweepA.GetTransform(os,i),n=this.m_sweepB.GetTransform(rs,i);switch(this.m_type){case ds.e_points:{const i=this.m_proxyA.GetVertex(t),o=this.m_proxyB.GetVertex(e),r=ni.MultiplyVec2(s,i,hs),h=ni.MultiplyVec2(n,o,as);return $e.Dot($e.Subtract(h,r,$e.s_t0),this.m_axis)}case ds.e_faceA:{const t=si.MultiplyVec2(s.q,this.m_axis,ls),i=ni.MultiplyVec2(s,this.m_localPoint,hs),o=this.m_proxyB.GetVertex(e),r=ni.MultiplyVec2(n,o,as);return $e.Dot($e.Subtract(r,i,$e.s_t0),t)}case ds.e_faceB:{const e=si.MultiplyVec2(n.q,this.m_axis,ls),i=ni.MultiplyVec2(n,this.m_localPoint,as),o=this.m_proxyA.GetVertex(t),r=ni.MultiplyVec2(s,o,hs);return $e.Dot($e.Subtract(r,i,$e.s_t0),e)}default:return Oe(!1),0}}},vs=[0],xs=[0],ws=new oi,As=new oi;function gs(t,e){++ns.calls,t.state=_s.e_unknown,t.t=e.tMax;const{proxyA:i,proxyB:s,tMax:n}=e,o=Math.max(8,i.m_count,s.m_count),r=ws.Copy(e.sweepA),h=As.Copy(e.sweepB);r.Normalize(),h.Normalize();const a=i.m_radius+s.m_radius,l=Math.max(ze,a-.015),c=.00125;let m=0,_=0;const d=us;d.count=0;const u=ps;for(u.proxyA.Copy(e.proxyA),u.proxyB.Copy(e.proxyB),u.useRadii=!1;;){const e=r.GetTransform(os,m),a=h.GetTransform(rs,m);u.transformA.Copy(e),u.transformB.Copy(a);const p=fs;if(Ci(p,d,u),p.distance<=0){t.state=_s.e_overlapped,t.t=0;break}if(p.distance<l+c){t.state=_s.e_touching,t.t=m;break}const f=ys;f.Initialize(d,i,r,s,h,m);let y=!1,v=n,x=0;for(;;){const e=vs,i=xs;let s=f.FindMinSeparation(e,i,v);if(s>l+c){t.state=_s.e_separated,t.t=n,y=!0;break}if(s>l-c){m=v;break}let r=f.Evaluate(e[0],i[0],m);if(r<l-c){t.state=_s.e_failed,t.t=m,y=!0;break}if(r<=l+c){t.state=_s.e_touching,t.t=m,y=!0;break}let h=0,a=m,_=v;for(;;){let t;t=1&h?a+(l-r)*(_-a)/(s-r):.5*(a+_),++h,++ns.rootIters;const n=f.Evaluate(e[0],i[0],t);if(Math.abs(n-l)<c){v=t;break}if(n>l?(a=t,r=n):(_=t,s=n),50===h)break}if(ns.maxRootIters=Math.max(ns.maxRootIters,h),++x,x===o)break}if(++_,++ns.iters,y)break;if(20===_){t.state=_s.e_failed,t.t=m;break}}ns.maxIters=Math.max(ns.maxIters,_)}const bs=new $e,Ss=new $e,Bs=new $e,Cs=new $e,Rs=new $e,Is=new ni,Gs=new $e,Ms=new $e;function Ts(t,e,i,s,n){const o=e.m_count,r=s.m_count,h=e.m_normals,a=e.m_vertices,l=s.m_vertices,c=ni.TransposeMultiply(n,i,Is);let m=0,_=-ke;for(let t=0;t<o;++t){const e=si.MultiplyVec2(c.q,h[t],Gs),i=ni.MultiplyVec2(c,a[t],Ms);let s=ke;for(let t=0;t<r;++t){const n=$e.Dot(e,$e.Subtract(l[t],i,$e.s_t0));n<s&&(s=n)}s>_&&(_=s,m=t)}return t[0]=m,_}const Ds=new $e,Ls=[new Fi,new Fi],Ps=[new Fi,new Fi],Fs=[new Fi,new Fi],Es=[0],Os=[0],Vs=new $e,ks=new $e,Us=new $e,Xs=new $e,zs=new $e,Ns=new $e,Ys=new $e,Ws=new $e;const qs=new $e,Hs=new $e,js=new $e,Js=new $e,Zs=new $e,Ks=new $e,Qs=new $e,$s=new Ti;function tn(t,e,i,s,n){t.pointCount=0;const o=ni.TransposeMultiplyVec2(i,ni.MultiplyVec2(n,s.m_p,$e.s_t0),qs),r=e.m_vertex1,h=e.m_vertex2,a=$e.Subtract(h,r,Hs),l=Qs.Set(a.y,-a.x),c=$e.Dot(l,$e.Subtract(o,r,$e.s_t0));if(e.m_oneSided&&c<0)return;const m=$e.Dot(a,$e.Subtract(h,o,$e.s_t0)),_=$e.Dot(a,$e.Subtract(o,r,$e.s_t0)),d=e.m_radius+s.m_radius,u=$s;if(u.cf.indexB=0,u.cf.typeB=Ri.e_vertex,_<=0){const i=r,n=$e.Subtract(o,i,js);if($e.Dot(n,n)>d*d)return;if(e.m_oneSided){const t=e.m_vertex0,i=r,s=$e.Subtract(i,t,Js);if($e.Dot(s,$e.Subtract(i,o,$e.s_t0))>0)return}return u.cf.indexA=0,u.cf.typeA=Ri.e_vertex,t.pointCount=1,t.type=Ii.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(u),void t.points[0].localPoint.Copy(s.m_p)}if(m<=0){const i=h,n=$e.Subtract(o,i,js);if($e.Dot(n,n)>d*d)return;if(e.m_oneSided){const t=e.m_vertex3,i=h,s=$e.Subtract(t,i,Zs);if($e.Dot(s,$e.Subtract(o,i,$e.s_t0))>0)return}return u.cf.indexA=1,u.cf.typeA=Ri.e_vertex,t.pointCount=1,t.type=Ii.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(u),void t.points[0].localPoint.Copy(s.m_p)}const p=$e.Dot(a,a),f=Ks;f.x=1/p*(m*r.x+_*h.x),f.y=1/p*(m*r.y+_*h.y);const y=$e.Subtract(o,f,js);$e.Dot(y,y)>d*d||(c<0&&l.Set(-l.x,-l.y),l.Normalize(),u.cf.indexA=0,u.cf.typeA=Ri.e_face,t.pointCount=1,t.type=Ii.e_faceA,t.localNormal.Copy(l),t.localPoint.Copy(r),t.points[0].id.Copy(u),t.points[0].localPoint.Copy(s.m_p))}var en;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(en||(en={}));class sn{constructor(){this.normal=new $e,this.type=en.e_unknown,this.index=0,this.separation=0}}const nn=new sn,on=[new $e,new $e],rn=new sn,hn=new $e,an=new ni,ln=new $e,cn=new $e,mn=new $e,_n=new $e,dn=new $e,un=new $e,pn=new $e,fn=new class{constructor(){this.vertices=Ze(8,$e),this.normals=Ze(8,$e),this.count=0}},yn=new class{constructor(){this.i1=0,this.i2=0,this.v1=new $e,this.v2=new $e,this.normal=new $e,this.sideNormal1=new $e,this.sideOffset1=0,this.sideNormal2=new $e,this.sideOffset2=0}},vn=[new Fi,new Fi],xn=[new Fi,new Fi],wn=[new Fi,new Fi];function An(t,e,i,s,n){t.pointCount=0;const o=ni.TransposeMultiply(i,n,an),r=ni.MultiplyVec2(o,s.m_centroid,ln),h=e.m_vertex1,a=e.m_vertex2,l=$e.Subtract(a,h,cn);l.Normalize();const c=mn.Set(l.y,-l.x),m=$e.Dot(c,$e.Subtract(r,h,$e.s_t0)),_=e.m_oneSided;if(_&&m<0)return;const d=fn;d.count=s.m_count;for(let t=0;t<s.m_count;++t)ni.MultiplyVec2(o,s.m_vertices[t],d.vertices[t]),si.MultiplyVec2(o.q,s.m_normals[t],d.normals[t]);const u=s.m_radius+e.m_radius,p=function(t,e,i){const s=nn;s.type=en.e_edgeA,s.index=-1,s.separation=-ke,s.normal.SetZero();const n=on;n[0].Copy(i),$e.Negate(i,n[1]);for(let i=0;i<2;++i){let o=ke;for(let s=0;s<t.count;++s){const r=$e.Dot(n[i],$e.Subtract(t.vertices[s],e,$e.s_t0));r<o&&(o=r)}o>s.separation&&(s.index=i,s.separation=o,s.normal.Copy(n[i]))}return s}(d,h,c);if(p.separation>u)return;const f=function(t,e,i){const s=rn;s.type=en.e_unknown,s.index=-1,s.separation=-ke,s.normal.SetZero();for(let n=0;n<t.count;++n){const o=$e.Negate(t.normals[n],hn),r=$e.Dot(o,$e.Subtract(t.vertices[n],e,$e.s_t0)),h=$e.Dot(o,$e.Subtract(t.vertices[n],i,$e.s_t0)),a=Math.min(r,h);a>s.separation&&(s.type=en.e_edgeB,s.index=n,s.separation=a,s.normal.Copy(o))}return s}(d,h,a);if(f.separation>u)return;let y;if(y=f.separation-u>.98*(p.separation-u)+.001?f:p,_){const t=$e.Subtract(h,e.m_vertex0,_n);t.Normalize();const i=dn.Set(t.y,-t.x),s=$e.Cross(t,l)>=0,n=$e.Subtract(e.m_vertex3,a,un);n.Normalize();const o=pn.Set(n.y,-n.x),r=$e.Cross(l,n)>=0,c=.1;if($e.Dot(y.normal,l)<=0)if(s){if($e.Cross(y.normal,i)>c)return}else y=p;else if(r){if($e.Cross(o,y.normal)>c)return}else y=p}const v=vn,x=yn;if(y.type===en.e_edgeA){t.type=Ii.e_faceA;let e=0,i=$e.Dot(y.normal,d.normals[0]);for(let t=1;t<d.count;++t){const s=$e.Dot(y.normal,d.normals[t]);s<i&&(i=s,e=t)}const s=e,n=s+1<d.count?s+1:0;v[0].v.Copy(d.vertices[s]),v[0].id.cf.indexA=0,v[0].id.cf.indexB=s,v[0].id.cf.typeA=Ri.e_face,v[0].id.cf.typeB=Ri.e_vertex,v[1].v.Copy(d.vertices[n]),v[1].id.cf.indexA=0,v[1].id.cf.indexB=n,v[1].id.cf.typeA=Ri.e_face,v[1].id.cf.typeB=Ri.e_vertex,x.i1=0,x.i2=1,x.v1.Copy(h),x.v2.Copy(a),x.normal.Copy(y.normal),$e.Negate(l,x.sideNormal1),x.sideNormal2.Copy(l)}else t.type=Ii.e_faceB,v[0].v.Copy(a),v[0].id.cf.indexA=1,v[0].id.cf.indexB=y.index,v[0].id.cf.typeA=Ri.e_vertex,v[0].id.cf.typeB=Ri.e_face,v[1].v.Copy(h),v[1].id.cf.indexA=0,v[1].id.cf.indexB=y.index,v[1].id.cf.typeA=Ri.e_vertex,v[1].id.cf.typeB=Ri.e_face,x.i1=y.index,x.i2=x.i1+1<d.count?x.i1+1:0,x.v1.Copy(d.vertices[x.i1]),x.v2.Copy(d.vertices[x.i2]),x.normal.Copy(d.normals[x.i1]),x.sideNormal1.Set(x.normal.y,-x.normal.x),$e.Negate(x.sideNormal1,x.sideNormal2);x.sideOffset1=$e.Dot(x.sideNormal1,x.v1),x.sideOffset2=$e.Dot(x.sideNormal2,x.v2);const w=xn,A=wn;let g;if(g=Vi(w,v,x.sideNormal1,x.sideOffset1,x.i1),g<2)return;if(g=Vi(A,w,x.sideNormal2,x.sideOffset2,x.i2),g<2)return;y.type===en.e_edgeA?(t.localNormal.Copy(x.normal),t.localPoint.Copy(x.v1)):(t.localNormal.Copy(s.m_normals[x.i1]),t.localPoint.Copy(s.m_vertices[x.i1]));let b=0;for(let e=0;e<2;++e)if($e.Dot(x.normal,$e.Subtract(A[e].v,x.v1,$e.s_t0))<=u){const i=t.points[b];y.type===en.e_edgeA?(ni.TransposeMultiplyVec2(o,A[e].v,i.localPoint),i.id.Copy(A[e].id)):(i.localPoint.Copy(A[e].v),i.id.cf.typeA=A[e].id.cf.typeB,i.id.cf.typeB=A[e].id.cf.typeA,i.id.cf.indexA=A[e].id.cf.indexB,i.id.cf.indexB=A[e].id.cf.indexA),++b}t.pointCount=b}class gn extends ci{constructor(t=0){super(li.e_circle,t),this.m_p=new $e}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return(new gn).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=ni.MultiplyVec2(t,this.m_p,gn.TestPoint_s_center),s=$e.Subtract(e,i,gn.TestPoint_s_d);return $e.Dot(s,s)<=this.m_radius**2}RayCast(t,e,i,s){const n=ni.MultiplyVec2(i,this.m_p,gn.RayCast_s_position),o=$e.Subtract(e.p1,n,gn.RayCast_s_s),r=$e.Dot(o,o)-this.m_radius**2,h=$e.Subtract(e.p2,e.p1,gn.RayCast_s_r),a=$e.Dot(o,h),l=$e.Dot(h,h),c=a*a-l*r;if(c<0||l<Ue)return!1;let m=-(a+Math.sqrt(c));return m>=0&&m<=e.maxFraction*l&&(m/=l,t.fraction=m,$e.AddScaled(o,m,h,t.normal).Normalize(),!0)}ComputeAABB(t,e,i){const s=ni.MultiplyVec2(e,this.m_p,gn.ComputeAABB_s_p);t.lowerBound.Set(s.x-this.m_radius,s.y-this.m_radius),t.upperBound.Set(s.x+this.m_radius,s.y+this.m_radius)}ComputeMass(t,e){const i=this.m_radius**2;t.mass=e*Math.PI*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+$e.Dot(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}Draw(t,e){const i=this.m_p,s=this.m_radius;$e.UNITX,t.DrawCircle(i,s,e)}}gn.TestPoint_s_center=new $e,gn.TestPoint_s_d=new $e,gn.RayCast_s_position=new $e,gn.RayCast_s_s=new $e,gn.RayCast_s_r=new $e,gn.ComputeAABB_s_p=new $e;const bn={ComputeCentroid:{s:new $e,p1:new $e,p2:new $e,p3:new $e,e1:new $e,e2:new $e},TestPoint:{pLocal:new $e},ComputeAABB:{v:new $e},ComputeMass:{center:new $e,s:new $e,e1:new $e,e2:new $e},Validate:{e:new $e,v:new $e},Set:{r:new $e,v:new $e},RayCast:{p1:new $e,p2:new $e,d:new $e},SetAsBox:{xf:new ni}};class Sn extends ci{constructor(){super(li.e_polygon,Ye),this.m_centroid=new $e,this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new Sn).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=Ze(this.m_count,$e),this.m_normals=Ze(this.m_count,$e);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(t,e=t.length){if(e<3)return this.SetAsBox(1,1);let i=Math.min(e,8);const s=[];for(let e=0;e<i;++e){const i=t[e];s.every((t=>$e.DistanceSquared(i,t)>=625e-8))&&s.push(i)}if(i=s.length,i<3)return this.SetAsBox(1,1);let n=0,o=s[0].x;for(let t=1;t<i;++t){const{x:e}=s[t];(e>o||e===o&&s[t].y<s[n].y)&&(n=t,o=e)}const r=[];let h=0,a=n;for(;;){r[h]=a;let t=0;for(let e=1;e<i;++e){if(t===a){t=e;continue}const i=$e.Subtract(s[t],s[r[h]],bn.Set.r),n=$e.Subtract(s[e],s[r[h]],bn.Set.v),o=$e.Cross(i,n);o<0&&(t=e),0===o&&n.LengthSquared()>i.LengthSquared()&&(t=e)}if(++h,a=t,t===n)break}Oe(h>=3,"Polygon is degenerate"),this.m_count=h,this.m_vertices=Ze(this.m_count,$e),this.m_normals=Ze(this.m_count,$e);for(let t=0;t<h;++t)this.m_vertices[t].Copy(s[r[t]]);for(let t=0;t<h;++t){const e=t,i=t+1<h?t+1:0,s=$e.Subtract(this.m_vertices[i],this.m_vertices[e],$e.s_t0);$e.CrossVec2One(s,this.m_normals[t]).Normalize()}return function(t,e,i){const s=i;s.SetZero();let n=0;const{s:o,p1:r,p2:h,p3:a,e1:l,e2:c}=bn.ComputeCentroid;o.Copy(t[0]);const m=1/3;for(let i=0;i<e;++i){$e.Subtract(t[0],o,r),$e.Subtract(t[i],o,h),$e.Subtract(t[i+1<e?i+1:0],o,a),$e.Subtract(h,r,l),$e.Subtract(a,r,c);const _=.5*$e.Cross(l,c);n+=_,s.x+=_*m*(r.x+h.x+a.x),s.y+=_*m*(r.y+h.y+a.y)}const _=1/n;s.x=_*s.x+o.x,s.y=_*s.y+o.y}(this.m_vertices,h,this.m_centroid),this}SetAsBox(t,e,i,s=0){if(this.m_count=4,this.m_vertices=Ze(this.m_count,$e),this.m_normals=Ze(this.m_count,$e),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),i){this.m_centroid.Copy(i);const{xf:t}=bn.SetAsBox;t.SetPosition(i),t.SetRotationAngle(s);for(let e=0;e<this.m_count;++e)ni.MultiplyVec2(t,this.m_vertices[e],this.m_vertices[e]),si.MultiplyVec2(t.q,this.m_normals[e],this.m_normals[e])}else this.m_centroid.SetZero();return this}TestPoint(t,e){const i=ni.TransposeMultiplyVec2(t,e,bn.TestPoint.pLocal);for(let t=0;t<this.m_count;++t)if($e.Dot(this.m_normals[t],$e.Subtract(i,this.m_vertices[t],$e.s_t0))>0)return!1;return!0}RayCast(t,e,i,s){const n=ni.TransposeMultiplyVec2(i,e.p1,bn.RayCast.p1),o=ni.TransposeMultiplyVec2(i,e.p2,bn.RayCast.p2),r=$e.Subtract(o,n,bn.RayCast.d);let h=0,a=e.maxFraction,l=-1;for(let t=0;t<this.m_count;++t){const e=$e.Dot(this.m_normals[t],$e.Subtract(this.m_vertices[t],n,$e.s_t0)),i=$e.Dot(this.m_normals[t],r);if(0===i){if(e<0)return!1}else i<0&&e<h*i?(h=e/i,l=t):i>0&&e<a*i&&(a=e/i);if(a<h)return!1}return l>=0&&(t.fraction=h,si.MultiplyVec2(i.q,this.m_normals[l],t.normal),!0)}ComputeAABB(t,e,i){const s=ni.MultiplyVec2(e,this.m_vertices[0],t.lowerBound),n=t.upperBound.Copy(s);for(let t=1;t<this.m_count;++t){const i=ni.MultiplyVec2(e,this.m_vertices[t],bn.ComputeAABB.v);$e.Min(s,i,s),$e.Max(n,i,n)}const o=this.m_radius;s.SubtractXY(o,o),n.AddXY(o,o)}ComputeMass(t,e){const i=bn.ComputeMass.center.SetZero();let s=0,n=0;const o=bn.ComputeMass.s.Copy(this.m_vertices[0]),r=1/3;for(let t=0;t<this.m_count;++t){const e=$e.Subtract(this.m_vertices[t],o,bn.ComputeMass.e1),h=$e.Subtract(this.m_vertices[t+1<this.m_count?t+1:0],o,bn.ComputeMass.e2),a=$e.Cross(e,h),l=.5*a;s+=l,i.AddScaled(l*r,$e.Add(e,h,$e.s_t0));const c=e.x,m=e.y,_=h.x,d=h.y;n+=.25*r*a*(c*c+_*c+_*_+(m*m+d*m+d*d))}t.mass=e*s,i.Scale(1/s),$e.Add(i,o,t.center),t.I=e*n,t.I+=t.mass*($e.Dot(t.center,t.center)-$e.Dot(i,i))}Validate(){const{e:t,v:e}=bn.Validate;for(let i=0;i<this.m_count;++i){const s=i,n=i<this.m_count-1?s+1:0,o=this.m_vertices[s];$e.Subtract(this.m_vertices[n],o,t);for(let i=0;i<this.m_count;++i)if(i!==s&&i!==n&&($e.Subtract(this.m_vertices[i],o,e),$e.Cross(t,e)<0))return!1}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}Draw(t,e){const i=this.m_count,s=this.m_vertices;t.DrawPolygon(s,i,e)}}class Bn extends ci{constructor(){super(li.e_edge,Ye),this.m_vertex1=new $e,this.m_vertex2=new $e,this.m_vertex0=new $e,this.m_vertex3=new $e,this.m_oneSided=!1}SetOneSided(t,e,i,s){return this.m_vertex0.Copy(t),this.m_vertex1.Copy(e),this.m_vertex2.Copy(i),this.m_vertex3.Copy(s),this.m_oneSided=!0,this}SetTwoSided(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_oneSided=!1,this}Clone(){return(new Bn).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_oneSided=t.m_oneSided,this}GetChildCount(){return 1}TestPoint(t,e){return!1}RayCast(t,e,i,s){const n=ni.TransposeMultiplyVec2(i,e.p1,Bn.RayCast_s_p1),o=ni.TransposeMultiplyVec2(i,e.p2,Bn.RayCast_s_p2),r=$e.Subtract(o,n,Bn.RayCast_s_d),h=this.m_vertex1,a=this.m_vertex2,l=$e.Subtract(a,h,Bn.RayCast_s_e),{normal:c}=t;c.Set(l.y,-l.x).Normalize();const m=$e.Dot(c,$e.Subtract(h,n,$e.s_t0));if(this.m_oneSided&&m>0)return!1;const _=$e.Dot(c,r);if(0===_)return!1;const d=m/_;if(d<0||e.maxFraction<d)return!1;const u=$e.AddScaled(n,d,r,Bn.RayCast_s_q),p=$e.Subtract(a,h,Bn.RayCast_s_r),f=$e.Dot(p,p);if(0===f)return!1;const y=$e.Dot($e.Subtract(u,h,$e.s_t0),p)/f;return!(y<0||y>1||(t.fraction=d,si.MultiplyVec2(i.q,t.normal,t.normal),m>0&&t.normal.Negate(),0))}ComputeAABB(t,e,i){const s=ni.MultiplyVec2(e,this.m_vertex1,Bn.ComputeAABB_s_v1),n=ni.MultiplyVec2(e,this.m_vertex2,Bn.ComputeAABB_s_v2);$e.Min(s,n,t.lowerBound),$e.Max(s,n,t.upperBound);const o=this.m_radius;t.lowerBound.SubtractXY(o,o),t.upperBound.AddXY(o,o)}ComputeMass(t,e){t.mass=0,$e.Mid(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}Draw(t,e){const i=this.m_vertex1,s=this.m_vertex2;t.DrawSegment(i,s,e),!1===this.m_oneSided&&(t.DrawPoint(i,4,e),t.DrawPoint(s,4,e))}}Bn.RayCast_s_p1=new $e,Bn.RayCast_s_p2=new $e,Bn.RayCast_s_d=new $e,Bn.RayCast_s_e=new $e,Bn.RayCast_s_q=new $e,Bn.RayCast_s_r=new $e,Bn.ComputeAABB_s_v1=new $e,Bn.ComputeAABB_s_v2=new $e;class Cn extends ci{constructor(){super(li.e_chain,Ye),this.m_vertices=[],this.m_prevVertex=new $e,this.m_nextVertex=new $e}CreateLoop(t,e=t.length){if(e<3)return this;this.m_vertices.length=e+1;for(let i=0;i<e;++i){const{x:e,y:s}=t[i];this.m_vertices[i]=new $e(e,s)}return this.m_vertices[e]=this.m_vertices[0].Clone(),this.m_prevVertex.Copy(this.m_vertices[this.m_vertices.length-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this}CreateChain(t,e,i,s){this.m_vertices.length=e;for(let i=0;i<e;++i){const{x:e,y:s}=t[i];this.m_vertices[i]=new $e(e,s)}return this.m_prevVertex.Copy(i),this.m_nextVertex.Copy(s),this}Clone(){return(new Cn).Copy(this)}Copy(t){return super.Copy(t),this.CreateChain(t.m_vertices,t.m_vertices.length,t.m_prevVertex,t.m_nextVertex)}GetChildCount(){return this.m_vertices.length-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),t.m_oneSided=!0,e>0?t.m_vertex0.Copy(this.m_vertices[e-1]):t.m_vertex0.Copy(this.m_prevVertex),e<this.m_vertices.length-2?t.m_vertex3.Copy(this.m_vertices[e+2]):t.m_vertex3.Copy(this.m_nextVertex)}TestPoint(t,e){return!1}RayCast(t,e,i,s){const n=Cn.RayCast_s_edgeShape,o=s;let r=s+1;return r===this.m_vertices.length&&(r=0),n.m_vertex1.Copy(this.m_vertices[o]),n.m_vertex2.Copy(this.m_vertices[r]),n.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const s=i;let n=i+1;n===this.m_vertices.length&&(n=0);const o=ni.MultiplyVec2(e,this.m_vertices[s],Cn.ComputeAABB_s_v1),r=ni.MultiplyVec2(e,this.m_vertices[n],Cn.ComputeAABB_s_v2),h=$e.Min(o,r,Cn.ComputeAABB_s_lower),a=$e.Max(o,r,Cn.ComputeAABB_s_upper);t.lowerBound.x=h.x-this.m_radius,t.lowerBound.y=h.y-this.m_radius,t.upperBound.x=a.x+this.m_radius,t.upperBound.y=a.y+this.m_radius}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_vertices.length?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}Draw(t,e){const i=this.m_vertices;let s=i[0];for(let n=1;n<i.length;++n){const o=i[n];t.DrawSegment(s,o,e),s=o}}}Cn.RayCast_s_edgeShape=new Bn,Cn.ComputeAABB_s_v1=new $e,Cn.ComputeAABB_s_v2=new $e,Cn.ComputeAABB_s_lower=new $e,Cn.ComputeAABB_s_upper=new $e;const Rn={pA:new $e,pB:new $e};var In;!function(t){t[t.e_unknownJoint=0]="e_unknownJoint",t[t.e_revoluteJoint=1]="e_revoluteJoint",t[t.e_prismaticJoint=2]="e_prismaticJoint",t[t.e_distanceJoint=3]="e_distanceJoint",t[t.e_pulleyJoint=4]="e_pulleyJoint",t[t.e_mouseJoint=5]="e_mouseJoint",t[t.e_gearJoint=6]="e_gearJoint",t[t.e_wheelJoint=7]="e_wheelJoint",t[t.e_weldJoint=8]="e_weldJoint",t[t.e_frictionJoint=9]="e_frictionJoint",t[t.e_motorJoint=10]="e_motorJoint",t[t.e_areaJoint=11]="e_areaJoint"}(In||(In={}));class Gn{constructor(t,e){this.prev=null,this.next=null,this.joint=t,this.other=e}}class Mn{constructor(t){this.userData=null,this.collideConnected=!1,this.type=t}}class Tn{constructor(t){var e;this.m_type=In.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA=new Gn(this,t.bodyB),this.m_edgeB=new Gn(this,t.bodyA),this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=null!==(e=t.collideConnected)&&void 0!==e&&e,this.m_userData=t.userData}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsEnabled(){return this.m_bodyA.IsEnabled()&&this.m_bodyB.IsEnabled()}GetCollideConnected(){return this.m_collideConnected}ShiftOrigin(t){}Draw(t){const e=this.m_bodyA.GetTransform().p,i=this.m_bodyB.GetTransform().p,s=this.GetAnchorA(Rn.pA),n=this.GetAnchorB(Rn.pB);t.DrawSegment(e,s,hi.joint6),t.DrawSegment(s,n,hi.joint6),t.DrawSegment(i,n,hi.joint6)}}const Dn={worldPointA:new $e,worldPointB:new $e,vpA:new $e,vpB:new $e,vpBA:new $e,P:new $e,qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,Draw:{pA:new $e,pB:new $e,axis:new $e,pRest:new $e,p1:new $e,p2:new $e}};class Ln extends Mn{constructor(){super(In.e_distanceJoint),this.localAnchorA=new $e,this.localAnchorB=new $e,this.length=1,this.minLength=0,this.maxLength=ke,this.stiffness=0,this.damping=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.length=Math.max($e.Distance(i,s),ze),this.minLength=this.length,this.maxLength=this.length}}class Pn extends Tn{constructor(t){var e,i;super(t),this.m_bias=0,this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_gamma=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new $e,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_currentLength=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_softMass=0,this.m_mass=0,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=Math.max(t.length,ze),this.m_minLength=Math.max(t.minLength,ze),this.m_maxLength=Math.max(t.maxLength,this.m_minLength),this.m_stiffness=null!==(e=t.stiffness)&&void 0!==e?e:0,this.m_damping=null!==(i=t.damping)&&void 0!==i?i:0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){const i=t*(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse);return e.x=i*this.m_u.x,e.y=i*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){return this.m_impulse=0,this.m_length=Math.max(ze,t),this.m_length}GetLength(){return this.m_length}SetMinLength(t){return this.m_lowerImpulse=0,this.m_minLength=Qe(t,ze,this.m_maxLength),this.m_minLength}GetMinLength(){return this.m_minLength}SetMaxLength(t){return this.m_upperImpulse=0,this.m_maxLength=Math.max(t,this.m_minLength),this.m_maxLength}GetMaxLength(){return this.m_maxLength}GetCurrentLength(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Dn.worldPointA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Dn.worldPointB);return $e.Distance(e,t)}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const{qA:l,qB:c,lalcA:m,lalcB:_}=Dn;l.Set(i),c.Set(r),si.MultiplyVec2(l,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,m),this.m_rA),si.MultiplyVec2(c,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,_),this.m_rB),this.m_u.x=o.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=o.y+this.m_rB.y-e.y-this.m_rA.y,this.m_currentLength=this.m_u.Length(),this.m_currentLength>ze?this.m_u.Scale(1/this.m_currentLength):(this.m_u.SetZero(),this.m_mass=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0);const d=$e.Cross(this.m_rA,this.m_u),u=$e.Cross(this.m_rB,this.m_u);let p=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*u*u;if(this.m_mass=0!==p?1/p:0,this.m_stiffness>0&&this.m_minLength<this.m_maxLength){const e=this.m_currentLength-this.m_length,i=this.m_damping,s=this.m_stiffness,n=t.step.dt;this.m_gamma=n*(i+n*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*n*s*this.m_gamma,p+=this.m_gamma,this.m_softMass=0!==p?1/p:0}else this.m_gamma=0,this.m_bias=0,this.m_softMass=this.m_mass;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const{P:e}=Dn;$e.Scale(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse,this.m_u,e),s.SubtractScaled(this.m_invMassA,e),n-=this.m_invIA*$e.Cross(this.m_rA,e),h.AddScaled(this.m_invMassB,e),a+=this.m_invIB*$e.Cross(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;if(this.m_minLength<this.m_maxLength){if(this.m_stiffness>0){const t=$e.AddCrossScalarVec2(e,i,this.m_rA,Dn.vpA),o=$e.AddCrossScalarVec2(s,n,this.m_rB,Dn.vpB),r=$e.Dot(this.m_u,$e.Subtract(o,t,Dn.vpBA)),h=-this.m_softMass*(r+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;const a=$e.Scale(h,this.m_u,Dn.P);e.SubtractScaled(this.m_invMassA,a),i-=this.m_invIA*$e.Cross(this.m_rA,a),s.AddScaled(this.m_invMassB,a),n+=this.m_invIB*$e.Cross(this.m_rB,a)}{const o=this.m_currentLength-this.m_minLength,r=Math.max(0,o)*t.step.inv_dt,h=$e.AddCrossScalarVec2(e,i,this.m_rA,Dn.vpA),a=$e.AddCrossScalarVec2(s,n,this.m_rB,Dn.vpB),l=$e.Dot(this.m_u,$e.Subtract(a,h,Dn.vpBA));let c=-this.m_mass*(l+r);const m=this.m_lowerImpulse;this.m_lowerImpulse=Math.max(0,this.m_lowerImpulse+c),c=this.m_lowerImpulse-m;const _=$e.Scale(c,this.m_u,Dn.P);e.SubtractScaled(this.m_invMassA,_),i-=this.m_invIA*$e.Cross(this.m_rA,_),s.AddScaled(this.m_invMassB,_),n+=this.m_invIB*$e.Cross(this.m_rB,_)}{const o=this.m_maxLength-this.m_currentLength,r=Math.max(0,o)*t.step.inv_dt,h=$e.AddCrossScalarVec2(e,i,this.m_rA,Dn.vpA),a=$e.AddCrossScalarVec2(s,n,this.m_rB,Dn.vpB),l=$e.Dot(this.m_u,$e.Subtract(h,a,Dn.vpBA));let c=-this.m_mass*(l+r);const m=this.m_upperImpulse;this.m_upperImpulse=Math.max(0,this.m_upperImpulse+c),c=this.m_upperImpulse-m;const _=$e.Scale(-c,this.m_u,Dn.P);e.SubtractScaled(this.m_invMassA,_),i-=this.m_invIA*$e.Cross(this.m_rA,_),s.AddScaled(this.m_invMassB,_),n+=this.m_invIB*$e.Cross(this.m_rB,_)}}else{const t=$e.AddCrossScalarVec2(e,i,this.m_rA,Dn.vpA),o=$e.AddCrossScalarVec2(s,n,this.m_rB,Dn.vpB),r=$e.Dot(this.m_u,$e.Subtract(o,t,Dn.vpBA)),h=-this.m_mass*r;this.m_impulse+=h;const a=$e.Scale(h,this.m_u,Dn.P);e.SubtractScaled(this.m_invMassA,a),i-=this.m_invIA*$e.Cross(this.m_rA,a),s.AddScaled(this.m_invMassB,a),n+=this.m_invIB*$e.Cross(this.m_rB,a)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const{qA:o,qB:r,lalcA:h,lalcB:a,P:l}=Dn;o.Set(i),r.Set(n);const c=si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,h),this.m_rA),m=si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,a),this.m_rB);this.m_u.x=s.x+m.x-e.x-c.x,this.m_u.y=s.y+m.y-e.y-c.y;const _=this.m_u.Normalize();let d;if(this.m_minLength===this.m_maxLength)d=_-this.m_minLength;else if(_<this.m_minLength)d=_-this.m_minLength;else{if(!(this.m_maxLength<_))return!0;d=_-this.m_maxLength}const u=-this.m_mass*d;return $e.Scale(u,this.m_u,l),e.SubtractScaled(this.m_invMassA,l),i-=this.m_invIA*$e.Cross(c,l),s.AddScaled(this.m_invMassB,l),n+=this.m_invIB*$e.Cross(m,l),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,Math.abs(d)<ze}Draw(t){const{pA:e,pB:i,axis:s,pRest:n}=Dn.Draw,o=this.m_bodyA.GetTransform(),r=this.m_bodyB.GetTransform();if(ni.MultiplyVec2(o,this.m_localAnchorA,e),ni.MultiplyVec2(r,this.m_localAnchorB,i),$e.Subtract(i,e,s),s.Normalize(),t.DrawSegment(e,i,hi.joint5),$e.AddScaled(e,this.m_length,s,n),t.DrawPoint(n,8,hi.joint1),this.m_minLength!==this.m_maxLength){if(this.m_minLength>ze){const i=$e.AddScaled(e,this.m_minLength,s,Dn.Draw.p1);t.DrawPoint(i,4,hi.joint2)}if(this.m_maxLength<ke){const i=$e.AddScaled(e,this.m_maxLength,s,Dn.Draw.p1);t.DrawPoint(i,4,hi.joint3)}}}}class Fn extends Tn{constructor(t){var e,i;super(t),this.m_stiffness=0,this.m_damping=0,this.m_impulse=0,this.m_targetArea=0,this.m_joints=[],this.m_delta=new $e,this.m_bodies=t.bodies,this.m_stiffness=null!==(e=t.stiffness)&&void 0!==e?e:0,this.m_damping=null!==(i=t.damping)&&void 0!==i?i:0,this.m_targetLengths=Je(t.bodies.length),this.m_normals=Ze(t.bodies.length,$e),this.m_deltas=Ze(t.bodies.length,$e);const s=new Ln;s.stiffness=this.m_stiffness,s.damping=this.m_damping,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const e=this.m_bodies[t],i=this.m_bodies[(t+1)%this.m_bodies.length],n=e.GetWorldCenter(),o=i.GetWorldCenter();this.m_targetLengths[t]=$e.Distance(n,o),this.m_targetArea+=$e.Cross(n,o),s.Initialize(e,i,n,o),this.m_joints[t]=e.GetWorld().CreateJoint(s)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetStiffness(t){this.m_stiffness=t;for(const e of this.m_joints)e.SetStiffness(t)}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t;for(const e of this.m_joints)e.SetDamping(t)}GetDamping(){return this.m_damping}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],s=this.m_bodies[(e+1)%this.m_bodies.length],n=t.positions[i.m_islandIndex].c,o=t.positions[s.m_islandIndex].c,r=this.m_deltas[e];$e.Subtract(o,n,r)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,n=this.m_deltas[e];s.x+=i.m_invMass*n.y*.5*this.m_impulse,s.y+=i.m_invMass*-n.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const n=this.m_bodies[s],o=t.velocities[n.m_islandIndex].v,r=this.m_deltas[s];e+=r.LengthSquared()/n.GetMass(),i+=$e.Cross(o,r)}const s=-2*i/e;this.m_impulse+=s;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,o=this.m_deltas[e];n.x+=i.m_invMass*o.y*.5*s,n.y+=i.m_invMass*-o.x*.5*s}}SolvePositionConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const n=this.m_bodies[s],o=this.m_bodies[(s+1)%this.m_bodies.length],r=t.positions[n.m_islandIndex].c,h=t.positions[o.m_islandIndex].c,a=$e.Subtract(h,r,this.m_delta);let l=a.Length();l<Ue&&(l=1),this.m_normals[s].x=a.y/l,this.m_normals[s].y=-a.x/l,e+=l,i+=$e.Cross(r,h)}i*=.5;const s=.5*(this.m_targetArea-i)/e;let n=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],o=t.positions[i.m_islandIndex].c,r=(e+1)%this.m_bodies.length,h=$e.Add(this.m_normals[e],this.m_normals[r],this.m_delta);h.Scale(s);const a=h.LengthSquared();a>.04000000000000001&&h.Scale(.2/Math.sqrt(a)),a>25e-6&&(n=!1),o.Add(h)}return n}}const En={qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,Cdot:new $e,impulse:new $e,oldImpulse:new $e};class On extends Tn{constructor(t){var e,i;super(t),this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_linearImpulse=new $e,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ei,this.m_angularMass=0,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=null!==(e=t.maxForce)&&void 0!==e?e:0,this.m_maxTorque=null!==(i=t.maxTorque)&&void 0!==i?i:0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const{qA:h,qB:a,lalcA:l,lalcB:c}=En;h.Set(e),a.Set(n),si.MultiplyVec2(h,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,l),this.m_rA),si.MultiplyVec2(a,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,c),this.m_rB);const m=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,u=this.m_invIB,p=this.m_linearMass;if(p.ex.x=m+_+d*this.m_rA.y*this.m_rA.y+u*this.m_rB.y*this.m_rB.y,p.ex.y=-d*this.m_rA.x*this.m_rA.y-u*this.m_rB.x*this.m_rB.y,p.ey.x=p.ex.y,p.ey.y=m+_+d*this.m_rA.x*this.m_rA.x+u*this.m_rB.x*this.m_rB.x,p.Inverse(),this.m_angularMass=d+u,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.Scale(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SubtractScaled(m,e),s-=d*($e.Cross(this.m_rA,e)+this.m_angularImpulse),o.AddScaled(_,e),r+=u*($e.Cross(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,r=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=t.step.dt;{const t=n-i;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,o=l*this.m_maxTorque;this.m_angularImpulse=Qe(this.m_angularImpulse+e,-o,o),e=this.m_angularImpulse-s,i-=h*e,n+=a*e}{const{Cdot:t,impulse:c,oldImpulse:m}=En;$e.Subtract($e.AddCrossScalarVec2(s,n,this.m_rB,$e.s_t0),$e.AddCrossScalarVec2(e,i,this.m_rA,$e.s_t1),t),ei.MultiplyVec2(this.m_linearMass,t,c).Negate(),m.Copy(this.m_linearImpulse),this.m_linearImpulse.Add(c);const _=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>_*_&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Scale(_)),$e.Subtract(this.m_linearImpulse,m,c),e.SubtractScaled(o,c),i-=h*$e.Cross(this.m_rA,c),s.AddScaled(r,c),n+=a*$e.Cross(this.m_rB,c)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}}const Vn={qA:new si,qB:new si,qC:new si,qD:new si,lalcA:new $e,lalcB:new $e,lalcC:new $e,lalcD:new $e,u:new $e,rA:new $e,rB:new $e,rC:new $e,rD:new $e,JvAC:new $e,JvBD:new $e};class kn extends Tn{constructor(t){var e;let i,s;super(t),this.m_typeA=In.e_unknownJoint,this.m_typeB=In.e_unknownJoint,this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_localAnchorC=new $e,this.m_localAnchorD=new $e,this.m_localAxisC=new $e,this.m_localAxisD=new $e,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new $e,this.m_lcB=new $e,this.m_lcC=new $e,this.m_lcD=new $e,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new $e,this.m_JvBD=new $e,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_joint1=t.joint1,this.m_joint2=t.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const n=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,r=this.m_bodyC.m_xf,h=this.m_bodyC.m_sweep.a;if(this.m_typeA===In.e_revoluteJoint){const e=t.joint1;this.m_localAnchorC.Copy(e.m_localAnchorA),this.m_localAnchorA.Copy(e.m_localAnchorB),this.m_referenceAngleA=e.m_referenceAngle,this.m_localAxisC.SetZero(),i=o-h-this.m_referenceAngleA}else{const e=t.joint1;this.m_localAnchorC.Copy(e.m_localAnchorA),this.m_localAnchorA.Copy(e.m_localAnchorB),this.m_referenceAngleA=e.m_referenceAngle,this.m_localAxisC.Copy(e.m_localXAxisA);const s=this.m_localAnchorC,o=si.TransposeMultiplyVec2(r.q,si.MultiplyVec2(n.q,this.m_localAnchorA,$e.s_t0).Add(n.p).Subtract(r.p),$e.s_t0);i=$e.Dot(o.Subtract(s),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const a=this.m_bodyB.m_xf,l=this.m_bodyB.m_sweep.a,c=this.m_bodyD.m_xf,m=this.m_bodyD.m_sweep.a;if(this.m_typeB===In.e_revoluteJoint){const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.SetZero(),s=l-m-this.m_referenceAngleB}else{const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.Copy(e.m_localXAxisA);const i=this.m_localAnchorD,n=si.TransposeMultiplyVec2(c.q,si.MultiplyVec2(a.q,this.m_localAnchorB,$e.s_t0).Add(a.p).Subtract(c.p),$e.s_t0);s=$e.Dot(n.Subtract(i),this.m_localAxisD)}this.m_ratio=null!==(e=t.ratio)&&void 0!==e?e:1,this.m_constant=i+this.m_ratio*s,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const h=t.positions[this.m_indexC].a,a=t.velocities[this.m_indexC].v;let l=t.velocities[this.m_indexC].w;const c=t.positions[this.m_indexD].a,m=t.velocities[this.m_indexD].v;let _=t.velocities[this.m_indexD].w;const{qA:d,qB:u,qC:p,qD:f}=Vn;if(d.Set(e),u.Set(n),p.Set(h),f.Set(c),this.m_mass=0,this.m_typeA===In.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const{u:t,rC:e,rA:i,lalcA:s,lalcC:n}=Vn;si.MultiplyVec2(p,this.m_localAxisC,t),si.MultiplyVec2(p,$e.Subtract(this.m_localAnchorC,this.m_lcC,n),e),si.MultiplyVec2(d,$e.Subtract(this.m_localAnchorA,this.m_lcA,s),i),this.m_JvAC.Copy(t),this.m_JwC=$e.Cross(e,t),this.m_JwA=$e.Cross(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===In.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const{u:t,rB:e,rD:i,lalcB:s,lalcD:n}=Vn;si.MultiplyVec2(f,this.m_localAxisD,t),si.MultiplyVec2(f,$e.Subtract(this.m_localAnchorD,this.m_lcD,n),i),si.MultiplyVec2(u,$e.Subtract(this.m_localAnchorB,this.m_lcB,s),e),$e.Scale(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*$e.Cross(i,t),this.m_JwB=this.m_ratio*$e.Cross(e,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(i.AddScaled(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,o.AddScaled(this.m_mB*this.m_impulse,this.m_JvBD),r+=this.m_iB*this.m_impulse*this.m_JwB,a.SubtractScaled(this.m_mC*this.m_impulse,this.m_JvAC),l-=this.m_iC*this.m_impulse*this.m_JwC,m.SubtractScaled(this.m_mD*this.m_impulse,this.m_JvBD),_-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=l,t.velocities[this.m_indexD].w=_}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=t.velocities[this.m_indexC].v;let r=t.velocities[this.m_indexC].w;const h=t.velocities[this.m_indexD].v;let a=t.velocities[this.m_indexD].w,l=$e.Dot(this.m_JvAC,$e.Subtract(e,o,$e.s_t0))+$e.Dot(this.m_JvBD,$e.Subtract(s,h,$e.s_t0));l+=this.m_JwA*i-this.m_JwC*r+(this.m_JwB*n-this.m_JwD*a);const c=-this.m_mass*l;this.m_impulse+=c,e.AddScaled(this.m_mA*c,this.m_JvAC),i+=this.m_iA*c*this.m_JwA,s.AddScaled(this.m_mB*c,this.m_JvBD),n+=this.m_iB*c*this.m_JwB,o.SubtractScaled(this.m_mC*c,this.m_JvAC),r-=this.m_iC*c*this.m_JwC,h.SubtractScaled(this.m_mD*c,this.m_JvBD),a-=this.m_iD*c*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n,t.velocities[this.m_indexC].w=r,t.velocities[this.m_indexD].w=a}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const o=t.positions[this.m_indexC].c;let r=t.positions[this.m_indexC].a;const h=t.positions[this.m_indexD].c;let a=t.positions[this.m_indexD].a;const{qA:l,qB:c,qC:m,qD:_,JvAC:d,JvBD:u}=Vn;l.Set(i),c.Set(n),m.Set(r),_.Set(a);let p,f,y,v,x,w,A=0;if(this.m_typeA===In.e_revoluteJoint)d.SetZero(),y=1,x=1,A+=this.m_iA+this.m_iC,p=i-r-this.m_referenceAngleA;else{const{u:t,rC:i,rA:s,lalcC:n,lalcA:r}=Vn;si.MultiplyVec2(m,this.m_localAxisC,t),si.MultiplyVec2(m,$e.Subtract(this.m_localAnchorC,this.m_lcC,n),i),si.MultiplyVec2(l,$e.Subtract(this.m_localAnchorA,this.m_lcA,r),s),d.Copy(t),x=$e.Cross(i,t),y=$e.Cross(s,t),A+=this.m_mC+this.m_mA+this.m_iC*x*x+this.m_iA*y*y;const h=n,a=si.TransposeMultiplyVec2(m,$e.Add(s,e,$e.s_t0).Subtract(o),$e.s_t0);p=$e.Dot($e.Subtract(a,h,$e.s_t0),this.m_localAxisC)}if(this.m_typeB===In.e_revoluteJoint)u.SetZero(),v=this.m_ratio,w=this.m_ratio,A+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),f=n-a-this.m_referenceAngleB;else{const{u:t,rD:e,rB:i,lalcD:n,lalcB:o}=Vn;si.MultiplyVec2(_,this.m_localAxisD,t),si.MultiplyVec2(_,$e.Subtract(this.m_localAnchorD,this.m_lcD,n),e),si.MultiplyVec2(c,$e.Subtract(this.m_localAnchorB,this.m_lcB,o),i),$e.Scale(this.m_ratio,t,u),w=this.m_ratio*$e.Cross(e,t),v=this.m_ratio*$e.Cross(i,t),A+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*w*w+this.m_iB*v*v;const r=n,a=si.TransposeMultiplyVec2(_,$e.Add(i,s,$e.s_t0).Subtract(h),$e.s_t0);f=$e.Dot(a.Subtract(r),this.m_localAxisD)}const g=p+this.m_ratio*f-this.m_constant;let b=0;return A>0&&(b=-g/A),e.AddScaled(this.m_mA*b,d),i+=this.m_iA*b*y,s.AddScaled(this.m_mB*b,u),n+=this.m_iB*b*v,o.SubtractScaled(this.m_mC*b,d),r-=this.m_iC*b*x,h.SubtractScaled(this.m_mD*b,u),a-=this.m_iD*b*w,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,t.positions[this.m_indexC].a=r,t.positions[this.m_indexD].a=a,!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return $e.Scale(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}}const Un={qA:new si,qB:new si,K:new ei,Cdot:new $e,impulse:new $e,oldImpulse:new $e};class Xn extends Tn{constructor(t){var e,i,s,n,o;super(t),this.m_linearOffset=new $e,this.m_linearImpulse=new $e,this.m_angularImpulse=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_linearError=new $e,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new ei,this.m_angularMass=0,this.m_linearOffset.Copy(null!==(e=t.linearOffset)&&void 0!==e?e:$e.ZERO),this.m_angularOffset=null!==(i=t.angularOffset)&&void 0!==i?i:0,this.m_linearImpulse.SetZero(),this.m_maxForce=null!==(s=t.maxForce)&&void 0!==s?s:1,this.m_maxTorque=null!==(n=t.maxTorque)&&void 0!==n?n:1,this.m_correctionFactor=null!==(o=t.correctionFactor)&&void 0!==o?o:.3}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return $e.Scale(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){$e.Equals(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}GetCorrectionFactor(){return this.m_correctionFactor}SetCorrectionFactor(t){this.m_correctionFactor=t}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const{qA:l,qB:c}=Un;l.Set(i),c.Set(r);const m=si.MultiplyVec2(l,$e.Subtract(this.m_linearOffset,this.m_localCenterA,$e.s_t0),this.m_rA),_=si.MultiplyVec2(c,$e.Negate(this.m_localCenterB,$e.s_t0),this.m_rB),d=this.m_invMassA,u=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,y=this.m_linearMass;if(y.ex.x=d+u+p*m.y*m.y+f*_.y*_.y,y.ex.y=-p*m.x*m.y-f*_.x*_.y,y.ey.x=y.ex.y,y.ey.y=d+u+p*m.x*m.x+f*_.x*_.x,y.Inverse(),this.m_angularMass=p+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),$e.Subtract($e.Add(o,_,$e.s_t0),$e.Add(e,m,$e.s_t1),this.m_linearError),this.m_angularError=r-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.Scale(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;s.SubtractScaled(d,e),n-=p*($e.Cross(m,e)+this.m_angularImpulse),h.AddScaled(u,e),a+=f*($e.Cross(_,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,r=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=t.step.dt,c=t.step.inv_dt;{const t=n-i+c*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,o=l*this.m_maxTorque;this.m_angularImpulse=Qe(this.m_angularImpulse+e,-o,o),e=this.m_angularImpulse-s,i-=h*e,n+=a*e}{const{impulse:t,oldImpulse:m,Cdot:_}=Un;$e.AddScaled($e.Subtract($e.AddCrossScalarVec2(s,n,this.m_rB,$e.s_t0),$e.AddCrossScalarVec2(e,i,this.m_rA,$e.s_t1),$e.s_t2),c*this.m_correctionFactor,this.m_linearError,_),ei.MultiplyVec2(this.m_linearMass,_,t).Negate(),m.Copy(this.m_linearImpulse),this.m_linearImpulse.Add(t);const d=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>d*d&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Scale(d)),$e.Subtract(this.m_linearImpulse,m,t),e.SubtractScaled(o,t),i-=h*$e.Cross(this.m_rA,t),s.AddScaled(r,t),n+=a*$e.Cross(this.m_rB,t)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){return!0}}const zn={qB:new si,lalcB:new $e,Cdot:new $e,impulse:new $e,oldImpulse:new $e,pA:new $e,pB:new $e};class Nn extends Tn{constructor(t){var e,i,s,n;super(t),this.m_localAnchorB=new $e,this.m_targetA=new $e,this.m_stiffness=0,this.m_damping=0,this.m_beta=0,this.m_impulse=new $e,this.m_maxForce=0,this.m_gamma=0,this.m_indexB=0,this.m_rB=new $e,this.m_localCenterB=new $e,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new ei,this.m_C=new $e,this.m_targetA.Copy(null!==(e=t.target)&&void 0!==e?e:$e.ZERO),ni.TransposeMultiplyVec2(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=null!==(i=t.maxForce)&&void 0!==i?i:0,this.m_stiffness=null!==(s=t.stiffness)&&void 0!==s?s:0,this.m_damping=null!==(n=t.damping)&&void 0!==n?n:0,this.m_beta=0,this.m_gamma=0}SetTarget(t){$e.Equals(t,this.m_targetA)||(this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t))}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const{qB:o,lalcB:r}=zn;o.Set(i);const h=this.m_damping,a=this.m_stiffness,l=t.step.dt;this.m_gamma=l*(h+l*a),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=l*a*this.m_gamma,si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,r),this.m_rB);const c=this.m_mass;c.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,c.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,c.ey.x=c.ex.y,c.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,c.Inverse(),$e.Add(e,this.m_rB,this.m_C).Subtract(this.m_targetA),this.m_C.Scale(this.m_beta),n*=.98,t.step.warmStarting?(this.m_impulse.Scale(t.step.dtRatio),s.AddScaled(this.m_invMassB,this.m_impulse),n+=this.m_invIB*$e.Cross(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=n}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const{Cdot:s,impulse:n,oldImpulse:o}=zn;$e.AddCrossScalarVec2(e,i,this.m_rB,s),ei.MultiplyVec2(this.m_mass,$e.Add(s,this.m_C,n).AddScaled(this.m_gamma,this.m_impulse).Negate(),n),o.Copy(this.m_impulse),this.m_impulse.Add(n);const r=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>r*r&&this.m_impulse.Scale(r/this.m_impulse.Length()),$e.Subtract(this.m_impulse,o,n),e.AddScaled(this.m_invMassB,n),i+=this.m_invIB*$e.Cross(this.m_rB,n),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return $e.Scale(t,this.m_impulse,e)}GetReactionTorque(t){return 0}ShiftOrigin(t){this.m_targetA.Subtract(t)}Draw(t){const e=this.GetAnchorA(zn.pA),i=this.GetAnchorB(zn.pB);t.DrawPoint(e,4,hi.joint7),t.DrawPoint(i,4,hi.joint7),t.DrawSegment(e,i,hi.joint8)}}const Yn={K3:new ii,K2:new ei,qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,rA:new $e,rB:new $e,GetJointTranslation:{pA:new $e,pB:new $e,d:new $e,axis:new $e},InitVelocityConstraints:{d:new $e,P:new $e},SolveVelocityConstraints:{P:new $e,df:new $e},SolvePositionConstraints:{d:new $e,impulse:new ti,impulse1:new $e,P:new $e},Draw:{p1:new $e,p2:new $e,pA:new $e,pB:new $e,axis:new $e,lower:new $e,upper:new $e,perp:new $e}};class Wn extends Tn{constructor(t){var e,i,s,n,o,r,h,a,l,c;super(t),this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_localXAxisA=new $e,this.m_localYAxisA=new $e,this.m_referenceAngle=0,this.m_impulse=new $e,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new $e,this.m_perp=new $e,this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new ei,this.m_translation=0,this.m_axialMass=0,this.m_localAnchorA.Copy(null!==(e=t.localAnchorA)&&void 0!==e?e:$e.ZERO),this.m_localAnchorB.Copy(null!==(i=t.localAnchorB)&&void 0!==i?i:$e.ZERO),$e.Normalize(null!==(s=t.localAxisA)&&void 0!==s?s:$e.UNITX,this.m_localXAxisA),$e.CrossOneVec2(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=null!==(n=t.referenceAngle)&&void 0!==n?n:0,this.m_lowerTranslation=null!==(o=t.lowerTranslation)&&void 0!==o?o:0,this.m_upperTranslation=null!==(r=t.upperTranslation)&&void 0!==r?r:0,this.m_maxMotorForce=null!==(h=t.maxMotorForce)&&void 0!==h?h:0,this.m_motorSpeed=null!==(a=t.motorSpeed)&&void 0!==a?a:0,this.m_enableLimit=null!==(l=t.enableLimit)&&void 0!==l&&l,this.m_enableMotor=null!==(c=t.enableMotor)&&void 0!==c&&c}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const{qA:l,qB:c,lalcA:m,lalcB:_,rA:d,rB:u}=Yn;l.Set(i),c.Set(r),si.MultiplyVec2(l,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,m),d),si.MultiplyVec2(c,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,_),u);const p=$e.Subtract(o,e,Yn.InitVelocityConstraints.d).Add(u).Subtract(d),f=this.m_invMassA,y=this.m_invMassB,v=this.m_invIA,x=this.m_invIB;si.MultiplyVec2(l,this.m_localXAxisA,this.m_axis),this.m_a1=$e.Cross($e.Add(p,d,$e.s_t0),this.m_axis),this.m_a2=$e.Cross(u,this.m_axis),this.m_axialMass=f+y+v*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_axialMass>0&&(this.m_axialMass=1/this.m_axialMass),si.MultiplyVec2(l,this.m_localYAxisA,this.m_perp),this.m_s1=$e.Cross($e.Add(p,d,$e.s_t0),this.m_perp),this.m_s2=$e.Cross(u,this.m_perp);const w=f+y+v*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,A=v*this.m_s1+x*this.m_s2;let g=v+x;if(0===g&&(g=1),this.m_K.ex.Set(w,A),this.m_K.ey.Set(A,g),this.m_enableLimit?this.m_translation=$e.Dot(this.m_axis,p):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.Scale(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,{P:i}=Yn.InitVelocityConstraints;$e.Scale(this.m_impulse.x,this.m_perp,i).AddScaled(e,this.m_axis);const o=this.m_impulse.x*this.m_s1+this.m_impulse.y+e*this.m_a1,r=this.m_impulse.x*this.m_s2+this.m_impulse.y+e*this.m_a2;s.SubtractScaled(f,i),n-=v*o,h.AddScaled(y,i),a+=x*r}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,r=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,{P:l,df:c}=Yn.SolveVelocityConstraints;if(this.m_enableMotor){const c=$e.Dot(this.m_axis,$e.Subtract(s,e,$e.s_t0))+this.m_a2*n-this.m_a1*i;let m=this.m_axialMass*(this.m_motorSpeed-c);const _=this.m_motorImpulse,d=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=Qe(this.m_motorImpulse+m,-d,d),m=this.m_motorImpulse-_,$e.Scale(m,this.m_axis,l);const u=m*this.m_a1,p=m*this.m_a2;e.SubtractScaled(o,l),i-=h*u,s.AddScaled(r,l),n+=a*p}if(this.m_enableLimit){{const c=this.m_translation-this.m_lowerTranslation,m=$e.Dot(this.m_axis,$e.Subtract(s,e,$e.s_t0))+this.m_a2*n-this.m_a1*i;let _=-this.m_axialMass*(m+Math.max(c,0)*t.step.inv_dt);const d=this.m_lowerImpulse;this.m_lowerImpulse=Math.max(this.m_lowerImpulse+_,0),_=this.m_lowerImpulse-d,$e.Scale(_,this.m_axis,l);const u=_*this.m_a1,p=_*this.m_a2;e.SubtractScaled(o,l),i-=h*u,s.AddScaled(r,l),n+=a*p}{const c=this.m_upperTranslation-this.m_translation,m=$e.Dot(this.m_axis,$e.Subtract(e,s,$e.s_t0))+this.m_a1*i-this.m_a2*n;let _=-this.m_axialMass*(m+Math.max(c,0)*t.step.inv_dt);const d=this.m_upperImpulse;this.m_upperImpulse=Math.max(this.m_upperImpulse+_,0),_=this.m_upperImpulse-d,$e.Scale(_,this.m_axis,l);const u=_*this.m_a1,p=_*this.m_a2;e.AddScaled(o,l),i+=h*u,s.SubtractScaled(r,l),n-=a*p}}{const t=$e.Dot(this.m_perp,$e.Subtract(s,e,$e.s_t0))+this.m_s2*n-this.m_s1*i,m=n-i;this.m_K.Solve(-t,-m,c),this.m_impulse.Add(c),$e.Scale(c.x,this.m_perp,l);const _=c.x*this.m_s1+c.y,d=c.x*this.m_s2+c.y;e.SubtractScaled(o,l),i-=h*_,s.AddScaled(r,l),n+=a*d}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const{qA:o,qB:r,lalcA:h,lalcB:a,rA:l,rB:c}=Yn;o.Set(i),r.Set(n);const m=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,u=this.m_invIB,{d:p,impulse:f,P:y}=Yn.SolvePositionConstraints;si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,h),l),si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,a),c),$e.Add(s,c,p).Subtract(e).Subtract(l);const v=si.MultiplyVec2(o,this.m_localXAxisA,this.m_axis),x=$e.Cross($e.Add(p,l,$e.s_t0),v),w=$e.Cross(c,v),A=si.MultiplyVec2(o,this.m_localYAxisA,this.m_perp),g=$e.Cross($e.Add(p,l,$e.s_t0),A),b=$e.Cross(c,A),S=$e.Dot(A,p),B=n-i-this.m_referenceAngle;let C=Math.abs(S);const R=Math.abs(B);let I=!1,G=0;if(this.m_enableLimit){const t=$e.Dot(v,p);Math.abs(this.m_upperTranslation-this.m_lowerTranslation)<.01?(G=t,C=Math.max(C,Math.abs(t)),I=!0):t<=this.m_lowerTranslation?(G=Math.min(t-this.m_lowerTranslation,0),C=Math.max(C,this.m_lowerTranslation-t),I=!0):t>=this.m_upperTranslation&&(G=Math.max(t-this.m_upperTranslation,0),C=Math.max(C,t-this.m_upperTranslation),I=!0)}if(I){const t=m+_+d*g*g+u*b*b,e=d*g+u*b,i=d*g*x+u*b*w;let s=d+u;0===s&&(s=1);const n=d*x+u*w,o=m+_+d*x*x+u*w*w,r=Yn.K3;r.ex.Set(t,e,i),r.ey.Set(e,s,n),r.ez.Set(i,n,o),r.Solve33(-S,-B,-G,f)}else{const t=m+_+d*g*g+u*b*b,e=d*g+u*b;let i=d+u;0===i&&(i=1);const s=Yn.K2;s.ex.Set(t,e),s.ey.Set(e,i);const n=s.Solve(-S,-B,Yn.SolvePositionConstraints.impulse1);f.x=n.x,f.y=n.y,f.z=0}$e.Scale(f.x,A,y).AddScaled(f.z,v);const M=f.x*g+f.y+f.z*x,T=f.x*b+f.y+f.z*w;return e.SubtractScaled(m,y),i-=d*M,s.AddScaled(_,y),n+=u*T,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,C<=ze&&R<=Ne}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){const i=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse;return e.x=t*(this.m_impulse.x*this.m_perp.x+i*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+i*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const{pA:t,pB:e,axis:i,d:s}=Yn.GetJointTranslation;return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t),this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e),$e.Subtract(e,t,s),this.m_bodyA.GetWorldVector(this.m_localXAxisA,i),$e.Dot(s,i)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB,{lalcA:i,lalcB:s,rA:n,rB:o}=Yn;si.MultiplyVec2(t.m_xf.q,$e.Subtract(this.m_localAnchorA,t.m_sweep.localCenter,i),n),si.MultiplyVec2(e.m_xf.q,$e.Subtract(this.m_localAnchorB,e.m_sweep.localCenter,s),o);const r=$e.Add(t.m_sweep.c,n,$e.s_t0),h=$e.Add(e.m_sweep.c,o,$e.s_t1),a=$e.Subtract(h,r,$e.s_t2),l=si.MultiplyVec2(t.m_xf.q,this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,m=e.m_linearVelocity,_=t.m_angularVelocity,d=e.m_angularVelocity;return $e.Dot(a,$e.CrossScalarVec2(_,l,$e.s_t0))+$e.Dot(l,$e.Subtract($e.AddCrossScalarVec2(m,d,o,$e.s_t0),$e.AddCrossScalarVec2(c,_,n,$e.s_t1),$e.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){return t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0),t}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){return t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t),t}SetMotorSpeed(t){return t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t),t}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Draw(t){const{p1:e,p2:i,pA:s,pB:n,axis:o}=Yn.Draw,r=this.m_bodyA.GetTransform(),h=this.m_bodyB.GetTransform();if(ni.MultiplyVec2(r,this.m_localAnchorA,s),ni.MultiplyVec2(h,this.m_localAnchorB,n),si.MultiplyVec2(r.q,this.m_localXAxisA,o),t.DrawSegment(s,n,hi.joint5),this.m_enableLimit){const{lower:n,upper:h,perp:a}=Yn.Draw;$e.AddScaled(s,this.m_lowerTranslation,o,n),$e.AddScaled(s,this.m_upperTranslation,o,h),si.MultiplyVec2(r.q,this.m_localYAxisA,a),t.DrawSegment(n,h,hi.joint1),t.DrawSegment($e.SubtractScaled(n,.5,a,e),$e.AddScaled(n,.5,a,i),hi.joint2),t.DrawSegment($e.SubtractScaled(h,.5,a,e),$e.AddScaled(h,.5,a,i),hi.joint3)}else t.DrawSegment($e.Subtract(s,o,e),$e.Add(s,o,i),hi.joint1);t.DrawPoint(s,5,hi.joint1),t.DrawPoint(n,5,hi.joint4)}}const qn={qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,p:new $e,PA:new $e,PB:new $e,vpA:new $e,vpB:new $e,pA:new $e,pB:new $e},Hn=new $e(-1,1),jn=$e.UNITX,Jn=new $e(-1,0),Zn=$e.UNITX;class Kn extends Tn{constructor(t){var e,i,s,n,o,r,h;super(t),this.m_groundAnchorA=new $e,this.m_groundAnchorB=new $e,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new $e,this.m_uB=new $e,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_groundAnchorA.Copy(null!==(e=t.groundAnchorA)&&void 0!==e?e:Hn),this.m_groundAnchorB.Copy(null!==(i=t.groundAnchorB)&&void 0!==i?i:jn),this.m_localAnchorA.Copy(null!==(s=t.localAnchorA)&&void 0!==s?s:Jn),this.m_localAnchorB.Copy(null!==(n=t.localAnchorB)&&void 0!==n?n:Zn),this.m_lengthA=null!==(o=t.lengthA)&&void 0!==o?o:0,this.m_lengthB=null!==(r=t.lengthB)&&void 0!==r?r:0,this.m_ratio=null!==(h=t.ratio)&&void 0!==h?h:1,this.m_constant=this.m_lengthA+this.m_ratio*this.m_lengthB,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const o=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const{qA:l,qB:c,lalcA:m,lalcB:_}=qn;l.Set(i),c.Set(r),si.MultiplyVec2(l,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,m),this.m_rA),si.MultiplyVec2(c,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,_),this.m_rB),$e.Add(e,this.m_rA,this.m_uA).Subtract(this.m_groundAnchorA),$e.Add(o,this.m_rB,this.m_uB).Subtract(this.m_groundAnchorB);const d=this.m_uA.Length(),u=this.m_uB.Length();d>.05?this.m_uA.Scale(1/d):this.m_uA.SetZero(),u>.05?this.m_uB.Scale(1/u):this.m_uB.SetZero();const p=$e.Cross(this.m_rA,this.m_uA),f=$e.Cross(this.m_rB,this.m_uB),y=this.m_invMassA+this.m_invIA*p*p,v=this.m_invMassB+this.m_invIB*f*f;if(this.m_mass=y+this.m_ratio*this.m_ratio*v,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const{PA:e,PB:i}=qn;$e.Scale(-this.m_impulse,this.m_uA,e),$e.Scale(-this.m_ratio*this.m_impulse,this.m_uB,i),s.AddScaled(this.m_invMassA,e),n+=this.m_invIA*$e.Cross(this.m_rA,e),h.AddScaled(this.m_invMassB,i),a+=this.m_invIB*$e.Cross(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const{PA:o,PB:r,vpA:h,vpB:a}=qn;$e.AddCrossScalarVec2(e,i,this.m_rA,h),$e.AddCrossScalarVec2(s,n,this.m_rB,a);const l=-$e.Dot(this.m_uA,h)-this.m_ratio*$e.Dot(this.m_uB,a),c=-this.m_mass*l;this.m_impulse+=c,$e.Scale(-c,this.m_uA,o),$e.Scale(-this.m_ratio*c,this.m_uB,r),e.AddScaled(this.m_invMassA,o),i+=this.m_invIA*$e.Cross(this.m_rA,o),s.AddScaled(this.m_invMassB,r),n+=this.m_invIB*$e.Cross(this.m_rB,r),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const{qA:o,qB:r,lalcA:h,lalcB:a,PA:l,PB:c}=qn;o.Set(i),r.Set(n);const m=si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,h),this.m_rA),_=si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,a),this.m_rB),d=$e.Add(e,m,this.m_uA).Subtract(this.m_groundAnchorA),u=$e.Add(s,_,this.m_uB).Subtract(this.m_groundAnchorB),p=d.Length(),f=u.Length();p>.05?d.Scale(1/p):d.SetZero(),f>.05?u.Scale(1/f):u.SetZero();const y=$e.Cross(m,d),v=$e.Cross(_,u),x=this.m_invMassA+this.m_invIA*y*y,w=this.m_invMassB+this.m_invIB*v*v;let A=x+this.m_ratio*this.m_ratio*w;A>0&&(A=1/A);const g=this.m_constant-p-this.m_ratio*f,b=Math.abs(g),S=-A*g;return $e.Scale(-S,d,l),$e.Scale(-this.m_ratio*S,u,c),e.AddScaled(this.m_invMassA,l),i+=this.m_invIA*$e.Cross(m,l),s.AddScaled(this.m_invMassB,c),n+=this.m_invIB*$e.Cross(_,c),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,b<ze}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,qn.p),e=this.m_groundAnchorA;return $e.Distance(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,qn.p),e=this.m_groundAnchorB;return $e.Distance(t,e)}ShiftOrigin(t){this.m_groundAnchorA.Subtract(t),this.m_groundAnchorB.Subtract(t)}Draw(t){const e=this.GetAnchorA(qn.pA),i=this.GetAnchorB(qn.pB),s=this.GetGroundAnchorA(),n=this.GetGroundAnchorB();t.DrawSegment(s,e,hi.joint6),t.DrawSegment(n,i,hi.joint6),t.DrawSegment(s,n,hi.joint6)}}const Qn={qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,P:new $e,Cdot:new $e,C:new $e,impulse:new $e,p2:new $e,r:new $e,pA:new $e,pB:new $e,rlo:new $e,rhi:new $e};class $n extends Tn{constructor(t){var e,i,s,n,o,r,h,a,l;super(t),this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_impulse=new $e,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_K=new ei,this.m_angle=0,this.m_axialMass=0,this.m_localAnchorA.Copy(null!==(e=t.localAnchorA)&&void 0!==e?e:$e.ZERO),this.m_localAnchorB.Copy(null!==(i=t.localAnchorB)&&void 0!==i?i:$e.ZERO),this.m_referenceAngle=null!==(s=t.referenceAngle)&&void 0!==s?s:0,this.m_impulse.SetZero(),this.m_lowerAngle=null!==(n=t.lowerAngle)&&void 0!==n?n:0,this.m_upperAngle=null!==(o=t.upperAngle)&&void 0!==o?o:0,this.m_maxMotorTorque=null!==(r=t.maxMotorTorque)&&void 0!==r?r:0,this.m_motorSpeed=null!==(h=t.motorSpeed)&&void 0!==h?h:0,this.m_enableLimit=null!==(a=t.enableLimit)&&void 0!==a&&a,this.m_enableMotor=null!==(l=t.enableMotor)&&void 0!==l&&l}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const{qA:h,qB:a,lalcA:l,lalcB:c}=Qn;h.Set(e),a.Set(n),si.MultiplyVec2(h,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,l),this.m_rA),si.MultiplyVec2(a,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,c),this.m_rB);const m=this.m_invMassA,_=this.m_invMassB,d=this.m_invIA,u=this.m_invIB;let p;if(this.m_K.ex.x=m+_+this.m_rA.y*this.m_rA.y*d+this.m_rB.y*this.m_rB.y*u,this.m_K.ey.x=-this.m_rA.y*this.m_rA.x*d-this.m_rB.y*this.m_rB.x*u,this.m_K.ex.y=this.m_K.ey.x,this.m_K.ey.y=m+_+this.m_rA.x*this.m_rA.x*d+this.m_rB.x*this.m_rB.x*u,this.m_axialMass=d+u,this.m_axialMass>0?(this.m_axialMass=1/this.m_axialMass,p=!1):p=!0,this.m_angle=n-e-this.m_referenceAngle,(!1===this.m_enableLimit||p)&&(this.m_lowerImpulse=0,this.m_upperImpulse=0),(!1===this.m_enableMotor||p)&&(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.Scale(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,n=Qn.P.Set(this.m_impulse.x,this.m_impulse.y);i.SubtractScaled(m,n),s-=d*($e.Cross(this.m_rA,n)+e),o.AddScaled(_,n),r+=u*($e.Cross(this.m_rB,n)+e)}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,r=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=h+a===0;if(this.m_enableMotor&&!l){const e=n-i-this.m_motorSpeed;let s=-this.m_axialMass*e;const o=this.m_motorImpulse,r=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Qe(this.m_motorImpulse+s,-r,r),s=this.m_motorImpulse-o,i-=h*s,n+=a*s}if(this.m_enableLimit&&!l){{const e=this.m_angle-this.m_lowerAngle,s=n-i;let o=-this.m_axialMass*(s+Math.max(e,0)*t.step.inv_dt);const r=this.m_lowerImpulse;this.m_lowerImpulse=Math.max(this.m_lowerImpulse+o,0),o=this.m_lowerImpulse-r,i-=h*o,n+=a*o}{const e=this.m_upperAngle-this.m_angle,s=i-n;let o=-this.m_axialMass*(s+Math.max(e,0)*t.step.inv_dt);const r=this.m_upperImpulse;this.m_upperImpulse=Math.max(this.m_upperImpulse+o,0),o=this.m_upperImpulse-r,i+=h*o,n-=a*o}}{const{Cdot:t,impulse:l}=Qn;$e.Subtract($e.AddCrossScalarVec2(s,n,this.m_rB,$e.s_t0),$e.AddCrossScalarVec2(e,i,this.m_rA,$e.s_t1),t),this.m_K.Solve(-t.x,-t.y,l),this.m_impulse.x+=l.x,this.m_impulse.y+=l.y,e.SubtractScaled(o,l),i-=h*$e.Cross(this.m_rA,l),s.AddScaled(r,l),n+=a*$e.Cross(this.m_rB,l)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const{qA:o,qB:r,lalcA:h,lalcB:a,impulse:l}=Qn;o.Set(i),r.Set(n);let c=0,m=0;const _=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&!_){const t=n-i-this.m_referenceAngle;let e=0;Math.abs(this.m_upperAngle-this.m_lowerAngle)<2*Ne?e=Qe(t-this.m_lowerAngle,-We,We):t<=this.m_lowerAngle?e=Qe(t-this.m_lowerAngle+Ne,-We,0):t>=this.m_upperAngle&&(e=Qe(t-this.m_upperAngle-Ne,0,We));const s=-this.m_axialMass*e;i-=this.m_invIA*s,n+=this.m_invIB*s,c=Math.abs(e)}{o.Set(i),r.Set(n);const t=si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,h),this.m_rA),c=si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,a),this.m_rB),_=$e.Add(s,c,Qn.C).Subtract(e).Subtract(t);m=_.Length();const d=this.m_invMassA,u=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,y=this.m_K;y.ex.x=d+u+p*t.y*t.y+f*c.y*c.y,y.ex.y=-p*t.x*t.y-f*c.x*c.y,y.ey.x=y.ex.y,y.ey.y=d+u+p*t.x*t.x+f*c.x*c.x,y.Solve(_.x,_.y,l).Negate(),e.SubtractScaled(d,l),i-=p*$e.Cross(t,l),s.AddScaled(u,l),n+=f*$e.Cross(c,l)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,m<=ze&&c<=Ne}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*(this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse)}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){return t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t),t}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){return t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0),t}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){return t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t),t}Draw(t){const{p2:e,r:i,pA:s,pB:n}=Qn,o=this.m_bodyA.GetTransform(),r=this.m_bodyB.GetTransform();ni.MultiplyVec2(o,this.m_localAnchorA,s),ni.MultiplyVec2(r,this.m_localAnchorB,n),t.DrawPoint(s,5,hi.joint4),t.DrawPoint(n,5,hi.joint5);const h=this.m_bodyA.GetAngle(),a=this.m_bodyB.GetAngle()-h-this.m_referenceAngle,l=.5;if(i.Set(Math.cos(a),Math.sin(a)).Scale(l),t.DrawSegment(n,$e.Add(n,i,e),hi.joint1),t.DrawCircle(n,l,hi.joint1),this.m_enableLimit){const{rlo:i,rhi:s}=Qn;i.Set(Math.cos(this.m_lowerAngle),Math.sin(this.m_lowerAngle)).Scale(l),s.Set(Math.cos(this.m_upperAngle),Math.sin(this.m_upperAngle)).Scale(l),t.DrawSegment(n,$e.Add(n,i,e),hi.joint2),t.DrawSegment(n,$e.Add(n,s,e),hi.joint3)}t.DrawSegment(o.p,s,hi.joint6),t.DrawSegment(s,n,hi.joint6),t.DrawSegment(r.p,n,hi.joint6)}}const to={qA:new si,qB:new si,rA:new $e,rB:new $e,lalcA:new $e,lalcB:new $e,K:new ii,P:new $e,Cdot1:new ti,impulse1:new $e,impulse:new ti,C1:new $e,C:new ti};class eo extends Tn{constructor(t){var e,i,s,n,o;super(t),this.m_stiffness=0,this.m_damping=0,this.m_bias=0,this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new ti,this.m_indexA=0,this.m_indexB=0,this.m_rA=new $e,this.m_rB=new $e,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new ii,this.m_localAnchorA.Copy(null!==(e=t.localAnchorA)&&void 0!==e?e:$e.ZERO),this.m_localAnchorB.Copy(null!==(i=t.localAnchorB)&&void 0!==i?i:$e.ZERO),this.m_referenceAngle=null!==(s=t.referenceAngle)&&void 0!==s?s:0,this.m_stiffness=null!==(n=t.stiffness)&&void 0!==n?n:0,this.m_damping=null!==(o=t.damping)&&void 0!==o?o:0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const{qA:h,qB:a,lalcA:l,lalcB:c,K:m}=to;h.Set(e),a.Set(n),si.MultiplyVec2(h,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,l),this.m_rA),si.MultiplyVec2(a,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,c),this.m_rB);const _=this.m_invMassA,d=this.m_invMassB,u=this.m_invIA,p=this.m_invIB;if(m.ex.x=_+d+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*p,m.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*p,m.ez.x=-this.m_rA.y*u-this.m_rB.y*p,m.ex.y=m.ey.x,m.ey.y=_+d+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*p,m.ez.y=this.m_rA.x*u+this.m_rB.x*p,m.ex.z=m.ez.x,m.ey.z=m.ez.y,m.ez.z=u+p,this.m_stiffness>0){m.GetInverse22(this.m_mass);let i=u+p;const s=n-e-this.m_referenceAngle,o=this.m_damping,r=this.m_stiffness,h=t.step.dt;this.m_gamma=h*(o+h*r),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=s*h*r*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else 0===m.ez.z?(m.GetInverse22(this.m_mass),this.m_gamma=0,this.m_bias=0):(m.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0);if(t.step.warmStarting){this.m_impulse.Scale(t.step.dtRatio);const{P:e}=to;e.Copy(this.m_impulse),i.SubtractScaled(_,e),s-=u*($e.Cross(this.m_rA,e)+this.m_impulse.z),o.AddScaled(d,e),r+=p*($e.Cross(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let n=t.velocities[this.m_indexB].w;const o=this.m_invMassA,r=this.m_invMassB,h=this.m_invIA,a=this.m_invIB;if(this.m_stiffness>0){const t=n-i,l=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,i-=h*l,n+=a*l;const{Cdot1:c,impulse1:m}=to;$e.Subtract($e.AddCrossScalarVec2(s,n,this.m_rB,$e.s_t0),$e.AddCrossScalarVec2(e,i,this.m_rA,$e.s_t1),c),ii.MultiplyVec2(this.m_mass,c,m).Negate(),this.m_impulse.x+=m.x,this.m_impulse.y+=m.y;const _=m;e.SubtractScaled(o,_),i-=h*$e.Cross(this.m_rA,_),s.AddScaled(r,_),n+=a*$e.Cross(this.m_rB,_)}else{const{Cdot1:t,impulse:l,P:c}=to;$e.Subtract($e.AddCrossScalarVec2(s,n,this.m_rB,$e.s_t0),$e.AddCrossScalarVec2(e,i,this.m_rA,$e.s_t1),t),t.z=n-i,ii.MultiplyVec3(this.m_mass,t,l).Negate(),this.m_impulse.Add(l),c.Set(l.x,l.y),e.SubtractScaled(o,c),i-=h*($e.Cross(this.m_rA,c)+l.z),s.AddScaled(r,c),n+=a*($e.Cross(this.m_rB,c)+l.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=n}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a;const{qA:o,qB:r,lalcA:h,lalcB:a,K:l,C1:c,P:m,rA:_,rB:d}=to;o.Set(i),r.Set(n);const u=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,y=this.m_invIB;let v,x;if(si.MultiplyVec2(o,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,h),_),si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,a),d),l.ex.x=u+p+_.y*_.y*f+d.y*d.y*y,l.ey.x=-_.y*_.x*f-d.y*d.x*y,l.ez.x=-_.y*f-d.y*y,l.ex.y=l.ey.x,l.ey.y=u+p+_.x*_.x*f+d.x*d.x*y,l.ez.y=_.x*f+d.x*y,l.ex.z=l.ez.x,l.ey.z=l.ez.y,l.ez.z=f+y,this.m_stiffness>0)$e.Add(s,d,c).Subtract(e).Subtract(_),v=c.Length(),x=0,l.Solve22(c.x,c.y,m).Negate(),e.SubtractScaled(u,m),i-=f*$e.Cross(_,m),s.AddScaled(p,m),n+=y*$e.Cross(d,m);else{$e.Add(s,d,c).Subtract(e).Subtract(_),$e.Subtract($e.Add(s,d,$e.s_t0),$e.Add(e,_,$e.s_t1),c);const t=n-i-this.m_referenceAngle;v=c.Length(),x=Math.abs(t);const{impulse:o,C:r}=to;r.Set(c.x,c.y,t),l.ez.z>0?l.Solve33(r.x,r.y,r.z,o).Negate():(l.Solve22(c.x,c.y,o).Negate(),o.z=0),m.Copy(o),e.SubtractScaled(u,m),i-=f*($e.Cross(_,m)+o.z),s.AddScaled(p,m),n+=y*($e.Cross(d,m)+o.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,v<=ze&&x<=Ne}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}}const io={qA:new si,qB:new si,lalcA:new $e,lalcB:new $e,rA:new $e,rB:new $e,d:new $e,P:new $e,ay:new $e,pA:new $e,pB:new $e,axis:new $e,Draw:{p1:new $e,p2:new $e,pA:new $e,pB:new $e,axis:new $e,lower:new $e,upper:new $e,perp:new $e}};class so extends Tn{constructor(t){var e,i,s,n,o,r,h,a,l,c,m;super(t),this.m_localAnchorA=new $e,this.m_localAnchorB=new $e,this.m_localXAxisA=new $e,this.m_localYAxisA=new $e,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_translation=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_stiffness=0,this.m_damping=0,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new $e,this.m_localCenterB=new $e,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new $e,this.m_ay=new $e,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_axialMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_localAnchorA.Copy(null!==(e=t.localAnchorA)&&void 0!==e?e:$e.ZERO),this.m_localAnchorB.Copy(null!==(i=t.localAnchorB)&&void 0!==i?i:$e.ZERO),this.m_localXAxisA.Copy(null!==(s=t.localAxisA)&&void 0!==s?s:$e.UNITX),$e.CrossOneVec2(this.m_localXAxisA,this.m_localYAxisA),this.m_lowerTranslation=null!==(n=t.lowerTranslation)&&void 0!==n?n:0,this.m_upperTranslation=null!==(o=t.upperTranslation)&&void 0!==o?o:0,this.m_enableLimit=null!==(r=t.enableLimit)&&void 0!==r&&r,this.m_maxMotorTorque=null!==(h=t.maxMotorTorque)&&void 0!==h?h:0,this.m_motorSpeed=null!==(a=t.motorSpeed)&&void 0!==a?a:0,this.m_enableMotor=null!==(l=t.enableMotor)&&void 0!==l&&l,this.m_ax.SetZero(),this.m_ay.SetZero(),this.m_stiffness=null!==(c=t.stiffness)&&void 0!==c?c:0,this.m_damping=null!==(m=t.damping)&&void 0!==m?m:0}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,n=this.m_invIB,o=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,h=t.velocities[this.m_indexA].v;let a=t.velocities[this.m_indexA].w;const l=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,m=t.velocities[this.m_indexB].v;let _=t.velocities[this.m_indexB].w;const{qA:d,qB:u,lalcA:p,lalcB:f,rA:y,rB:v,d:x}=io;d.Set(r),u.Set(c),si.MultiplyVec2(d,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,p),y),si.MultiplyVec2(u,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,f),v),$e.Add(l,v,x).Subtract(o).Subtract(y),si.MultiplyVec2(d,this.m_localYAxisA,this.m_ay),this.m_sAy=$e.Cross($e.Add(x,y,$e.s_t0),this.m_ay),this.m_sBy=$e.Cross(v,this.m_ay),this.m_mass=e+i+s*this.m_sAy*this.m_sAy+n*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),si.MultiplyVec2(d,this.m_localXAxisA,this.m_ax),this.m_sAx=$e.Cross($e.Add(x,y,$e.s_t0),this.m_ax),this.m_sBx=$e.Cross(v,this.m_ax);const w=e+i+s*this.m_sAx*this.m_sAx+n*this.m_sBx*this.m_sBx;if(this.m_axialMass=w>0?1/w:0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_stiffness>0&&w>0){this.m_springMass=1/w;const e=$e.Dot(x,this.m_ax),i=t.step.dt;this.m_gamma=i*(this.m_damping+i*this.m_stiffness),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*i*this.m_stiffness*this.m_gamma,this.m_springMass=w+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}else this.m_springImpulse=0;if(this.m_enableLimit?this.m_translation=$e.Dot(this.m_ax,x):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor?(this.m_motorMass=s+n,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse,{P:i}=io;$e.Scale(this.m_impulse,this.m_ay,i).AddScaled(e,this.m_ax);const s=this.m_impulse*this.m_sAy+e*this.m_sAx+this.m_motorImpulse,n=this.m_impulse*this.m_sBy+e*this.m_sBx+this.m_motorImpulse;h.SubtractScaled(this.m_invMassA,i),a-=this.m_invIA*s,m.AddScaled(this.m_invMassB,i),_+=this.m_invIB*n}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=_}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,n=this.m_invIB,o=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const{P:l}=io;{const t=$e.Dot(this.m_ax,$e.Subtract(h,o,$e.s_t0))+this.m_sBx*a-this.m_sAx*r,c=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=c,$e.Scale(c,this.m_ax,l);const m=c*this.m_sAx,_=c*this.m_sBx;o.SubtractScaled(e,l),r-=s*m,h.AddScaled(i,l),a+=n*_}{const e=a-r-this.m_motorSpeed;let i=-this.m_motorMass*e;const o=this.m_motorImpulse,h=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Qe(this.m_motorImpulse+i,-h,h),i=this.m_motorImpulse-o,r-=s*i,a+=n*i}if(this.m_enableLimit){{const c=this.m_translation-this.m_lowerTranslation,m=$e.Dot(this.m_ax,$e.Subtract(h,o,$e.s_t0))+this.m_sBx*a-this.m_sAx*r;let _=-this.m_axialMass*(m+Math.max(c,0)*t.step.inv_dt);const d=this.m_lowerImpulse;this.m_lowerImpulse=Math.max(this.m_lowerImpulse+_,0),_=this.m_lowerImpulse-d,$e.Scale(_,this.m_ax,l);const u=_*this.m_sAx,p=_*this.m_sBx;o.SubtractScaled(e,l),r-=s*u,h.AddScaled(i,l),a+=n*p}{const c=this.m_upperTranslation-this.m_translation,m=$e.Dot(this.m_ax,$e.Subtract(o,h,$e.s_t0))+this.m_sAx*r-this.m_sBx*a;let _=-this.m_axialMass*(m+Math.max(c,0)*t.step.inv_dt);const d=this.m_upperImpulse;this.m_upperImpulse=Math.max(this.m_upperImpulse+_,0),_=this.m_upperImpulse-d,$e.Scale(_,this.m_ax,l);const u=_*this.m_sAx,p=_*this.m_sBx;o.AddScaled(e,l),r+=s*u,h.SubtractScaled(i,l),a-=n*p}}{const t=$e.Dot(this.m_ay,$e.Subtract(h,o,$e.s_t0))+this.m_sBy*a-this.m_sAy*r,c=-this.m_mass*t;this.m_impulse+=c,$e.Scale(c,this.m_ay,l);const m=c*this.m_sAy,_=c*this.m_sBy;o.SubtractScaled(e,l),r-=s*m,h.AddScaled(i,l),a+=n*_}t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let n=t.positions[this.m_indexB].a,o=0;const{qA:r,qB:h,lalcA:a,lalcB:l,rA:c,rB:m,d:_,P:d,ay:u}=io;if(this.m_enableLimit){r.Set(i),h.Set(n),si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,a),c),si.MultiplyVec2(h,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,l),m),$e.Subtract(s,e,_).Add(m).Subtract(c);const t=si.MultiplyVec2(r,this.m_localXAxisA,this.m_ax),u=$e.Cross($e.Add(_,c,$e.s_t0),this.m_ax),p=$e.Cross(m,this.m_ax);let f=0;const y=$e.Dot(t,_);if(Math.abs(this.m_upperTranslation-this.m_lowerTranslation)<.01?f=y:y<=this.m_lowerTranslation?f=Math.min(y-this.m_lowerTranslation,0):y>=this.m_upperTranslation&&(f=Math.max(y-this.m_upperTranslation,0)),0!==f){const r=this.m_invMassA+this.m_invMassB+this.m_invIA*u*u+this.m_invIB*p*p;let h=0;0!==r&&(h=-f/r),$e.Scale(h,t,d);const a=h*u,l=h*p;e.SubtractScaled(this.m_invMassA,d),i-=this.m_invIA*a,s.AddScaled(this.m_invMassB,d),n+=this.m_invIB*l,o=Math.abs(f)}}{r.Set(i),h.Set(n),si.MultiplyVec2(r,$e.Subtract(this.m_localAnchorA,this.m_localCenterA,a),c),si.MultiplyVec2(h,$e.Subtract(this.m_localAnchorB,this.m_localCenterB,l),m),$e.Subtract(s,e,_).Add(m).Subtract(c),si.MultiplyVec2(r,this.m_localYAxisA,u);const t=$e.Cross($e.Add(_,c,$e.s_t0),u),p=$e.Cross(m,u),f=$e.Dot(_,u),y=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let v=0;0!==y&&(v=-f/y),$e.Scale(v,u,d);const x=v*t,w=v*p;e.SubtractScaled(this.m_invMassA,d),i-=this.m_invIA*x,s.AddScaled(this.m_invMassB,d),n+=this.m_invIB*w,o=Math.max(o,Math.abs(f))}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=n,o<=ze}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){const i=this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse;return e.x=t*(this.m_impulse*this.m_ay.x+i*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+i*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,{pA:i,pB:s,d:n,axis:o}=io;return t.GetWorldPoint(this.m_localAnchorA,i),e.GetWorldPoint(this.m_localAnchorB,s),$e.Subtract(s,i,n),t.GetWorldVector(this.m_localXAxisA,o),$e.Dot(n,o)}GetJointLinearSpeed(){const t=this.m_bodyA,e=this.m_bodyB,{rA:i,rB:s,lalcA:n,lalcB:o,axis:r}=io;si.MultiplyVec2(t.m_xf.q,$e.Subtract(this.m_localAnchorA,t.m_sweep.localCenter,n),i),si.MultiplyVec2(e.m_xf.q,$e.Subtract(this.m_localAnchorB,e.m_sweep.localCenter,o),s);const h=$e.Add(t.m_sweep.c,i,$e.s_t0),a=$e.Add(e.m_sweep.c,s,$e.s_t1),l=$e.Subtract(a,h,$e.s_t2);si.MultiplyVec2(t.m_xf.q,this.m_localXAxisA,r);const c=t.m_linearVelocity,m=e.m_linearVelocity,_=t.m_angularVelocity,d=e.m_angularVelocity;return $e.Dot(l,$e.CrossScalarVec2(_,r,$e.s_t0))+$e.Dot(r,$e.AddCrossScalarVec2(m,d,s,$e.s_t0).Subtract(c).Subtract($e.CrossScalarVec2(_,i,$e.s_t1)))}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetJointAngularSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){return t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t),t}SetMotorSpeed(t){return t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t),t}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){return t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0),t}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}Draw(t){const{p1:e,p2:i,pA:s,pB:n,axis:o}=io.Draw,r=this.m_bodyA.GetTransform(),h=this.m_bodyB.GetTransform();if(ni.MultiplyVec2(r,this.m_localAnchorA,s),ni.MultiplyVec2(h,this.m_localAnchorB,n),si.MultiplyVec2(r.q,this.m_localXAxisA,o),t.DrawSegment(s,n,hi.joint5),this.m_enableLimit){const{lower:n,upper:h,perp:a}=io.Draw;$e.AddScaled(s,this.m_lowerTranslation,o,n),$e.AddScaled(s,this.m_upperTranslation,o,h),si.MultiplyVec2(r.q,this.m_localYAxisA,a),t.DrawSegment(n,h,hi.joint1),t.DrawSegment($e.SubtractScaled(n,.5,a,e),$e.AddScaled(n,.5,a,i),hi.joint2),t.DrawSegment($e.SubtractScaled(h,.5,a,e),$e.AddScaled(h,.5,a,i),hi.joint3)}else t.DrawSegment($e.Subtract(s,o,e),$e.Add(s,o,i),hi.joint1);t.DrawPoint(s,5,hi.joint1),t.DrawPoint(n,5,hi.joint4)}}function no(t,e){return Math.sqrt(t*e)}function oo(t,e){return t>e?t:e}function ro(t,e){return t<e?t:e}class ho{get other(){return Oe(null!==this.m_other),this.m_other}set other(t){Oe(null===this.m_other),this.m_other=t}constructor(t){this.m_other=null,this.prev=null,this.next=null,this.contact=t}Reset(){this.m_other=null,this.prev=null,this.next=null}}class ao{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new ho(this),this.m_nodeB=new ho(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new Li,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=0,this.m_tangentSpeed=0,this.m_oldManifold=new Li}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),s=this.GetShapeA(),n=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),s.m_radius,i.GetTransform(),n.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=no(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=oo(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetRestitutionThreshold(){return this.m_restitutionThreshold}ResetRestitutionThreshold(){this.m_restitutionThreshold=ro(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,s){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=no(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=oo(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution),this.m_restitutionThreshold=ro(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const s=this.m_touchingFlag,n=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),r=n||o,h=this.m_fixtureA.GetBody(),a=this.m_fixtureB.GetBody(),l=h.GetTransform(),c=a.GetTransform();if(r){const t=this.GetShapeA(),e=this.GetShapeB();i=zi(t,this.m_indexA,e,this.m_indexB,l,c),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,c),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const s=this.m_oldManifold.points[t];if(s.id.key===i.key){e.normalImpulse=s.normalImpulse,e.tangentImpulse=s.tangentImpulse;break}}}i!==s&&(h.SetAwake(!0),a.SetAwake(!0))}this.m_touchingFlag=i,!s&&i&&t&&t.BeginContact(this),s&&!i&&t&&t.EndContact(this),!r&&i&&t&&t.PreSolve(this,this.m_oldManifold)}}class lo extends ao{Evaluate(t,e,i){!function(t,e,i,s,n){t.pointCount=0;const o=ni.MultiplyVec2(i,e.m_p,bs),r=ni.MultiplyVec2(n,s.m_p,Ss),h=$e.DistanceSquared(o,r),a=e.m_radius+s.m_radius;h>a*a||(t.type=Ii.e_circles,t.localPoint.Copy(e.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0)}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class co extends ao{Evaluate(t,e,i){!function(t,e,i,s,n){t.pointCount=0;const o=e.m_radius+s.m_radius,r=Es,h=Ts(r,e,i,s,n);if(h>o)return;const a=Os,l=Ts(a,s,n,e,i);if(l>o)return;let c,m,_,d,u,p;l>h+5e-4?(c=s,m=e,_=n,d=i,u=a[0],t.type=Ii.e_faceB,p=1):(c=e,m=s,_=i,d=n,u=r[0],t.type=Ii.e_faceA,p=0);const f=Ls;!function(t,e,i,s,n,o){const r=e.m_normals,h=n.m_count,a=n.m_vertices,l=n.m_normals,c=si.TransposeMultiplyVec2(o.q,si.MultiplyVec2(i.q,r[s],$e.s_t0),Ds);let m=0,_=ke;for(let t=0;t<h;++t){const e=$e.Dot(c,l[t]);e<_&&(_=e,m=t)}const d=m,u=d+1<h?d+1:0,p=t[0];ni.MultiplyVec2(o,a[d],p.v);const f=p.id.cf;f.indexA=s,f.indexB=d,f.typeA=Ri.e_face,f.typeB=Ri.e_vertex;const y=t[1];ni.MultiplyVec2(o,a[u],y.v);const v=y.id.cf;v.indexA=s,v.indexB=u,v.typeA=Ri.e_face,v.typeB=Ri.e_vertex}(f,c,_,u,m,d);const y=c.m_count,v=c.m_vertices,x=u,w=u+1<y?u+1:0;let A=v[x],g=v[w];const b=$e.Subtract(g,A,Vs);b.Normalize();const S=$e.CrossVec2One(b,ks),B=$e.Mid(A,g,Us),C=si.MultiplyVec2(_.q,b,zs),R=$e.CrossVec2One(C,Xs);A=ni.MultiplyVec2(_,A,Ys),g=ni.MultiplyVec2(_,g,Ws);const I=$e.Dot(R,A),G=-$e.Dot(C,A)+o,M=$e.Dot(C,g)+o,T=Ps,D=Fs;let L=Vi(T,f,$e.Negate(C,Ns),G,x);if(L<2)return;if(L=Vi(D,T,C,M,w),L<2)return;t.localNormal.Copy(S),t.localPoint.Copy(B);let P=0;for(let e=0;e<2;++e){const i=D[e];if($e.Dot(R,i.v)-I<=o){const e=t.points[P];if(ni.TransposeMultiplyVec2(d,i.v,e.localPoint),e.id.Copy(i.id),p){const{cf:t}=e.id;t.indexA=t.indexB,t.indexB=t.indexA,t.typeA=t.typeB,t.typeB=t.typeA}++P}}t.pointCount=P}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class mo extends ao{Evaluate(t,e,i){!function(t,e,i,s,n){t.pointCount=0;const o=ni.MultiplyVec2(n,s.m_p,Bs),r=ni.TransposeMultiplyVec2(i,o,Cs);let h=0,a=-ke;const l=e.m_radius+s.m_radius,c=e.m_count,m=e.m_vertices,_=e.m_normals;for(let t=0;t<c;++t){const e=$e.Dot(_[t],$e.Subtract(r,m[t],$e.s_t0));if(e>l)return;e>a&&(a=e,h=t)}const d=h,u=d+1<c?d+1:0,p=m[d],f=m[u];if(a<Ue)return t.pointCount=1,t.type=Ii.e_faceA,t.localNormal.Copy(_[h]),$e.Mid(p,f,t.localPoint),t.points[0].localPoint.Copy(s.m_p),void(t.points[0].id.key=0);const y=$e.Dot($e.Subtract(r,p,$e.s_t0),$e.Subtract(f,p,$e.s_t1)),v=$e.Dot($e.Subtract(r,f,$e.s_t0),$e.Subtract(p,f,$e.s_t1));if(y<=0){if($e.DistanceSquared(r,p)>l*l)return;t.pointCount=1,t.type=Ii.e_faceA,$e.Subtract(r,p,t.localNormal).Normalize(),t.localPoint.Copy(p),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else if(v<=0){if($e.DistanceSquared(r,f)>l*l)return;t.pointCount=1,t.type=Ii.e_faceA,$e.Subtract(r,f,t.localNormal).Normalize(),t.localPoint.Copy(f),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else{const e=$e.Mid(p,f,Rs);if($e.Dot($e.Subtract(r,e,$e.s_t1),_[d])>l)return;t.pointCount=1,t.type=Ii.e_faceA,t.localNormal.Copy(_[d]),t.localPoint.Copy(e),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class _o extends ao{Evaluate(t,e,i){tn(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class uo extends ao{Evaluate(t,e,i){An(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class po extends ao{Evaluate(t,e,i){const s=po.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),tn(t,s,e,this.GetShapeB(),i)}}po.Evaluate_s_edge=new Bn;class fo extends ao{Evaluate(t,e,i){const s=fo.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),An(t,s,e,this.GetShapeB(),i)}}fo.Evaluate_s_edge=new Bn;class yo{constructor(){const t=new Array(li.e_typeCount);for(let e=0;e<li.e_typeCount;e++)t[e]=new Array(li.e_typeCount);this.m_registers=t,this.AddType(lo,li.e_circle,li.e_circle),this.AddType(mo,li.e_polygon,li.e_circle),this.AddType(co,li.e_polygon,li.e_polygon),this.AddType(_o,li.e_edge,li.e_circle),this.AddType(uo,li.e_edge,li.e_polygon),this.AddType(po,li.e_chain,li.e_circle),this.AddType(fo,li.e_chain,li.e_polygon)}AddType(t,e,i){const s=[],n=t=>{s.push(t)};this.m_registers[e][i]={createFcn(e,i,n,o){var r;const h=null!==(r=s.pop())&&void 0!==r?r:new t;return h.Reset(e,i,n,o),h},destroyFcn:n},e!==i&&(this.m_registers[i][e]={createFcn(e,i,n,o){var r;const h=null!==(r=s.pop())&&void 0!==r?r:new t;return h.Reset(n,o,e,i),h},destroyFcn:n})}Create(t,e,i,s){const n=t.GetType(),o=i.GetType(),r=this.m_registers[n][o];return r?r.createFcn(t,e,i,s):null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),s=this.m_registers[e][i];null==s||s.destroyFcn(t)}}class vo{ShouldCollide(t,e){const i=t.GetFilterData(),s=e.GetFilterData();return i.groupIndex===s.groupIndex&&0!==i.groupIndex?i.groupIndex>0:!!(i.maskBits&s.categoryBits)&&!!(i.categoryBits&s.maskBits)}}vo.b2_defaultFilter=new vo;class xo{BeginContact(t){}EndContact(t){}PreSolve(t,e){}PostSolve(t,e){}}xo.b2_defaultListener=new xo;class wo{constructor(){this.m_broadPhase=new ss,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=vo.b2_defaultFilter,this.m_contactListener=xo.b2_defaultListener,this.m_contactFactory=new yo,this.AddPair=(t,e)=>{let i=t.fixture,s=e.fixture,n=t.childIndex,o=e.childIndex,r=i.GetBody(),h=s.GetBody();if(r===h)return;let a=h.GetContactList();for(;a;){if(a.other===r){const t=a.contact.GetFixtureA(),e=a.contact.GetFixtureB(),r=a.contact.GetChildIndexA(),h=a.contact.GetChildIndexB();if(t===i&&e===s&&r===n&&h===o)return;if(t===s&&e===i&&r===o&&h===n)return}a=a.next}if(!1===h.ShouldCollide(r))return;if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,s))return;const l=this.m_contactFactory.Create(i,n,s,o);null!==l&&(i=l.GetFixtureA(),s=l.GetFixtureB(),n=l.GetChildIndexA(),o=l.GetChildIndexB(),r=i.m_body,h=s.m_body,l.m_prev=null,l.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=l),this.m_contactList=l,l.m_nodeA.other=h,l.m_nodeA.prev=null,l.m_nodeA.next=r.m_contactList,null!==r.m_contactList&&(r.m_contactList.prev=l.m_nodeA),r.m_contactList=l.m_nodeA,l.m_nodeB.other=r,l.m_nodeB.prev=null,l.m_nodeB.next=h.m_contactList,null!==h.m_contactList&&(h.m_contactList.prev=l.m_nodeB),h.m_contactList=l.m_nodeB,++this.m_contactCount)}}FindNewContacts(){this.m_broadPhase.UpdatePairs(this.AddPair)}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetBody(),n=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===s.m_contactList&&(s.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===n.m_contactList&&(n.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let t=this.m_contactList;for(;t;){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=t.GetChildIndexA(),n=t.GetChildIndexB(),o=e.GetBody(),r=i.GetBody();if(t.m_filterFlag){if(!r.ShouldCollide(o)||this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){const e=t;t=e.m_next,this.Destroy(e);continue}t.m_filterFlag=!1}const h=o.IsAwake()&&o.m_type!==Zi.b2_staticBody,a=r.IsAwake()&&r.m_type!==Zi.b2_staticBody;if(!h&&!a){t=t.m_next;continue}const l=e.m_proxies[s].treeNode,c=i.m_proxies[n].treeNode;if(l.aabb.TestOverlap(c.aabb))t.Update(this.m_contactListener),t=t.m_next;else{const e=t;t=e.m_next,this.Destroy(e)}}}}class Ao{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class go{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.config={velocityIterations:0,positionIterations:0},this.warmStarting=!1}static Create(){return new go}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.config=Object.assign({},t.config),this.warmStarting=t.warmStarting,this}}class bo{constructor(){this.c=new $e,this.a=0}}class So{constructor(){this.v=new $e,this.w=0}}class Bo{constructor(){this.rA=new $e,this.rB=new $e,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}}class Co{constructor(){this.points=Ze(2,Bo),this.normal=new $e,this.tangent=new $e,this.normalMass=new ei,this.K=new ei,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.threshold=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}}class Ro{constructor(){this.localPoints=Ze(2,$e),this.localNormal=new $e,this.localPoint=new $e,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new $e,this.localCenterB=new $e,this.invIA=0,this.invIB=0,this.type=Ii.e_circles,this.radiusA=0,this.radiusB=0,this.pointCount=0}}class Io{constructor(){this.normal=new $e,this.point=new $e,this.separation=0}Initialize(t,e,i,s){const n=Io.Initialize_s_pointA,o=Io.Initialize_s_pointB,r=Io.Initialize_s_planePoint,h=Io.Initialize_s_clipPoint;switch(t.type){case Ii.e_circles:ni.MultiplyVec2(e,t.localPoint,n),ni.MultiplyVec2(i,t.localPoints[0],o),$e.Subtract(o,n,this.normal).Normalize(),$e.Mid(n,o,this.point),this.separation=$e.Dot($e.Subtract(o,n,$e.s_t0),this.normal)-t.radiusA-t.radiusB;break;case Ii.e_faceA:si.MultiplyVec2(e.q,t.localNormal,this.normal),ni.MultiplyVec2(e,t.localPoint,r),ni.MultiplyVec2(i,t.localPoints[s],h),this.separation=$e.Dot($e.Subtract(h,r,$e.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(h);break;case Ii.e_faceB:si.MultiplyVec2(i.q,t.localNormal,this.normal),ni.MultiplyVec2(i,t.localPoint,r),ni.MultiplyVec2(e,t.localPoints[s],h),this.separation=$e.Dot($e.Subtract(h,r,$e.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(h),this.normal.Negate()}}}Io.Initialize_s_pointA=new $e,Io.Initialize_s_pointB=new $e,Io.Initialize_s_planePoint=new $e,Io.Initialize_s_clipPoint=new $e;class Go{constructor(){this.m_step=go.Create(),this.m_positionConstraints=Ze(1024,Ro),this.m_velocityConstraints=Ze(1024,Co),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=Math.max(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new Ro}if(this.m_velocityConstraints.length<this.m_count){const t=Math.max(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Co}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,s=e.m_fixtureB,n=i.GetShape(),o=s.GetShape(),r=n.m_radius,h=o.m_radius,a=i.GetBody(),l=s.GetBody(),c=e.GetManifold(),{pointCount:m}=c,_=this.m_velocityConstraints[t];_.friction=e.m_friction,_.restitution=e.m_restitution,_.threshold=e.m_restitutionThreshold,_.tangentSpeed=e.m_tangentSpeed,_.indexA=a.m_islandIndex,_.indexB=l.m_islandIndex,_.invMassA=a.m_invMass,_.invMassB=l.m_invMass,_.invIA=a.m_invI,_.invIB=l.m_invI,_.contactIndex=t,_.pointCount=m,_.K.SetZero(),_.normalMass.SetZero();const d=this.m_positionConstraints[t];d.indexA=a.m_islandIndex,d.indexB=l.m_islandIndex,d.invMassA=a.m_invMass,d.invMassB=l.m_invMass,d.localCenterA.Copy(a.m_sweep.localCenter),d.localCenterB.Copy(l.m_sweep.localCenter),d.invIA=a.m_invI,d.invIB=l.m_invI,d.localNormal.Copy(c.localNormal),d.localPoint.Copy(c.localPoint),d.pointCount=m,d.radiusA=r,d.radiusB=h,d.type=c.type;for(let t=0;t<m;++t){const e=c.points[t],i=_.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,d.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=Go.InitializeVelocityConstraints_s_xfA,e=Go.InitializeVelocityConstraints_s_xfB,i=Go.InitializeVelocityConstraints_s_worldManifold;for(let s=0;s<this.m_count;++s){const n=this.m_velocityConstraints[s],o=this.m_positionConstraints[s],{radiusA:r,radiusB:h,localCenterA:a,localCenterB:l}=o,c=this.m_contacts[n.contactIndex].GetManifold(),{indexA:m,indexB:_,tangent:d,pointCount:u}=n,p=n.invMassA,f=n.invMassB,y=n.invIA,v=n.invIB,x=this.m_positions[m].c,w=this.m_positions[m].a,A=this.m_velocities[m].v,g=this.m_velocities[m].w,b=this.m_positions[_].c,S=this.m_positions[_].a,B=this.m_velocities[_].v,C=this.m_velocities[_].w;t.q.Set(w),e.q.Set(S),$e.Subtract(x,si.MultiplyVec2(t.q,a,$e.s_t0),t.p),$e.Subtract(b,si.MultiplyVec2(e.q,l,$e.s_t0),e.p),i.Initialize(c,t,r,e,h),n.normal.Copy(i.normal),$e.CrossVec2One(n.normal,d);for(let t=0;t<u;++t){const e=n.points[t];$e.Subtract(i.points[t],x,e.rA),$e.Subtract(i.points[t],b,e.rB);const s=$e.Cross(e.rA,n.normal),o=$e.Cross(e.rB,n.normal),r=p+f+y*s*s+v*o*o;e.normalMass=r>0?1/r:0;const h=$e.Cross(e.rA,d),a=$e.Cross(e.rB,d),l=p+f+y*h*h+v*a*a;e.tangentMass=l>0?1/l:0,e.velocityBias=0;const c=$e.Dot(n.normal,$e.Subtract($e.AddCrossScalarVec2(B,C,e.rB,$e.s_t0),$e.AddCrossScalarVec2(A,g,e.rA,$e.s_t1),$e.s_t0));c<-n.threshold&&(e.velocityBias=-n.restitution*c)}if(2===n.pointCount){const t=n.points[0],e=n.points[1],i=$e.Cross(t.rA,n.normal),s=$e.Cross(t.rB,n.normal),o=$e.Cross(e.rA,n.normal),r=$e.Cross(e.rB,n.normal),h=p+f+y*i*i+v*s*s,a=p+f+y*o*o+v*r*r,l=p+f+y*i*o+v*s*r;h*h<1e3*(h*a-l*l)?(n.K.ex.Set(h,l),n.K.ey.Set(l,a),n.K.GetInverse(n.normalMass)):n.pointCount=1}}}WarmStart(){const t=Go.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],{indexA:s,indexB:n,pointCount:o,normal:r,tangent:h}=i,a=i.invMassA,l=i.invIA,c=i.invMassB,m=i.invIB,_=this.m_velocities[s].v;let d=this.m_velocities[s].w;const u=this.m_velocities[n].v;let p=this.m_velocities[n].w;for(let e=0;e<o;++e){const s=i.points[e];$e.Add($e.Scale(s.normalImpulse,r,$e.s_t0),$e.Scale(s.tangentImpulse,h,$e.s_t1),t),d-=l*$e.Cross(s.rA,t),_.SubtractScaled(a,t),p+=m*$e.Cross(s.rB,t),u.AddScaled(c,t)}this.m_velocities[s].w=d,this.m_velocities[n].w=p}}SolveVelocityConstraints(){const t=Go.SolveVelocityConstraints_s_dv,e=Go.SolveVelocityConstraints_s_dv1,i=Go.SolveVelocityConstraints_s_dv2,s=Go.SolveVelocityConstraints_s_P,n=Go.SolveVelocityConstraints_s_a,o=Go.SolveVelocityConstraints_s_b,r=Go.SolveVelocityConstraints_s_x,h=Go.SolveVelocityConstraints_s_d,a=Go.SolveVelocityConstraints_s_P1,l=Go.SolveVelocityConstraints_s_P2,c=Go.SolveVelocityConstraints_s_P1P2;for(let m=0;m<this.m_count;++m){const _=this.m_velocityConstraints[m],{indexA:d,indexB:u,pointCount:p,normal:f,tangent:y,friction:v}=_,x=_.invMassA,w=_.invIA,A=_.invMassB,g=_.invIB,b=this.m_velocities[d].v;let S=this.m_velocities[d].w;const B=this.m_velocities[u].v;let C=this.m_velocities[u].w;for(let e=0;e<p;++e){const i=_.points[e];$e.Subtract($e.AddCrossScalarVec2(B,C,i.rB,$e.s_t0),$e.AddCrossScalarVec2(b,S,i.rA,$e.s_t1),t);const n=$e.Dot(t,y)-_.tangentSpeed;let o=i.tangentMass*-n;const r=v*i.normalImpulse,h=Qe(i.tangentImpulse+o,-r,r);o=h-i.tangentImpulse,i.tangentImpulse=h,$e.Scale(o,y,s),b.SubtractScaled(x,s),S-=w*$e.Cross(i.rA,s),B.AddScaled(A,s),C+=g*$e.Cross(i.rB,s)}if(1===_.pointCount)for(let e=0;e<p;++e){const i=_.points[e];$e.Subtract($e.AddCrossScalarVec2(B,C,i.rB,$e.s_t0),$e.AddCrossScalarVec2(b,S,i.rA,$e.s_t1),t);const n=$e.Dot(t,f);let o=-i.normalMass*(n-i.velocityBias);const r=Math.max(i.normalImpulse+o,0);o=r-i.normalImpulse,i.normalImpulse=r,$e.Scale(o,f,s),b.SubtractScaled(x,s),S-=w*$e.Cross(i.rA,s),B.AddScaled(A,s),C+=g*$e.Cross(i.rB,s)}else{const t=_.points[0],s=_.points[1];n.Set(t.normalImpulse,s.normalImpulse),$e.Subtract($e.AddCrossScalarVec2(B,C,t.rB,$e.s_t0),$e.AddCrossScalarVec2(b,S,t.rA,$e.s_t1),e),$e.Subtract($e.AddCrossScalarVec2(B,C,s.rB,$e.s_t0),$e.AddCrossScalarVec2(b,S,s.rA,$e.s_t1),i);let m=$e.Dot(e,f),d=$e.Dot(i,f);for(o.x=m-t.velocityBias,o.y=d-s.velocityBias,o.Subtract(ei.MultiplyVec2(_.K,n,$e.s_t0));;){if(ei.MultiplyVec2(_.normalMass,o,r).Negate(),r.x>=0&&r.y>=0){$e.Subtract(r,n,h),$e.Scale(h.x,f,a),$e.Scale(h.y,f,l),$e.Add(a,l,c),b.SubtractScaled(x,c),S-=w*($e.Cross(t.rA,a)+$e.Cross(s.rA,l)),B.AddScaled(A,c),C+=g*($e.Cross(t.rB,a)+$e.Cross(s.rB,l)),t.normalImpulse=r.x,s.normalImpulse=r.y;break}if(r.x=-t.normalMass*o.x,r.y=0,m=0,d=_.K.ex.y*r.x+o.y,r.x>=0&&d>=0){$e.Subtract(r,n,h),$e.Scale(h.x,f,a),$e.Scale(h.y,f,l),$e.Add(a,l,c),b.SubtractScaled(x,c),S-=w*($e.Cross(t.rA,a)+$e.Cross(s.rA,l)),B.AddScaled(A,c),C+=g*($e.Cross(t.rB,a)+$e.Cross(s.rB,l)),t.normalImpulse=r.x,s.normalImpulse=r.y;break}if(r.x=0,r.y=-s.normalMass*o.y,m=_.K.ey.x*r.y+o.x,d=0,r.y>=0&&m>=0){$e.Subtract(r,n,h),$e.Scale(h.x,f,a),$e.Scale(h.y,f,l),$e.Add(a,l,c),b.SubtractScaled(x,c),S-=w*($e.Cross(t.rA,a)+$e.Cross(s.rA,l)),B.AddScaled(A,c),C+=g*($e.Cross(t.rB,a)+$e.Cross(s.rB,l)),t.normalImpulse=r.x,s.normalImpulse=r.y;break}if(r.x=0,r.y=0,m=o.x,d=o.y,m>=0&&d>=0){$e.Subtract(r,n,h),$e.Scale(h.x,f,a),$e.Scale(h.y,f,l),$e.Add(a,l,c),b.SubtractScaled(x,c),S-=w*($e.Cross(t.rA,a)+$e.Cross(s.rA,l)),B.AddScaled(A,c),C+=g*($e.Cross(t.rB,a)+$e.Cross(s.rB,l)),t.normalImpulse=r.x,s.normalImpulse=r.y;break}break}}this.m_velocities[d].w=S,this.m_velocities[u].w=C}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=Go.SolvePositionConstraints_s_xfA,e=Go.SolvePositionConstraints_s_xfB,i=Go.SolvePositionConstraints_s_psm,s=Go.SolvePositionConstraints_s_rA,n=Go.SolvePositionConstraints_s_rB,o=Go.SolvePositionConstraints_s_P;let r=0;for(let h=0;h<this.m_count;++h){const a=this.m_positionConstraints[h],{indexA:l,indexB:c,localCenterA:m,localCenterB:_,pointCount:d}=a,u=a.invMassA,p=a.invIA,f=a.invMassB,y=a.invIB,v=this.m_positions[l].c;let x=this.m_positions[l].a;const w=this.m_positions[c].c;let A=this.m_positions[c].a;for(let h=0;h<d;++h){t.q.Set(x),e.q.Set(A),$e.Subtract(v,si.MultiplyVec2(t.q,m,$e.s_t0),t.p),$e.Subtract(w,si.MultiplyVec2(e.q,_,$e.s_t0),e.p),i.Initialize(a,t,e,h);const{normal:l,point:c,separation:d}=i;$e.Subtract(c,v,s),$e.Subtract(c,w,n),r=Math.min(r,d);const g=Qe(.2*(d+ze),-.2,0),b=$e.Cross(s,l),S=$e.Cross(n,l),B=u+f+p*b*b+y*S*S,C=B>0?-g/B:0;$e.Scale(C,l,o),v.SubtractScaled(u,o),x-=p*$e.Cross(s,o),w.AddScaled(f,o),A+=y*$e.Cross(n,o)}this.m_positions[l].c.Copy(v),this.m_positions[l].a=x,this.m_positions[c].c.Copy(w),this.m_positions[c].a=A}return r>=-.015}SolveTOIPositionConstraints(t,e){const i=Go.SolveTOIPositionConstraints_s_xfA,s=Go.SolveTOIPositionConstraints_s_xfB,n=Go.SolveTOIPositionConstraints_s_psm,o=Go.SolveTOIPositionConstraints_s_rA,r=Go.SolveTOIPositionConstraints_s_rB,h=Go.SolveTOIPositionConstraints_s_P;let a=0;for(let l=0;l<this.m_count;++l){const c=this.m_positionConstraints[l],{indexA:m,indexB:_,localCenterA:d,localCenterB:u,pointCount:p}=c;let f=0,y=0;m!==t&&m!==e||(f=c.invMassA,y=c.invIA);let v=0,x=0;_!==t&&_!==e||(v=c.invMassB,x=c.invIB);const w=this.m_positions[m].c;let A=this.m_positions[m].a;const g=this.m_positions[_].c;let b=this.m_positions[_].a;for(let t=0;t<p;++t){i.q.Set(A),s.q.Set(b),$e.Subtract(w,si.MultiplyVec2(i.q,d,$e.s_t0),i.p),$e.Subtract(g,si.MultiplyVec2(s.q,u,$e.s_t0),s.p),n.Initialize(c,i,s,t);const{normal:e,point:l,separation:m}=n;$e.Subtract(l,w,o),$e.Subtract(l,g,r),a=Math.min(a,m);const _=Qe(.75*(m+ze),-.2,0),p=$e.Cross(o,e),S=$e.Cross(r,e),B=f+v+y*p*p+x*S*S,C=B>0?-_/B:0;$e.Scale(C,e,h),w.SubtractScaled(f,h),A-=y*$e.Cross(o,h),g.AddScaled(v,h),b+=x*$e.Cross(r,h)}this.m_positions[m].a=A,this.m_positions[_].a=b}return a>=-.0075}}Go.InitializeVelocityConstraints_s_xfA=new ni,Go.InitializeVelocityConstraints_s_xfB=new ni,Go.InitializeVelocityConstraints_s_worldManifold=new Pi,Go.WarmStart_s_P=new $e,Go.SolveVelocityConstraints_s_dv=new $e,Go.SolveVelocityConstraints_s_dv1=new $e,Go.SolveVelocityConstraints_s_dv2=new $e,Go.SolveVelocityConstraints_s_P=new $e,Go.SolveVelocityConstraints_s_a=new $e,Go.SolveVelocityConstraints_s_b=new $e,Go.SolveVelocityConstraints_s_x=new $e,Go.SolveVelocityConstraints_s_d=new $e,Go.SolveVelocityConstraints_s_P1=new $e,Go.SolveVelocityConstraints_s_P2=new $e,Go.SolveVelocityConstraints_s_P1P2=new $e,Go.SolvePositionConstraints_s_xfA=new ni,Go.SolvePositionConstraints_s_xfB=new ni,Go.SolvePositionConstraints_s_psm=new Io,Go.SolvePositionConstraints_s_rA=new $e,Go.SolvePositionConstraints_s_rB=new $e,Go.SolvePositionConstraints_s_P=new $e,Go.SolveTOIPositionConstraints_s_xfA=new ni,Go.SolveTOIPositionConstraints_s_xfB=new ni,Go.SolveTOIPositionConstraints_s_psm=new Io,Go.SolveTOIPositionConstraints_s_rA=new $e,Go.SolveTOIPositionConstraints_s_rB=new $e,Go.SolveTOIPositionConstraints_s_P=new $e;class Mo{constructor(t,e,i,s){this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=t,this.m_listener=s,this.m_bodies=new Array(t),this.m_contacts=new Array(e),this.m_joints=new Array(i),this.m_velocities=Ze(t,So),this.m_positions=Ze(t,bo),this.Resize(t)}Resize(t){for(;this.m_bodyCapacity<t;)this.m_velocities[this.m_bodyCapacity]=new So,this.m_positions[this.m_bodyCapacity]=new bo,this.m_bodyCapacity++}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount]=t,++this.m_bodyCount}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(t,e,i,s){const n=e.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c);const{a:s}=e.m_sweep,o=this.m_velocities[t].v.Copy(e.m_linearVelocity);let r=e.m_angularVelocity;e.m_sweep.c0.Copy(e.m_sweep.c),e.m_sweep.a0=e.m_sweep.a,e.m_type===Zi.b2_dynamicBody&&(o.x+=n*e.m_invMass*(e.m_gravityScale*e.m_mass*i.x+e.m_force.x),o.y+=n*e.m_invMass*(e.m_gravityScale*e.m_mass*i.y+e.m_force.y),r+=n*e.m_invI*e.m_torque,o.Scale(1/(1+n*e.m_linearDamping)),r*=1/(1+n*e.m_angularDamping)),this.m_positions[t].a=s,this.m_velocities[t].w=r}const o=Mo.s_solverData;o.step.Copy(e),o.positions=this.m_positions,o.velocities=this.m_velocities;const r=Mo.s_contactSolverDef;r.step.Copy(e),r.contacts=this.m_contacts,r.count=this.m_contactCount,r.positions=this.m_positions,r.velocities=this.m_velocities;const h=Mo.s_contactSolver.Initialize(r);h.InitializeVelocityConstraints(),e.warmStarting&&h.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(o);for(let t=0;t<e.config.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(o);h.SolveVelocityConstraints()}h.StoreImpulses();for(let t=0;t<this.m_bodyCount;++t){const{c:e}=this.m_positions[t];let{a:i}=this.m_positions[t];const{v:s}=this.m_velocities[t];let{w:o}=this.m_velocities[t];const r=$e.Scale(n,s,Mo.s_translation);if($e.Dot(r,r)>4){const t=2/r.Length();s.Scale(t)}const h=n*o;h*h>He&&(o*=qe/Math.abs(h)),e.AddScaled(n,s),i+=n*o,this.m_positions[t].a=i,this.m_velocities[t].w=o}let a=!1;for(let t=0;t<e.config.positionIterations;++t){const t=h.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(o);e=e&&i}if(t&&e){a=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(this.Report(h.m_velocityConstraints),s){let t=ke;const e=1e-4,i=je*je;for(let s=0;s<this.m_bodyCount;++s){const o=this.m_bodies[s];o.GetType()!==Zi.b2_staticBody&&(!o.m_autoSleepFlag||o.m_angularVelocity*o.m_angularVelocity>i||$e.Dot(o.m_linearVelocity,o.m_linearVelocity)>e?(o.m_sleepTime=0,t=0):(o.m_sleepTime+=n,t=Math.min(t,o.m_sleepTime)))}if(t>=.5&&a)for(let t=0;t<this.m_bodyCount;++t)this.m_bodies[t].SetAwake(!1)}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const s=Mo.s_contactSolverDef;s.contacts=this.m_contacts,s.count=this.m_contactCount,s.step.Copy(t),s.positions=this.m_positions,s.velocities=this.m_velocities;const n=Mo.s_contactSolver.Initialize(s);for(let s=0;s<t.config.positionIterations&&!n.SolveTOIPositionConstraints(e,i);++s);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,n.InitializeVelocityConstraints();for(let e=0;e<t.config.velocityIterations;++e)n.SolveVelocityConstraints();const o=t.dt;for(let t=0;t<this.m_bodyCount;++t){const{c:e}=this.m_positions[t];let{a:i}=this.m_positions[t];const{v:s}=this.m_velocities[t];let{w:n}=this.m_velocities[t];const r=$e.Scale(o,s,Mo.s_translation);if($e.Dot(r,r)>4){const t=2/r.Length();s.Scale(t)}const h=o*n;h*h>He&&(n*=qe/Math.abs(h)),e.AddScaled(o,s),i+=o*n,this.m_positions[t].a=i,this.m_velocities[t].w=n;const a=this.m_bodies[t];a.m_sweep.c.Copy(e),a.m_sweep.a=i,a.m_linearVelocity.Copy(s),a.m_angularVelocity=n,a.SynchronizeTransform()}this.Report(n.m_velocityConstraints)}Report(t){for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e],s=t[e],n=Mo.s_impulse;n.count=s.pointCount;for(let t=0;t<s.pointCount;++t)n.normalImpulses[t]=s.points[t].normalImpulse,n.tangentImpulses[t]=s.points[t].tangentImpulse;this.m_listener.PostSolve(i,n)}}}Mo.s_solverData=new class{constructor(){this.step=go.Create()}},Mo.s_contactSolverDef=new class{constructor(){this.step=go.Create(),this.count=0}},Mo.s_contactSolver=new Go,Mo.s_translation=new $e,Mo.s_impulse=new class{constructor(){this.normalImpulses=Je(2),this.tangentImpulses=Je(2),this.count=0}};class To{constructor(t){this.m_contactManager=new wo,this.m_bodyList=null,this.m_jointList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new $e,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_inv_dt0=0,this.m_newContacts=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Ao,this.m_island=new Mo(64,32,0,this.m_contactManager.m_contactListener),this.s_stack=[],this.m_gravity.Copy(t)}static Create(t){return new To(t)}SetDestructionListener(t){this.m_destructionListener=t}GetDestructionListener(){return this.m_destructionListener}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t,this.m_island.m_listener=t}CreateBody(t={}){Oe(!this.IsLocked());const e=new Qi(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){var e,i;Oe(!this.IsLocked());let s=t.m_jointList;for(;s;){const i=s;s=s.next,null===(e=this.m_destructionListener)||void 0===e||e.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=s}t.m_jointList=null;let n=t.m_contactList;for(;n;){const t=n;n=n.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;const o=this.m_contactManager.m_broadPhase;let r=t.m_fixtureList;for(;r;){const e=r;r=r.m_next,null===(i=this.m_destructionListener)||void 0===i||i.SayGoodbyeFixture(e),e.DestroyProxies(o),t.m_fixtureList=r,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static Joint_Create(t){switch(t.type){case In.e_distanceJoint:return new Pn(t);case In.e_mouseJoint:return new Nn(t);case In.e_prismaticJoint:return new Wn(t);case In.e_revoluteJoint:return new $n(t);case In.e_pulleyJoint:return new Kn(t);case In.e_gearJoint:return new kn(t);case In.e_wheelJoint:return new so(t);case In.e_weldJoint:return new eo(t);case In.e_frictionJoint:return new On(t);case In.e_motorJoint:return new Xn(t);case In.e_areaJoint:return new Fn(t)}throw new Error}CreateJoint(t){Oe(!this.IsLocked());const e=To.Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,s=e.m_bodyB;if(!t.collideConnected){let t=s.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){Oe(!this.IsLocked()),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,s=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.prev=null,t.m_edgeA.next=null,t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.prev=null,t.m_edgeB.next=null,--this.m_jointCount,!s){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}Step(t,e){this.m_newContacts&&(this.m_contactManager.FindNewContacts(),this.m_newContacts=!1),this.m_locked=!0;const i=To.Step_s_step;i.dt=t,i.config=Object.assign({},e),i.inv_dt=t>0?1/t:0,i.dtRatio=this.m_inv_dt0*t,i.warmStarting=this.m_warmStarting,this.m_contactManager.Collide(),this.m_stepComplete&&i.dt>0&&this.Solve(i),this.m_continuousPhysics&&i.dt>0&&this.SolveTOI(i),i.dt>0&&(this.m_inv_dt0=i.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1}ClearForces(){for(let t=this.m_bodyList;t;t=t.GetNext())t.m_force.SetZero(),t.m_torque=0}QueryAABB(t,e){this.m_contactManager.m_broadPhase.Query(t,(t=>{const i=Ve(t.userData);return e(i.fixture)}))}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(t,e){this.m_contactManager.m_broadPhase.QueryPoint(t,(t=>{const i=Ve(t.userData);return e(i.fixture)}))}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(t,e,i,s){const n=To.QueryFixtureShape_s_aabb;t.ComputeAABB(n,i,e),this.m_contactManager.m_broadPhase.Query(n,(n=>{const o=Ve(n.userData),{fixture:r}=o;return!zi(t,e,r.GetShape(),o.childIndex,i,r.GetBody().GetTransform())||s(r)}))}QueryAllFixtureShape(t,e,i,s=[]){return this.QueryFixtureShape(t,e,i,(t=>(s.push(t),!0))),s}QueryFixturePoint(t,e){this.m_contactManager.m_broadPhase.QueryPoint(t,(i=>{const s=Ve(i.userData),{fixture:n}=s;return!n.TestPoint(t)||e(n)}))}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(t,e,i){const s=To.RayCast_s_input;s.maxFraction=1,s.p1.Copy(t),s.p2.Copy(e),this.m_contactManager.m_broadPhase.RayCast(s,((s,n)=>{const o=Ve(n.userData),{fixture:r}=o,h=o.childIndex,a=To.RayCast_s_output;if(r.RayCast(a,s,h)){const{fraction:s}=a,n=To.RayCast_s_point;return n.Set((1-s)*t.x+s*e.x,(1-s)*t.y+s*e.y),i(r,n,a.normal,s)}return s.maxFraction}))}RayCastOne(t,e){let i=null,s=1;return this.RayCast(t,e,((t,e,n,o)=>(o<s&&(s=o,i=t),s))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(t=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t){this.m_gravity.Copy(t)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){Oe(!this.IsLocked());for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.Subtract(t),e.m_sweep.c0.Subtract(t),e.m_sweep.c.Subtract(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Solve(t){this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const e=this.m_island;e.Resize(this.m_bodyCount),e.Clear();for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const i=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsEnabled())continue;if(s.GetType()===Zi.b2_staticBody)continue;e.Clear();let n=0;for(i[n++]=s,s.m_islandFlag=!0;n>0;){const t=i[--n];if(Oe(null!==t),e.AddBody(t),t.GetType()!==Zi.b2_staticBody){t.m_awakeFlag=!0;for(let s=t.m_contactList;s;s=s.next){const{contact:t}=s;if(t.m_islandFlag)continue;if(!t.IsEnabled()||!t.IsTouching())continue;const o=t.m_fixtureA.m_isSensor,r=t.m_fixtureB.m_isSensor;if(o||r)continue;e.AddContact(t),t.m_islandFlag=!0;const{other:h}=s;h.m_islandFlag||(i[n++]=h,h.m_islandFlag=!0)}for(let s=t.m_jointList;s;s=s.next){if(s.joint.m_islandFlag)continue;const{other:t}=s;t.IsEnabled()&&(e.AddJoint(s.joint),s.joint.m_islandFlag=!0,t.m_islandFlag||(i[n++]=t,t.m_islandFlag=!0))}}}const o=new Ao;e.Solve(o,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=o.solveInit,this.m_profile.solveVelocity+=o.solveVelocity,this.m_profile.solvePosition+=o.solvePosition;for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];i.GetType()===Zi.b2_staticBody&&(i.m_islandFlag=!1)}}for(let t=0;t<i.length&&i[t];++t)i[t]=null;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag&&t.GetType()!==Zi.b2_staticBody&&t.SynchronizeFixtures();this.m_contactManager.FindNewContacts()}SolveTOI(t){const e=this.m_island;if(e.Clear(),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let i=null,s=1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next){if(!t.IsEnabled())continue;if(t.m_toiCount>8)continue;let e=1;if(t.m_toiFlag)e=t.m_toi;else{const i=t.GetFixtureA(),s=t.GetFixtureB();if(i.IsSensor()||s.IsSensor())continue;const n=i.GetBody(),o=s.GetBody(),r=n.m_type,h=o.m_type,a=n.IsAwake()&&r!==Zi.b2_staticBody,l=o.IsAwake()&&h!==Zi.b2_staticBody;if(!a&&!l)continue;const c=n.IsBullet()||r!==Zi.b2_dynamicBody,m=o.IsBullet()||h!==Zi.b2_dynamicBody;if(!c&&!m)continue;let{alpha0:_}=n.m_sweep;n.m_sweep.alpha0<o.m_sweep.alpha0?(_=o.m_sweep.alpha0,n.m_sweep.Advance(_)):o.m_sweep.alpha0<n.m_sweep.alpha0&&(_=n.m_sweep.alpha0,o.m_sweep.Advance(_));const d=t.GetChildIndexA(),u=t.GetChildIndexB(),p=To.SolveTOI_s_toi_input;p.proxyA.SetShape(i.GetShape(),d),p.proxyB.SetShape(s.GetShape(),u),p.sweepA.Copy(n.m_sweep),p.sweepB.Copy(o.m_sweep),p.tMax=1;const f=To.SolveTOI_s_toi_output;gs(f,p);const y=f.t;e=f.state===_s.e_touching?Math.min(_+(1-_)*y,1):1,t.m_toi=e,t.m_toiFlag=!0}e<s&&(i=t,s=e)}if(null===i||.9999<s){this.m_stepComplete=!0;break}const n=i.GetFixtureA(),o=i.GetFixtureB(),r=n.GetBody(),h=o.GetBody(),a=To.SolveTOI_s_backup1.Copy(r.m_sweep),l=To.SolveTOI_s_backup2.Copy(h.m_sweep);if(r.Advance(s),h.Advance(s),i.Update(this.m_contactManager.m_contactListener),i.m_toiFlag=!1,++i.m_toiCount,!i.IsEnabled()||!i.IsTouching()){i.SetEnabled(!1),r.m_sweep.Copy(a),h.m_sweep.Copy(l),r.SynchronizeTransform(),h.SynchronizeTransform();continue}r.SetAwake(!0),h.SetAwake(!0),e.Clear(),e.AddBody(r),e.AddBody(h),e.AddContact(i),r.m_islandFlag=!0,h.m_islandFlag=!0,i.m_islandFlag=!0;for(let t=0;t<2;++t){const i=0===t?r:h;if(i.m_type===Zi.b2_dynamicBody)for(let t=i.m_contactList;t&&e.m_bodyCount!==e.m_bodyCapacity&&32!==e.m_contactCount;t=t.next){const{contact:n}=t;if(n.m_islandFlag)continue;const{other:o}=t;if(o.m_type===Zi.b2_dynamicBody&&!i.IsBullet()&&!o.IsBullet())continue;const r=n.m_fixtureA.m_isSensor,h=n.m_fixtureB.m_isSensor;if(r||h)continue;const a=To.SolveTOI_s_backup.Copy(o.m_sweep);o.m_islandFlag||o.Advance(s),n.Update(this.m_contactManager.m_contactListener),n.IsEnabled()&&n.IsTouching()?(n.m_islandFlag=!0,e.AddContact(n),o.m_islandFlag||(o.m_islandFlag=!0,o.m_type!==Zi.b2_staticBody&&o.SetAwake(!0),e.AddBody(o))):(o.m_sweep.Copy(a),o.SynchronizeTransform())}}const c=To.SolveTOI_s_subStep;c.dt=(1-s)*t.dt,c.inv_dt=1/c.dt,c.dtRatio=1,c.config=Object.assign(Object.assign({},t.config),{positionIterations:20}),c.warmStarting=!1,e.SolveTOI(c,r.m_islandIndex,h.m_islandIndex);for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];if(i.m_islandFlag=!1,i.m_type===Zi.b2_dynamicBody){i.SynchronizeFixtures();for(let t=i.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}}var Do,Lo;To.Step_s_step=go.Create(),To.QueryFixtureShape_s_aabb=new Oi,To.RayCast_s_input=new Ei,To.RayCast_s_output=new class{constructor(){this.normal=new $e,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}},To.RayCast_s_point=new $e,To.SolveTOI_s_subStep=go.Create(),To.SolveTOI_s_backup=new oi,To.SolveTOI_s_backup1=new oi,To.SolveTOI_s_backup2=new oi,To.SolveTOI_s_toi_input=new class{constructor(){this.proxyA=new mi,this.proxyB=new mi,this.sweepA=new oi,this.sweepB=new oi,this.tMax=0}},To.SolveTOI_s_toi_output=new class{constructor(){this.state=_s.e_unknown,this.t=0}},new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,new $e,function(t){t[t.b2_pbdStretchingModel=0]="b2_pbdStretchingModel",t[t.b2_xpbdStretchingModel=1]="b2_xpbdStretchingModel"}(Do||(Do={})),function(t){t[t.b2_springAngleBendingModel=0]="b2_springAngleBendingModel",t[t.b2_pbdAngleBendingModel=1]="b2_pbdAngleBendingModel",t[t.b2_xpbdAngleBendingModel=2]="b2_xpbdAngleBendingModel",t[t.b2_pbdDistanceBendingModel=3]="b2_pbdDistanceBendingModel",t[t.b2_pbdHeightBendingModel=4]="b2_pbdHeightBendingModel",t[t.b2_pbdTriangleBendingModel=5]="b2_pbdTriangleBendingModel"}(Lo||(Lo={}));class Po{constructor(t,e){this.tranStack=[],this.points=[],this.batcher=t,this.mat=new $(K.GetShaderProgram("color"))}getTran(){return 0==this.tranStack.length?ni.IDENTITY:this.tranStack[this.tranStack.length-1]}PushTransform(t){if(0==this.tranStack.length)this.tranStack.push(t);else{let e=new ni;ni.Multiply(this.tranStack[this.tranStack.length-1],t,e),this.tranStack.push(e)}}PopTransform(t){this.tranStack.pop()}DrawPolygon(t,e,i){for(;this.points.length<2;)this.points.push(new Ot);let s=this.getTran();for(var n=0;n<e;n++){let o={x:0,y:0},r={x:0,y:0},h=n+1;h>=e&&(h=0),ni.MultiplyVec2(s,t[n+0],o),ni.MultiplyVec2(s,t[h],r),this.points[0].x=1*o.x,this.points[0].y=1*o.y,this.points[0].z=0,this.points[0].r=i.r,this.points[0].g=i.g,this.points[0].b=i.b,this.points[0].a=i.a,this.points[1].x=1*r.x,this.points[1].y=1*r.y,this.points[1].z=0,this.points[1].r=i.r,this.points[1].g=i.g,this.points[1].b=i.b,this.points[1].a=i.a,this.batcher.DrawLines(this.mat,this.points,1)}}DrawSolidPolygon(t,e,i){for(;this.points.length<3;)this.points.push(new Ot);let s=this.getTran(),n={x:0,y:0};ni.MultiplyVec2(s,t[0],n),n.x*=1,n.y*=1;for(var o=0;o<e-2;o++){let e={x:0,y:0},r={x:0,y:0};ni.MultiplyVec2(s,t[o+1],e),ni.MultiplyVec2(s,t[o+2],r),this.points[0].x=1*n.x,this.points[0].y=1*n.y,this.points[0].z=0,this.points[0].r=i.r,this.points[0].g=i.g,this.points[0].b=i.b,this.points[0].a=i.a,this.points[1].x=1*e.x,this.points[1].y=1*e.y,this.points[1].z=0,this.points[1].r=i.r,this.points[1].g=i.g,this.points[1].b=i.b,this.points[1].a=i.a,this.points[2].x=1*r.x,this.points[2].y=1*r.y,this.points[2].z=0,this.points[2].r=i.r,this.points[2].g=i.g,this.points[2].b=i.b,this.points[2].a=i.a,this.batcher.DrawTris(this.mat,this.points,1)}}DrawCircle(t,e,i){for(;this.points.length<2;)this.points.push(new Ot);let s=this.getTran();for(var n=0;n<16;n++){let o=Math.sin(2*Math.PI*n/16),r=Math.cos(2*Math.PI*n/16),h=Math.sin(2*Math.PI*(n+1)/16),a=Math.cos(2*Math.PI*(n+1)/16),l={x:0,y:0},c={x:0,y:0},m={x:t.x+o*e,y:t.y+r*e},_={x:t.x+h*e,y:t.y+a*e};ni.MultiplyVec2(s,m,l),ni.MultiplyVec2(s,_,c),this.points[0].x=1*l.x,this.points[0].y=1*l.y,this.points[0].z=0,this.points[0].r=i.r,this.points[0].g=i.g,this.points[0].b=i.b,this.points[0].a=i.a,this.points[1].x=1*c.x,this.points[1].y=1*c.y,this.points[1].z=0,this.points[1].r=i.r,this.points[1].g=i.g,this.points[1].b=i.b,this.points[1].a=i.a,this.batcher.DrawLines(this.mat,this.points,1)}}DrawSolidCircle(t,e,i,s){for(;this.points.length<3;)this.points.push(new Ot);let n=this.getTran(),o={x:0,y:0};ni.MultiplyVec2(n,t,o);for(var r=0;r<16;r++){let i=Math.sin(2*Math.PI*r/16),h=Math.cos(2*Math.PI*r/16),a=Math.sin(2*Math.PI*(r+1)/16),l=Math.cos(2*Math.PI*(r+1)/16),c={x:0,y:0},m={x:0,y:0},_={x:t.x+i*e,y:t.y+h*e},d={x:t.x+a*e,y:t.y+l*e};ni.MultiplyVec2(n,_,c),ni.MultiplyVec2(n,d,m),this.points[0].x=1*o.x,this.points[0].y=1*o.y,this.points[0].z=0,this.points[0].r=s.r,this.points[0].g=s.g,this.points[0].b=s.b,this.points[0].a=s.a,this.points[1].x=1*c.x,this.points[1].y=1*c.y,this.points[1].z=0,this.points[1].r=s.r,this.points[1].g=s.g,this.points[1].b=s.b,this.points[1].a=s.a,this.points[2].x=1*m.x,this.points[2].y=1*m.y,this.points[2].z=0,this.points[2].r=s.r,this.points[2].g=s.g,this.points[2].b=s.b,this.points[2].a=s.a,this.batcher.DrawTris(this.mat,this.points,1)}}DrawSegment(t,e,i){throw new Error("Method not implemented.")}DrawTransform(t){throw new Error("Method not implemented.")}DrawPoint(t,e,i){throw new Error("Method not implemented.")}}var Fo,Eo=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class Oo{static Init(){try{Neutralino.init(),this._envWeb=!1,this.Log("Neutralino env Init."),Neutralino.events.on("windowClose",(()=>{Neutralino.app.exit()}))}catch(t){this._envWeb=!0,this.Log("error:"+t),this.Log("Web env Init.")}}static IsWebEnv(){return this._envWeb}static Log(t,e=Fo.INFO){this._envWeb||(e==Fo.INFO?Neutralino.debug.log("[IOExt]==>"+t,"INFO"):e==Fo.WARNING?Neutralino.debug.log("[IOExt]==>"+t,"WARNING"):Neutralino.debug.log("[IOExt]==>"+t,"ERROR")),e==Fo.INFO?console.log("[IOExt]==>"+t):e==Fo.WARNING?console.warn("[IOExt]==>"+t):console.error("[IOExt]==>"+t)}static Picker_OpenFile(){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let t=yield window.showOpenFilePicker();return null==t?null:new Vo(t[0],null)}{let t={filters:[{name:"tt.json",extensions:["tt.json"]}]},e=yield Neutralino.os.showOpenDialog("open file dialog.",t);return null==e||0==e.length?null:new Vo(e[0],null)}}))}static Picker_SaveFile(){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let t=yield window.showSaveFilePicker();return null==t?null:new Vo(t,null)}{let t={filters:[{name:"tt.json",extensions:["tt.json"]}]},e=yield Neutralino.os.showSaveDialog("open file dialog.",t);return null==e?null:new Vo(e,null)}}))}static Picker_Folder(){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){var t=yield window.showDirectoryPicker();return new ko(t,null)}var e=yield Neutralino.os.showFolderDialog("选择文件夹");return new ko(e,null)}))}static File_ReadText(t){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let e=yield t.state.getFile();return yield e.text()}return yield Neutralino.filesystem.readFile(t.state)}))}static File_ReadBinary(t){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let e=yield t.state.getFile();return yield e.arrayBuffer()}return yield Neutralino.filesystem.readBinaryFile(t.state)}))}static File_WriteBinary(t,e){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let i=t.state,s=yield i.createWritable({keepExistingData:!1});return s.write(e),s.close(),!0}return yield Neutralino.filesystem.writeBinaryFile(t.state,e),!0}))}static File_WriteText(t,e){return Eo(this,void 0,void 0,(function*(){if(this._envWeb){let i=yield t.state.createWritable({keepExistingData:!1});return i.write(e),i.close(),!0}return yield Neutralino.filesystem.writeFile(t.state,e),!0}))}static File_CreateText(t,e,i){return Eo(this,void 0,void 0,(function*(){let s;if(this._envWeb){let i=yield t.state.getFileHandle(e,{create:!0});s=new Vo(i,t)}else{let i=t.state+"/"+e;s=new Vo(i,t)}return yield this.File_WriteText(s,i)}))}static File_CreateBinary(t,e,i){return Eo(this,void 0,void 0,(function*(){let s;if(this._envWeb){let i=yield t.state.getFileHandle(e,{create:!0});s=new Vo(i,t)}else{let i=t.state+"/"+e;s=new Vo(i,t)}return yield this.File_WriteBinary(s,i)}))}static Directory_List(t){return Eo(this,void 0,void 0,(function*(){var e,i,s,n;let o=[];try{if(this._envWeb){var r=t.state.entries();try{for(var h,a=!0,l=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},s("next"),s("throw"),s("return"),e[Symbol.asyncIterator]=function(){return this},e);function s(i){e[i]=t[i]&&function(e){return new Promise((function(s,n){!function(t,e,i,s){Promise.resolve(s).then((function(e){t({value:e,done:i})}),e)}(s,n,(e=t[i](e)).done,e.value)}))}}}(r);!(e=(h=yield l.next()).done);a=!0){n=h.value,a=!1;const[e,i]=n;let s=i;"file"==s.kind?o.push(new Vo(s,t)):o.push(new ko(s,t))}}catch(t){i={error:t}}finally{try{a||e||!(s=l.return)||(yield s.call(l))}finally{if(i)throw i.error}}}else{let e=yield Neutralino.filesystem.readDirectory(t.state);for(var c=0;c<e.length;c++)"FILE"==e[c].type?o.push(new Vo(e[c].path,t)):o.push(new ko(e[c].path,t))}}catch(e){this.Log("Directory_List Error("+JSON.stringify(t)+" msg:"+e,Fo.ERROR)}return o}))}static Directory_Create(t,e){return Eo(this,void 0,void 0,(function*(){if(!this._envWeb){let i=t.state+"/"+e;return yield Neutralino.filesystem.createDirectory(i),new ko(i,t)}try{let i=yield t.state.getDirectoryHandle(e,{create:!0});return new ko(i,t)}catch(t){this.Log("Directory_Create error:"+t)}}))}static Directory_Remove(t,e){return Eo(this,void 0,void 0,(function*(){if(!this._envWeb){let i=t.state+"/"+e;return yield Neutralino.filesystem.remove(i),!0}try{return yield t.state.removeEntry(e,{recursive:!0}),!0}catch(t){return this.Log("Directory_Create error:"+t),!1}}))}}Oo._envWeb=!1,function(t){t[t.INFO=0]="INFO",t[t.WARNING=1]="WARNING",t[t.ERROR=2]="ERROR"}(Fo||(Fo={}));class Vo{constructor(t,e){if(this.state=t,this.isfile=!0,Oo.IsWebEnv())this.name=t.name;else{let e=t.lastIndexOf("/");this.name=t.substring(e+1)}this.fullname=null==e?this.name:e.fullname+"/"+this.name,this.parent=e}}class ko{constructor(t,e){if(this.state=t,this.isfile=!1,Oo.IsWebEnv())this.name=t.name;else{let e=t.lastIndexOf("/");this.name=t.substring(e+1)}this.fullname=null==e?this.name:e.fullname+"/"+this.name,this.parent=e}}var Uo,Xo,zo=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class No{static FindAllFile(t,e,i){return zo(this,void 0,void 0,(function*(){let i="";for(var s=0;s<e.length;s++){let t=e[s];"."!=t.charAt(0)&&(t="."+t),s>0&&(i+="|"),i=i+"(("+t+")$)"}let n=new RegExp(i);n.ignoreCase;let o=[];return yield this.FindAllFile_Deep(t,n,o,2),o}))}static FindAllFile_Deep(t,e,i,s){return zo(this,void 0,void 0,(function*(){let n=yield Oo.Directory_List(t);for(var o=0;o<n.length;o++)n[o].isfile?e.test(n[o].name)&&i.push(n[o]):s>1&&"."!=n[o].name.charAt(0)&&(yield this.FindAllFile_Deep(n[o],e,i,s-1))}))}}class Yo{constructor(t=!1){}RenderBatch(t,e,i,s){}RenderOrderedBegin(t,e,i){}RenderOrdered(t){}RenderOrderedEnd(){}}(Xo=Uo||(Uo={}))[Xo.SingleMesh=0]="SingleMesh",Xo[Xo.TBOBatchRender=1]="TBOBatchRender",Xo[Xo.VBOBatchRender=2]="VBOBatchRender";class Wo{constructor(){this._dirtypos=!1,this._passOffset=!1,this._pos=B.Zero,this._poslocal=B.Zero,this.name="",this.scene=null,this.parent=null,this.comps=null,this.children=null}set posdirty(t){this._dirtypos=t}get passOffset(){return this._passOffset}set passOffset(t){this._passOffset!=t&&(this._passOffset=t,this.posdirty=!0)}get pos(){return this._pos}set poslocal(t){this._poslocal=t,this._dirtypos=!0}get poslocal(){return this._poslocal}IsRoot(){return null!=this.scene&&null==this.parent}InScene(){return null!=this.scene}OnNodeAdd(t){this.parent=t}OnNodeRemove(){this.parent=null}OnAttachScene(t){if(null==this.scene){if(this.scene=t,null!=this.comps)for(var e=0;e<this.comps.length;e++)this.comps[e].OnAdd(this);if(null!=this.children)for(e=0;e<this.children.length;e++)this.children[e].OnAttachScene(t)}}OnRemoveScene(){if(null!=this.scene){if(null!=this.comps)for(var t=0;t<this.comps.length;t++)this.comps[t].OnRemove();if(null!=this.children)for(t=0;t<this.children.length;t++)this.children[t].OnRemoveScene()}this.scene=null}UpdatePos(){var t;if(this._dirtypos&&((null===(t=this.parent)||void 0===t?void 0:t.passOffset)?this._pos=B.Add(this.parent.pos,this._poslocal):this._pos=this._poslocal,this._dirtypos=!1,this.passOffset&&null!=this.children))for(var e=0;e<this.children.length;e++)this.children[e].posdirty=!0}OnUpdate(t){if(this.UpdatePos(),null!=this.comps)for(var e=0;e<this.comps.length;e++)this.comps[e].OnUpdate(t);if(null!=this.children)for(e=0;e<this.children.length;e++)this.children[e].OnUpdate(t)}Comp_Add(t){if(null==this.comps&&(this.comps=[]),this.comps.indexOf(t)>=0)throw"alread have comp.";this.comps.push(t),this.InScene()&&t.OnAdd(this)}Comp_Count(){return null==this.comps?0:this.comps.length}Comp_GetAt(t){return null==this.comps?null:this.comps[t]}Comp_Find(t){if(null!=this.comps){for(var e=0;e<this.comps.length;e++)if(this.comps[e].CompType==t)return this.comps[e];return null}}Node_Add(t){if(t.IsRoot())throw"this is root node.";if(t.InScene()&&t.parent.Node_Remove(t),null==this.children&&(this.children=[]),this.children.indexOf(t)>=0)throw"error alread have node.";this.children.push(t),t.OnNodeAdd(this),this.InScene()&&t.OnAttachScene(this.scene)}Node_Remove(t){if(null==this.children)throw"not have this node.";let e=this.children.indexOf(t);if(e<0)throw"not have this node.";this.children.splice(e,1),t.OnNodeRemove(),this.InScene()&&t.OnRemoveScene()}Node_GetCount(){var t;return null===(t=this.children)||void 0===t?void 0:t.length}Node_GetChild(t){var e;return null===(e=this.children)||void 0===e?void 0:e[t]}}class qo{constructor(){this.renderList_NoOrder={},this.renderList_Sorted=[],this.render_NoOrder={},this.render_Sorted={},this.rootNode=new Wo,this.rootNode.OnNodeAdd(null),this.rootNode.OnAttachScene(this),this.renderList_NoOrder[Uo.SingleMesh]=[],this.renderList_NoOrder[Uo.VBOBatchRender]=[],this.renderList_NoOrder[Uo.TBOBatchRender]=[],this.render_NoOrder[Uo.SingleMesh]=new Ho(!0),this.render_NoOrder[Uo.VBOBatchRender]=new jo(!0),this.render_NoOrder[Uo.TBOBatchRender]=new Yo(!0),this.render_Sorted[Uo.SingleMesh]=new Ho,this.render_Sorted[Uo.VBOBatchRender]=new jo,this.render_Sorted[Uo.TBOBatchRender]=new Yo}OnUpdate(t,e,i,s){this.lastTag=s,this.lastCamera=i,this.lastTarget=e,this.rootNode.OnUpdate(t),this.renderList_Sorted.length>0&&this.renderList_Sorted.sort(((t,e)=>t.sortz-e.sortz))}OnRender(){for(var t in this.renderList_NoOrder){let e=this.render_NoOrder[t],i=this.renderList_NoOrder[t];e.RenderBatch(this.lastCamera,this.lastTarget,this.lastTag,i)}if(this.renderList_Sorted.length>0){let t=null;for(var e=0;e<this.renderList_Sorted.length;e++){let i=this.renderList_Sorted[e],s=this.render_Sorted[i.type];t!=s&&(null!=t&&t.RenderOrderedEnd(),t=s,t.RenderOrderedBegin(this.lastCamera,this.lastTarget,this.lastTag)),s.RenderOrdered(i)}null!=t&&t.RenderOrderedEnd()}}GetRoot(){return this.rootNode}}class Ho{constructor(t=!1){}RenderBatch(t,e,i,s){this.RenderOrderedBegin(t,e,i);for(var n=0;n<s.length;n++)this.RenderOrdered(s[n]);this.RenderOrderedEnd()}RenderOrderedBegin(t,e,i){}RenderOrdered(t){}RenderOrderedEnd(){}}class jo{constructor(e=!1){let i=t.graphic.GetWebGL();this.spritebatch=new Vt(i)}RenderBatch(t,e,i,s){this.RenderOrderedBegin(t,e,i);for(var n=0;n<s.length;n++)this.RenderOrdered(s[n]);this.RenderOrderedEnd()}RenderOrderedBegin(t,e,i){this.spritebatch.BeginDraw(e,t)}RenderOrdered(t){let e=t;e.sprite.RenderWithPivot(this.spritebatch,e.pos,e.scale,e.color,0)}RenderOrderedEnd(){this.spritebatch.EndDraw()}}class Jo{constructor(){this.scale=S.One,this.color=b.White,this._sort=!1,this.sprite=K.GetPackElement().ConvertElemToSprite(K.GetWhiteBlock())}get type(){return Uo.VBOBatchRender}get sort(){return this._sort}set sort(t){if(t!=this._sort)if(null!=this.node){let e=this.node;this.OnRemove(),this._sort=t,this.OnAdd(e)}else this._sort=t}get CompType(){return"sprite"}OnUpdate(t){this.pos=this.node.pos,this.sortz=this.node.sortz}OnAdd(t){this.node=t,(this.sort?this.node.scene.renderList_Sorted:this.node.scene.renderList_NoOrder[this.type]).push(this)}OnRemove(){let t=this.sort?this.node.scene.renderList_Sorted:this.node.scene.renderList_NoOrder[this.type];t.splice(t.indexOf(this),1),this.node=null}}class Zo{constructor(){this.y=64}OnInit(e){this.y=64,null==this.nav&&(this.nav=e),this.guilayer=new rt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),O.GetViewList().AddDrawLayer(this.guilayer),this.container=new ue,this.container.setAsp(2/3,.5),this.guilayer.GetCanvas().AddChild(this.container),this.AddBackButton(),this.nav.context.TopUI2Top()}AddEmpty(t=20){this.y+=t}GetUIY(){return this.y}AddLabel(t,e=1){let i=new ye;i.text=t,this.container.AddChild(i),i.halign=Nt.Left,i.localRect.setHPosFill(10,10),i.localRect.setVPosByTopBorder(20,this.y),i.fontScale.X*=e,i.fontScale.Y*=e,this.y+=24*e}AddButton(t,e){let i=new ve;i.SetText(t),i.localRect.setHPosFill(10,10),i.localRect.setVPosByTopBorder(20,this.y),this.container.AddChild(i),i.OnClick=()=>{e()},this.y+=24}AddBackButton(){if(1==this.nav.Count())return;let t=new ve;t.SetText("<--"),t.localRect.setHPosByLeftBorder(64,8),t.localRect.setVPosByTopBorder(20,8),this.container.AddChild(t),t.OnClick=()=>{this.nav.Back()}}OnUpdate(t){}OnExit(){O.GetViewList().RemoveDrawLayer(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,n){}OnWheelAfterGUI(t,e,i){}}class Ko{static Show(e,i){return s=this,n=void 0,r=function*(){let s=new me;{e.AddChild(s);let t=new pe;t.localRect.SetAsFill(),s.AddChild(t),t.localColor=new b(0,0,0,.5);let o=new we;s.AddChild(o);let r=new ye;r.text=i,r.localRect.SetAsFill(),s.AddChild(r);let h=new Ce;h.title.text="信息",s.AddChild(h),h.localRect.offsetX1=120,h.localRect.offsetY1=120,h.localRect.offsetX2=-120,h.localRect.offsetY2=-120;let a=new Ae;a.direction=zt.Horizontal,h.container.AddChild(a),a.localRect.setVPosByBottomBorder(22);let l=new ve;l.localRect.setBySize(100,22),l.SetText("关闭"),l.OnClick=()=>{this.finish=!0},a.AddChild(l);let c=new Ae;h.container.AddChild(c),c.direction=zt.Vertical,c.localRect.SetAsFill(),c.localRect.offsetY2=-22;let m=i.split("\n"),_=e.GetWorldRect().Width-200;for(var n=0;n<m.length;n++){let t=new ye;t.text=m[n],t.localRect.setBySize(_,16),c.AddChild(t)}}for(this.finish=!1;!this.finish;)yield t.sleep(1);e.RemoveChild(s)},new((o=void 0)||(o=Promise))((function(t,e){function i(t){try{a(r.next(t))}catch(t){e(t)}}function h(t){try{a(r.throw(t))}catch(t){e(t)}}function a(e){var s;e.done?t(e.value):(s=e.value,s instanceof o?s:new o((function(t){t(s)}))).then(i,h)}a((r=r.apply(s,n||[])).next())}));var s,n,o,r}}Ko.finish=!1;var Qo=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class $o{Apply(){this.data.IsInnerHex()&&this.data.FillHexSrcName(this.data.data);let t=this.data.srcfile;t+=";pivot="+this.data.pivotX+","+this.data.pivotY,tr.Cmd_SetImg(this.name,t)}}class tr{static CreateEditImage(t){let e=new $o;e.name=t;let i=this.texturePool.GetPicByName(t);return e.data=Te.FromText(this.ttjson.pics[t]),e.sprite=i[0],e.data.data=i[2].data,e}static Rec_History(){return Qo(this,void 0,void 0,(function*(){}))}static Restore_History(){return Qo(this,arguments,void 0,(function*(t=-1){}))}static Cmd_SetImg(t,e){return Qo(this,void 0,void 0,(function*(){this.ttjson.pics[t]!=e&&(this.Rec_History(),this.ttjson.pics[t]=e)}))}static Cmd_RemoveImg(t){return Qo(this,void 0,void 0,(function*(){let e=!1;for(let i=0;i<t.length;i++)null!=this.ttjson.pics[t[i]]&&(0==e&&(e=!0,this.Rec_History()),delete this.ttjson.pics[t[i]])}))}static Cmd_AddImgsFromFile(e){return Qo(this,void 0,void 0,(function*(){let i=!1;for(var s=0;s<e.length;s++){var n=e[s].name,o=this.GetPathReletiveEditFile(e[s].fullname);let r=this.GetUniqueImgName(n);if(this.texturePool.HavePic(o)){let t=this.texturePool.GetPicName(o);if(null!=this.ttjson.pics[t])continue;this.texturePool.SetPicNameOnly(r,o)}else{let i=yield Oo.File_ReadBinary(e[s]),r=new Blob([i]),h=yield t.loaderex.LoadImageDataAsync(URL.createObjectURL(r)),a=new q;a.pivotX=0,a.pivotY=0,a.data=h.data,a.format=d.RGBA32,a.width=h.width,a.height=h.height,this.texturePool.SetPic(n,o,a)}0==i&&(i=!0,this.Rec_History()),tr.ttjson.pics[r]=o}}))}static GetUniqueImgName(t){var e=t;let i=0;for(;null!=tr.ttjson.pics[e];)i++,e=t+"_"+i;return e}static Save(){return Qo(this,void 0,void 0,(function*(){return yield Oo.File_WriteText(this.editfile,JSON.stringify(this.ttjson,null,2))}))}static FindFile(t){return Qo(this,arguments,void 0,(function*(t,e=3){return yield No.FindAllFile(this.root,t,e)}))}static FindFileReletive(t,e){return Qo(this,arguments,void 0,(function*(t,e,i=3){return yield No.FindAllFile(t,e,i)}))}static GetFileReletive(t,e){return Qo(this,void 0,void 0,(function*(){let i=Ft.GetFirstPath(e);return""==i?this.GetFile(t,e):yield this.GetFileReletive(yield this.GetSubPath(t,i),Ft.RemoveFirstPath(e))}))}static GetFile(t,e){return Qo(this,void 0,void 0,(function*(){let i=yield Oo.Directory_List(t);for(var s=0;s<i.length;s++)if(i[s].name.toLowerCase()==e.toLowerCase()&&i[s].isfile)return i[s];return null}))}static GetSubPath(t,e){return Qo(this,void 0,void 0,(function*(){let i=yield Oo.Directory_List(t);for(var s=0;s<i.length;s++)if(i[s].name.toLowerCase()==e.toLowerCase()&&0==i[s].isfile)return i[s];return null}))}static GetPathReletiveEditFile(t){var e=this.editfile.parent.fullname;return t.replace(e+"/","")}static CreateJsonFile(t,e){return Qo(this,void 0,void 0,(function*(){let i=yield this.GetFile(this.root,e);return null!=i?(Ko.Show(t,"Error CreateJsonFile 01:"+e+" 文件已存在"),null):(yield Oo.File_CreateText(this.root,e,"{}"))?(i=yield this.GetFile(this.root,e),null==i?(Ko.Show(t,"Error CreateJsonFile 03:"+e+" 文件创建完却没了"),null):i):(Ko.Show(t,"Error CreateJsonFile 02:"+e+" 文件创建失败"),null)}))}}tr.texturePool=new class{constructor(){this.mapPicName2FileName={},this.mapPicFileName2Name={},this.mapPic={}}LoadPic(t){}Render(t,e,i){t.cacheobj.RenderWithPivot(this.batcher,e,i)}HavePic(t){return null!=this.mapPic[t]}GetPicName(t){let e=this.mapPicFileName2Name[t];return null==e?null:e}GetPicByName(t){let e=this.mapPicName2FileName[t];return null==e?null:this.GetPicByFileName(e)}GetPicByFileName(t){let e=this.mapPic[t];return null==e?null:e}SetPicNameOnly(t,e){this.mapPicName2FileName[t]=e,this.mapPicFileName2Name[e]=t}SetPic(e,i,s){if(null!=this.mapPic[i])throw"already have a picfile :"+i+" with name:"+e;this.SetPicNameOnly(e,i);let n,o=new M(t.graphic.GetWebGL(),s.width,s.height,s.format,s.data);{let t=new $(K.GetShaderProgram("simple"));t.uniformTexs.tex.value=o,n=new re(t),this.mapPic[i]=[n,o,s]}return n.pivotX=s.pivotX,n.pivotY=s.pivotY,[n,o,s]}};class er extends le{constructor(){super(),this.OnCustomUpdate=null,this.OnCustomRender=null,this.OnCustomTouch=null,this.localRect.SetAsFill()}GetElementType(){return Wt.Element_CustomRender}OnRender(t){null!=this.OnCustomRender&&(t.batcherUI.getTarget(),t.batcherUI.EndDraw(),this.OnCustomRender(t),t.batcherUI.ResumeDraw()),super.OnRender(t)}OnUpdate(t,e){null!=this.OnCustomUpdate&&this.OnCustomUpdate(e),super.OnUpdate(t,e)}OnTouch(t,e,i,s,n,o){return!!super.OnTouch(t,e,i,s,n,o)||null!=this.OnCustomTouch&&this.OnCustomTouch(e,i,s,n,o)}}class ir{static Edit(e,i){this.edititem=i;let s=new er;e.GetPanel1().container.AddChild(s),s.OnCustomRender=t=>{this.OnRender(t,s.GetWorldRect())},s.OnUpdate=(t,e)=>{this.OnUpdate(e)},t.input.OnKey=(t,e)=>{this.OnKey(t,e)};let n=new ye;n.text="用 上下左右或者 wasd 移动pivot,图片定轴以后才方便替换",n.localRect.setHPosFill(),n.localRect.setVPosByTopBorder(20,2),e.GetPanel1().container.AddChild(n)}static OnUpdate(t){for(this.timer+=t;this.timer>1;)this.timer-=1;let e=this.timer>.5?1-this.timer:this.timer;this.color.A=2*e}static OnRender(t,e){let i=new C(e.X+32,e.Y+32,2*this.edititem.sprite.pixelwidth,2*this.edititem.sprite.pixelheight);this.edititem.sprite.RenderRect(t.batcherUI,i);let s=Ie.GetWhiteSprite(),n=this.edititem.data.pivotX,o=this.edititem.data.pivotY;s.RenderRect(t.batcherUI,new C(e.X,i.Y+o-1,e.Width,2),this.color),s.RenderRect(t.batcherUI,new C(i.X+n-1,e.Y,2,e.Height),this.color)}static OnKey(t,e){console.log("--key "+t+","+e),"KeyW"!=t&&"ArrowUp"!=t||this.edititem.data.pivotY--,"KeyA"!=t&&"ArrowLeft"!=t||this.edititem.data.pivotX--,"KeyS"!=t&&"ArrowDown"!=t||this.edititem.data.pivotY++,"KeyD"!=t&&"ArrowRight"!=t||this.edititem.data.pivotX++,this.edititem.sprite.pivotX=this.edititem.data.pivotX,this.edititem.sprite.pivotY=this.edititem.data.pivotY,this.edititem.Apply(),tr.Save()}}ir.color=b.White,ir.timer=0;class sr extends ce{constructor(t){super(),this.localRect.setBySize(500,25);let e=new we;this.AddChild(e),e.OnPress=()=>{this._parent.Pick(this)};let i=this.imageback=new pe;i.localRect.SetAsFill(),this.AddChild(i),i.localColor.A=0;let s=this.image=new pe;s.keepAspect=!0,s.localRect.setByPosAndSize(0,0,24,24),s.sprite=null,this.AddChild(s);let n=this.label=new ye;n.localRect.SetAsFill(),n.localRect.offsetX1=25,n.text="pickable",n.halign=Nt.Left,this.AddChild(n),this.context=t}GetElementType(){return Wt.Element_User}OnFocus(){this.imageback.localColor=new b(.3,.4,.9,1),this.label.localColor=new b(.9,.9,.3,1)}OnUnFocus(){this.imageback.localColor.A=0,this.label.localColor=b.White}}class nr extends ce{constructor(t){super(),this.checked=!1;let e=new we;this.AddChild(e),e.OnPress=()=>{this.checked=!this.checked,this.checked?this.OnFocus():this.OnUnFocus()};let i=this.imageback=new pe;i.localRect.SetAsFill(),this.AddChild(i),i.localColor.A=0;let s=this.image=new pe;s.keepAspect=!0,s.localRect.setByPosAndSize(0,0,24,24),s.sprite=null,this.AddChild(s);let n=this.label=new ye;n.localRect.SetAsFill(),n.localRect.offsetX1=25,n.text="pickable",n.halign=Nt.Left,this.AddChild(n),this.context=t}GetElementType(){return Wt.Element_User}OnFocus(){this.imageback.localColor=new b(.3,.4,.9,1),this.label.localColor=new b(.9,.9,.3,1)}OnUnFocus(){this.imageback.localColor.A=0,this.label.localColor=b.White}}var or=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class rr{static Init(t){let e=new Se;{e.splitDir=zt.Horizontal,e.splitPos=.25,e.localRect.SetAsFill(),e.getBorder().SetZero(),e.localRect.offsetY1=22,e.getSplitButton().SetText(""),e.splitSize=4,e.GetPanel1().getBorder().SetZero(),e.GetPanel2().getBorder().SetZero(),t.AddChild(e);let i=this.editArea=new Se;i.getBorder().SetZero(),i.splitDir=zt.Horizontal,i.splitPos=.66,i.localRect.SetAsFill(),i.localRect.offsetY1=22,i.getSplitButton().SetText(""),i.splitSize=4,i.GetPanel1().getBorder().SetZero(),i.GetPanel2().getBorder().SetZero(),this.editTitle=new ye,this.editTitle.localRect.setHPosFill(),this.editTitle.localRect.setVPosByTopBorder(22),this.editTitle.halign=Nt.Left,this.editTitle.localRect.offsetX1=4,this.editTitle.text="当前编辑文件",e.GetPanel2().container.AddChild(this.editTitle),e.GetPanel2().container.AddChild(i)}{let t=new Be;t.title.text="图片Sprite",t.localRect.SetAsFill(),t.localRect.radioY2=.5,this.scrollPic=new be,t.container.AddChild(this.scrollPic),e.GetPanel1().container.AddChild(t)}{let t=new Be;t.title.text="动画Animation",t.localRect.SetAsFill(),t.localRect.radioY1=.5,this.scrollAni=new be,t.container.AddChild(this.scrollAni),e.GetPanel1().container.AddChild(t)}this.scrollPic.container.OnPick=t=>{let e=t.context;this.EditImg(e)}}static ClearEditArea(){this.editArea.GetPanel1().container.RemoveChildAll(),this.editArea.GetPanel2().container.RemoveChildAll()}static EditImg(t){this.ClearEditArea(),ir.Edit(this.editArea,tr.CreateEditImage(t))}static EditAni(t){}static GetPickPic(){var t;return null===(t=this.scrollPic.container.GetPicked())||void 0===t?void 0:t.context}static Open(t){return or(this,void 0,void 0,(function*(){null!=tr.editfile&&(tr.ttjson=JSON.parse(yield Oo.File_ReadText(tr.editfile)),this.editTitle.text=tr.editfile.fullname,rr.UpdatePics())}))}static UpdatePics(){return or(this,void 0,void 0,(function*(){for(var e in this.scrollPic.container.RemoveChildAll(),tr.ttjson.pics){let i=Te.FromText(tr.ttjson.pics[e]),s=tr.texturePool.GetPicByFileName(i.srcfile);if(null==s){if(null==i.data){let t=yield tr.GetFileReletive(tr.editfile.parent,i.srcfile),e=yield Oo.File_ReadBinary(t);i.data=new Uint8Array(e)}let n=new Blob([i.data]),o=yield t.loaderex.LoadImageDataAsync(URL.createObjectURL(n)),r=new q;r.pivotX=i.pivotX,r.pivotY=i.pivotY,r.data=o.data,r.format=d.RGBA32,r.width=o.width,r.height=o.height,s=yield tr.texturePool.SetPic(e,i.srcfile,r)}else s[0].pivotX=i.pivotX,s[0].pivotY=i.pivotY;let n=new sr(e);n.label.text=e,n.image.SetBySprite(s[0]),this.scrollPic.container.AddChild(n)}}))}}var hr=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class ar{static ShowPick(e){return hr(this,void 0,void 0,(function*(){let i=new me;e.AddChild(i);let s=new pe;s.localRect.SetAsFill(),i.AddChild(s),s.localColor=new b(0,0,0,.5);let n=new we;i.AddChild(n);let o=new Ce;o.title.text="选择编辑文件",i.AddChild(o),o.localRect.offsetX1=100,o.localRect.offsetY1=100,o.localRect.offsetX2=-100,o.localRect.offsetY2=-100;let r=new Ae;r.direction=zt.Horizontal,o.container.AddChild(r),r.localRect.setVPosByTopBorder(22);let h=new ve;h.localRect.setBySize(100,22),h.SetText("打开选中"),r.AddChild(h);let a=new ve;a.localRect.setBySize(100,22),a.SetText("新建 tt.json");let l=null;a.OnClick=()=>hr(this,void 0,void 0,(function*(){l=yield this.OnNewFile(e)})),r.AddChild(a);let c=new ve;c.localRect.setBySize(100,22),c.SetText("取消"),r.AddChild(c);let m=new be;h.OnClick=()=>{l=m.container.GetPicked().context,this.OnPick(e,l)},c.OnClick=()=>{l=null,this.finish=!0},o.container.AddChild(m),m.localRect.offsetY1=22;let _=yield tr.FindFile([".tt.json"],3);for(var d=0;d<_.length;d++){let t=new sr(_[d]);t.localRect.setBySize(500,25),m.container.AddChild(t),t.label.text=_[d].fullname}if(0==_.length){let t=new sr(null);t.localRect.setBySize(500,25),m.container.AddChild(t),t.label.text="Empty"}for(m.container.PickAt(0),this.finish=!1;!this.finish;)yield t.sleep(1);return e.RemoveChild(i),l}))}static OnPick(t,e){return hr(this,void 0,void 0,(function*(){null!=e?this.finish=!0:yield Ko.Show(t,"Pick Empty.")}))}static OnNewFile(e){return hr(this,void 0,void 0,(function*(){let i=yield t.input.Prompt("输入文件名","new1.tt.json",20,K.GetDefFont().GetFont());console.log("input name:"+i);let s=yield tr.CreateJsonFile(e,i);return this.finish=!0,s}))}}ar.finish=!1;var lr=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class cr{static ShowPick(e){return lr(this,void 0,void 0,(function*(){let i=new me;e.AddChild(i);let s=new pe;s.localRect.SetAsFill(),i.AddChild(s),s.localColor=new b(0,0,0,.5);let n=new we;i.AddChild(n);let o=new Ce;o.title.text="选择编辑文件",i.AddChild(o),o.localRect.offsetX1=100,o.localRect.offsetY1=100,o.localRect.offsetX2=-100,o.localRect.offsetY2=-100;let r=new Ae;r.direction=zt.Horizontal,o.container.AddChild(r),r.localRect.setVPosByTopBorder(22);let h=new ve;h.localRect.setBySize(100,22),h.SetText("打开选中"),r.AddChild(h);let a=new ve;a.localRect.setBySize(100,22),a.SetText("取消"),r.AddChild(a);let l=new be,c=[];h.OnClick=()=>{for(var t=0;t<l.container.GetChildCount();t++){let e=l.container.GetChild(t);e.checked&&c.push(e.context)}this.OnPick(e,c)},a.OnClick=()=>{this.finish=!0},o.container.AddChild(l),l.localRect.offsetY1=22;let m=yield No.FindAllFile(tr.editfile.parent,[".png",".jpg",".jpeg"],3);for(var _=0;_<m.length;_++){let t=new nr(m[_]);t.localRect.setBySize(500,25),l.container.AddChild(t);let e=yield this.LoadFileToTexture(m[_]);t.image.SetByTexture(e),t.label.text=m[_].fullname}if(0==m.length){let t=new nr(null);t.localRect.setBySize(500,25),l.container.AddChild(t),t.label.text="Empty"}for(this.finish=!1;!this.finish;)yield t.sleep(1);return e.RemoveChild(i),this.FreeTexture(),c}))}static LoadFileToTexture(e){return lr(this,void 0,void 0,(function*(){let i=yield Oo.File_ReadBinary(e),s=new Blob([i]),n=yield t.loaderex.LoadImageDataAsync(URL.createObjectURL(s)),o=new M(t.graphic.GetWebGL(),n.width,n.height,d.RGBA32,n.data);return this.texs.push(o),o}))}static FreeTexture(){for(var t=0;t<this.texs.length;t++)this.texs[t].Destory();this.texs=[]}static OnPick(t,e){return lr(this,void 0,void 0,(function*(){null!=e&&0!=e.length?this.finish=!0:yield Ko.Show(t,"Pick Empty.")}))}}cr.finish=!1,cr.texs=[];var mr=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class _r{static Init(t,e){let i,s=new ge;t.AddChild(s),s.localRect.setVPosByTopBorder(22);let n=new Ae;s.container=n,n.direction=zt.Horizontal,i=new Re;let o=new Re,r=new Re,h=new Re,a=new Re;i.items.push({label:"文件File",sprite:null,submenu:o,onaction:null}),i.items.push({label:"精灵Sprite",sprite:null,submenu:r,onaction:null}),i.items.push({label:"动画Anim",sprite:null,submenu:h,onaction:null}),i.items.push({label:"其它Other",sprite:Ie.GetSprite("round"),submenu:a,onaction:null}),o.items.push({label:"打开工作目录",sprite:Ie.GetSprite("corner"),submenu:null,onaction:()=>{this.OnOpenWorkingDir(t)}}),o.items.push({label:"--",sprite:Ie.GetSprite("border"),submenu:null,onaction:null}),null!=e&&o.items.push({label:"退出编辑器",sprite:Ie.GetSprite("border"),submenu:null,onaction:()=>{e()}}),r.items.push({label:"添加",sprite:null,submenu:null,onaction:()=>{this.OnSpriteAdd(t)}}),r.items.push({label:"排序",sprite:null,submenu:null,onaction:()=>{this.OnSpriteSort(t)}}),r.items.push({label:"添加嵌入",sprite:null,submenu:null,onaction:()=>{Ko.Show(t,"尚未支持")}}),r.items.push({label:"删除选中",sprite:null,submenu:null,onaction:()=>{this.OnSpriteDelete(t)}}),h.items.push({label:"添加",sprite:null,submenu:null,onaction:()=>{Ko.Show(t,"尚未支持")}}),h.items.push({label:"排序",sprite:null,submenu:null,onaction:()=>{Ko.Show(t,"尚未支持")}}),h.items.push({label:"删除选中",sprite:null,submenu:null,onaction:()=>{Ko.Show(t,"尚未支持")}}),a.items.push({label:"Help",sprite:null,submenu:null,onaction:()=>{Ko.Show(t,"对话框测试\ngood day。")}}),i.FillTo(t,n)}static OnOpenWorkingDir(t){return mr(this,void 0,void 0,(function*(){console.log("open.");let e=yield Oo.Picker_Folder();null!=e&&(tr.root=e,tr.editfile=yield ar.ShowPick(t),rr.Open(t))}))}static OnSpriteAdd(t){return mr(this,void 0,void 0,(function*(){if(null!=tr.editfile&&null!=tr.root){var e=yield cr.ShowPick(t);null==tr.ttjson.pics&&(tr.ttjson.pics={}),yield tr.Cmd_AddImgsFromFile(e),yield tr.Save(),rr.UpdatePics()}else Ko.Show(t,"Error editfile.")}))}static OnSpriteDelete(t){return mr(this,void 0,void 0,(function*(){if(null!=tr.editfile&&null!=tr.root){var e=rr.GetPickPic();null!=e&&(yield tr.Cmd_RemoveImg([e]),yield tr.Save(),yield rr.UpdatePics())}else Ko.Show(t,"Error editfile.")}))}static OnSpriteSort(t){return mr(this,void 0,void 0,(function*(){let t=[],e=tr.ttjson.pics;for(var i in tr.ttjson.pics)t.push(i);tr.ttjson.pics={},t.sort();for(var s=0;s<t.length;s++){let i=t[s];tr.ttjson.pics[i]=e[i]}yield tr.Save(),rr.UpdatePics()}))}}class dr extends Zo{OnInit(t){super.OnInit(t),Oo.Init();let e=this.guilayer.GetCanvas();e.RemoveChildAll(),_r.Init(e,(()=>{t.Back()})),rr.Init(e)}}class ur extends Zo{OnInit(e){super.OnInit(e);let i=t.graphic.GetWebGL();this.AddLabel("DevicePixelRadio="+t.graphic.getDevicePixelRadio()),this.AddLabel("font MAX_UNIFORM_BLOCK_SIZE="+i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE)),this.AddLabel("MAX_3D_TEXTURE_SIZE="+i.getParameter(i.MAX_3D_TEXTURE_SIZE)),this.AddLabel("MAX_ARRAY_TEXTURE_LAYERS="+i.getParameter(i.MAX_ARRAY_TEXTURE_LAYERS)),this.AddLabel("MAX_TEXTURE_SIZE="+i.getParameter(i.MAX_TEXTURE_SIZE)),this.AddLabel("MAX_VERTEX_UNIFORM_BLOCKS="+i.getParameter(i.MAX_VERTEX_UNIFORM_BLOCKS)),this.AddLabel("MAX_VERTEX_UNIFORM_COMPONENTS="+i.getParameter(i.MAX_VERTEX_UNIFORM_COMPONENTS))}}class pr extends Zo{OnInit(e){super.OnInit(e);let i=t.graphic.GetWebGL(),s=new T(i,16,16,5,d.R8),n=new M(i,16,16,d.R8,null),o=new Uint8Array(256);for(let t=0;t<256;t++)o[t]=t;let r=new Uint8Array(256);for(let t=0;t<256;t++)r[t]=255-t;this.AddLabel("tex1="+s.getWidth()+","+s.getHeight()+","+s.GetLayer()),s.UploadSubTexture(0,0,0,16,16,o),n.UploadTexture(0,0,16,16,r),this.AddLabel("tex2="+n.getWidth()+","+n.getHeight()),this.AddLabel("普通贴图传给texturearray不能正常渲染"),K.GetPackElement();{let t=K.GetDefFont().GetCharSprite("你".charCodeAt(0)),e=new pe;e.SetBySprite(t),e.localRect.setHPosByLeftBorder(256,32),e.localRect.setVPosByTopBorder(256,32),this.guilayer.GetCanvas().AddChild(e)}{let t=K.GetDefFont().GetCharSprite("好".charCodeAt(0)),e=new pe;e.SetBySprite(t),e.localRect.setHPosByLeftBorder(256,300),e.localRect.setVPosByTopBorder(256,32),this.guilayer.GetCanvas().AddChild(e)}}}class fr extends Zo{constructor(){super(...arguments),this.inst=[]}OnInit(t){super.OnInit(t),this.AddSprites(),this.AddLabel("DrawElement,TBO模式"),this.AddLabel("vb0 是一个小方块"),this.AddLabel("vb1 是instance 数据"),this.AddLabel("sprite 数据放在一张贴图里，尺寸几乎没有限制，这里使用了 512x512的float贴图"),this.AddLabel("这个贴图尺寸下,可使用65536种精灵")}AddSprites(){this.canvaslayer=new F(u.Main),this.canvaslayer.GetCamera().Scale=2,this.render=new kt,this.canvaslayer.AddRender(this.render),O.GetViewList().AddDrawLayer(this.canvaslayer);let t=K.GetBlock("border2"),e=K.GetBlock("round");this.render.SetPackElement(K.GetPackElement());for(var i=0;i<51200;i++){let s=new Y;s.pos=new B(400*Math.random()-200,400*Math.random()-200,0),s.rotate=Math.random()*Math.PI,s.scale=new S(1,1),s.instid=i%2==0?t.index:e.index,s.color=new b(Math.random(),Math.random(),Math.random(),Math.random()),this.render.AddElementInst(s),this.inst.push(s)}}OnUpdate(t){for(var e=0;e<this.inst.length;e++)this.inst[e].rotate+=t*Math.PI,this.render.WriteElementInst(this.inst[e],e)}OnExit(){super.OnExit(),O.GetViewList().RemoveDrawLayer(this.canvaslayer)}}class yr{constructor(){this.scale=1,this.lasttag=0}SetTiledmap(e,i,s,n=1){this.scale=n;let o=t.graphic.GetWebGL();this.mat=new $(K.GetShaderProgram("tiledmap")),this.mat.UpdateMatModel(),this.mesh=new nt,this.mesh.UpdateVertexFormat(o,st.GetFormat_Vertex_UV_Color()),this.UpdateMesh(e.getWidth(),e.getHeight(),s*n),this.mat.uniformTexs.texTile.value=i,this.mat.uniformTexs.texIndex.value=e,this.mat.uniformFloats.tilesize.value=s,this.mat.uniformVecs.mapinfo.value=new Float32Array([e.getWidth(),e.getHeight(),i.getWidth(),i.getHeight()])}GetScale(){return this.scale}UpdateMesh(e,i,s){let n=t.graphic.GetWebGL(),o=this.mesh.GetVertexFormat().vbos[0].stride,r=new Uint8Array(6*o),h=new DataView(r.buffer);h.setFloat32(0*o,0,!0),h.setFloat32(0*o+4,0,!0),h.setFloat32(0*o+8,0,!0),h.setFloat32(0*o+12,0,!0),h.setFloat32(0*o+16,0,!0),h.setFloat32(1*o,e*s,!0),h.setFloat32(1*o+4,0,!0),h.setFloat32(1*o+8,0,!0),h.setFloat32(1*o+12,1,!0),h.setFloat32(1*o+16,0,!0),h.setFloat32(2*o,0,!0),h.setFloat32(2*o+4,i*s,!0),h.setFloat32(2*o+8,0,!0),h.setFloat32(2*o+12,0,!0),h.setFloat32(2*o+16,1,!0),h.setFloat32(3*o,0,!0),h.setFloat32(3*o+4,i*s,!0),h.setFloat32(3*o+8,0,!0),h.setFloat32(3*o+12,0,!0),h.setFloat32(3*o+16,1,!0),h.setFloat32(4*o,e*s,!0),h.setFloat32(4*o+4,0,!0),h.setFloat32(4*o+8,0,!0),h.setFloat32(4*o+12,1,!0),h.setFloat32(4*o+16,0,!0),h.setFloat32(5*o,e*s,!0),h.setFloat32(5*o+4,i*s,!0),h.setFloat32(5*o+8,0,!0),h.setFloat32(5*o+12,1,!0),h.setFloat32(5*o+16,1,!0),this.mesh.UploadVertexBuffer(n,0,r,!1,r.byteLength)}GetGUI(){return null}OnUpdate(t,e,i,s){null!=this.mat&&null!=this.mesh&&0==s&&(this.lasttag=s,this.mat.UpdateMatProj(e),this.mat.UpdateMatView(i.GetViewMatrix()))}OnRender(){if(null==this.mat||null==this.mesh)return;let e=t.graphic.GetWebGL();0==this.lasttag&&nt.DrawMesh(e,this.mesh,this.mat)}}class vr{static Init(){if(null==this.p){this.p=new Uint8Array(512);for(var t=0;t<512;t++)this.p[t]=this.permutation[t%this.permutation.length]}}static GenNoise(t,e,i,s,n){for(var o=0,r=1,h=1,a=0,l=0;l<s;l++)a+=this.Perlin(t*r,e*r,i*r)*h,o+=h,h*=n,r*=2;return a/o}static Perlin(t,e,i){this.Init();var s=255&t,n=255&e,o=255&i,r=t-(0|t),h=e-(0|e),a=i-(0|i),l=this.fade(r),c=this.fade(h),m=this.fade(a),_=this.p[this.p[this.p[s]+n]+o],d=this.p[this.p[this.p[s]+this.inc(n)]+o],u=this.p[this.p[this.p[s]+n]+this.inc(o)],p=this.p[this.p[this.p[s]+this.inc(n)]+this.inc(o)],f=this.p[this.p[this.p[this.inc(s)]+n]+o],y=this.p[this.p[this.p[this.inc(s)]+this.inc(n)]+o],v=this.p[this.p[this.p[this.inc(s)]+n]+this.inc(o)],x=this.p[this.p[this.p[this.inc(s)]+this.inc(n)]+this.inc(o)],w=this.lerp(this.grad(_,r,h,a),this.grad(f,r-1,h,a),l),A=this.lerp(this.grad(d,r,h-1,a),this.grad(y,r-1,h-1,a),l),g=this.lerp(w,A,c);w=this.lerp(this.grad(u,r,h,a-1),this.grad(v,r,h-1,a-1),l),A=this.lerp(this.grad(p,r,h-1,a-1),this.grad(x,r-1,h-1,a-1),l);var b=this.lerp(w,A,c);return.5*this.lerp(g,b,m)+.5}static inc(t){return t+1}static grad(t,e,i,s){switch(15&t){case 0:return e+i;case 1:return-e+i;case 2:return e-i;case 3:return-e-i;case 4:return e+s;case 5:return-e+s;case 6:return e-s;case 7:return-e-s;case 8:return i+s;case 9:case 13:return-i+s;case 10:return i-s;case 11:case 15:return-i-s;case 12:return i+e;case 14:return i-e;default:return 0}}static fade(t){return t*t*t*(t*(6*t-15)+10)}static lerp(t,e,i){return t*(1-i)+e*i}}vr.permutation=new Uint8Array([151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180]),vr.p=null;class xr{}class wr{}class Ar extends M{constructor(t,e){super(t,e.width,e.height,d.RGBA32,null),this.tiles=[],this.tileLayer=[],this.tileSize=e.tileSize}GetTileLayers(){return this.tileLayer}GetTileLayerCount(){return this.tileLayer.length}GetTileLayer(t){return this.tileLayer[t]}GetTileSize(){return this.tileSize}GetTileCount(){return this.tiles.length}GetTile(t){return this.tiles[t]}GetEmpty(){return this.tileEmpty}AddEmpty(){if(null!=this.tileEmpty)return this.tileEmpty;let t=new xr;return t.index=0,t.posU=0,t.posV=0,this.tiles.push(t),this.tileEmpty=t,t}AddTile(t){return this.SetTile(this.tiles.length,t)}SetTile(t,e){if(e.width!=this.tileSize||e.height!=this.tileSize)throw"错误的TileSize:"+e.width+","+e.height;let i=this._width/this.tileSize|0,s=t%i|0,n=t/i|0,o=this._height/this.tileSize|0;if(n<0||n>=o)throw"index 超出范围";for(;this.tiles.length<=t;)this.tiles.push(null);let r=new xr;return r.posU=s,r.posV=n,r.index=t,this.tiles[t]=r,e.format!=d.RGBA32&&(e=e.ConvertToRGBA()),this.UploadTexture(r.posU*this.tileSize,r.posV*this.tileSize,this.tileSize,this.tileSize,e.data),r}AddLPCTile(t,e=S.Zero){let i=new wr;return this.tileLayer.push(i),i.smallpot=this.AddTile(t.Cut(0*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.bigpot=this.AddTile(t.Cut(0*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner=[],i.innerCorner[0]=this.AddTile(t.Cut(1*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[1]=this.AddTile(t.Cut(2*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[2]=this.AddTile(t.Cut(1*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[3]=this.AddTile(t.Cut(2*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner=[],i.outCorner[0]=this.AddTile(t.Cut(0*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[1]=this.AddTile(t.Cut(1*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[2]=this.AddTile(t.Cut(2*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[3]=this.AddTile(t.Cut(0*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[4]=this.AddTile(t.Cut(1*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[5]=this.AddTile(t.Cut(2*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[6]=this.AddTile(t.Cut(0*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[7]=this.AddTile(t.Cut(1*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[8]=this.AddTile(t.Cut(2*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled=[],i.tiled[0]=i.outCorner[4],i.tiled[1]=this.AddTile(t.Cut(0*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled[2]=this.AddTile(t.Cut(1*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled[3]=this.AddTile(t.Cut(2*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i}ConvertTile2Sprite(t){null==this.tiledMaterial&&(this.tiledMaterial=new $(K.GetShaderProgram("simple")),this.tiledMaterial.uniformTexs.tex.value=this);let e=new re(this.tiledMaterial);e.pixelwidth=this.tileSize,e.pixelheight=this.tileSize,e.effect=Et.RGBA,e.uvlayer=0;let i=this._width/this.tileSize|0,s=this._height/this.tileSize|0;return e.uv=new G(t.posU/i,t.posV/s,(t.posU+1)/i,(t.posV+1)/s),e}}class gr extends M{constructor(t,e,i){super(t,e,i,d.RGBA32,null),this.data=new Uint8Array(e*i*4)}MarkDirty(){this.dirty=!0}DropData(){this.data=null}GetData(){return this.data}SetIndexLayer1(t,e,i,s){null==this.data&&(this.data=new Uint8Array(this._width*this._height*4)),this.data[4*(e*this._width+t)+0]=i,this.data[4*(e*this._width+t)+1]=s,this.dirty=!0}SetIndexLayer2(t,e,i,s){null==this.data&&(this.data=new Uint8Array(this._width*this._height*4)),this.data[4*(e*this._width+t)+2]=i,this.data[4*(e*this._width+t)+3]=s,this.dirty=!0}FillIndexLayer1(t){for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){let s=(100*Math.random()+.5|0)-97;s<0&&(s=0),s>3&&(s=3);let n=t.tiled[s];this.SetIndexLayer1(i,e,n.posU,n.posV)}}FillIndexLayer2WithData(t,e){for(var i=0;i<this._height;i+=2)for(var s=0;s<this._width;s+=2){let t=e[i*this._width+s]+e[i*this._width+s+1]+e[(i+1)*this._width+s]+e[(i+1)*this._width+s+1]>=2?1:0;e[i*this._width+s]=t,e[i*this._width+s+1]=t,e[(i+1)*this._width+s]=t,e[(i+1)*this._width+s+1]=t}for(i=0;i<this._height;i++)for(s=0;s<this._width;s++){let n=0,o=0,r=0;i>0&&(s>0&&(n=e[(i-1)*this._width+s-1]),o=e[(i-1)*this._width+s],s<this._width-1&&(r=e[(i-1)*this._width+s+1]));let h=0,a=0,l=0;s>0&&(h=e[i*this._width+s-1]),a=e[i*this._width+s],s<this._width-1&&(l=e[i*this._width+s+1]);let c=0,m=0,_=0;if(i<this._height-1&&(s>0&&(c=e[(i+1)*this._width+s-1]),m=e[(i+1)*this._width+s],s<this._width-1&&(_=e[(i+1)*this._width+s+1])),a>0){let e=0;if(o>0&&e++,h>0&&e++,l>0&&e++,m>0&&e++,0==e)this.SetIndexLayer2(s,i,t.smallpot.posU,t.smallpot.posV);else if(1==e)console.log("error count 2");else if(2==e)0==o&&0==h&&this.SetIndexLayer2(s,i,t.outCorner[0].posU,t.outCorner[0].posV),0==o&&0==l&&this.SetIndexLayer2(s,i,t.outCorner[2].posU,t.outCorner[2].posV),0==m&&0==h&&this.SetIndexLayer2(s,i,t.outCorner[6].posU,t.outCorner[6].posV),0==m&&0==l&&this.SetIndexLayer2(s,i,t.outCorner[8].posU,t.outCorner[8].posV);else if(3==e)0==o&&this.SetIndexLayer2(s,i,t.outCorner[1].posU,t.outCorner[1].posV),0==h&&this.SetIndexLayer2(s,i,t.outCorner[3].posU,t.outCorner[3].posV),0==l&&this.SetIndexLayer2(s,i,t.outCorner[5].posU,t.outCorner[5].posV),0==m&&this.SetIndexLayer2(s,i,t.outCorner[7].posU,t.outCorner[7].posV);else if(4==e){let e=0;if(n>0&&e++,r>0&&e++,c>0&&e++,_>0&&e++,3==e)0==n&&this.SetIndexLayer2(s,i,t.innerCorner[3].posU,t.innerCorner[3].posV),0==r&&this.SetIndexLayer2(s,i,t.innerCorner[2].posU,t.innerCorner[2].posV),0==c&&this.SetIndexLayer2(s,i,t.innerCorner[1].posU,t.innerCorner[1].posV),0==_&&this.SetIndexLayer2(s,i,t.innerCorner[0].posU,t.innerCorner[0].posV);else{let e=(100*Math.random()+.5|0)-97;e<0&&(e=0),e>3&&(e=3);let n=t.tiled[e];this.SetIndexLayer2(s,i,n.posU,n.posV)}}}else this.SetIndexLayer2(s,i,0,0)}}Apply(){if(this.dirty){if(null==this.data)throw"no data on IndexdTex";this.UploadTexture(0,0,this._width,this._height,this.data),this.dirty=!1}}}class br extends Zo{constructor(){super(...arguments),this.timer=0}OnInit(e){super.OnInit(e),this.tiledlayer=new F(u.Main),this.tiledlayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),O.GetViewList().AddDrawLayer(this.tiledlayer),this.tiledrender=new yr,this.tiledlayer.AddRender(this.tiledrender),this.tiledtex=new Ar(t.graphic.GetWebGL(),{width:1024,height:1024,tileSize:32}),this.tiledtexIndex=new gr(t.graphic.GetWebGL(),256,256),this.tiledrender.SetTiledmap(this.tiledtexIndex,this.tiledtex,this.tiledtex.GetTileSize(),.25),this.AddLabel("LPC有个很好的Tiledmap 规则"),this.AddButton("随机地图",(()=>{this.RandomMap()})),this.initacync()}RandomMap(){let t=this.tiledtex.GetTileLayer(0),e=this.tiledtex.GetTileLayer(1);this.tiledtexIndex.FillIndexLayer1(e);let i=new S(Math.random(),Math.random()),s=new Uint8Array(this.tiledtexIndex.getWidth()*this.tiledtexIndex.getHeight());for(let t=0;t<this.tiledtexIndex.getHeight();t++)for(let e=0;e<this.tiledtexIndex.getWidth();e++){let n=vr.GenNoise(e/this.tiledtexIndex.getWidth()/2+i.X,t/this.tiledtexIndex.getHeight()/2+i.Y,0,5,1);s[t*this.tiledtexIndex.getWidth()+e]=n>.5?1:0}this.tiledtexIndex.FillIndexLayer2WithData(t,s),this.tiledtexIndex.Apply()}initacync(){return e=this,i=void 0,n=function*(){let e=t.graphic.GetWebGL(),i=16;this.tiledtex.AddEmpty();{let s=new $(K.GetShaderProgram("simple")),n=yield t.loaderex.LoadImageAsync("./data/tiledrule.png"),o=new M(e,n.width,n.height,d.RGBA32,null);o.UploadImg(n),s.uniformTexs.tex.value=o;let r=new re(s),h=new pe;h.sprite=r,h.localRect.setHPosByLeftBorder(96,i),i+=100,h.localRect.setVPosByTopBorder(192,this.GetUIY()),this.guilayer.GetCanvas().AddChild(h)}{let s=new $(K.GetShaderProgram("simple")),n=yield t.loaderex.LoadImageDataAsync("./data/grass.png"),o=new M(e,n.width,n.height,d.RGBA32,null);o.UploadImg(n),s.uniformTexs.tex.value=o;let r=new re(s),h=new pe;h.sprite=r,h.localRect.setHPosByLeftBorder(96,i),i+=100,h.localRect.setVPosByTopBorder(192,this.GetUIY()),this.guilayer.GetCanvas().AddChild(h);let a=new q;a.format=d.RGBA32,a.data=n.data,a.width=n.width,a.height=n.height,this.tiledtex.AddLPCTile(a)}{let s=new $(K.GetShaderProgram("simple")),n=yield t.loaderex.LoadImageDataAsync("./data/dirt.png"),o=new M(e,n.width,n.height,d.RGBA32,null);o.UploadImg(n),s.uniformTexs.tex.value=o;let r=new re(s),h=new pe;h.sprite=r,h.localRect.setHPosByLeftBorder(96,i),i+=100,h.localRect.setVPosByTopBorder(192,this.GetUIY()),this.guilayer.GetCanvas().AddChild(h);let a=new q;a.format=d.RGBA32,a.data=n.data,a.width=n.width,a.height=n.height,this.tiledtex.AddLPCTile(a)}this.AddEmpty(192),this.AddLabel("使用3x6的区块，表达地表的一层"),this.AddLabel("大点，小点，内角四块。"),this.AddLabel("外角八块，外角的最中间是平铺块"),this.AddLabel("最下边一行是替换的平铺块"),this.RandomMap()},new((s=void 0)||(s=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,h)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n}OnUpdate(t){if(null==this.tiledlayer)return;this.timer+=t;let e=65*Math.sin(this.timer)+65,i=32*Math.cos(this.timer)+32;this.tiledlayer.GetCamera().LookAt.X=(2*e|0)/2,this.tiledlayer.GetCamera().LookAt.Y=(2*i|0)/2}OnExit(){super.OnExit(),O.GetViewList().RemoveDrawLayer(this.tiledlayer)}}class Sr{constructor(t){this.aniinst=null,this.render=t}LoadPic(t){return K.GetPackElement().GetElementByName(t).index}Render(t,e,i){null==this.aniinst&&(this.aniinst=new Y,this.aniinst.pos=new B(0,0,0),this.aniinst.rotate=0,this.aniinst.scale=new S(2,2),this.aniinst.color=new b(1,1,1,1)),this.aniinst.instid=t.cacheobj,this.aniinst.pos.X=e.X+t.x*i.X,this.aniinst.pos.Y=e.Y+t.y*i.Y,this.aniinst.scale.X=i.X*t.scaleX,this.aniinst.scale.Y=i.Y*t.scaleY,this.aniinst.rotate=t.rotate,this.render.AddElementInst(this.aniinst)}}class Br extends Zo{constructor(){super(...arguments),this.inst=[]}OnInit(t){super.OnInit(t),this.LoadAsync()}LoadAsync(){return e=this,i=void 0,n=function*(){this.AddLabel("测试TTPack加载");let e=yield Me.Load("data/p01.tt.json",t.loader);console.log("pp="+e.Name),this.AddLabel("Load Package:"+e.Name);let i=e.GetPicKey();for(var s=0;s<i.length;s++){let t=i[s],n=e.GetPic(t);this.AddLabel("Load pic:"+t+","+n.width+","+n.height+","+n.pivotX+","+n.pivotY);let o=new q;o.data=n.data,o.format=d.RGBA32,o.width=n.width,o.height=n.height,o.pivotX=n.pivotX,o.pivotY=n.pivotY,K.GetPackElement().AddSprite(o,Et.RGBA,t)}this.ani=e.GetAni("ani1"),this.AddSprites()},new((s=void 0)||(s=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,h)}a((n=n.apply(e,i||[])).next())}));var e,i,s,n}AddSprites(){this.canvaslayer=new F(u.Main),this.canvaslayer.GetCamera().Scale=2,this.render=new kt,this.aniadapter=new Sr(this.render),this.anip=new Ee(this.ani,this.aniadapter),this.canvaslayer.AddRender(this.render),O.GetViewList().AddDrawLayer(this.canvaslayer);let t=K.GetPackElement().GetElementByName("dot1"),e=K.GetBlock("round");this.render.SetPackElement(K.GetPackElement());for(var i=0;i<5;i++){let s=new Y;s.pos=new B(50*i,0,0),s.rotate=0,s.scale=new S(2,2),s.instid=i%2==0?t.index:e.index,s.color=new b(1,Math.random(),1,1),this.inst.push(s),this.render.AddElementInst(this.inst[i])}console.log("int count ="+this.inst.length)}OnUpdate(t){if(null!=this.render){this.render.ClearElementInst();for(var e=0;e<this.inst.length;e++)this.inst[e].rotate+=t*Math.PI,this.render.AddElementInst(this.inst[e]);for(this.anip.Update(t),e=0;e<10;e++)this.anip.pos.X=50*e,this.anip.pos.Y=50,this.anip.Render()}}OnExit(){super.OnExit(),O.GetViewList().RemoveDrawLayer(this.canvaslayer)}}class Cr{toString(){return"b2obj:"+this.id}constructor(){this.dir=S.Zero,this.target=void 0,this.hitcount=0,this.color=new ri(0,0,1,1),Cr.g_id++,this.id=Cr.g_id}OnHit(t){this.hitcount++,this.color=new ri(1,0,0,1)}OnUnHit(t){this.hitcount--,0==this.hitcount&&(this.color=new ri(0,0,1,1))}Update(t){let e=30*t;(null==this.target||S.Dist(this.elem.pos,this.target)<e)&&(null==this.target&&(this.target=S.Zero),this.target.X=500*Math.random(),this.target.Y=400*Math.random()),this.dir=S.Dir(this.elem.pos,this.target),S.Dir(this.elem.pos,this.target),this.elem.pos.X+=this.dir.X*e,this.elem.pos.Y+=this.dir.Y*e,this.elem.rotate+=t*Math.PI,this.body.SetTransformXY(this.elem.pos.X,this.elem.pos.Y,this.elem.rotate)}}Cr.g_id=0;class Rr extends le{constructor(){super(...arguments),this.b2debug=new Po(null,1)}GetElementType(){return Wt.Element_Bar}OnRender(t){this.b2debug.batcher=t.batcherUI;for(let t=this.b2world.GetBodyList();t;t=t.m_next){const e=t.m_xf;this.b2debug.PushTransform(e);for(let e=t.GetFixtureList();e;e=e.m_next)e.GetShape().Draw(this.b2debug,e.GetUserData().color);this.b2debug.PopTransform(e)}t.batcherUI.ApplyBatch()}}class Ir extends xo{BeginContact(t){let e=t.m_fixtureB.GetUserData(),i=t.m_fixtureA.GetUserData();e.OnHit(i),i.OnHit(e)}EndContact(t){let e=t.m_fixtureB.GetUserData(),i=t.m_fixtureA.GetUserData();e.OnUnHit(i),i.OnUnHit(e)}}class Gr extends Zo{constructor(){super(...arguments),this.b2op={velocityIterations:0,positionIterations:0},this.bodys=[],this.objs=[]}OnInit(t){super.OnInit(t),O.GetMainScreen(),this.b2world=To.Create({x:0,y:0});let e=new Rr;e.b2world=this.b2world,this.b2world.SetContactListener(new Ir),this.guilayer.GetCanvas().AddChild(e);for(let t=0;t<30;t++){let e=this.b2world.CreateBody({type:Zi.b2_dynamicBody}),i=null;t%2==0?(i=new gn,i.m_radius=12):(i=new Sn).SetAsBox(10,10);let s=e.CreateFixture({shape:i,isSensor:!0});t%2==0?s.SetFilterData({categoryBits:1,maskBits:2}):s.SetFilterData({categoryBits:2,maskBits:1}),e.SetTransformXY(10*t,10*t,0),this.bodys.push(e);let n=K.GetBlock("border2"),o=new Cr;s.SetUserData(o),o.body=e,e.m_userData=o,o.elem=new Y,o.elem.instid=n.index,o.elem.color=b.White;let r=e.GetPosition();o.elem.pos=new B(r.x,r.y,0),o.elem.rotate=e.GetAngle(),o.elem.scale=new S(1,1),this.objs.push(o)}}OnExit(){super.OnExit(),O.GetViewList().RemoveDrawLayer(this.drawlayer)}OnUpdate(t){var e,i;let s=null===(i=null===(e=this.guilayer)||void 0===e?void 0:e.GetCanvas())||void 0===i?void 0:i.camera;if(null==s)return;null==this.drawlayer&&null!=s&&(this.drawlayer=new F(u.Main),this.render=new kt,this.render.SetPackElement(K.GetPackElement()),this.drawlayer.AddRender(this.render),O.GetViewList().AddDrawLayer(this.drawlayer));let n=this.guilayer.GetCanvas().GetWorldRect();console.log("canvas size("+n.Width+","+n.Height+")"),null!=s&&(this.drawlayer.GetCamera().LookAt=s.LookAt,this.drawlayer.GetCamera().Scale=s.Scale),this.b2world.Step(t,this.b2op),this.render.ClearElementInst();for(var o=0;o<this.objs.length;o++)this.objs[o].Update(t),this.render.AddElementInst(this.objs[o].elem)}}class Mr extends Zo{OnInit(t){super.OnInit(t),this.container.setAsp(2/3,.5),this.AddLabel("基本功能测试"),this.AddButton("Test:Show GL Info",(()=>{this.nav.NavigatorTo(new ur)})),this.AddButton("Test:TextureArray",(()=>{this.nav.NavigatorTo(new pr)})),this.AddButton("Test:Element (TBO)",(()=>{this.nav.NavigatorTo(new fr)})),this.AddButton("Test:Tiledmap",(()=>{this.nav.NavigatorTo(new br)})),this.AddButton("Test:TTPack",(()=>{this.nav.NavigatorTo(new Br)})),this.AddButton("Test:Box2d",(()=>{this.nav.NavigatorTo(new Gr)}))}}var Tr=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class Dr{static OpenFileAsDataUrl(){return Tr(this,arguments,void 0,(function*(t="image/png"){return null==this.input&&(this.input=document.createElement("input"),document.body.appendChild(this.input),this.input.type="file",this.input.style.visibility="hidden"),this.input.accept=t,new Promise((t=>{this.input.onchange=()=>{var e=this.input.files[0];if(null!=e){console.log("file name:"+e.name+" size:"+e.size);let i=new FileReader;i.onload=()=>{console.log("file="+i.result),t(i.result)},i.readAsDataURL(this.input.files[0])}else t(null)},this.input.click()}))}))}static SpriteDataToDataUrl(t){null==this.canvas&&(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.style.visibility="hidden",this.c2d=this.canvas.getContext("2d"));var e=new ImageData(t.width,t.height);for(let i=0;i<t.data.length;i++)e.data[i]=t.data[i];return this.canvas.width=t.width,this.canvas.height=t.height,this.c2d.putImageData(e,0,0),this.canvas.toDataURL("png")}static SpriteDataToBlob(t){return Tr(this,void 0,void 0,(function*(){null==this.canvas&&(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.style.visibility="hidden",this.c2d=this.canvas.getContext("2d"));var e=new ImageData(t.width,t.height);for(let i=0;i<t.data.length;i++)e.data[i]=t.data[i];return this.canvas.width=t.width,this.canvas.height=t.height,this.c2d.putImageData(e,0,0),new Promise((t=>{this.canvas.toBlob((e=>{t(e)}),"png")}))}))}static DataURLToBlob(t){let e=t.split(";base64,"),i=e[0].split(":")[1],s=window.atob(e[1]),n=s.length,o=new Uint8Array(n);for(let t=0;t<n;++t)o[t]=s.charCodeAt(t);return new window.Blob([o],{type:i})}static SaveData(t,e){return Tr(this,void 0,void 0,(function*(){null==this.a&&(this.a=document.createElement("a"),document.body.appendChild(this.a),this.a.style.visibility="hidden"),this.a.href=e,this.a.download=t,this.a.click()}))}}Dr.input=null,Dr.canvas=null,Dr.c2d=null,Dr.a=null;var Lr=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function r(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,h)}a((s=s.apply(t,e||[])).next())}))};class Pr extends Zo{OnInit(t){super.OnInit(t),this.AddLabel("Filesystem access Api Test 只有https才可以用 "),this.AddLabel("移动平台通常不支持!");var e=null!=window.showDirectoryPicker;this.AddLabel("FileAPI支持="+e),this.AddButton("Open Path",(()=>{this.OpenPath()})),this.AddLabel("Input 支持好些，但是体验较差!"),this.AddButton("Open By Input",(()=>Lr(this,void 0,void 0,(function*(){var t=yield Dr.OpenFileAsDataUrl("image/png,image/jpeg");console.log("file="+t)})))),this.AddButton("Save By FileWriter",(()=>Lr(this,void 0,void 0,(function*(){var t=new q;t.width=32,t.height=32,t.format=d.RGBA32,t.data=new Uint8Array(4096);for(let e=0;e<t.data.length;e++)t.data[e]=255;var e=Dr.DataURLToBlob(Dr.SpriteDataToDataUrl(t));Dr.SaveData("abcd.png",URL.createObjectURL(e))}))))}OpenPath(){return Lr(this,void 0,void 0,(function*(){var t,e,i,s;try{let h=yield showDirectoryPicker({mode:"readwrite",startIn:"documents"});try{for(var n,o=!0,r=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},s("next"),s("throw"),s("return"),e[Symbol.asyncIterator]=function(){return this},e);function s(i){e[i]=t[i]&&function(e){return new Promise((function(s,n){!function(t,e,i,s){Promise.resolve(s).then((function(e){t({value:e,done:i})}),e)}(s,n,(e=t[i](e)).done,e.value)}))}}}(h.entries());!(t=(n=yield r.next()).done);o=!0){s=n.value,o=!1;let t=s,e=t[0],i=t[1];console.log(e+":"+i.kind)}}catch(t){e={error:t}}finally{try{o||t||!(i=r.return)||(yield i.call(r))}finally{if(e)throw e.error}}let a=yield h.getFileHandle("f1.json",{create:!0}),l=yield a.createWritable({keepExistingData:!1});yield l.write("text ab1"),yield l.close(),yield h.getDirectoryHandle("bb",{create:!0})}catch(t){this.AddLabel("Err:"+t)}}))}}class Fr extends Zo{OnInit(t){super.OnInit(t),this.container.setAsp(1,2),this.AddLabel("PC功能测试"),this.AddButton("Test:FileAPI",(()=>{this.nav.NavigatorTo(new Pr)}))}}class Er{get CompType(){return"mycomp"}constructor(){this.target=new S(1e3*Math.random()-500,1e3*Math.random()-500)}OnUpdate(t){let e=S.Dir(this.node.poslocal,this.target),i=S.Dist(this.node.poslocal,this.target);var s=100*t;.5*i<=s&&(s=.5*i,this.target=new S(1e3*Math.random()-500,1e3*Math.random()-500)),e.X*=s,e.Y*=s;let n=S.Add(this.node.poslocal,e);this.node.poslocal=new B(n.X,n.Y,0)}OnAdd(t){this.node=t}OnRemove(){this.node=null}}class Or extends Zo{OnInit(t){this.scene=new qo,this.scenelayer=new ht(this.scene),O.GetViewList().AddDrawLayer(this.scenelayer),super.OnInit(t),this.container.setAsp(2/3,.5);let e=new Wo;e.name="rectgroup",this.scene.GetRoot().Node_Add(e);for(var i=0;i<1e3;i++){let t=new Wo;t.name="mynode_"+i,e.Node_Add(t),t.poslocal=new B(15*i,0,0);let s=new Jo;t.Comp_Add(s),t.Comp_Add(new Er)}}OnUpdate(t){let e=this.scenelayer.GetCamera(),i=this.container.GetCanvas();null!=e&&null!=i.camera&&(e.limitRect=this.container.getWorldRectScale(i.camera.Scale))}OnExit(){O.GetViewList().RemoveDrawLayer(this.scenelayer)}OnKey(t,e){var i,s;null===(s=(i=this.scene).OnKey)||void 0===s||s.call(i,t,e)}OnPointAfterGUI(t,e,i,s,n){var o,r;null===(r=(o=this.scene).OnPoint)||void 0===r||r.call(o,t,e,i,s,n)}}class Vr extends Zo{OnInit(t){super.OnInit(t),this.container.setAsp(2/3,.5),this.AddLabel("综合测试"),this.AddButton("Test:BaseScene",(()=>{this.nav.NavigatorTo(new Or)}))}}class kr extends Zo{OnInit(t){super.OnInit(t),this.container=new ue,this.container.setAsp(2/3,.5),this.guilayer.GetCanvas().AddChild(this.container),this.AddLabel("TTEngine 测试菜单"),this.AddButton("基本特性测试",(()=>{this.nav.NavigatorTo(new Mr)})),this.AddButton("PC浏览器特性测试",(()=>{this.nav.NavigatorTo(new Fr)})),this.AddButton("编辑器(PCOnly)",(()=>{this.nav.NavigatorTo(new dr)})),this.AddButton("综合测试",(()=>{this.nav.NavigatorTo(new Vr)}))}}class Ur{TopUI2Top(){let t=O.GetViewList().GetDrawLayers(u.GUI),e=t.indexOf(this.topuiview);e!=t.length-1&&(t.splice(e,1),t.push(this.topuiview))}}class Xr extends g{constructor(){super(...arguments),this.context=new Ur,this.frameCount=0,this.timer=0}OnInit(){this.context.topuiview=new rt,O.GetViewList().AddDrawLayer(this.context.topuiview),this.InitTopUI(this.context),this.NavigatorTo(new kr)}InitTopUI(e){{t.graphic.setMainScreenScale(1),e.topuiview.GetCamera().Scale=1.5*t.graphic.getDevicePixelRadio();{let t=new ye;t.text="新TTAPI",t.localColor=new b(0,0,0,.5),e.topuiview.GetCanvas().AddChild(t),t.localRect.setHPosFill(33,31),t.localRect.setVPosByTopBorder(16,9)}let i=new ye;i.text="新TTAPI",i.localColor=new b(.8,1,0,1),e.topuiview.GetCanvas().AddChild(i),i.localRect.setHPosFill(32,32),i.localRect.setVPosByTopBorder(16,8);let s=new pe;s.sprite=Ie.GetSprite("round"),s.localRect.setHPosByRightBorder(16,80),s.localRect.setVPosByTopBorder(16,0),e.topuiview.GetCanvas().AddChild(s);let n=this.label_fps=new ye;n.text="FPS:",e.topuiview.GetCanvas().AddChild(n),n.halign=Nt.Left,n.localRect.setHPosByRightBorder(80,0),n.localRect.setVPosByTopBorder(16,0)}}OnUpdate(t){var e;if(null===(e=this.GetLast())||void 0===e||e.OnUpdate(t),this.frameCount++,this.timer+=t,this.timer>1){let t=((this.frameCount/this.timer*10+.5|0)/10).toString();t.indexOf(".")<0&&(t+=".0"),this.label_fps.text="FPS:"+t,this.timer=0,this.frameCount=0}}OnExit(){var t;null===(t=this.GetLast())||void 0===t||t.OnExit()}OnResize(t,e){var i;null===(i=this.GetLast())||void 0===i||i.OnResize(t,e)}OnKey(t,e){var i;null===(i=this.GetLast())||void 0===i||i.OnKey(t,e)}OnPointAfterGUI(t,e,i,s,n){var o;null===(o=this.GetLast())||void 0===o||o.OnPointAfterGUI(t,e,i,s,n)}OnWheelAfterGUI(t,e,i){var s;null===(s=this.GetLast())||void 0===s||s.OnWheelAfterGUI(t,e,i)}}!function(){var e,i,s,n;e=this,i=void 0,n=function*(){var e=new _.ttimpl_browser,i=document.createElement("canvas");i.style.width="100%",i.style.height="100%",i.style.border="0px",i.style.margin="0px",document.body.appendChild(i),e.Init(i),console.log("hello world");let s=yield t.loaderex.LoadCustomFont("VonwaonBitmap-16px","./data/VonwaonBitmap-16px.ttf");console.log("add font:"+s);let n=new Z;n.defFontName="VonwaonBitmap-16px",n.defFontSize=32,O.Start(n,new Xr)},new((s=void 0)||(s=Promise))((function(t,o){function r(t){try{a(n.next(t))}catch(t){o(t)}}function h(t){try{a(n.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,h)}a((n=n.apply(e,i||[])).next())}))}()})();