(()=>{"use strict";var t,e;!function(t){t.sleep=function(t){return e=this,i=void 0,r=function*(){return new Promise((e=>setTimeout(e,t)))},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{a(r.next(t))}catch(t){n(t)}}function l(t){try{a(r.throw(t))}catch(t){n(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,l)}a((r=r.apply(e,i||[])).next())}));var e,i,s,r};class e{constructor(){this.id=0,this.x=0,this.y=0,this.press=!1,this.move=!1}Clone(){let t=new e;return t.id=this.id,t.x=this.x,t.y=this.y,t.press=this.press,t}}t.InputPoint=e,t.ImageBuffer=class{constructor(){this.width=0,this.height=0,this.gray=!1,this.data=null}}}(t||(t={})),function(e){e.ttimpl_graphics=class{constructor(t,e){this._MainScreenScale=1,this.OnUpdate=null,this.OnResize=null,this.OnRender=null,this._webgl=t,this.c2d=e}GetBackGroundC2D(){return this.c2d}GetWebGL(){return this._webgl}getMainScreenScale(){return this._MainScreenScale}setMainScreenScale(t){this._MainScreenScale=t,this.UpdateScreenSize()}UpdateScreenSize(){let e=this._webgl.canvas;var i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height))}getDeviceScreenWidth(){return this._webgl.canvas.clientWidth}getDeviceScreenHeight(){return this._webgl.canvas.clientHeight}getDevicePixelRadio(){return window.devicePixelRatio}getFinalScale(){return this.getDevicePixelRadio()/this._MainScreenScale}}}(e||(e={}));var i,s=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}))};!function(e){e.Loader=class{LoadStringAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.text()}))}LoadBinaryAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.arrayBuffer()}))}LoadImageAsync(t){return new Promise(((e,i)=>{let s=new Image;s.src=t;let r=!1;s.onload=t=>{r=!0,e(s)},s.onerror=t=>{r=!0,s=null,i("img error:"+t.toString())}}))}LoadImageDataAsync(e){return s(this,void 0,void 0,(function*(){let i=yield this.LoadImageAsync(e),s=t.graphic.GetBackGroundC2D();return s.canvas.width=i.width,s.canvas.height=i.height,s.clearRect(0,0,i.width,i.height),s.drawImage(i,0,0),s.getImageData(0,0,i.width,i.height)}))}LoadCustomFont(t,e){return s(this,void 0,void 0,(function*(){const i=new FontFace(t,"url("+e+")");let s=yield i.load();return document.fonts.add(s),s.family}))}}}(i||(i={}));var r,n=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}))};!function(t){class e{constructor(t,e,i){null!=e&&null==i?(this.loaded=!1,this.initByUrlAsync(t,e)):null!=i&&null==e&&this.initByDataAsync(t,i)}initByUrlAsync(t,e){return n(this,void 0,void 0,(function*(){let i=yield fetch(e),s=yield i.arrayBuffer();this.buffer=yield t.decodeAudioData(s)}))}initByDataAsync(t,e){return n(this,void 0,void 0,(function*(){this.buffer=yield t.decodeAudioData(e),this.loaded=!0}))}}class i{constructor(t,e){let i=new HTMLAudioElement;this.url=i.src=e,i.loop=!0,this.node=t.createMediaElementSource(i),this.loaded=!1,i.onload=()=>{this.loaded=!0},i.loop=!0,i.onended=()=>{null!=this.onEnd&&this.onEnd(this)}}setLoop(t){this.node.mediaElement.loop=t}getLoop(){return this.node.mediaElement.loop}}class s{constructor(t){this.sourceBGM=null,this.inBGM=!1,this.audioContext=t,this.vol=this.audioContext.createGain(),this.vol.gain.value=1,this.vol.connect(this.audioContext.destination)}SetBGM(t){this.inBGM&&(this.inBGM=!1,this.sourceBGM.disconnect(),this.sourceBGM=null),null!=t&&(this.sourceBGM=t.node,this.sourceBGM.connect(this.vol))}setVolume(t){this.vol.gain.value=t}getVolume(){return this.vol.gain.value}PlaySound(t){let e=this.audioContext.createBufferSource();e.buffer=t.buffer,e.connect(this.vol),e.loop=!1,e.start(),null!=t.onEnd&&(e.onended=()=>{t.onEnd(t)})}}t.Channel_Impl=s,t.AudioImpl=class{constructor(){this.channels=[];try{this.audioContext=new AudioContext,console.log("audio Context inited")}catch(t){throw console.error("!Your browser does not support AudioContext"),new Error("!Your browser does not support AudioContext")}this.Init()}GetChannel(t){if(t>16||t<0)throw new Error("error channel id.");for(;this.channels.length<=t;)this.channels.push(null);return null==this.channels[t]&&(this.channels[t]=new s(this.audioContext)),this.channels[t]}CreateBGM(t){return new i(this.audioContext,t)}CreateSound(t){return new e(this.audioContext,t,null)}CreateSoundFromArrayBuffer(t){return new e(this.audioContext,null,t)}Init(){if(null!=this.audioContext){var t=this.audioContext.createBuffer(1,1,22050),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start()}}ReInit(){this.Init()}}}(r||(r={}));var h,l;!function(e){e.Input=class{constructor(t){this._mousepress=!1,this._pressKeys=[],this.points=[],this.ishow=!1,this.Start(t)}Start(t){window.addEventListener("keydown",(t=>{this.UpdateKey(t.code,!0)})),window.addEventListener("keyup",(t=>{this.UpdateKey(t.code,!1)})),t.addEventListener("mousedown",(t=>{0==t.button&&(this.UpdateMouse(t,!0,!1),this._mousepress=!0)})),t.addEventListener("mouseup",(t=>{0==t.button&&(this.UpdateMouse(t,!1,!1),this._mousepress=!1)})),t.addEventListener("mousemove",(t=>{0==t.button&&this._mousepress&&this.UpdateMouse(t,!0,!0)})),t.addEventListener("touchstart",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!1)})),t.addEventListener("touchmove",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!0)})),t.addEventListener("touchend",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)})),t.addEventListener("touchcancel",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)}))}UpdateMouse(e,i,s){for(;this.points.length<=0;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[0].id=0,this.points[0].press=i,this.points[0].x=e.x,this.points[0].y=e.y,null!=this.OnPoint&&this.OnPoint(0,e.x,e.y,i,s)}UpdatePoint(e,i,s){let r=e.identifier+1;for(;this.points.length<=r;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[r].press=i,this.points[r].x=e.clientX,this.points[r].y=e.clientY,null!=this.OnPoint&&this.OnPoint(r,e.clientX,e.clientY,i,s)}UpdateKey(t,e){if(e){if(this._pressKeys.indexOf(t)>=0)return;this._pressKeys.push(t)}else{let e=this._pressKeys.indexOf(t);e>=0&&this._pressKeys.splice(e,1)}console.log("Input Key:"+t+"="+e),null!=this.OnKey&&this.OnKey(t,e)}GetPressKeys(){return this._pressKeys}IsKeyDown(t){return this._pressKeys.indexOf(t)>=0}GetInputPoints(){return this.points}Prompt(){return t=this,e=arguments,s=function*(t="",e=256){for(var i=0;i<this.points.length;i++)this.points[i].press=!1;return window.prompt("",t)},new((i=void 0)||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}));var t,e,i,s}}}(h||(h={})),function(t){t.Platform=class{getPlatformName(){return"browser_"+window.navigator.userAgent}}}(l||(l={}));var a=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}))};class o{constructor(){this._loaded=!1,this.InitAsync()}InitAsync(){return a(this,void 0,void 0,(function*(){yield u.OpenOrCreateDB("_ttstore_"),this._loaded=!0}))}IsReady(){return this._loaded}GetText(t){return a(this,void 0,void 0,(function*(){return yield u.GetStringValue(t)}))}GetBinary(t){return a(this,void 0,void 0,(function*(){return yield u.GetBinaryValue(t)}))}SaveText(t,e){return a(this,void 0,void 0,(function*(){yield u.SetStringValue(t,e)}))}SaveBinary(t,e){return a(this,void 0,void 0,(function*(){yield u.SetBinaryValue(t,e)}))}SaveDataToLocal(t,e){return a(this,void 0,void 0,(function*(){var i=document.createElement("a");i.download=t,i.style.display="none";var s=new Blob([e]);return i.href=URL.createObjectURL(s),document.body.appendChild(i),i.click(),document.body.removeChild(i),!0}))}}const d="__store__";class u{static DeleteDb(e){return a(this,void 0,void 0,(function*(){let i=indexedDB.deleteDatabase(e),s=0;for(i.onsuccess=()=>{console.log("db delete succ."),s=1},i.onerror=()=>{console.log("db delete error."),s=2};0==s;)yield t.sleep(1)}))}static OpenOrCreateDB(e){return a(this,void 0,void 0,(function*(){let i=0,s=indexedDB.open(e,1);for(s.onsuccess=t=>{console.log("db open"),i=1,this.db=s.result},s.onerror=()=>{console.log(" dbreq.onerror"),i=2,this.db=null},s.onupgradeneeded=t=>{console.log("db onupgradeneeded"),this.db=s.result,this.db.createObjectStore(d,{keyPath:["_id"]}).createIndex("_id","_id",{unique:!0}),console.log(" --create store--")};0==i;)yield t.sleep(1)}))}static SetStringValue(e,i){return a(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(d,"readwrite"),r=0,n=s.objectStore(d).put({_id:e,value:i,format:"text"});for(n.onsuccess=t=>{r=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},n.onerror=t=>{r=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==r;)yield t.sleep(1)}))}static SetBinaryValue(e,i){return a(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(d,"readwrite"),r=0,n=s.objectStore(d).put({_id:e,value:i,format:"hex"});for(n.onsuccess=t=>{r=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},n.onerror=t=>{r=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==r;)yield t.sleep(1)}))}static GetValue(e){return a(this,void 0,void 0,(function*(){if(null==this.db)return null;let i=this.db.transaction(d,"readonly").objectStore(d).index("_id").get(e),s=0;for(i.onsuccess=t=>{s=1,console.log("GetValue key:"+e+" data:"+JSON.stringify(i.result))},i.onerror=t=>{s=2,console.log("GetValue Fail key:"+JSON.stringify(i.result))};0==s;)yield t.sleep(1);return i.result}))}static GetBinaryValue(t){return a(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("hex"==e.format)return e.value;throw new Error("format is text.")}))}static GetStringValue(t){return a(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("text"==e.format)return e.value;throw new Error("format is text.")}))}}var c,p,f,_,m,g,v,w,y,R,b;u.db=null,function(s){s.ttimpl_browser=class{constructor(){this.timerMs=0}Init(s){if(this.webgl=s.getContext("webgl2",{antialias:!1}),null!=this.webgl){let i=new OffscreenCanvas(32,32).getContext("2d",{colorSpace:"srgb",willReadFrequently:!0});t.graphic=new e.ttimpl_graphics(this.webgl,i),this.timerMs=(new Date).getTime(),requestAnimationFrame(this.Update.bind(this))}else console.error("init webgl error.");t.loader=new i.Loader,t.audio=new r.AudioImpl,t.input=new h.Input(s),t.platform=new l.Platform,t.store=new o}ReInitAudio(){}SendEnvEventToUser(t,e){}Update(){if(null!=this.webgl){var e=this.webgl.canvas,i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;t.graphic.getDevicePixelRadio(),e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height)),requestAnimationFrame(this.Update.bind(this));var r=(new Date).getTime(),n=(r-this.timerMs)/1e3;this.timerMs=r,null!=t.graphic.OnUpdate&&t.graphic.OnUpdate(n),null!=t.graphic.OnRender&&t.graphic.OnRender()}}}}(c||(c={}));class x{constructor(t){this.contextObj=null,this._stateStack=[],this.contextObj=t}GetContextObj(){return this.contextObj}GetLast(){return 0==this._stateStack.length?null:this._stateStack[this._stateStack.length-1]}Count(){return this._stateStack.length}NavigatorTo(t){if(null==t)throw"不可以导航到空状态";this._stateStack.indexOf(t)>=0?this.BackTo(t):this.Push(t)}Back(){if(0==this._stateStack.length)throw"已经是空栈状态";let t=this._stateStack[this._stateStack.length-1];this._stateStack.splice(this._stateStack.length-1,1),t.OnExit(),this._stateStack.length>0&&this._stateStack[this._stateStack.length-1].OnInit(this)}BackTo(t){if(null==t)throw"不可以导航到空状态";let e=this._stateStack.indexOf(t);if(e<0)throw"不存在的栈,无法回退";if(e==this._stateStack.length-1)throw"不能回退到自身";for(;this._stateStack.length>0;){let e=this._stateStack[this._stateStack.length-1];if(this._stateStack.splice(this._stateStack.length-1,1),e==t)return void e.OnInit(this);e.OnExit()}}Push(t){this._stateStack.length>0&&this._stateStack[this._stateStack.length-1].OnExit(),this._stateStack.push(t),t.OnInit(this)}}class B{constructor(t,e,i,s=1){this.R=t,this.G=e,this.B=i,this.A=s}static get White(){return new B(1,1,1,1)}static get Black(){return new B(0,0,0,1)}static get Tran(){return new B(0,0,0,0)}Clone(){return new B(this.R,this.G,this.B,this.A)}}class A{constructor(t,e){this.X=t,this.Y=e}Clone(){return new A(this.X,this.Y)}static get One(){return new A(1,1)}static get Zero(){return new A(0,0)}static Length(t){return Math.sqrt(t.X*t.X+t.Y*t.Y)}static Dist(t,e){return Math.sqrt((t.X-e.X)*(t.X-e.X)+(t.Y-e.Y)*(t.Y-e.Y))}static Dir(t,e){let i=A.Dist(t,e);return new A((e.X-t.X)/i,(e.Y-t.Y)/i)}static Add(t,e){return new A(t.X+e.X,t.Y+e.Y)}static Normal(t){let e=A.Length(t);return new A(t.X/e,t.Y/e)}}class S{constructor(t,e,i){this.X=t,this.Y=e,this.Z=i}Clone(){return new S(this.X,this.Y,this.Z)}static get One(){return new S(1,1,1)}static get Zero(){return new S(0,0,0)}}class C{constructor(t,e,i,s){this.X=t,this.Y=e,this.Width=i,this.Height=s}}class E{static Clone(t){return new C(t.X,t.Y,t.Width,t.Height)}static Intersect(t,e){let i=t.X,s=t.X+t.Width,r=t.Y,n=t.Y+t.Height,h=e.X,l=e.Y,a=h+e.Width,o=l+e.Height;if(i>=a||h>=s||r>=o||l>=n)return new C(0,0,0,0);let d=Math.max(i,h),u=Math.max(r,l),c=Math.min(s,a),p=Math.min(n,o);return new C(d,u,c-d,p-u)}}class G{constructor(t,e,i,s){this.XLeft=t,this.YTop=e,this.XRight=i,this.YBottom=s}}class T{constructor(t,e,i,s){this.U1=t,this.V1=e,this.U2=i,this.V2=s}}!function(t){t[t.R8=0]="R8",t[t.RGBA32=1]="RGBA32",t[t.F_R8=2]="F_R8",t[t.F_RGBA=3]="F_RGBA"}(p||(p={}));class I{IsArray(){return!1}GetLayer(){return 0}constructor(t,e,i,s,r){if(this._webgl=t,this._format=s,this._texobj=t.createTexture(),this._id=I.texid,this._width=e,this._height=i,I.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==p.F_R8||this._format==p.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==p.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==p.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),null==r)this._webgl,this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,null);else{let t=s==p.RGBA32?4:1;if(r.length!=this._width*this._height*t)throw new Error("wrong texSize");this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,r)}}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}UploadImg(t){this._width=t.width,this._height=t.height,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,this._formatGL,this._typeGL,t)}UploadTexture(t,e,i,s,r){this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texSubImage2D(this._webgl.TEXTURE_2D,0,t,e,i,s,this._formatGL,this._typeGL,r)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}I.texid=1;class L{IsArray(){return!0}GetLayer(){return this._layer}constructor(t,e,i,s,r){this._webgl=t,this._format=r,this._layer=s,this._texobj=t.createTexture(),this._texobj,this._id=I.texid,this._width=e,this._height=i,I.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==p.F_R8||this._format==p.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==p.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==p.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl,this._webgl.texImage3D(this._webgl.TEXTURE_2D_ARRAY,0,this._formatInnerGL,e,i,this._layer,0,this._formatGL,this._typeGL,null)}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}UploadSubTexture(t,e,i,s,r,n){this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._format==p.RGBA32?this._webgl.RGBA:this._webgl.R8,this._webgl.UNSIGNED_BYTE,this._webgl.texSubImage3D(this._webgl.TEXTURE_2D_ARRAY,0,e,i,t,s,r,1,this._formatGL,this._typeGL,n)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}class U{constructor(t){this.rectLimit=[],this._webgl=t,console.log("webgl init size:"+t.canvas.width+","+t.canvas.height)}IsArray(){return!1}GetLayer(){return 0}IsMainOutput(){return!0}Begin(){this._webgl.bindFramebuffer(this._webgl.FRAMEBUFFER,null),this._webgl.viewport(0,0,this.getWidth(),this.getHeight()),this.ResetLimitRect()}Clear(t){this._webgl.clearColor(t.R,t.G,t.B,t.A),this._webgl.clear(this._webgl.COLOR_BUFFER_BIT)}End(){this._webgl.flush()}getID(){return 0}getGLTex(){return null}getFormat(){return p.RGBA32}getWidth(){return this._webgl.canvas.width}getHeight(){return this._webgl.canvas.height}getData(){throw new Error("not spport on MainScreen.")}IsStatic(){return!0}IsTarget(){return!0}UploadTexture(t,e,i,s,r){throw new Error("MainScreen Method not implemented.")}ApplyTexture(t){throw new Error("MainScreen Method not implemented.")}Destory(){throw new Error("MainScreen Method not implemented.")}Resize(t,e){throw new Error("MainScreen Method not implemented.")}PushLimitRect(t){let e=null;if(0==this.rectLimit.length)e=E.Clone(t);else{let i=this.rectLimit[this.rectLimit.length-1];e=E.Intersect(i,t)}this.rectLimit.push(e),this.ResetLimitRect()}PopLimitRect(){this.rectLimit.splice(this.rectLimit.length-1,1),this.ResetLimitRect()}ClearLimitRect(){this.rectLimit.splice(0,this.rectLimit.length),this.ResetLimitRect()}ResetLimitRect(){if(0==this.rectLimit.length)this._webgl.disable(this._webgl.SCISSOR_TEST);else{let t=this.rectLimit[this.rectLimit.length-1];this._webgl.enable(this._webgl.SCISSOR_TEST),this._webgl.scissor(t.X,this.getHeight()-t.Y-t.Height,t.Width,t.Height)}}}class F{constructor(){this.clearcolor=new B(1,.5,.5,1),this.maintarget=null}Render(t){null==this.maintarget&&(this.maintarget=X.GetMainScreen()),this.maintarget.Begin(),this.maintarget.Clear(this.clearcolor),t.RenderDrawLayers(f.Main,this.maintarget,0),t.RenderDrawLayers(f.GUI,this.maintarget,0),this.maintarget.End()}}!function(t){t[t.ERROR=0]="ERROR",t[t.Main=1]="Main",t[t.GUI=2]="GUI",t[t.PreRender=3]="PreRender",t[t.POSTRender=4]="POSTRender",t[t.CUSTOM=5]="CUSTOM"}(f||(f={}));class O{constructor(){this.LookAt=A.Zero,this.Scale=2,this._viewmatrix=new Float32Array(16),this._projmatrix=new Float32Array(16)}GetViewMatrix(){let t=this._viewmatrix,e=this.Scale,i=this.Scale,s=-this.LookAt.X,r=-this.LookAt.Y;return t[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this._viewmatrix}GetProjMatrix(t){let e=this._projmatrix,i=2/t.getWidth(),s=2/t.getHeight();return t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,e}}class D{constructor(t){this.camera=new O,this.renders=[],this.numbertag=t}GetTag(){return this.numbertag}GetCamera(){return this.camera}GetRenders(){return this.renders}GetGUIs(t){for(let e=0;e<this.renders.length;e++){let i=this.renders[e];null!=i.GetGUI()&&t.push(i.GetGUI())}}AddRender(t){this.renders.push(t)}Update(t){for(let e=0;e<this.renders.length;e++)this.renders[e].OnUpdate(t)}Render(t,e){for(let i=0;i<this.renders.length;i++)this.renders[i].OnRender(t,this.camera,e)}}class V{constructor(){this.mapviews={},this.pipeline=new F}AddDrawLayer(t){let e=t.GetTag();null==this.mapviews[e]&&(this.mapviews[e]=[]),this.mapviews[e].push(t)}RemoveDrawLayers(t){let e=t.GetTag(),i=this.GetDrawLayers(e),s=i.indexOf(t);s>=0&&i.splice(s,1)}GetDrawLayers(t){return null==this.mapviews[t]&&(this.mapviews[t]=[]),this.mapviews[t]}RenderDrawLayers(t,e,i){let s=this.GetDrawLayers(t);if(null!=s){for(let t=0;t<s.length;t++)s[t].Render(e,i);return s.length}return 0}GetDrawLayerTags(){let t=[];for(let e in this.mapviews)t.push(e);return t}Update(t){for(let e in this.mapviews){let i=this.mapviews[e];for(let e=0;e<i.length;e++)i[e].Update(t)}}Render(){this.pipeline.Render(this)}}class X{static Start(e,i){let s=t.graphic.GetWebGL();J.Init(e),this._mainscreen=new U(s),this._viewlist=new V,this.regevent(),this.SetUserLogic(i)}static regevent(){t.graphic.OnRender=this.OnRender.bind(this),t.graphic.OnUpdate=this.OnUpdate.bind(this),t.graphic.OnResize=this.OnResize.bind(this),t.input.OnPoint=this.OnPoint.bind(this),t.input.OnKey=this.OnKey.bind(this)}static Pause(t){this._pause=t}static SetUserLogic(t){null!=this._state&&this._state.OnExit(),this._state=t,null!=this._state&&this._state.OnInit()}static GetViewList(){return this._viewlist}static Fence(){return!this._willfence&&(this._willfence=!0,!0)}static CanFence(){return!this._willfence}static GetFenceID(){return this._fenceid}static GetMainScreen(){return this._mainscreen}static OnUpdate(t){this._pause||(this._viewlist.Update(t),null!=this._state&&this._state.OnUpdate(t))}static OnResize(t,e){this._pause||null!=this._state&&this._state.OnResize(t,e)}static OnRender(){if(this._pause)return;let e=t.graphic.GetWebGL();this._viewlist.Render(),this._willfence&&this.DoFence(e)}static DoFence(t){this._willfence=!1;let e=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush();let i=()=>{let s=t.clientWaitSync(e,0,0);if(s==t.TIMEOUT_EXPIRED||s==t.WAIT_FAILED)return console.log("=>not signed."),void setTimeout(i,0);console.log("=>signed."),t.deleteSync(e),this._willfence=!1,this._fenceid++};setTimeout(i,0)}static OnPoint(t,e,i,s,r){if(this._pause)return;let n=this._viewlist.GetDrawLayers(f.GUI);if(null!=n)for(let h=n.length-1;h>=0;h--){let l=!1,a=n[h].GetRenders();for(let n=a.length-1;n>=0;n--){let h=a[n].GetGUI();if(null!=h&&(l=h.OnTouch(t,s,r,e,i),l))break}if(l)break}null!=this._state&&this._state.OnPointAfterGUI(t,e,i,s,r)}static OnKey(t,e){this._pause||null!=this._state&&this._state.OnKey(t,e)}}X._pause=!1,X._mainscreen=null,X._state=null,X._viewlist=null,X._willfence=!1,X._fenceid=0,function(t){t[t.VertexShader=0]="VertexShader",t[t.FragmentShader=1]="FragmentShader"}(_||(_={})),function(t){t[t.empty=0]="empty",t[t.unknown=1]="unknown",t[t.mat4=2]="mat4",t[t.sampler2D=3]="sampler2D",t[t.block=4]="block",t[t.float=5]="float",t[t.int=6]="int",t[t.vec4=7]="vec4",t[t.ivec4=8]="ivec4"}(m||(m={}));class P{constructor(t,e,i){this.type=t,this.name=e,this.shader=i}}class Y{constructor(t,e,i,s,r){this.name=e,this.program=i;var n=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES);for(let e=0;e<n;e++){var h=t.getActiveAttrib(i,e);t.getAttribLocation(i,h.name)}this.uniformInfos={};var l=t.getProgramParameter(i,t.ACTIVE_UNIFORMS);for(let e=0;e<l;e++){var a=t.getActiveUniform(i,e);let s=t.getUniformLocation(this.program,a.name);if(null==s)break;let r=m.empty;switch(a.type){case t.INT:r=m.int;break;case t.FLOAT:r=m.float;break;case 35666:r=m.vec4;break;case 35666:r=m.ivec4;break;case 35676:r=m.mat4;break;case 35678:case 36289:r=m.sampler2D;break;default:throw"ShaderProgram.ctor not supported."+a.type.toString(16)}this.uniformInfos[a.name]={loc:s,locblock:-1,type:r}}var o=t.getProgramParameter(i,t.ACTIVE_UNIFORM_BLOCKS);for(let e=0;e<o;e++){var d=t.getActiveUniformBlockName(i,e);let s=t.getUniformBlockIndex(this.program,d);null==s||s<0||(this.uniformInfos[d]={loc:null,locblock:s,type:m.block})}}AddUniform(t,e,i){if(i==m.block){let s=t.getUniformBlockIndex(this.program,e);if(null==s||s<0)return;this.uniformInfos[e]={loc:null,locblock:s,type:i}}else{let s=t.getUniformLocation(this.program,e);if(null==s)return;this.uniformInfos[e]={loc:s,locblock:-1,type:i}}}}class k{constructor(t=0,e=0,i=0,s=0,r=!1,n=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=t,this._height=e,this._x=i,this._y=s,this._data={},this._rot=r,this._allowRotation=n}static Collide(t,e){return t.collide(e)}static Contain(t,e){return t.contain(e)}area(){return this.width*this.height}collide(t){return t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y}contain(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._dirty++)}get height(){return this._height}set height(t){t!==this._height&&(this._height=t,this._dirty++)}get x(){return this._x}set x(t){t!==this._x&&(this._x=t,this._dirty++)}get y(){return this._y}set y(t){t!==this._y&&(this._y=t,this._dirty++)}get rot(){return this._rot}set rot(t){if(!1!==this._allowRotation&&this._rot!==t){const e=this.width;this.width=this.height,this.height=e,this._rot=t,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(t){this._allowRotation!==t&&(this._allowRotation=t,this._dirty++)}get data(){return this._data}set data(t){null!==t&&t!==this._data&&(this._data=t,"object"==typeof t&&t.hasOwnProperty("allowRotation")&&(this._allowRotation=t.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(t=!0){this._dirty=t?this._dirty+1:0}}(b=g||(g={}))[b.MAX_AREA=0]="MAX_AREA",b[b.MAX_EDGE=1]="MAX_EDGE";class M{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some((t=>t.dirty))}setDirty(t=!0){if(this._dirty=t?this._dirty+1:0,!t)for(let t of this.rects)t.setDirty&&t.setDirty(!1)}}class W extends M{constructor(t=4096,e=4096,i=0,s={}){super(),this.maxWidth=t,this.maxHeight=e,this.padding=i,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:g.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),s),this.width=this.options.smart?0:t,this.height=this.options.smart?0:e,this.border=this.options.border?this.options.border:0,this.freeRects.push(new k(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)),this.stage=new k(this.width,this.height)}add(...t){let e,i;if(1===t.length){if("object"!=typeof t[0])throw new Error("MacrectsBin.add(): Wrong parameters");i=t[0];let e=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==e)return}else{if(e=t.length>2?t[2]:null,this.options.tag&&this.options.exclusiveTag){if(e&&this.tag!==e.tag)return;if(!e&&this.tag)return}i=new k(t[0],t[1]),i.data=e,i.setDirty(!1)}const s=this.place(i);return s&&this.rects.push(s),s}repack(){let t=[];this.reset(),this.rects.sort(((t,e)=>{const i=Math.max(e.width,e.height)-Math.max(t.width,t.height);return 0===i&&t.hash&&e.hash?t.hash>e.hash?-1:1:i}));for(let e of this.rects)this.place(e)||t.push(e);for(let e of t)this.rects.splice(this.rects.indexOf(e),1);return t.length>0?t:void 0}reset(t=!1,e=!1){t&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],e&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new k(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)],this.stage=new k(this.width,this.height),this._dirty=0}clone(){let t=new W(this.maxWidth,this.maxHeight,this.padding,this.options);for(let e of this.rects)t.add(e);return t}place(t){let e,i,s=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;if(!this.options.tag||!this.options.exclusiveTag||this.tag===s){if(i=t.hasOwnProperty("_allowRotation")&&void 0!==t.allowRotation?t.allowRotation:this.options.allowRotation,e=this.findNode(t.width+this.padding,t.height+this.padding,i),e){this.updateBinSize(e);let i=this.freeRects.length,s=0;for(;s<i;)this.splitNode(this.freeRects[s],e)&&(this.freeRects.splice(s,1),i--,s--),s++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,t.x=e.x,t.y=e.y,void 0===t.rot&&(t.rot=!1),t.rot=e.rot?!t.rot:t.rot,this._dirty++,t}if(this.verticalExpand){if(this.updateBinSize(new k(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new k(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(t)}else if(this.updateBinSize(new k(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new k(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(t)}}findNode(t,e,i){let s,r,n,h=Number.MAX_VALUE;for(let l in this.freeRects)r=this.freeRects[l],r.width>=t&&r.height>=e&&(s=this.options.logic===g.MAX_AREA?r.width*r.height-t*e:Math.min(r.width-t,r.height-e),s<h&&(n=new k(t,e,r.x,r.y),h=s)),i&&r.width>=e&&r.height>=t&&(s=this.options.logic===g.MAX_AREA?r.width*r.height-e*t:Math.min(r.height-t,r.width-e),s<h&&(n=new k(e,t,r.x,r.y,!0),h=s));return n}splitNode(t,e){if(!t.collide(e))return!1;if(e.x<t.x+t.width&&e.x+e.width>t.x){if(e.y>t.y&&e.y<t.y+t.height){let i=new k(t.width,e.y-t.y,t.x,t.y);this.freeRects.push(i)}if(e.y+e.height<t.y+t.height){let i=new k(t.width,t.y+t.height-(e.y+e.height),t.x,e.y+e.height);this.freeRects.push(i)}}if(e.y<t.y+t.height&&e.y+e.height>t.y){if(e.x>t.x&&e.x<t.x+t.width){let i=new k(e.x-t.x,t.height,t.x,t.y);this.freeRects.push(i)}if(e.x+e.width<t.x+t.width){let i=new k(t.x+t.width-(e.x+e.width),t.height,e.x+e.width,t.y);this.freeRects.push(i)}}return!0}pruneFreeList(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;let s=this.freeRects[t];for(;e<i;){let r=this.freeRects[e];if(r.contain(s)){this.freeRects.splice(t,1),t--,i--;break}s.contain(r)&&(this.freeRects.splice(e,1),e--,i--),e++}t++}}updateBinSize(t){if(!this.options.smart)return!1;if(this.stage.contain(t))return!1;let e=Math.max(this.width,t.x+t.width-this.padding+this.border),i=Math.max(this.height,t.y+t.height-this.padding+this.border);if(this.options.allowRotation){const s=Math.max(this.width,t.x+t.height-this.padding+this.border),r=Math.max(this.height,t.y+t.width-this.padding+this.border);s*r<e*i&&(e=s,i=r)}return this.options.pot&&(e=Math.pow(2,Math.ceil(Math.log(e)*Math.LOG2E)),i=Math.pow(2,Math.ceil(Math.log(i)*Math.LOG2E))),this.options.square&&(e=i=Math.max(e,i)),!(e>this.maxWidth+this.padding||i>this.maxHeight+this.padding||(this.expandFreeRects(e+this.padding,i+this.padding),this.width=this.stage.width=e,this.height=this.stage.height=i,0))}expandFreeRects(t,e){this.freeRects.forEach(((i,s)=>{i.x+i.width>=Math.min(this.width+this.padding-this.border,t)&&(i.width=t-i.x-this.border),i.y+i.height>=Math.min(this.height+this.padding-this.border,e)&&(i.height=e-i.y-this.border)}),this),this.freeRects.push(new k(t-this.width-this.padding,e-2*this.border,this.width+this.padding-this.border,this.border)),this.freeRects.push(new k(t-2*this.border,e-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter((t=>!(t.width<=0||t.height<=0||t.x<this.border||t.y<this.border))),this.pruneFreeList()}}class z{constructor(){this.index=-1}}class N{}class H{static CalcElementSpriteStr(t){return t.sizeTL.X+","+t.sizeTL.Y+","+t.sizeRB.X+","+t.sizeRB.Y+t.uvCenter.X+","+t.uvCenter.Y+","+t.uvHalfSize.X+","+t.uvHalfSize.Y+t.uvLayer+","+t.index}static GetElementInstSize(){return 32}static GetFormat_Vertex_Ubo(){if(null==this.inst_ubo){let t=new st("Vertex_InstFull");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=4,t.vbos[1].atrribs.push(new et(y.FLOAT,4,!1)),t.vbos[1].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_SHORT,2,!1)),this.inst_ubo=t,t.Update()}return this.inst_ubo}}!function(t){t[t.R2Gray=0]="R2Gray",t[t.R2Alpha=1]="R2Alpha"}(v||(v={})),function(t){t[t.R=0]="R",t[t.GRAY=1]="GRAY",t[t.Alpha=2]="Alpha"}(w||(w={}));class j{constructor(){this.toRgba=v.R2Alpha,this.toR=w.GRAY,this.pivotX=0,this.pivotY=0}CopyPixel(t,e,i,s,r){if(i==p.R8&&this.format==p.R8){let i=this.data[r*this.width+s];t[e]=i}else if(i==p.RGBA32&&this.format==p.RGBA32){let i=this.data[4*(r*this.width+s)+0],n=this.data[4*(r*this.width+s)+1],h=this.data[4*(r*this.width+s)+2],l=this.data[4*(r*this.width+s)+3];t[e]=i,t[e+1]=n,t[e+2]=h,t[e+3]=l}else if(i==p.R8&&this.format==p.RGBA32){let i=0;this.toR==w.R?i=this.data[4*(r*this.width+s)+0]:this.toR==w.GRAY?i=.3*this.data[4*(r*this.width+s)+0]+.6*this.data[4*(r*this.width+s)+1]+.1*this.data[4*(r*this.width+s)+2]:this.toR==w.Alpha&&(i=this.data[4*(r*this.width+s)+3]),t[e]=i}else if(i==p.RGBA32&&this.format==p.R8){let i=this.data[r*this.width+s];this.toRgba==v.R2Gray?(t[e]=i,t[e+1]=i,t[e+2]=i,t[e+3]=255):(t[e]=255,t[e+1]=255,t[e+2]=255,t[e+3]=i)}}ConvertToR(){if(this.format!=p.RGBA32)throw"only rgba can convert to R";let t=new j;t.format=p.R8,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=e*this.width+i;this.CopyPixel(t.data,s,p.R8,i,e)}return t}ConvertToRGBA(){if(this.format!=p.R8)throw"only r8 can convert to Rgba";let t=new j;t.format=p.RGBA32,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=4*(e*this.width+i);this.CopyPixel(t.data,s,p.RGBA32,i,e)}return t}Cut(t,e,i,s){let r=new j;r.format=this.format,r.toRgba=this.toRgba,r.toR=this.toR,r.width=i,r.height=s;let n=p.RGBA32?4:1;r.data=new Uint8Array(i*s*n);for(let h=0;h<s;h++)for(let s=0;s<i;s++){let l=h*i+s,a=(h+e)*this.width+(s+t);1==n?r.data[l]=this.data[a]:(r.data[4*l+0]=this.data[4*a+0],r.data[4*l+1]=this.data[4*a+1],r.data[4*l+2]=this.data[4*a+2],r.data[4*l+3]=this.data[4*a+3])}return r}}class K extends L{constructor(t,e,i,s,r,n=0){super(t,e,i,r,s),this.dirty=!1,this.curlayer=0,this.maxrect=new W(e,i,n),this.pixelbuf=new Uint8Array(e*i*(s==p.RGBA32?4:1)),this.dirty=!1}AddSprite(t,e){let i=this.maxrect.add(t.width,t.height,null);if(null==i&&(this.maxrect.reset(),i=this.maxrect.add(t.width,t.height,null),this.Apply(),this.curlayer++,this.curlayer>=this._layer))throw"AddSprite:Layer 满了";for(let e=0;e<t.height;e++)for(let s=0;s<t.width;s++){let r=(e+i.y)*this._width+(i.x+s);this._format==p.RGBA32?t.CopyPixel(this.pixelbuf,4*r,p.RGBA32,s,e):t.CopyPixel(this.pixelbuf,r,p.R8,s,e)}this.dirty=!0;let s=new z;s.sizeTL=new A(-t.pivotX,-t.pivotY),s.sizeRB=new A(t.width-t.pivotX,t.height-t.pivotY);let r=i.x/this._width,n=i.y/this._height,h=(i.x+t.width)/this._width,l=(i.y+t.height)/this._height;return s.uvCenter=new A(.5*(r+h),.5*(n+l)),s.uvHalfSize=new A(.5*(h-r),.5*(l-n)),s.uvLayer=this.curlayer,s.eff=e,s}Apply(t=!1){(this.dirty||t)&&(this.UploadSubTexture(this.curlayer,0,0,this._width,this._height,this.pixelbuf),this.dirty=!1)}}class Z{AddSprite(t,e){return e==R.RGBA?this.packRGBA.AddSprite(t,e):this.packGray.AddSprite(t,e)}}class q{constructor(t){this.mapName2Index={},this.packTexDuo=t,this.ElemInit(512,512)}InitMat(){this.material=new tt(J.GetShaderProgram("default")),this.material.uniformTexs.texRGBA.value=this.packTexDuo.packRGBA,this.material.uniformTexs.texGray.value=this.packTexDuo.packGray}GetMaterial(){return this.material}ConvertElemToSprite(t){let e=new Ct(this.material);return e.effect=t.eff,e.uv=new T(t.uvCenter.X-t.uvHalfSize.X,t.uvCenter.Y-t.uvHalfSize.Y,t.uvCenter.X+t.uvHalfSize.X,t.uvCenter.Y+t.uvHalfSize.Y),e.pixelwidth=t.sizeRB.X-t.sizeTL.X,e.pixelheight=t.sizeRB.Y-t.sizeTL.Y,e.uvlayer=t.uvLayer,e}ElemInit(e,i){this.elemBufData=new Float32Array(e*i*4);let s=t.graphic.GetWebGL();this.elemTex=new I(s,e,i,p.F_RGBA,null),this.maxElemCount=e/4*i,this.elemCount=0,this.elemDirty=!1}GetElemTex(){return this.elemTex}GetPackTexDuo(){return this.packTexDuo}GetElementCount(){return this.elemCount}GetMaxElementCount(){return this.maxElemCount}WriteElement(t,e){t.index=e;let i=16*e;this.elemBufData[i+0]=t.sizeTL.X,this.elemBufData[i+1]=t.sizeTL.Y,this.elemBufData[i+2]=t.sizeRB.X,this.elemBufData[i+3]=t.sizeRB.Y,this.elemBufData[i+4]=t.uvCenter.X,this.elemBufData[i+5]=t.uvCenter.Y,this.elemBufData[i+6]=t.uvHalfSize.X,this.elemBufData[i+7]=t.uvHalfSize.Y,this.elemBufData[i+8]=t.uvLayer,this.elemBufData[i+11]=t.eff,this.elemDirty=!0}GetElementByIndex(t){let e=16*t,i=new z;return i.index=t,i.sizeTL=new A(0,0),i.sizeRB=new A(0,0),i.uvCenter=new A(0,0),i.uvHalfSize=new A(0,0),i.sizeTL.X=this.elemBufData[e+0],i.sizeTL.Y=this.elemBufData[e+1],i.sizeRB.X=this.elemBufData[e+2],i.sizeRB.Y=this.elemBufData[e+3],i.uvCenter.X=this.elemBufData[e+4],i.uvCenter.Y=this.elemBufData[e+5],i.uvHalfSize.X=this.elemBufData[e+6],i.uvHalfSize.Y=this.elemBufData[e+7],i.uvLayer=this.elemBufData[e+8],i.eff=this.elemBufData[e+11],i}AddSprite(t,e,i){let s=this.packTexDuo.AddSprite(t,e);return this.AddElement(i,s)}AddElement(t,e){let i=this.mapName2Index[t];if(null==i){if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";i=this.elemCount,this.mapName2Index[t]=i,this.elemCount++}return this.WriteElement(e,i),this.GetElementByIndex(i)}AddElementNoname(t){let e=this.elemCount;if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";return e=this.elemCount,this.elemCount++,this.WriteElement(t,e),this.GetElementByIndex(e)}GetElementByName(t){let e=this.mapName2Index[t];return null!=e?this.GetElementByIndex(e):null}ApplyTextureData(){this.packTexDuo.packRGBA.Apply(),this.packTexDuo.packGray.Apply(),this.elemDirty&&(this.elemTex.UploadTexture(0,0,this.elemTex.getWidth(),this.elemTex.getHeight(),this.elemBufData),this.elemDirty=!1)}}class Q{constructor(){this.defFontName="Arail",this.defFontSize=32,this.packedGrayWidth=1024,this.packedGrayHeight=1024,this.packedGrayLayerCount=8,this.packedRGBAWidth=1024,this.packedRGBAHeight=1024,this.packedRGBALayerCount=4}}class J{static Init(e){let i=t.graphic.GetWebGL();this.InitInnerResource(i,e)}static InitInnerResource(t,e){!function(t){var e=J.CompileShader(t,_.VertexShader,"inst_tbo",wt),i=J.CompileShader(t,_.VertexShader,"inst_ubo",yt),s=J.CompileShader(t,_.VertexShader,"default",vt),r=J.CompileShader(t,_.FragmentShader,"default",Rt);null!=s&&null!=r&&J.AddProgram(t,"default",s,r);var n=J.CompileShader(t,_.VertexShader,"simple",bt),h=J.CompileShader(t,_.FragmentShader,"simple",xt);null!=n&&null!=h&&J.AddProgram(t,"simple",n,h);var l=J.CompileShader(t,_.VertexShader,"feedback",Bt),a=J.CompileShader(t,_.FragmentShader,"empty",At);null!=l&&null!=a&&J.AddProgramFeedback(t,"feedback",l,a,["outPos","outNormal"]);var o=J.CompileShader(t,_.FragmentShader,"tiledmap",St);null!=s&&null!=o&&J.AddProgram(t,"tiledmap",n,o),null!=i&&null!=r&&J.AddProgram(t,"inst_ubo",i,r),null!=e&&null!=r&&J.AddProgram(t,"inst_tbo",e,r)}(t);let i=new Z;i.packGray=new K(t,e.packedGrayWidth,e.packedGrayHeight,p.R8,e.packedGrayLayerCount,0),i.packRGBA=new K(t,e.packedRGBAWidth,e.packedRGBAHeight,p.RGBA32,e.packedRGBALayerCount,0),this.packedelem=new q(i),this.packedelem.InitMat(),this.deffont=new Et(t,e.defFontName,e.defFontSize,this.packedelem);{let t=new j;t.format=p.R8,t.width=8,t.height=8,t.data=new Uint8Array(64);for(var s=0;s<t.height;s++)for(var r=0;r<t.width;r++)t.data[s*t.width+r]=255;t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,R.GrayAsAlpha,"white")}{let t=new j;t.format=p.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,R.GrayAsAlpha,"border")}{let t=new j;t.format=p.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,255,255,255,255,0,255,255,0,255,0,0,255,0,255,255,0,255,0,0,255,0,255,255,0,255,255,255,255,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,R.GrayAsAlpha,"border2")}{let t=new j;t.format=p.R8,t.width=8,t.height=8,t.toR=w.Alpha,t.data=new Uint8Array([0,0,0,255,255,0,0,0,0,0,255,255,255,255,0,0,0,255,255,128,128,255,255,0,255,255,128,200,200,128,255,255,255,255,128,200,200,128,255,255,0,255,255,128,128,255,255,0,0,0,255,255,255,255,0,0,0,0,0,255,255,0,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,R.GrayAsAlpha,"round")}this.packedelem.ApplyTextureData()}static GetPackElement(){return this.packedelem}static getWhiteBlock(){return this.packedelem.GetElementByName("white")}static GetRoundBlock(){return this.packedelem.GetElementByName("round")}static GetBorderBlock(){return this.packedelem.GetElementByName("border")}static GetBorder2Block(){return this.packedelem.GetElementByName("border2")}static GetBorderScale(){return null==this.scale_border&&(this.scale_border=new Lt(this.GetBorderBlock(),this.packedelem,new G(3,3,3,3))),this.scale_border}static CreateFont(e,i){return new Et(t.graphic.GetWebGL(),e,i,this.packedelem)}static GetDefFont(){return this.deffont}static CreateGUI_Label(t,e=new B(1,1,1,1)){let i=new Vt(this.deffont,t);i.color=e,i.localRect.setAsFill();let s=16/this.deffont.GetFontSize();return i.fontScale=new A(s,s),i.valign=_t.Middle,i.halign=ft.Middle,i}static CreateGUI_Button(t,e){let i=new Xt,s=new Dt(this.GetBorderScale()),r=new Dt(this.GetBorderScale());{s.color=e,s.localRect.setAsFill();let i=new Vt(this.deffont,t);i.color=e,i.localRect.setAsFill();let r=16/this.deffont.GetFontSize();i.fontScale=new A(r,r),s.addChild(i)}{let i=e.Clone();i.R*=.5,i.G*=.5,i.B*=.5,r.color=i,r.localRect.setAsFill();let s=new Vt(this.deffont,t);s.color=i,s.localRect.setAsFill();let n=16/this.deffont.GetFontSize();s.fontScale=new A(n,n),r.addChild(s)}return i.ElemNormal=s,i.ElemPress=r,i.localRect.setHPosByLeftBorder(100,100),i.localRect.setVPosByTopBorder(25,100),i}static GetShaderProgram(t){return null==this.programs[t]?null:this.programs[t]}static CompileShader(t,e,i,s){var r=function(t,e,i,s){var r=t.createShader(e==_.VertexShader?t.VERTEX_SHADER:t.FRAGMENT_SHADER);return null==r?(console.error("AddShader error webgl.createShader:"+e+":"+i),null):(t.shaderSource(r,s),t.compileShader(r),0==t.getShaderParameter(r,t.COMPILE_STATUS)?(console.error("AddShader error webgl.compileShader:"+t.getShaderInfoLog(r)+":"+e+":"+i),null):(console.log("AddShader:"+_[e].toString()+":"+i),new P(e,i,r)))}(t,e,i,s);return r}static AddProgram(t,e,i,s){if(null!=this.programs[e])throw"have a shader program:"+e;let r=function(t,e,i,s){var r=t.createProgram();if(null!=r){if(t.attachShader(r,i.shader),t.attachShader(r,s.shader),t.linkProgram(r),0==t.getProgramParameter(r,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+e+" E:"+t.getProgramInfoLog(r)),null;var n=new Y(t,e,r,i,s);return console.log("LinkShader:"+e),n}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s);return this.programs[e]=r,r}static AddProgramFeedback(t,e,i,s,r){if(null!=this.programs[e])throw"have a shader program:"+e;let n=function(t,e,i,s,r){var n=t.createProgram();if(null!=n){if(t.attachShader(n,i.shader),t.attachShader(n,s.shader),t.transformFeedbackVaryings(n,r,t.INTERLEAVED_ATTRIBS),t.linkProgram(n),0==t.getProgramParameter(n,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+t.getProgramInfoLog(n)),null;var h=new Y(t,e,n,i,s);return console.log("LinkShader:"+e),h}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s,r);return this.programs[e]=n,n}}J.scale_border=null,J.deffont=null,J.programs={};class ${static GetEmpty(){if(null==this._empty){let e=t.graphic.GetWebGL();this._empty=new $(e)}return this._empty}static GetMax(){let e=t.graphic.GetWebGL(),i=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE);return null==i?-1:i}constructor(t){this.buf=t.createBuffer()}GetGLBuf(){return this.buf}UploadData(t,e,i){t.bindBuffer(t.UNIFORM_BUFFER,this.buf),t.bufferData(t.UNIFORM_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW)}}class tt{constructor(t){this.uniformFloats={},this.uniformInts={},this.uniformMats={},this.uniformTexs={},this.uniformVecs={},this.uniformIVecs={},this.uniformBlocks={};let e=new Float32Array(16);e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1;let i=new Float32Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=0;let s=new Int32Array(4);for(var r in s[0]=0,s[1]=0,s[2]=0,s[3]=0,this.shader=t,t.uniformInfos){let n=t.uniformInfos[r];switch(n.type){case m.sampler2D:this.uniformTexs[r]={loc:n.loc,value:J.GetPackElement().GetPackTexDuo().packRGBA};break;case m.block:this.uniformBlocks[r]={index:n.locblock,value:$.GetEmpty()};case m.mat4:this.uniformMats[r]={loc:n.loc,value:e};break;case m.vec4:this.uniformVecs[r]={loc:n.loc,value:i};break;case m.ivec4:this.uniformIVecs[r]={loc:n.loc,value:s};break;case m.float:this.uniformFloats[r]={loc:n.loc,value:0};break;case m.int:this.uniformInts[r]={loc:n.loc,value:0}}}}GetShader(){return this.shader}UpdateMatProj(t){let e=new Float32Array(16),i=2/t.getWidth(),s=2/t.getHeight();t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this.uniformMats.matProj.value=e}UpdateMatModel(t=null){null==t&&((t=new Float32Array(16))[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1),this.uniformMats.matModel.value=t}UpdateMatView(t=null){if(null==t){let e=1,i=1,s=0,r=0;(t=new Float32Array(16))[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1}this.uniformMats.matView.value=t}Apply(t){for(var e in t.disable(t.CULL_FACE),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE),t.useProgram(this.shader.program),this.uniformFloats){let i=this.uniformFloats[e];t.uniform1f(i.loc,i.value)}for(var e in this.uniformInts){let i=this.uniformInts[e];t.uniform1i(i.loc,i.value)}for(var e in this.uniformMats){let i=this.uniformMats[e];t.uniformMatrix4fv(i.loc,!1,i.value)}for(var e in this.uniformVecs){let i=this.uniformVecs[e];t.uniform4fv(i.loc,i.value)}for(var e in this.uniformIVecs){let i=this.uniformIVecs[e];t.uniform4iv(i.loc,i.value)}let i=0;for(var e in this.uniformTexs){let s=this.uniformTexs[e];t.activeTexture(t.TEXTURE0+i);let r=s.value;r.IsArray()?t.bindTexture(t.TEXTURE_2D_ARRAY,r.getGLTex()):t.bindTexture(t.TEXTURE_2D,r.getGLTex()),t.uniform1i(s.loc,i),i++}let s=0;for(var e in this.uniformBlocks){let i=this.uniformBlocks[e];t.bindBufferBase(t.UNIFORM_BUFFER,s,i.value.GetGLBuf()),t.uniformBlockBinding(this.shader.program,i.index,s),s++}}}!function(t){t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"}(y||(y={}));class et{constructor(t,e,i){this.type=t,this.size=e,this.normalize=i}}class it{constructor(){this.vertexAttribDivisor=0,this.atrribs=[]}Update(){this.atrribsCount=this.atrribs.length,this.stride=0,this.hash="";for(var t=0;t<this.atrribs.length;t++){var e=this.atrribs[t];if(e.offset=this.stride,e.type==y.FLOAT)this.stride+=4*e.size;else if(e.type==y.UNSIGNED_BYTE)this.stride+=1*e.size;else if(e.type==y.UNSIGNED_SHORT)this.stride+=2*e.size;else{if(e.type!=y.UNSIGNED_INT)throw"unknown stride";this.stride+=4*e.size}this.hash+=e.type+"("+e.size+");"}}}class st{constructor(t){this.id=t,this.vbos=[]}Update(){this.hash="";for(var t=0;t<this.vbos.length;t++){var e=this.vbos[t];e.Update(),this.hash+="{"+e.hash+"}"}}}class rt{static RegFormat(t){t.Update();let e=t;return null==this.vertexFormats[t.hash]?this.vertexFormats[t.hash]=t:e=this.vertexFormats[t.hash],this.vertexFormatsID2Hash[t.id]=t.hash,e}static GetFormat(t){let e=this.vertexFormatsID2Hash[t];return this.vertexFormats[e]}static GetFormat_Vertex_Normal(){if(null==this.vertexFormat_Vertex_Normal){let t=new st("Vertex_Normal");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!0)),this.vertexFormat_Vertex_Normal=this.RegFormat(t)}return this.vertexFormat_Vertex_Normal}static GetFormat_Vertex_Color(){if(null==this.vertexFormat_Vertex_Color){let t=new st("Vertex_Color");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_Color}static GetFormat_Vertex_UV(){if(null==this.vertexFormat_Vertex_UV){let t=new st("Vertex_UV_Color");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),this.vertexFormat_Vertex_UV=this.RegFormat(t)}return this.vertexFormat_Vertex_UV}static GetFormat_Vertex_UV_Color(){if(null==this.vertexFormat_Vertex_UV_Color){let t=new st("Vertex_UV_Color");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color}static GetFormat_Vertex_UV_Color_Ext(){if(null==this.vertexFormat_Vertex_UV_Color_Color2){let t=new st("Vertex_UV_Color_Color2");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!1)),this.vertexFormat_Vertex_UV_Color_Color2=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_Color2}static GetFormat_Vertex_UV_Color_InstPos(){if(null==this.vertexFormat_Vertex_UV_Color_InstPos){let t=new st("Vertex_UV_Color_InstPos");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new et(y.FLOAT,3,!1)),this.vertexFormat_Vertex_UV_Color_InstPos=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPos}static GetFormat_Vertex_UV_Color_InstPosNormal(){if(null==this.vertexFormat_Vertex_UV_Color_InstPosNormal){let t=new st("Vertex_UV_Color_InstPosNormal");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[1].atrribs.push(new et(y.FLOAT,3,!0)),this.vertexFormat_Vertex_UV_Color_InstPosNormal=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}static GetFormat_Vertex_InstFull(){if(null==this.vertexFormat_Vertex_InstFull){let t=new st("Vertex_InstFull");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=4,t.vbos[1].atrribs.push(new et(y.FLOAT,4,!1)),t.vbos[1].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_SHORT,2,!1)),this.vertexFormat_Vertex_InstFull=this.RegFormat(t)}return this.vertexFormat_Vertex_InstFull}static GetFormat_Vertex_UV_Color_InstXYZRUVRectColor(){if(null==this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor){let t=new st("Vertex_UV_Color_InstXYZRUVRectColor");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,3,!1)),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[0].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new et(y.FLOAT,4,!1)),t.vbos[1].atrribs.push(new et(y.FLOAT,4,!1)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}}rt.vertexFormats={},rt.vertexFormatsID2Hash={},rt.vertexFormat_Vertex_Normal=null,rt.vertexFormat_Vertex_Color=null,rt.vertexFormat_Vertex_UV=null,rt.vertexFormat_Vertex_UV_Color=null,rt.vertexFormat_Vertex_UV_Color_Color2=null,rt.vertexFormat_Vertex_UV_Color_InstPos=null,rt.vertexFormat_Vertex_UV_Color_InstPosNormal=null,rt.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=null,rt.vertexFormat_Vertex_InstFull=null;class nt{constructor(){this._vbos=null,this._ebo=null,this._vao=null,this.indexcount=0}GetVertexFormat(){return this.vertexFormat}UpdateVertexFormat(t,e){for(null==this._vao&&(this._vao=t.createVertexArray()),null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<e.vbos.length;)this._vbos.push(null);for(;this.vertexcount.length<e.vbos.length;)this.vertexcount.push(0);for(var i=0;i<e.vbos.length;i++)null==this._vbos[i]&&(this._vbos[i]=t.createBuffer());this.vertexFormat=e;{t.bindVertexArray(this._vao);let r=0;for(i=0;i<e.vbos.length;i++){let n=e.vbos[i];t.bindBuffer(t.ARRAY_BUFFER,this._vbos[i]);for(var s=0;s<n.atrribsCount;s++){let e=n.atrribs[s];t.enableVertexAttribArray(r),t.vertexAttribPointer(r,e.size,e.type,e.normalize,n.stride,e.offset),t.vertexAttribDivisor(r,n.vertexAttribDivisor),r++}}for(s=r;s<10;s++)t.disableVertexAttribArray(s);t.bindVertexArray(null)}}SetVertexBuffer(t,e,i,s){for(null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<=e;)this._vbos.push(null);for(;this.vertexcount.length<=e;)this.vertexcount.push(0);this._vbos[e]=i,this.vertexcount[e]=s}SetIndexBuffer(t,e,i,s){this._ebo=e,this.indexcount=s}UploadVertexBuffer(t,e,i,s,r){null==this._vbos[e]&&(this._vbos[e]=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this._vbos[e]),t.bufferData(t.ARRAY_BUFFER,i,s?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,r),this.vertexcount[e]=r/this.vertexFormat.vbos[e].stride,t.bindBuffer(t.ARRAY_BUFFER,null)}UploadIndexBuffer(t,e,i,s){null==this._ebo&&(this._ebo=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,s),this.indexcount=s/2,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}Apply(t){t.bindVertexArray(this._vao),null!=this._ebo&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo)}static DrawMesh(t,e,i){e.Apply(t),i.Apply(t),null==e._ebo?t.drawArrays(t.TRIANGLES,0,e.vertexcount[0]):t.drawElements(t.TRIANGLES,e.indexcount,t.UNSIGNED_SHORT,t.ZERO)}static DrawMeshInstanced(t,e,i){e.Apply(t),i.Apply(t),null==e._ebo?t.drawArraysInstanced(t.TRIANGLES,0,e.vertexcount[0],e.instancecount):t.drawElementsInstanced(t.TRIANGLES,e.indexcount,t.UNSIGNED_SHORT,t.ZERO,e.instancecount)}}class ht{constructor(){this.canvas=new Ut(null)}GetGUI(){return this.canvas}OnUpdate(t){this.canvas.OnUpdate(t)}OnRender(t,e,i){0==i&&(this.canvas.scale=e.Scale,this.canvas.target=t,this.canvas.FIllTarget(),this.canvas.OnRender(null))}}class lt extends D{constructor(t=f.GUI){super(t);let e=new ht;this.canvas=e.canvas,this.GetRenders().push(e)}GetCanvas(){return this.canvas}}class at{static LoadTextPixel(e,i,s,r,n,h,l){let a=t.graphic.GetBackGroundC2D();a.canvas.width=r,a.canvas.height=n,a.scale(1,1),a.imageSmoothingEnabled=!1,a.shadowBlur=0,a.font=s+"px "+i,a.clearRect(0,0,r,n),a.textBaseline="top",a.textAlign="left",a.fillStyle="#ffffffff",a.globalAlpha=1,a.fillText(e,h,l);let o=a.measureText(e).width;return a.getImageData(0,0,o,n)}}!function(t){t[t.RGBA=0]="RGBA",t[t.Gray=1]="Gray",t[t.GrayAsAlpha=4]="GrayAsAlpha"}(R||(R={}));class ot{constructor(){this.x=0,this.y=0,this.z=0,this.r=1,this.g=1,this.b=1,this.a=1,this.u=0,this.v=0,this.uvlayer=0,this.e2=0,this.e3=0,this.eff=0}Clone(){var t=new ot;return t.x=this.x,t.y=this.y,t.z=this.z,t.u=this.u,t.v=this.v,t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t.uvlayer=this.uvlayer,t.e2=this.e2,t.e3=this.e3,t.eff=this.eff,t.x=this.x,t}}class dt{constructor(t){this._mesh=null,this._lastmat=null,this.matrixView=new Float32Array(16),this.matrixWorld=new Float32Array(16),this._webgl=t,this._target=null,this._lastmat=null,this._buffer=new Uint8Array(1835008),this._bufferView=new DataView(this._buffer.buffer,0,this._buffer.length),this._pointseek=0,this._lastMode=t.TRIANGLES,this.LookAt=new A(0,0),this.Scale=1,this._mesh=new nt,this._mesh.UpdateVertexFormat(t,rt.GetFormat_Vertex_UV_Color_Ext());let e=this.matrixWorld=new Float32Array(16);e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1}DrawQuads(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+6*i>=65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++)this._AddBuf(e[4*s+0]),this._AddBuf(e[4*s+1]),this._AddBuf(e[4*s+2]),this._AddBuf(e[4*s+2]),this._AddBuf(e[4*s+1]),this._AddBuf(e[4*s+3])}DrawTris(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+3*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++)this._AddBuf(e[3*s+0]),this._AddBuf(e[3*s+1]),this._AddBuf(e[3*s+2])}DrawLines(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.LINES||this._lastmat!=t||this._pointseek+2*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.LINES;for(var s=0;s<i;s++)this._AddBuf(e[2*s+0]),this._AddBuf(e[2*s+1])}DrawPoints(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.POINTS||this._lastmat!=t||this._pointseek+1*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.POINTS;for(var s=0;s<i;s++)this._AddBuf(e[s])}getTarget(){return this._target}getName(){return"Batcher"}UpdateMatView(){let t=this.matrixView,e=this.Scale,i=this.Scale,s=-this.LookAt.X,r=-this.LookAt.Y;t[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1}ResetMatrix(){this._Render(),this._lastmat.UpdateMatModel(),this._lastmat.UpdateMatView(),this._lastmat.UpdateMatProj(this._target)}ApplyBatch(){this._Render()}BeginDraw(t){this._target=t,this.UpdateMatView(),null!=this._lastmat&&(this._lastmat.UpdateMatModel(this.matrixWorld),this._lastmat.UpdateMatView(this.matrixView),this._lastmat.UpdateMatProj(this._target));let e=this._webgl;e.disable(e.CULL_FACE),e.depthMask(!1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.SRC_ALPHA,e.ONE)}EndDraw(){this._Render(),this._target=null,this._ApplySingle(null)}_Render(){if(0==this._pointseek)return;let t=this._webgl;this._mesh.UploadVertexBuffer(t,0,this._buffer,!0,28*this._pointseek),this._pointseek=0,null!=this._lastmat&&nt.DrawMesh(t,this._mesh,this._lastmat)}_AddBuf(t){this._bufferView.setFloat32(28*this._pointseek+0,t.x,!0),this._bufferView.setFloat32(28*this._pointseek+4,t.y,!0),this._bufferView.setFloat32(28*this._pointseek+8,t.z,!0),this._bufferView.setFloat32(28*this._pointseek+12,t.u,!0),this._bufferView.setFloat32(28*this._pointseek+16,t.v,!0),this._bufferView.setUint8(28*this._pointseek+20,255*t.r|0),this._bufferView.setUint8(28*this._pointseek+21,255*t.g|0),this._bufferView.setUint8(28*this._pointseek+22,255*t.b|0),this._bufferView.setUint8(28*this._pointseek+23,255*t.a|0),this._bufferView.setUint8(28*this._pointseek+24,t.uvlayer),this._bufferView.setUint8(28*this._pointseek+25,t.e2),this._bufferView.setUint8(28*this._pointseek+26,t.e3),this._bufferView.setUint8(28*this._pointseek+27,t.eff),this._pointseek++}_ApplySingle(t){this._lastmat=t,null!=this._lastmat&&(this._lastmat.UpdateMatModel(this.matrixWorld),this._lastmat.UpdateMatView(this.matrixView),this._lastmat.UpdateMatProj(this._target))}}var ut,ct,pt,ft,_t,mt,gt,vt="#version 300 es\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n    layout(location = 3) in vec4 ext; \n\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void) \n    {\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        vExt = int(ext.w);\n        vLayer =int(ext.x);\n    }\n    ",wt="#version 300 es\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    // layout(std140, column_major) uniform;\n    struct Sprite //结构体的基线是4n的倍数\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        float uvlayer;\n        float empty1;//占位，凑4N\n        float empty2;\n        float eff;\n       \n    };\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n    uniform sampler2D texelem;\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        int ext = int(ext.x);\n        int iuvx = ext%128 *4;\n        int iuvy = ext/128;\n\n        \n        vec4 v0 = texelFetch(texelem,ivec2(iuvx+0,iuvy),0);\n        vec4 v1 = texelFetch(texelem,ivec2(iuvx+1,iuvy),0);\n        vec4 v2 = texelFetch(texelem,ivec2(iuvx+2,iuvy),0);\n        //vec4 v3 =texelFetch(texelem,ivec2(iuvx+3,iuvy),0);\n        \n        Sprite s;\n        s.posLT = v0.xy;\n        s.posRB = v0.zw;\n        s.uvCenter = v1.xy;\n        s.uvHalfSize = v1.zw;\n        s.uvlayer = v2.x;\n        s.eff = v2.w;\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n    \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            //--begin rotate\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n            //--end rorate\n        }\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n       \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.eff);\n        vLayer=int(s.uvlayer);\n    }\n",yt="#version 300 es\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    layout(std140, column_major) uniform;\n    struct Sprite //\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        vec4 ext;\n    };\n\n    uniform SpritesBlock {//\n        //\n        Sprite data[1023];    \n        int endtag; //\n    } sprites;\n    \n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        Sprite s = sprites.data[int(ext.x)];\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n        //--begin rotate\n       \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n        }\n        //--end rorate\n\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n        \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.ext.w);\n        vLayer=int(s.ext.x);\n    }\n",Rt="#version 300 es\n    precision mediump float;//指定浮点型精确度\n    precision highp sampler2DArray;\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    flat in int vExt;\n    flat in int vLayer;\n        \n    layout(location = 0) out vec4 fragColor;\n\n    \n    uniform sampler2DArray texRGBA;  //从外部设置的参数\n    uniform sampler2DArray texGray;\n    void main(void) \n    {\n        vec4 texc = vExt==0? texture(texRGBA,vec3(vUv,vLayer))\n        : texture(texGray,vec3(vUv,vLayer));\n        vec4 outc = vColor;\n        int effect = vExt;//int(vExt.w);\n        if(effect==0)//rgba model \n        {\n            outc = vColor*texc;\n        }\n        else if(effect==1)//gray model\n        {\n            vec4 c = vec4(texc.r,texc.r,texc.r,1);\n            outc = vColor * c;\n        }\n        else if(effect==4)//gray as alpha model\n        {\n            //outc.a *= texc.r;\n            outc = vColor;\n            outc.a *=texc.r; \n            //outc = vColor * 0.5;\n        }\n        fragColor =  outc;\n        \n    }\n    ",bt="#version 300 es\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n \n\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    //flat out vec4 vExt;\n    uniform sampler2D tex2;\n    void main(void) \n    {\n        vec4 t1 = texelFetch(tex2,ivec2(0, 0), 0);\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        //vExt = ext;\n    }\n    ",xt="#version 300 es\n    precision mediump float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    //flat in vec4 vExt;\n\n        \n    layout(location = 0) out vec4 fragColor;\n\n    uniform sampler2D tex;  //从外部设置的参数\n    void main(void) \n    {\n     \n        vec4 texc = texture(tex,vUv);\n        vec4 outc = vColor;\n       \n        outc = vColor * texc;\n       \n        fragColor =  outc;\n    }\n    ",Bt="#version 300 es\nlayout(location = 0) in vec3 position;//顶点提供的数据\nlayout(location = 1) in vec3 normal;//顶点提供的数据\nout vec3 outPos;\nout vec3 outNormal;\nvoid main(void) \n{\n    outPos = position + normal;\n    outNormal = normal;\n}\n",At="#version 300 es\n    precision mediump float;//指定浮点型精确度\n   \n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        fragColor =  vec4(0,0,0,1);\n    }\n    ",St="#version 300 es\n    precision mediump float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n \n    uniform sampler2D texIndex; \n    uniform sampler2D texTile; \n    uniform float   tilesize;\n    uniform vec4     mapinfo;//xy map size, zw=tile texturesize\n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        //抽取TiledIndex\n        vec4 texc = texture(texIndex,vUv);\n        float su =float(int(texc.r*255.0+0.9)); //tileindex x\n        float sv =float(int(texc.g*255.0+0.9)); //tileindex y\n\n        float su2 =float(int(texc.b*255.0+0.9)); //tileindex z\n        float sv2 =float(int(texc.a*255.0+0.9)); //tileindex w\n\n        //计算tileduv\n        float subu = mod(vUv.x * mapinfo.x, 1.0);\n        float subv = mod(vUv.y * mapinfo.y, 1.0);\n        vec2 tilescale =vec2(tilesize,tilesize)/mapinfo.zw;\n        //float tilescaleY =tiledsize/mapinfo.w;\n        vec2 tuv = vec2((su+subu)*tilescale.x,(sv+subv)*tilescale.y);\n        vec2 tuv2 = vec2((su2+subu)*tilescale.x,(sv2+subv)*tilescale.y);\n\n        //合成颜色\n        vec4 ttc = texture(texTile,tuv);\n        vec4 ttc2 = texture(texTile,tuv2);\n \n\n        vec4 outcolor = ttc2.a*ttc2 + (1.0-ttc2.a)*ttc;\n        \n        fragColor = outcolor;\n    }\n    ";class Ct{constructor(t){this.uvlayer=0,this.material=t,this.effect=R.RGBA,this.uv=new T(0,0,1,1);let e=t.uniformTexs.tex;null==e&&(e=t.uniformTexs.texRGBA),null==e&&(e=t.uniformTexs.texGray),null!=e?(this.pixelwidth=e.value.getWidth(),this.pixelheight=e.value.getHeight()):(this.pixelwidth=16,this.pixelheight=16),this.uvlayer=0}RenderRectWithLimit(t,e,i,s=null,r=-1){let n=Ct._rectbuf;for(;n.length<4;)n.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let h=null==s?Ct._colorbuf:s,l=(e.Width,this.pixelwidth,e.Height,this.pixelheight,e.X),a=e.X+e.Width,o=e.Y,d=e.Y+e.Height,u=this.uv.U1,c=this.uv.V1,p=this.uv.U2,f=this.uv.V2,_=a-l,m=d-o;if(l>=i.X+i.Width||a<i.X||o>=i.Y+i.Height||d<i.Y)l=a=o=d=0;else if(0!=_&&0!=m){let t=l,e=a,s=o,r=d,n=!1;if(l<i.X&&(t=i.X,n=!0),a>i.X+i.Width&&(e=i.X+i.Width,n=!0),o<i.Y&&(s=i.Y,n=!0),d>i.Y+i.Height&&(r=i.Y+i.Height,n=!0),n){let i=p-u,n=f-c;u+=i*((t-l)/_),c+=n*((s-o)/m),p+=i*((e-a)/_),f+=n*((r-d)/m),l=t,o=s,a=e,d=r}}n[0].x=l,n[0].y=o,n[0].u=u,n[0].v=c,n[0].r=h.R,n[0].g=h.G,n[0].b=h.B,n[0].a=h.A,n[0].uvlayer=this.uvlayer,n[0].eff=this.effect,n[1].x=a,n[1].y=o,n[1].u=p,n[1].v=c,n[1].r=h.R,n[1].g=h.G,n[1].b=h.B,n[1].a=h.A,n[1].uvlayer=this.uvlayer,n[1].eff=this.effect,n[2].x=l,n[2].y=d,n[2].u=u,n[2].v=f,n[2].r=h.R,n[2].g=h.G,n[2].b=h.B,n[2].a=h.A,n[2].uvlayer=this.uvlayer,n[2].eff=this.effect,n[3].x=a,n[3].y=d,n[3].u=p,n[3].v=f,n[3].r=h.R,n[3].g=h.G,n[3].b=h.B,n[3].a=h.A,n[3].uvlayer=this.uvlayer,n[3].eff=this.effect,t.DrawQuads(this.material,n,1)}RenderRect(t,e,i=null,s=-1){let r=Ct._rectbuf;for(;r.length<4;)r.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let n=null==i?Ct._colorbuf:i;e.Width,this.pixelwidth,e.Height,this.pixelheight,r[0].x=e.X,r[0].y=e.Y,r[0].u=this.uv.U1,r[0].v=this.uv.V1,r[0].r=n.R,r[0].g=n.G,r[0].b=n.B,r[0].a=n.A,r[0].uvlayer=this.uvlayer,r[0].eff=this.effect,r[1].x=e.X+e.Width,r[1].y=e.Y,r[1].u=this.uv.U2,r[1].v=this.uv.V1,r[1].r=n.R,r[1].g=n.G,r[1].b=n.B,r[1].a=n.A,r[1].uvlayer=this.uvlayer,r[1].eff=this.effect,r[2].x=e.X,r[2].y=e.Y+e.Height,r[2].u=this.uv.U1,r[2].v=this.uv.V2,r[2].r=n.R,r[2].g=n.G,r[2].b=n.B,r[2].a=n.A,r[2].uvlayer=this.uvlayer,r[2].eff=this.effect,r[3].x=e.X+e.Width,r[3].y=e.Y+e.Height,r[3].u=this.uv.U2,r[3].v=this.uv.V2,r[3].r=n.R,r[3].g=n.G,r[3].b=n.B,r[3].a=n.A,r[3].uvlayer=this.uvlayer,r[3].eff=this.effect,t.DrawQuads(this.material,r,1)}RenderRect2(t,e,i,s,r,n=null,h=-1){let l=Ct._rectbuf;for(;l.length<4;)l.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let a=null==n?Ct._colorbuf:n;this.pixelwidth,this.pixelheight,l[0].x=e,l[0].y=i,l[0].u=this.uv.U1,l[0].v=this.uv.V1,l[0].r=a.R,l[0].g=a.G,l[0].b=a.B,l[0].a=a.A,l[0].uvlayer=this.uvlayer,l[0].eff=this.effect,l[1].x=s,l[1].y=i,l[1].u=this.uv.U2,l[1].v=this.uv.V1,l[1].r=a.R,l[1].g=a.G,l[1].b=a.B,l[1].a=a.A,l[1].uvlayer=this.uvlayer,l[1].eff=this.effect,l[2].x=e,l[2].y=r,l[2].u=this.uv.U1,l[2].v=this.uv.V2,l[2].r=a.R,l[2].g=a.G,l[2].b=a.B,l[2].a=a.A,l[2].uvlayer=this.uvlayer,l[2].eff=this.effect,l[3].x=s,l[3].y=r,l[3].u=this.uv.U2,l[3].v=this.uv.V2,l[3].r=a.R,l[3].g=a.G,l[3].b=a.B,l[3].a=a.A,l[3].uvlayer=this.uvlayer,l[3].eff=this.effect,t.DrawQuads(this.material,l,1)}Render(t,e,i,s=null,r=-1){let n=Ct._rectbuf;for(;n.length<4;)n.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let h=null==s?Ct._colorbuf:s;n[0].x=e.X,n[0].y=e.Y,n[0].u=this.uv.U1,n[0].v=this.uv.V1,n[0].r=h.R,n[0].g=h.G,n[0].b=h.B,n[0].a=h.A,n[0].uvlayer=this.uvlayer,n[0].eff=this.effect,n[1].x=e.X+i.X*this.pixelwidth,n[1].y=e.Y,n[1].u=this.uv.U2,n[1].v=this.uv.V1,n[1].r=h.R,n[1].g=h.G,n[1].b=h.B,n[1].a=h.A,n[1].uvlayer=this.uvlayer,n[1].eff=this.effect,n[2].x=e.X,n[2].y=e.Y+i.Y*this.pixelheight,n[2].u=this.uv.U1,n[2].v=this.uv.V2,n[2].r=h.R,n[2].g=h.G,n[2].b=h.B,n[2].a=h.A,n[2].uvlayer=this.uvlayer,n[2].eff=this.effect,n[3].x=e.X+i.X*this.pixelwidth,n[3].y=e.Y+i.Y*this.pixelheight,n[3].u=this.uv.U2,n[3].v=this.uv.V2,n[3].r=h.R,n[3].g=h.G,n[3].b=h.B,n[3].a=h.A,n[3].uvlayer=this.uvlayer,n[3].eff=this.effect,t.DrawQuads(this.material,n,1)}RenderWithRotate(t,e,i,s,r,n,h=null,l=-1){let a=Ct._rectbuf;for(;a.length<4;)a.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let o=null==h?Ct._colorbuf:h,d=e.X,u=e.X+i.X*this.pixelwidth,c=e.Y,p=e.Y+i.Y*this.pixelheight,f=e.X+r*i.X,_=e.Y+n*i.Y,m=d-f,g=c-_,v=u-f,w=p-_,y=Math.sin(s),R=Math.cos(s),b=f+m*R-g*y,x=_+m*y+g*R,A=f+v*R-g*y,S=_+v*y+g*R,C=f+m*R-w*y,E=_+m*y+w*R,G=f+v*R-w*y,T=_+v*y+w*R;a[0].x=b,a[0].y=x,a[0].u=this.uv.U1,a[0].v=this.uv.V1,a[0].r=o.R,a[0].g=o.G,a[0].b=o.B,a[0].a=o.A,a[0].uvlayer=this.uvlayer,a[0].eff=this.effect,a[1].x=A,a[1].y=S,a[1].u=this.uv.U2,a[1].v=this.uv.V1,a[1].r=o.R,a[1].g=o.G,a[1].b=o.B,a[1].a=o.A,a[1].uvlayer=this.uvlayer,a[1].eff=this.effect,a[2].x=C,a[2].y=E,a[2].u=this.uv.U1,a[2].v=this.uv.V2,a[2].r=o.R,a[2].g=o.G,a[2].b=o.B,a[2].a=o.A,a[2].uvlayer=this.uvlayer,a[2].eff=this.effect,a[3].x=G,a[3].y=T,a[3].u=this.uv.U2,a[3].v=this.uv.V2,a[3].r=o.R,a[3].g=o.G,a[3].b=o.B,a[3].a=o.A,a[3].uvlayer=this.uvlayer,a[3].eff=this.effect,t.DrawQuads(this.material,a,1)}}Ct._rectbuf=[];class Et{constructor(t,e,i,s){this.fonttex=s,this.fontsize=i,this.fontname=e}GetFont(){return this.fontname}GetFontSize(){return this.fontsize}GetCharSprite(t){let e=this._CacheCharSprite(t);return null!=e&&this.fonttex.ApplyTextureData(),e}_CacheCharSprite(t){let e=String.fromCharCode(t),i=this.fonttex.GetElementByName(e);if(null!=i)return this.fonttex.ConvertElemToSprite(i);try{let t=at.LoadTextPixel(e,this.fontname,this.fontsize,this.fontsize+2,this.fontsize+2,0,0);if(0==t.height||0==t.width)return null;let s=new j;s.format=p.RGBA32,s.toR=w.Alpha,s.data=t.data,s.width=t.width,s.height=t.height;let r=s.ConvertToR();return r.toR=w.Alpha,i=this.fonttex.AddSprite(r,R.GrayAsAlpha,e),this.fonttex.ConvertElemToSprite(i)}catch(i){return console.error("cache char error:"+i),null}}SureText(t){let e=0;for(var i=0;i<t.length;i++){let s=this._CacheCharSprite(t.charCodeAt(i));e+=null!=s?s.pixelwidth:this.fontsize/2}return this.fonttex.ApplyTextureData(),e}RenderText(t,e,i,s,r){let n=0;for(var h=0;h<e.length;h++){let l=this.GetCharSprite(e.charCodeAt(h));null!=l?(l.Render(t,new A(i.X+n,i.Y),s,r),n+=l.pixelwidth*s.X):n+=this.fontsize/2*s.X}}RenderTextWithLimit(t,e,i,s,r,n){let h=0;for(var l=0;l<e.length;l++){let a=this.GetCharSprite(e.charCodeAt(l));if(null!=a){let e=new C(i.X+h,i.Y,a.pixelwidth*s.X,a.pixelheight*s.Y);a.RenderRectWithLimit(t,e,n,r),h+=a.pixelwidth*s.X}else h+=this.fontsize/2*s.X}}}!function(t){t[t.None=0]="None",t[t.LeftToRight=1]="LeftToRight",t[t.UpToDown=2]="UpToDown",t[t.Both=3]="Both"}(ut||(ut={})),function(t){t[t.LeftToRight=0]="LeftToRight",t[t.UpToDown=1]="UpToDown",t[t.RightToLeft=2]="RightToLeft",t[t.DownToUp=3]="DownToUp"}(ct||(ct={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(pt||(pt={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(ft||(ft={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom"}(_t||(_t={}));class Gt{Clone(){let t=new Gt;return t.radioX1=this.radioX1,t.radioX2=this.radioX2,t.radioY1=this.radioY1,t.radioY2=this.radioY2,t.offsetX1=this.offsetX1,t.offsetX2=this.offsetX2,t.offsetY1=this.offsetY1,t.offsetY2=this.offsetY2,t}getFinalRect(t){let e=t.X,i=t.X+t.Width,s=t.Y,r=t.Y+t.Height,n=e+this.radioX1*(i-e)+this.offsetX1,h=s+this.radioY1*(r-s)+this.offsetY1,l=e+this.radioX2*(i-e)+this.offsetX2,a=s+this.radioY2*(r-s)+this.offsetY2;return new C(n,h,l-n,a-h)}getFinalRectScale(t,e){let i=t.X,s=t.X+t.Width,r=t.Y,n=t.Y+t.Height,h=(i+this.radioX1*(s-i)+this.offsetX1)*e,l=(r+this.radioY1*(n-r)+this.offsetY1)*e,a=(i+this.radioX2*(s-i)+this.offsetX2)*e,o=(r+this.radioY2*(n-r)+this.offsetY2)*e;return new C(h,l,a-h,o-l)}setAsFill(){this.radioX1=0,this.radioY1=0,this.radioX2=1,this.radioY2=1,this.offsetX1=0,this.offsetX2=0,this.offsetY1=0,this.offsetY2=0}setByRect(t){this.radioX1=0,this.radioY1=0,this.radioX2=0,this.radioY2=0,this.offsetX1=t.X,this.offsetX2=t.X+t.Width,this.offsetY1=t.Y,this.offsetY2=t.Y+t.Height}setHPosByLeftBorder(t,e=0){this.radioX1=0,this.radioX2=0,this.offsetX1=e,this.offsetX2=e+t}setHPosByCenter(t){this.radioX1=.5,this.radioX2=.5,this.offsetX1=-.5*t,this.offsetX2=.5*t}setHPosByRightBorder(t,e=0){this.radioX1=1,this.radioX2=1,this.offsetX1=-e-t,this.offsetX2=-e}setHPosFill(t=0,e=0){this.radioX1=0,this.radioX2=1,this.offsetX1=t,this.offsetX2=-e}setVPosByTopBorder(t,e=0){this.radioY1=0,this.radioY2=0,this.offsetY1=e,this.offsetY2=e+t}setVPosByCenter(t){this.radioY1=.5,this.radioY2=.5,this.offsetY1=-.5*t,this.offsetY2=.5*t}setVPosByBottomBorder(t,e=0){this.radioY1=1,this.radioY2=1,this.offsetY1=-e-t,this.offsetY2=-e}setVPosFill(t=0,e=0){this.radioY1=0,this.radioY2=1,this.offsetY1=t,this.offsetY2=-e}}!function(t){t[t.Element_Canvas=0]="Element_Canvas",t[t.Element_Container=1]="Element_Container",t[t.Element_RenderContainer=2]="Element_RenderContainer",t[t.Element_Image=3]="Element_Image",t[t.Element_Image_Scale9=4]="Element_Image_Scale9",t[t.Element_Label=5]="Element_Label",t[t.Element_Button=6]="Element_Button",t[t.Element_Joystick=7]="Element_Joystick",t[t.Element_TextBox_Prompt=8]="Element_TextBox_Prompt",t[t.Element_DragButton=9]="Element_DragButton",t[t.Element_Overlay=10]="Element_Overlay",t[t.Element_Toggle=11]="Element_Toggle",t[t.Element_Bar=12]="Element_Bar",t[t.Element_ScrollBar=13]="Element_ScrollBar",t[t.Element_Panel=14]="Element_Panel",t[t.Element_Panel_Scroll=15]="Element_Panel_Scroll",t[t.Element_Panel_Split=16]="Element_Panel_Split",t[t.Element_Panel_Scroll_Unlimit=17]="Element_Panel_Scroll_Unlimit"}(mt||(mt={}));class Tt{constructor(){this.Tag=null,this.localRect=new Gt,this._parent=null,this.Enable=!0,this.alpha=1}getParent(){return this._parent}CancelTouch(){if(null!=this._children)for(var t=this._children.length-1;t>=0;t--){let e=this._children[t];e.Enable&&e.CancelTouch()}}OnTouch(t,e,i,s,r){if(null!=this._children)for(var n=this._children.length-1;n>=0;n--){let h=this._children[n];if(h.Enable&&h.OnTouch(t,e,i,s,r))return!0}return!1}OnRender(t){if(null!=this._children)for(var e=0;e<this._children.length;e++){let i=this._children[e];i.Enable&&i.OnRender(t)}}OnUpdate(t){if(null!=this._children)for(var e=0;e<this._children.length;e++){let i=this._children[e];i.Enable&&i.OnUpdate(t)}}getChildCount(){return null==this._children?0:this._children.length}getChild(t){return null==this._children||t>=this._children.length?null:this._children[t]}addChild(t){if(null==this._children&&(this._children=[]),this._children.indexOf(t)>=0)return;let e=t._parent;null!=e&&e.removeChild(e),this._children.push(t),t._parent=this}removeChild(t){if(null==this._children)return;let e=this._children.indexOf(t);e<0||(this._children.splice(e,1),t._parent=null)}removeChildAt(t){null!=this._children&&this._children.splice(t,1)}removeChildAll(){if(null!=this._children){for(var t=0;t<this._children.length;t++)this._children[t]._parent=null;this._children.splice(0,this._children.length)}}removeChildBegin(t){if(null!=this._children){for(var e=t;e<this._children.length;e++)this._children[e]._parent=null;this._children.splice(t)}}getWorldRect(){if(null==this._parent){let t=this.localRect.offsetX1,e=this.localRect.offsetY1,i=this.localRect.offsetX2,s=this.localRect.offsetY2;return new C(t,e,i-t,s-e)}{let t=this._parent.getWorldRect();return this.localRect.getFinalRect(t)}}getWorldRectScale(t){if(null==this._parent){let e=this.localRect.offsetX1*t,i=this.localRect.offsetY1*t,s=this.localRect.offsetX2*t,r=this.localRect.offsetY2*t;return new C(e,i,s-e,r-i)}{let e=this._parent.getWorldRect();return this.localRect.getFinalRectScale(e,t)}}}function It(t){return null==t?t:t.Clone()}class Lt{constructor(t,e,i,s=0,r=0){this.sprite=e.ConvertElemToSprite(t),this.l=i.XLeft,this.r=i.XRight,this.t=i.YTop,this.b=i.YBottom;let n=(this.sprite.uv.U2-this.sprite.uv.U1)/this.sprite.pixelwidth,h=(this.sprite.uv.V2-this.sprite.uv.V1)/this.sprite.pixelheight,l=this.sprite.uv;if(this.u0=l.U1,this.u3=l.U2,this.u1=this.u0+i.XLeft*n,this.u2=this.u3-i.XRight*n,!(this.u0<=this.u1&&this.u1<this.u2&&this.u2<=this.u3))throw new Error("U尺寸不对，无法形成九宫");if(this.v0=l.V1,this.v3=l.V2,this.v1=this.v0+i.YTop*h,this.v2=this.v3-i.YBottom*h,!(this.v0<=this.v1&&this.v1<this.v2&&this.v2<=this.v3))throw new Error("U尺寸不对，无法形成九宫");0==s&&(s=this.u3-this.u0),0==r&&(r=this.v3-this.v0),this._minwidth=s,this._minheight=r}getElementType(){return mt.Element_Image_Scale9}getMinWidth(){return this._minwidth}getMinHeight(){return this._minheight}_Render1RectWithLimit(t,e,i,s,r,n,h,l,a=-1){let o=Ct._rectbuf;for(;o.length<4;)o.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let d=null==l?Ct._colorbuf:l,u=n.X,c=n.X+n.Width,p=n.Y,f=n.Y+n.Height,_=c-u,m=f-p;if(u>=h.X+h.Width||c<h.X||p>=h.Y+h.Height||f<h.Y)u=c=p=f=0;else if(0!=_&&0!=m){let r=u,n=c,l=p,a=f,o=!1;if(u<h.X&&(r=h.X,o=!0),c>h.X+h.Width&&(n=h.X+h.Width,o=!0),p<h.Y&&(l=h.Y,o=!0),f>h.Y+h.Height&&(a=h.Y+h.Height,o=!0),o){let h=e-t,o=s-i;t+=h*((r-u)/_),i+=o*((l-p)/m),e+=h*((n-c)/_),s+=o*((a-f)/m),u=r,p=l,c=n,f=a}}o[0].x=u,o[0].y=p,o[0].u=t,o[0].v=i,o[0].r=d.R,o[0].g=d.G,o[0].b=d.B,o[0].a=d.A,o[0].uvlayer=this.sprite.uvlayer,o[0].eff=this.sprite.effect,o[1].x=c,o[1].y=p,o[1].u=e,o[1].v=i,o[1].r=d.R,o[1].g=d.G,o[1].b=d.B,o[1].a=d.A,o[1].uvlayer=this.sprite.uvlayer,o[1].eff=this.sprite.effect,o[2].x=u,o[2].y=f,o[2].u=t,o[2].v=s,o[2].r=d.R,o[2].g=d.G,o[2].b=d.B,o[2].a=d.A,o[2].uvlayer=this.sprite.uvlayer,o[2].eff=this.sprite.effect,o[3].x=c,o[3].y=f,o[3].u=e,o[3].v=s,o[3].r=d.R,o[3].g=d.G,o[3].b=d.B,o[3].a=d.A,o[3].uvlayer=this.sprite.uvlayer,o[3].eff=this.sprite.effect,r.DrawQuads(this.sprite.material,o,1)}_Render1Rect(t,e,i,s,r,n,h,l=-1){if(t==e||i==s)return;let a=Ct._rectbuf;for(;a.length<4;)a.push(new ot);null==Ct._colorbuf&&(Ct._colorbuf=B.White);let o=null==h?Ct._colorbuf:h;a[0].x=n.X,a[0].y=n.Y,a[0].u=t,a[0].v=i,a[0].r=o.R,a[0].g=o.G,a[0].b=o.B,a[0].a=o.A,a[0].uvlayer=this.sprite.uvlayer,a[0].eff=this.sprite.effect,a[1].x=n.X+n.Width,a[1].y=n.Y,a[1].u=e,a[1].v=i,a[1].r=o.R,a[1].g=o.G,a[1].b=o.B,a[1].a=o.A,a[1].uvlayer=this.sprite.uvlayer,a[1].eff=this.sprite.effect,a[2].x=n.X,a[2].y=n.Y+n.Height,a[2].u=t,a[2].v=s,a[2].r=o.R,a[2].g=o.G,a[2].b=o.B,a[2].a=o.A,a[2].uvlayer=this.sprite.uvlayer,a[2].eff=this.sprite.effect,a[3].x=n.X+n.Width,a[3].y=n.Y+n.Height,a[3].u=e,a[3].v=s,a[3].r=o.R,a[3].g=o.G,a[3].b=o.B,a[3].a=o.A,a[3].uvlayer=this.sprite.uvlayer,a[3].eff=this.sprite.effect,r.DrawQuads(this.sprite.material,a,1)}RenderRect(t,e,i=null,s=-1,r){let n=this.l*r,h=this.r*r,l=this.t*r,a=this.b*r,o=new C(0,0,1,1);o.Y=e.Y,o.Height=l,o.X=e.X,o.Width=n,this._Render1Rect(this.u0,this.u1,this.v0,this.v1,t,o,i,s),o.X=e.X+n,o.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v0,this.v1,t,o,i,s),o.X=e.X+e.Width-h,o.Width=h,this._Render1Rect(this.u2,this.u3,this.v0,this.v1,t,o,i,s),o.Y=e.Y+l,o.Height=e.Height-l-a,o.X=e.X,o.Width=n,this._Render1Rect(this.u0,this.u1,this.v1,this.v2,t,o,i,s),o.X=e.X+n,o.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v1,this.v2,t,o,i,s),o.X=e.X+e.Width-h,o.Width=h,this._Render1Rect(this.u2,this.u3,this.v1,this.v2,t,o,i,s),o.Y=e.Y+e.Height-a,o.Height=a,o.X=e.X,o.Width=n,this._Render1Rect(this.u0,this.u1,this.v2,this.v3,t,o,i,s),o.X=e.X+n,o.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v2,this.v3,t,o,i,s),o.X=e.X+e.Width-h,o.Width=h,this._Render1Rect(this.u2,this.u3,this.v2,this.v3,t,o,i,s)}RenderRectWithLimit(t,e,i,s=null,r=-1,n){let h=this.l*n,l=this.r*n,a=this.t*n,o=this.b*n,d=new C(0,0,1,1);d.Y=e.Y,d.Height=a,d.X=e.X,d.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v0,this.v1,t,d,i,s,r),d.X=e.X+h,d.Width=e.Width-h-a,this._Render1RectWithLimit(this.u1,this.u2,this.v0,this.v1,t,d,i,s,r),d.X=e.X+e.Width-l,d.Width=l,this._Render1RectWithLimit(this.u2,this.u3,this.v0,this.v1,t,d,i,s,r),d.Y=e.Y+a,d.Height=e.Height-a-o,d.X=e.X,d.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v1,this.v2,t,d,i,s,r),d.X=e.X+h,d.Width=e.Width-h-a,this._Render1RectWithLimit(this.u1,this.u2,this.v1,this.v2,t,d,i,s,r),d.X=e.X+e.Width-l,d.Width=l,this._Render1RectWithLimit(this.u2,this.u3,this.v1,this.v2,t,d,i,s,r),d.Y=e.Y+e.Height-o,d.Height=o,d.X=e.X,d.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v2,this.v3,t,d,i,s,r),d.X=e.X+h,d.Width=e.Width-h-a,this._Render1RectWithLimit(this.u1,this.u2,this.v2,this.v3,t,d,i,s,r),d.X=e.X+e.Width-l,d.Width=l,this._Render1RectWithLimit(this.u2,this.u3,this.v2,this.v3,t,d,i,s,r)}}class Ut extends Tt{constructor(e){super(),this.scale=1,this.target=e,this.batcherUI=new dt(t.graphic.GetWebGL()),this.FIllTarget()}FIllTarget(){if(null==this.target)return;this.batcherUI.LookAt.X=this.target.getWidth()/2,this.batcherUI.LookAt.Y=this.target.getHeight()/2;let t=this.target.getWidth()/this.scale,e=this.target.getHeight()/this.scale;this.localRect.setByRect(new C(0,0,t,e))}Clone(){throw new Error("can not clone canvas.")}getElementType(){return mt.Element_Canvas}OnUpdate(t){if(this.Enable){if(null!=this.target){this.batcherUI.LookAt.X=this.target.getWidth()/2,this.batcherUI.LookAt.Y=this.target.getHeight()/2;let t=this.target.getWidth()/this.scale,e=this.target.getHeight()/this.scale;this.localRect.setByRect(new C(0,0,t,e))}super.OnUpdate(t)}}OnRender(t){this.Enable&&(this.batcherUI.BeginDraw(this.target),super.OnRender(this),this.batcherUI.EndDraw())}OnTouch(e,i,s,r,n){let h=t.graphic.getFinalScale()/this.scale,l=r*h,a=n*h;return super.OnTouch(e,i,s,l,a)}}class Ft extends Tt{getElementType(){return mt.Element_Container}Clone(){let t=new Ft;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t}}class Ot extends Tt{constructor(t=null){super(),this.color=B.White,this.sprite=t,null!=this.sprite?this.localRect.setByRect(new C(0,0,this.sprite.pixelwidth,this.sprite.pixelheight)):this.localRect.setByRect(new C(0,0,100,100))}Clone(){let t=new Ot;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.sprite=this.sprite,t.color=this.color.Clone(),t}getElementType(){return mt.Element_Image}OnRender(t){this.color.A=this.alpha,null!=this.sprite&&this.sprite.RenderRect(t.batcherUI,this.getWorldRectScale(t.scale),this.color,-1),super.OnRender(t)}}class Dt extends Tt{constructor(t=null){super(),this.color=B.White,this.scale9=t,null!=t?this.localRect.setByRect(new C(0,0,t.getMinWidth(),t.getMinHeight())):this.localRect.setByRect(new C(0,0,128,128))}getElementType(){return mt.Element_Image_Scale9}Clone(){let t=new Dt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.scale9=this.scale9,t.color=this.color.Clone(),t}OnRender(t){null!=this.scale9&&this.scale9.RenderRect(t.batcherUI,this.getWorldRectScale(t.scale),this.color,-1,t.scale),super.OnRender(t)}}class Vt extends Tt{constructor(t=null,e=""){super(),this.color=B.White,this.withShadow=!0,this.colorShadow=new B(0,0,0,.5),this.fontScale=new A(1,1),this.cut=!1,this.halign=ft.Middle,this.valign=_t.Middle,this._pos=new A(0,0),this.font=t,this.text=e,this.localRect.setByRect(new C(0,0,100,100))}getElementType(){return mt.Element_Label}Clone(){let t=new Vt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.font=this.font,t.text=this.text,t.color=this.color.Clone(),t.fontScale=this.fontScale.Clone(),t.cut=this.cut,t.halign=this.halign,t.valign=this.valign,t}OnRender(t){if(this.color.A=this.alpha,null!=this.font){let e=this.getWorldRectScale(t.scale),i=this.font.GetFontSize()*this.fontScale.Y*t.scale,s=this.font.SureText(this.text)*this.fontScale.X*t.scale;this.halign==ft.Left?this._pos.X=e.X:this.halign==ft.Middle?this._pos.X=e.X+(e.Width-s)/2:this.halign==ft.Right&&(this._pos.X=e.X+(e.Width-s)),this.valign==_t.Top?this._pos.Y=e.Y:this.valign==_t.Middle?this._pos.Y=e.Y+(e.Height-i)/2:this.valign==_t.Bottom&&(this._pos.Y=e.Y+(e.Height-i));let r=new A(this.fontScale.X*t.scale,this.fontScale.Y*t.scale);this.cut?(this.withShadow&&this.font.RenderTextWithLimit(t.batcherUI,this.text,new A(this._pos.X+1/this.fontScale.X,this._pos.Y+1/this.fontScale.Y),r,this.colorShadow,e),this.font.RenderTextWithLimit(t.batcherUI,this.text,this._pos,r,this.color,e)):(this.withShadow&&this.font.RenderText(t.batcherUI,this.text,new A(this._pos.X+1/this.fontScale.X,this._pos.Y+1/this.fontScale.Y),r,this.colorShadow),this.font.RenderText(t.batcherUI,this.text,this._pos,r,this.color))}super.OnRender(t)}}class Xt extends Tt{constructor(){super(),this.ElemNormal=null,this.ElemPress=null,this.BindKey=null,this._press=!1,this._keypress=!1,this._pressid=-1,this.OnClick=null,this.OnPressDown=null,this.OnPressUp=null,this.localRect.setByRect(new C(0,0,100,100))}Clone(){let t=new Xt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.ElemNormal=It(this.ElemNormal),t.ElemPress=It(this.ElemPress),t}getElementType(){return mt.Element_Button}CancelTouch(){this._press=!1,this._pressid=-1,super.CancelTouch()}OnTouch(t,e,i,s,r){if(super.OnTouch(t,e,i,s,r))return!0;let n=this.getWorldRect(),h=n.X+n.Width,l=n.Y+n.Height;return 0==this._press&&1==e&&0==i&&s>=n.X&&s<h&&r>=n.Y&&r<l?(this._press=!0,this._pressid=t,null!=this.OnPressDown&&this.OnPressDown(),!0):1==this._press&&1==e&&this._pressid==t||1==this._press&&0==e&&this._pressid==t&&(this._press=!1,this._pressid=-1,null!=this.OnPressUp&&this.OnPressUp(),s>=n.X&&s<h&&r>=n.Y&&r<l)&&(null!=this.OnClick&&this.OnClick(),!0)}OnRender(t){this._press?null!=this.ElemPress&&(this.ElemPress._parent=this,this.ElemPress.alpha=this.alpha,this.ElemPress.OnRender(t)):null!=this.ElemNormal&&(this.ElemNormal._parent=this,this.ElemNormal.alpha=this.alpha,this.ElemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(e){if(null!=this.BindKey){let e=t.input.IsKeyDown(this.BindKey);this._keypress&&!e?(this._keypress=!1,this._press=!1,null!=this.OnPressDown&&this.OnPressUp()):0==this._keypress&&e&&(this._keypress=!0,this._press=!0,null!=this.OnPressDown&&this.OnPressDown())}this._press?null!=this.ElemPress&&this.ElemPress.OnUpdate(e):null!=this.ElemNormal&&this.ElemNormal.OnUpdate(e),super.OnUpdate(e)}}class Pt extends Tt{constructor(){super(),this.ElemNormal=null,this.ElemPress=null,this.press=!1,this.pressid=-1,this.OnDragStart=null,this.OnDrag=null,this.OnDragEnd=null,this.localRect.setByRect(new C(0,0,100,100))}getElementType(){return mt.Element_DragButton}Clone(){let t=new Pt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.ElemNormal=It(this.ElemNormal),t.ElemPress=It(this.ElemPress),t}OnTouch(t,e,i,s,r){if(super.OnTouch(t,e,i,s,r))return!0;let n=this.getWorldRect(),h=n.X,l=n.Y,a=n.X+n.Width,o=n.Y+n.Height;return 0==this.press&&1==e&&0==i&&s>=h&&s<a&&r>=l&&r<o?(this.press=!0,this.pressid=t,this.dragX=s,this.dragY=r,this.dragOX=this.localRect.offsetX1,this.dragOY=this.localRect.offsetY1,null!=this.OnDragStart&&this.OnDragStart(s,r),!0):1==this.press&&1==e&&this.pressid==t?(null!=this.OnDrag&&this.OnDrag(s,r,this.dragX,this.dragY),!0):1==this.press&&0==e&&this.pressid==t&&(this.press=!1,this.pressid=-1,null!=this.OnDragEnd&&this.OnDragEnd(s,r),!0)}OnRender(t){this.press?null!=this.ElemPress&&(this.ElemPress._parent=this,this.ElemPress.OnRender(t)):null!=this.ElemNormal&&(this.ElemNormal._parent=this,this.ElemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(t){this.press?null!=this.ElemPress&&this.ElemPress.OnUpdate(t):null!=this.ElemNormal&&this.ElemNormal.OnUpdate(t)}}!function(t){t[t.DoNotScroll=0]="DoNotScroll",t[t.ScrollByTouchDrag=1]="ScrollByTouchDrag",t[t.ScrollByTouchDrag_LoopValue=2]="ScrollByTouchDrag_LoopValue"}(gt||(gt={}));class Yt extends Tt{constructor(){super(),this.localRect.setByRect(new C(0,0,250,250)),this.container=new Ft,this.container._parent=this,this.container.localRect.setAsFill(),this._border=new G(2,2,2,2)}getElementType(){return mt.Element_Panel}Clone(){let t=new Yt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.backElement=It(this.backElement),t.borderElement=It(this.borderElement),t}getBorder(){return this._border}OnRender(t){null!=this.backElement&&this.backElement.OnRender(t);let e=t.batcherUI,i=this.getWorldRectScale(t.scale);i.X+=this._border.XLeft,i.Y+=this._border.YTop,i.Width-=this._border.XLeft+this._border.XRight,i.Height-=this._border.YTop+this._border.YBottom;let s=e.getTarget();e.EndDraw(),s.PushLimitRect(i),e.BeginDraw(s),this.container.OnRender(t),e.EndDraw(),s.PopLimitRect(),e.BeginDraw(s),null!=this.borderElement&&this.borderElement.OnRender(t)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=1,this.container.localRect.radioY2=1,this.container.localRect.offsetX1=this._border.XLeft,this.container.localRect.offsetX2=-this._border.XRight,this.container.localRect.offsetY1=this._border.YTop,this.container.localRect.offsetY2=-this._border.YBottom}OnUpdate(t){null!=this.backElement&&(this.backElement._parent=this,this.backElement.localRect.setAsFill(),this.backElement.OnUpdate(t)),this.updateContainerPos(),this.container.OnUpdate(t),null!=this.borderElement&&(this.borderElement._parent=this,this.borderElement.localRect.setAsFill(),this.borderElement.OnUpdate(t)),super.OnUpdate(t)}OnTouch(t,e,i,s,r){if(1==e&&0==i){let t=this.getWorldRect(),e=t.X+this._border.XLeft,i=t.Y+this._border.YTop,n=t.X+t.Width-this._border.XRight,h=t.Y+t.Height-this._border.YBottom;if(!(s>=e&&s<=n&&r>=i&&r<=h))return!1}return this.container.OnTouch(t,e,i,s,r)}getChildCount(){return this.container.getChildCount()}getChild(t){return this.container.getChild(t)}addChild(t){this.container.addChild(t)}removeChild(t){this.container.removeChild(t)}removeChildAll(){this.container.removeChildAll()}removeChildBegin(t){this.container.removeChildBegin(t)}removeChildAt(t){this.container.removeChildAt(t)}}class kt extends Yt{constructor(){super(),this.dragDist=32,this.dragDirection=ut.UpToDown,this._press=!1,this._pressid=0,this._drag=!1,this._dragy=0,this._dragx=0,this.dragout=!0,this.panelOffsetX=this.panelOffsetWantX=0,this.panelOffsetY=this.panelOffsetWantY=0,this.panelWidth=250,this.panelHeight=250}getElementType(){return mt.Element_Panel_Scroll}Clone(){let t=new kt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.backElement=It(this.backElement),t.borderElement=It(this.borderElement),t.panelOffsetX=this.panelOffsetX,t.panelOffsetY=this.panelOffsetY,t.panelWidth=this.panelWidth,t.panelHeight=this.panelHeight,t.dragDist=this.dragDist,t.dragDirection=this.dragDirection,t}Scroll(t,e){this.panelOffsetWantX+=t,this.panelOffsetWantX+=e;let i=this.getWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,r=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-r)&&(this.panelOffsetWantY=-(this.panelHeight-r)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=0,this.container.localRect.radioY2=0,this.container.localRect.offsetX1=this.panelOffsetX,this.container.localRect.offsetY1=this.panelOffsetY,this.container.localRect.offsetX2=this.panelOffsetX+this.panelWidth,this.container.localRect.offsetY2=this.panelOffsetY+this.panelHeight}CancelTouch(){this._press=!1,this._pressid=-1,super.CancelTouch()}OnTouch(e,i,s,r,n){if(this.dragDirection==ut.None)return super.OnTouch(e,i,s,r,n);if(0==this._press&&1==i&&0==s){let t=this.getWorldRect(),i=t.X+this._border.XLeft,s=t.Y+this._border.YTop,h=t.X+t.Width-this._border.XRight,l=t.Y+t.Height-this._border.YBottom;r>=i&&r<=h&&n>=s&&n<=l&&(this._press=!0,this._pressid=e,this._pressx=r,this._pressy=n)}return this._pressid==e&&1==this._press&&1==i&&1==s&&(this._drag?this._dragPanel(r,n):this._calcDragDist(r,n)>this.dragDist*t.graphic.getDevicePixelRadio()&&(this._drag=!0,this._dragx=this.panelOffsetX,this._dragy=this.panelOffsetY,this._pressy=n,this._pressx=r)),this._pressid==e&&1==this._press&&0==i&&(this._press=!1,this._pressid=0,this._drag=!1),this._drag?(this.container.CancelTouch(),!0):super.OnTouch(e,i,s,r,n)}_calcDragDist(t,e){if(this.dragDirection==ut.None)return 0;if(this.dragDirection==ut.LeftToRight)return Math.abs(t-this._pressx);if(this.dragDirection==ut.UpToDown)return Math.abs(e-this._pressy);let i=t-this._pressx,s=e-this._pressy;return Math.sqrt(i*i+s*s)}_dragPanel(t,e){if(this.dragDirection==ut.None)return;this.dragDirection!=ut.UpToDown&&this.dragDirection!=ut.Both||(this.panelOffsetY=this._dragy+(e-this._pressy)),this.dragDirection!=ut.LeftToRight&&this.dragDirection!=ut.Both||(this.panelOffsetX=this._dragx+(t-this._pressx));let i=this.getWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,r=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX=this.panelOffsetX,this.panelOffsetWantY=this.panelOffsetY,this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-r)&&(this.panelOffsetWantY=-(this.panelHeight-r)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0),0==this.dragout&&(this.panelOffsetX=this.panelOffsetWantX,this.panelOffsetY=this.panelOffsetWantY)}OnUpdate(t){0==this._drag&&(this.panelOffsetX=this.panelOffsetX+.5*(this.panelOffsetWantX-this.panelOffsetX),this.panelOffsetY=this.panelOffsetY+.5*(this.panelOffsetWantY-this.panelOffsetY)),super.OnUpdate(t)}}class Mt extends Tt{constructor(){super(),this.splitSize=16,this.splitPos=.5,this.splitDir=pt.Horizontal,this.localRect.setByRect(new C(0,0,250,250)),this._panel1=new Ft,this._panel1._parent=this,this._panel1.localRect.setAsFill(),this._panel2=new Ft,this._panel2._parent=this,this._panel2.localRect.setAsFill(),this._border=new G(16,16,16,16),this._splitButton=new Pt,this._splitButton._parent=this,this._splitButton.localRect.setAsFill(),this._splitButton.OnDragStart=this._ondragstart.bind(this),this._splitButton.OnDrag=this._ondrag.bind(this),this.updateContainerPos(),this.updateSplitBtnPos()}_ondragstart(t,e){this._dragvalue=this.splitPos}_ondrag(t,e,i,s){if(this.splitDir==pt.Horizontal){let e=(t-i)/this.getWorldRect().Width;this.splitPos=this._dragvalue+e}else{let t=(e-s)/this.getWorldRect().Height;this.splitPos=this._dragvalue+t}this.splitPos<.1&&(this.splitPos=.1),this.splitPos>.9&&(this.splitPos=.9),this.updateSplitBtnPos()}getElementType(){return mt.Element_Panel_Split}Clone(){let t=new Mt;t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.backElement=It(this.backElement),t.borderElement=It(this.borderElement),t.splitSize=this.splitSize,t.splitPos=this.splitPos,t.splitDir=this.splitDir,t}getBorder(){return this._border}getSplitButton(){return this._splitButton}OnRender(t){null!=this.backElement&&this.backElement.OnRender(t);let e=t.batcherUI,i=e.getTarget();e.EndDraw(),i.PushLimitRect(this._panel1.getWorldRectScale(t.scale)),e.BeginDraw(i),this._panel1.OnRender(t),e.EndDraw(),i.PopLimitRect(),i.PushLimitRect(this._panel2.getWorldRectScale(t.scale)),e.BeginDraw(i),this._panel2.OnRender(t),e.EndDraw(),i.PopLimitRect(),e.BeginDraw(i),this._splitButton.OnRender(t),null!=this.borderElement&&this.borderElement.OnRender(t)}updateSplitBtnPos(){this.splitDir==pt.Horizontal?(this._splitButton.localRect.radioX1=this.splitPos,this._splitButton.localRect.radioX2=this.splitPos,this._splitButton.localRect.radioY1=0,this._splitButton.localRect.radioY2=1,this._splitButton.localRect.offsetX1=.5*-this.splitSize,this._splitButton.localRect.offsetX2=.5*this.splitSize,this._splitButton.localRect.offsetY1=this._border.YTop,this._splitButton.localRect.offsetY2=-this._border.YBottom):(this._splitButton.localRect.radioY1=this.splitPos,this._splitButton.localRect.radioY2=this.splitPos,this._splitButton.localRect.radioX1=0,this._splitButton.localRect.radioX2=1,this._splitButton.localRect.offsetX1=this._border.XLeft,this._splitButton.localRect.offsetX2=this._border.XRight,this._splitButton.localRect.offsetY1=.5*-this.splitSize,this._splitButton.localRect.offsetY2=.5*this.splitSize)}updateContainerPos(){this.splitDir==pt.Horizontal?(this._panel1.localRect.radioX1=0,this._panel1.localRect.radioY1=0,this._panel1.localRect.radioX2=this.splitPos,this._panel1.localRect.radioY2=1,this._panel1.localRect.offsetX1=this._border.XLeft,this._panel1.localRect.offsetX2=-.5*this.splitSize,this._panel1.localRect.offsetY1=this._border.YTop,this._panel1.localRect.offsetY2=-this._border.YBottom,this._panel2.localRect.radioX1=this.splitPos,this._panel2.localRect.radioY1=0,this._panel2.localRect.radioX2=1,this._panel2.localRect.radioY2=1,this._panel2.localRect.offsetX1=.5*this.splitSize,this._panel2.localRect.offsetX2=-this._border.XRight,this._panel2.localRect.offsetY1=this._border.YTop,this._panel2.localRect.offsetY2=-this._border.YBottom):(this._panel1.localRect.radioX1=0,this._panel1.localRect.radioY1=0,this._panel1.localRect.radioX2=1,this._panel1.localRect.radioY2=this.splitPos,this._panel1.localRect.offsetX1=this._border.XLeft,this._panel1.localRect.offsetX2=-this._border.XRight,this._panel1.localRect.offsetY1=this._border.YTop,this._panel1.localRect.offsetY2=-.5*this.splitSize,this._panel2.localRect.radioX1=0,this._panel2.localRect.radioY1=this.splitPos,this._panel2.localRect.radioX2=1,this._panel2.localRect.radioY2=1,this._panel2.localRect.offsetX1=this._border.XLeft,this._panel2.localRect.offsetX2=this._border.XRight,this._panel2.localRect.offsetY1=.5*this.splitSize,this._panel2.localRect.offsetY2=-this._border.YBottom)}OnUpdate(t){null!=this.backElement&&(this.backElement._parent=this,this.backElement.localRect.setAsFill(),this.backElement.OnUpdate(t)),this.updateContainerPos(),this.updateSplitBtnPos(),this._panel1.OnUpdate(t),this._panel2.OnUpdate(t),this._splitButton.OnUpdate(t),null!=this.borderElement&&(this.borderElement._parent=this,this.borderElement.localRect.setAsFill(),this.borderElement.OnUpdate(t)),super.OnUpdate(t)}OnTouch(t,e,i,s,r){let n=!1,h=!1;if(1==e&&0==i){{let t=this._panel1.getWorldRect(),e=t.X,i=t.Y,h=t.X+t.Width,l=t.Y+t.Height;s>=e&&s<=h&&r>=i&&r<=l||(n=!0)}{let t=this._panel2.getWorldRect(),e=t.X,i=t.Y,n=t.X+t.Width,l=t.Y+t.Height;s>=e&&s<=n&&r>=i&&r<=l||(h=!0)}}return!!this._splitButton.OnTouch(t,e,i,s,r)||!(n||!this._panel1.OnTouch(t,e,i,s,r))||!h&&this._panel2.OnTouch(t,e,i,s,r)}getPanel1(){return this._panel1}getPanel2(){return this._panel2}getChildCount(){throw new Error("QUI_Panel_Split,use panel1 or panel2")}getChild(t){throw new Error("QUI_Panel_Split,use panel1 or panel2")}addChild(t){throw new Error("QUI_Panel_Split,use panel1 or panel2")}removeChild(t){throw new Error("QUI_Panel_Split,use panel1 or panel2")}removeChildAll(){throw new Error("QUI_Panel_Split,use panel1 or panel2")}}class Wt extends Yt{constructor(t){super(),this._freeItem=[],this._itemheight=0,this.panelValue=0,this.panelWantValue=0,this._items=[],this._pickid=-1,this._press=!1,this._pressid=0,this._drag=!1,this._dragy=0,this.dragout=!0,this.dragDist=32,this.ResetItemFunc(t)}ResetItemFunc(t){if(this._updateUIFunc=t,null!=this._updateUIFunc){for(var e=0;e<10;e++)this._freeItem.push(this._updateUIFunc(null,null,-1,!1));this._itemheight=this._freeItem[0].localRect.offsetY2-this._freeItem[0].localRect.offsetY1}}getElementType(){return mt.Element_Panel_Scroll_Unlimit}Clone(){let t=new Wt(this._updateUIFunc);t.localRect=this.localRect.Clone(),t._parent=null,t.Enable=this.Enable;for(var e=0;e<this.getChildCount();e++)t.addChild(this.getChild(e).Clone());return t.backElement=It(this.backElement),t.borderElement=It(this.borderElement),t.panelValue=this.panelValue,t.panelWantValue=this.panelWantValue,t.dragDist=this.dragDist,t}ScrollZero(){this.panelValue=0,this.panelWantValue=0}getItems(){return this._items}Clear(){this._items.splice(0),this._pickid=-1,this.ScrollZero()}getTotalHeight(){return this._items.length*this._itemheight}Pick(t){if((t<0||t>=this._items.length)&&(t=-1),t!=this._pickid&&null!=this.OnPick){this._pickid=t;let e=null;-1!=t&&(e=this._items[t]),this.OnPick(t,e)}}UpdateList(){let t=this.panelValue/this._itemheight|0,e=this.container.getWorldRect().Height,i=t*this._itemheight-this.panelValue,s=0;for(var r=t;r<this._items.length;r++){for(;this.getChildCount()<=s;){let t=null;this._freeItem.length>0&&(t=this._freeItem.pop()),null==t?this.addChild(this._updateUIFunc(null,null,-1,!1)):this.addChild(t)}if(r>=0){this._updateUIFunc(this._items[r],this.getChild(s),r,this._pickid==r);let t=this.getChild(s);t.localRect.offsetY1=i,t.localRect.offsetY2=i+this._itemheight,s++}if(i+=this._itemheight,i>e)break}if(s>=0){for(var n=s;n<this.getChildCount();n++)this._freeItem.push(this.getChild(n));this.removeChildBegin(s)}}ResetList(){this._freeItem.splice(0,this._freeItem.length);for(var t=0;t<10;t++)this._freeItem.push(this._updateUIFunc(null,null,-1,!1));this.UpdateList()}CancelTouch(){this._press=!1,this._pressid=-1,super.CancelTouch()}OnTouch(e,i,s,r,n){if(0==this._press&&1==i&&0==s){let t=this.getWorldRect(),i=t.X+this._border.XLeft,s=t.Y+this._border.YTop,h=t.X+t.Width-this._border.XRight,l=t.Y+t.Height-this._border.YBottom;r>=i&&r<=h&&n>=s&&n<=l&&(this._press=!0,this._pressid=e,this._pressx=r,this._pressy=n)}return this._pressid==e&&1==this._press&&1==i&&1==s&&(this._drag?this._dragPanel(n):Math.abs(n-this._pressy)>this.dragDist*t.graphic.getDevicePixelRadio()&&(this._drag=!0,this._dragy=this.panelValue,this._pressy=n,this._pressx=r)),this._pressid==e&&1==this._press&&0==i&&(this._press=!1,this._pressid=0,this._drag=!1),this._drag?(this.container.CancelTouch(),!0):super.OnTouch(e,i,s,r,n)}_dragPanel(t){this.panelValue=this._dragy-(t-this._pressy),this.panelWantValue=this.panelValue,this.panelWantValue<0&&(this.panelWantValue=0);let e=this.container.getWorldRect().Height,i=this.getTotalHeight()-e;i<0&&(i=0),this.panelWantValue>i&&(this.panelWantValue=i),0==this.dragout&&(this.panelValue=this.panelWantValue)}OnUpdate(t){0==this._drag&&(this.panelValue=this.panelValue+.1*(this.panelWantValue-this.panelValue)),this.UpdateList(),super.OnUpdate(t)}}class zt{constructor(){this.material=new tt(J.GetShaderProgram("inst_tbo")),this.material.UpdateMatModel(),this.ElemInstInit();let e=t.graphic.GetWebGL();this.mesh=new nt,this.mesh.UpdateVertexFormat(e,H.GetFormat_Vertex_Ubo()),this.InitDrawMesh(e)}static GetFormat_Vertex_Ubo(){if(null==this.inst_ubo){let t=new st("Vertex_InstFull");t.vbos.push(new it),t.vbos[0].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos.push(new it),t.vbos[1].vertexAttribDivisor=4,t.vbos[1].atrribs.push(new et(y.FLOAT,4,!1)),t.vbos[1].atrribs.push(new et(y.FLOAT,2,!1)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new et(y.UNSIGNED_SHORT,2,!1)),this.inst_ubo=t,t.Update()}return this.inst_ubo}SetPackElement(t){this.packelem=t,this.material.uniformTexs.texRGBA.value=t.GetPackTexDuo().packRGBA,this.material.uniformTexs.texGray.value=t.GetPackTexDuo().packGray;let e=this.material.uniformTexs.texelem;null!=e&&(e.value=t.GetElemTex())}GetPackElement(){return this.packelem}ElemInstInit(){this.elemInstBufData=new Uint8Array(32768),this.elemInstBufView=new DataView(this.elemInstBufData.buffer),this.elemInstCount=0,this.elemInstDirty=!1}GetElementInstCount(){return this.elemInstCount}ClearElementInst(){this.elemInstCount=0}AddElementInst(t){let e=this.elemInstCount;return this.elemInstCount++,this.WriteElementInst(t,e),e}WriteElementInst(t,e){if(32*e>=this.elemInstBufData.length){let t=new Uint8Array(32*(1024+e));for(let e=0;e<this.elemInstBufData.length;e++)t[e]=this.elemInstBufData[e];this.elemInstBufData=t,this.elemInstBufView=new DataView(this.elemInstBufData.buffer)}let i=32*e;this.elemInstBufView.setFloat32(i+0,t.pos.X,!0),this.elemInstBufView.setFloat32(i+4,t.pos.Y,!0),this.elemInstBufView.setFloat32(i+8,t.pos.Z,!0),this.elemInstBufView.setFloat32(i+12,t.rotate,!0),this.elemInstBufView.setFloat32(i+16,t.scale.X,!0),this.elemInstBufView.setFloat32(i+20,t.scale.Y,!0),this.elemInstBufView.setUint8(i+24,255*t.color.R),this.elemInstBufView.setUint8(i+25,255*t.color.G),this.elemInstBufView.setUint8(i+26,255*t.color.B),this.elemInstBufView.setUint8(i+27,255*t.color.A),this.elemInstBufView.setUint16(i+28,t.instid,!0),this.elemInstDirty=!0}GetElementInst(t){let e=32*t,i=new N;i.pos=new S(0,0,0),i.scale=new A(0,0),i.color=new B(0,0,0,0),i.pos.X=this.elemInstBufView.getFloat32(e+0,!0),i.pos.Y=this.elemInstBufView.getFloat32(e+4,!0),i.pos.Z=this.elemInstBufView.getFloat32(e+8,!0),i.rotate=this.elemInstBufView.getFloat32(e+12,!0),i.scale.X=this.elemInstBufView.getFloat32(e+16,!0),i.scale.Y=this.elemInstBufView.getFloat32(e+20,!0),i.color.R=this.elemInstBufView.getUint8(e+24)/255,i.color.G=this.elemInstBufView.getUint8(e+25)/255,i.color.B=this.elemInstBufView.getUint8(e+26)/255,i.color.A=this.elemInstBufView.getUint8(e+27)/255;let s=this.elemInstBufView.getUint16(e+28,!0);return i.instid=s,i}InitDrawMesh(t){let e=this.mesh.GetVertexFormat().vbos[0].stride,i=new Uint8Array(6*e),s=new DataView(i.buffer);s.setFloat32(0*e,-1,!0),s.setFloat32(0*e+4,-1,!0),s.setFloat32(1*e,1,!0),s.setFloat32(1*e+4,-1,!0),s.setFloat32(2*e,-1,!0),s.setFloat32(2*e+4,1,!0),s.setFloat32(3*e,-1,!0),s.setFloat32(3*e+4,1,!0),s.setFloat32(4*e,1,!0),s.setFloat32(4*e+4,-1,!0),s.setFloat32(5*e,1,!0),s.setFloat32(5*e+4,1,!0),this.mesh.UploadVertexBuffer(t,0,i,!1,i.byteLength)}GetGUI(){return null}OnUpdate(t){}OnRender(e,i,s){if(0==s){let s=t.graphic.GetWebGL();this.packelem.ApplyTextureData(),this.elemInstDirty&&(this.mesh.UploadVertexBuffer(s,1,this.elemInstBufData,!0,this.elemInstBufData.byteLength),this.elemInstDirty=!1),this.mesh.instancecount=this.elemInstCount,this.material.UpdateMatProj(e),this.material.UpdateMatView(i.GetViewMatrix()),nt.DrawMeshInstanced(s,this.mesh,this.material)}}}class Nt{constructor(){this.inst=[],this.y=64}OnInit(t){null==this.nav&&(this.nav=t),this.AddBackButton(),this.AddSprites(),this.AddLabel("DrawElement,TBO模式"),this.AddLabel("vb0 是一个小方块"),this.AddLabel("vb1 是instance 数据"),this.AddLabel("sprite 数据放在一张贴图里，尺寸几乎没有限制，这里使用了 512x512的float贴图"),this.AddLabel("这个贴图尺寸下,可使用65536种精灵")}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),e.fontScale.X*=.5,e.fontScale.Y*=.5,this.y+=16}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer);let e=J.CreateGUI_Button("<--",new B(1,1,1,1));e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(e),e.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}AddSprites(){this.canvaslayer=new D(f.Main),this.canvaslayer.GetCamera().Scale=2,this.render=new zt,this.canvaslayer.AddRender(this.render),X.GetViewList().AddDrawLayer(this.canvaslayer);let t=J.GetBorder2Block(),e=J.GetRoundBlock();this.render.SetPackElement(J.GetPackElement());for(var i=0;i<51200;i++){let s=new N;s.pos=new S(400*Math.random()-200,400*Math.random()-200,0),s.rotate=Math.random()*Math.PI,s.scale=new A(1,1),s.instid=i%2==0?t.index:e.index,s.color=new B(Math.random(),Math.random(),Math.random(),Math.random()),this.render.AddElementInst(s),this.inst.push(s)}}OnUpdate(t){for(var e=0;e<this.inst.length;e++)this.inst[e].rotate+=t*Math.PI,this.render.WriteElementInst(this.inst[e],e)}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer),X.GetViewList().RemoveDrawLayers(this.canvaslayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class Ht{constructor(){this.ElemInit(),this.ElemInstInit(),this.material=new tt(J.GetShaderProgram("inst_ubo")),this.material.UpdateMatModel();let e=t.graphic.GetWebGL();this.mesh=new nt,this.mesh.UpdateVertexFormat(e,H.GetFormat_Vertex_Ubo()),this.InitDrawMesh(e)}ElemInit(){this.elemBufData=new Uint8Array(49108),this.elemBufView=new DataView(this.elemBufData.buffer),this.elemCount=0,this.elemDirty=!1}GetElementCount(){return this.elemCount}AddElement(t){let e=this.elemCount;return this.elemCount++,this.WriteElement(t,e),e}SetTexture(t){this.material.uniformTexs.texRGBA.value=t.packRGBA,this.material.uniformTexs.texGray.value=t.packGray}WriteElement(t,e){t.index=e;let i=48*e;this.elemBufView.setFloat32(i+0,t.sizeTL.X,!0),this.elemBufView.setFloat32(i+4,t.sizeTL.Y,!0),this.elemBufView.setFloat32(i+8,t.sizeRB.X,!0),this.elemBufView.setFloat32(i+12,t.sizeRB.Y,!0),this.elemBufView.setFloat32(i+16,t.uvCenter.X,!0),this.elemBufView.setFloat32(i+20,t.uvCenter.Y,!0),this.elemBufView.setFloat32(i+24,t.uvHalfSize.X,!0),this.elemBufView.setFloat32(i+28,t.uvHalfSize.Y,!0),this.elemBufView.setFloat32(i+32,t.uvLayer,!0),this.elemBufView.setFloat32(i+44,t.eff,!0),this.elemDirty=!0}GetElement(t){let e=48*t,i=new z;return i.sizeTL=new A(0,0),i.sizeTL.X=this.elemBufView.getFloat32(e+0,!0),i.sizeTL.Y=this.elemBufView.getFloat32(e+4,!0),i.sizeRB.X=this.elemBufView.getFloat32(e+8,!0),i.sizeRB.Y=this.elemBufView.getFloat32(e+12,!0),i.uvCenter.X=this.elemBufView.getFloat32(e+16,!0),i.uvCenter.Y=this.elemBufView.getFloat32(e+20,!0),i.uvHalfSize.X=this.elemBufView.getFloat32(e+24,!0),i.uvHalfSize.Y=this.elemBufView.getFloat32(e+28,!0),i.uvLayer=this.elemBufView.getFloat32(e+32,!0),i.eff=this.elemBufView.getFloat32(e+44,!0),i}ElemInstInit(){this.elemInstBufData=new Uint8Array(32768),this.elemInstBufView=new DataView(this.elemInstBufData.buffer),this.elemInstCount=0,this.elemInstDirty=!1}GetElementInstCount(){return this.elemInstCount}ClearElementInst(){this.elemInstCount=0}AddElementInst(t){let e=this.elemInstCount;return this.elemInstCount++,this.WriteElementInst(t,e),e}WriteElementInst(t,e){if(32*e>=this.elemInstBufData.length){let t=new Uint8Array(32*(1024+e));for(let e=0;e<this.elemInstBufData.length;e++)t[e]=this.elemInstBufData[e];this.elemInstBufData=t,this.elemInstBufView=new DataView(this.elemInstBufData.buffer)}let i=32*e;this.elemInstBufView.setFloat32(i+0,t.pos.X,!0),this.elemInstBufView.setFloat32(i+4,t.pos.Y,!0),this.elemInstBufView.setFloat32(i+8,t.pos.Z,!0),this.elemInstBufView.setFloat32(i+12,t.rotate,!0),this.elemInstBufView.setFloat32(i+16,t.scale.X,!0),this.elemInstBufView.setFloat32(i+20,t.scale.Y,!0),this.elemInstBufView.setUint8(i+24,255*t.color.R),this.elemInstBufView.setUint8(i+25,255*t.color.G),this.elemInstBufView.setUint8(i+26,255*t.color.B),this.elemInstBufView.setUint8(i+27,255*t.color.A),this.elemInstBufView.setUint16(i+28,t.instid,!0),this.elemInstDirty=!0}GetElementInst(t){let e=32*t,i=new N;i.pos=new S(0,0,0),i.scale=new A(0,0),i.color=new B(0,0,0,0),i.pos.X=this.elemInstBufView.getFloat32(e+0,!0),i.pos.Y=this.elemInstBufView.getFloat32(e+4,!0),i.pos.Z=this.elemInstBufView.getFloat32(e+8,!0),i.rotate=this.elemInstBufView.getFloat32(e+12,!0),i.scale.X=this.elemInstBufView.getFloat32(e+16,!0),i.scale.Y=this.elemInstBufView.getFloat32(e+20,!0),i.color.R=this.elemInstBufView.getUint8(e+24)/255,i.color.G=this.elemInstBufView.getUint8(e+25)/255,i.color.B=this.elemInstBufView.getUint8(e+26)/255,i.color.A=this.elemInstBufView.getUint8(e+27)/255;let s=this.elemInstBufView.getUint16(e+28,!0);return i.instid=s,i}InitDrawMesh(t){let e=this.mesh.GetVertexFormat().vbos[0].stride,i=new Uint8Array(6*e),s=new DataView(i.buffer);s.setFloat32(0*e,-1,!0),s.setFloat32(0*e+4,-1,!0),s.setFloat32(1*e,1,!0),s.setFloat32(1*e+4,-1,!0),s.setFloat32(2*e,-1,!0),s.setFloat32(2*e+4,1,!0),s.setFloat32(3*e,-1,!0),s.setFloat32(3*e+4,1,!0),s.setFloat32(4*e,1,!0),s.setFloat32(4*e+4,-1,!0),s.setFloat32(5*e,1,!0),s.setFloat32(5*e+4,1,!0),this.mesh.UploadVertexBuffer(t,0,i,!1,i.byteLength)}GetGUI(){return null}OnUpdate(t){}OnRender(e,i,s){if(0==s){let s=t.graphic.GetWebGL();this.elemInstDirty&&this.mesh.UploadVertexBuffer(s,1,this.elemInstBufData,!0,this.elemInstBufData.byteLength),this.elemDirty&&this.material.uniformBlocks.SpritesBlock.value.UploadData(s,this.elemBufData,!0),this.mesh.instancecount=this.elemInstCount,this.material.UpdateMatProj(e),this.material.UpdateMatView(i.GetViewMatrix()),nt.DrawMeshInstanced(s,this.mesh,this.material)}}}class jt{constructor(){this.inst=[],this.y=64}OnInit(t){null==this.nav&&(this.nav=t),this.AddBackButton(),this.AddSprites(),this.AddLabel("DrawElement,UBO模式"),this.AddLabel("vb0 是一个小方块"),this.AddLabel("vb1 是instance 数据"),this.AddLabel("sprite 数据放在Uniform里，尺寸受到设备限制"),this.AddLabel("移动平台可使用1023种精灵"),this.AddLabel("这个模式不如TBO模式")}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer);let e=J.CreateGUI_Button("<--",new B(1,1,1,1));e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(e),e.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),e.fontScale.X*=.5,e.fontScale.Y*=.5,this.y+=16}AddSprites(){this.canvaslayer=new D(f.Main),this.canvaslayer.GetCamera().Scale=2,this.render=new Ht,this.canvaslayer.AddRender(this.render),X.GetViewList().AddDrawLayer(this.canvaslayer);let t=J.GetBorder2Block(),e=J.GetRoundBlock();this.render.SetTexture(J.GetPackElement().GetPackTexDuo());let i=null,s=null;{let e=new z;e.sizeTL=new A(0,0),e.sizeRB=new A(16,16),e.uvCenter=t.uvCenter.Clone(),e.uvHalfSize=t.uvHalfSize.Clone(),e.uvLayer=t.uvLayer,e.eff=t.eff,this.render.AddElement(e),i=e}{let t=new z;t.sizeTL=new A(-8,-8),t.sizeRB=new A(8,8),t.uvCenter=e.uvCenter.Clone(),t.uvHalfSize=e.uvHalfSize.Clone(),t.uvLayer=e.uvLayer,t.eff=e.eff,this.render.AddElement(t),s=t}for(var r=0;r<1024;r++){let t=new N;t.pos=new S(400*Math.random()-200,400*Math.random()-200,0),t.rotate=Math.random()*Math.PI,t.scale=new A(1,1),t.instid=r%2==0?i.index:s.index,t.color=new B(Math.random(),Math.random(),Math.random(),Math.random()),this.render.AddElementInst(t),this.inst.push(t)}}OnUpdate(t){for(var e=0;e<this.inst.length;e++)this.inst[e].rotate+=t*Math.PI,this.render.WriteElementInst(this.inst[e],e)}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer),X.GetViewList().RemoveDrawLayers(this.canvaslayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class Kt{constructor(){this.y=64}OnInit(e){null==this.nav&&(this.nav=e),this.AddBackButton();let i=t.graphic.GetWebGL();this.AddLabel("DevicePixelRadio="+t.graphic.getDevicePixelRadio()),this.AddLabel("MAX_UNIFORM_BLOCK_SIZE="+i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE)),this.AddLabel("MAX_3D_TEXTURE_SIZE="+i.getParameter(i.MAX_3D_TEXTURE_SIZE)),this.AddLabel("MAX_ARRAY_TEXTURE_LAYERS="+i.getParameter(i.MAX_ARRAY_TEXTURE_LAYERS)),this.AddLabel("MAX_TEXTURE_SIZE="+i.getParameter(i.MAX_TEXTURE_SIZE)),this.AddLabel("MAX_VERTEX_UNIFORM_BLOCKS="+i.getParameter(i.MAX_VERTEX_UNIFORM_BLOCKS)),this.AddLabel("MAX_VERTEX_UNIFORM_COMPONENTS="+i.getParameter(i.MAX_VERTEX_UNIFORM_COMPONENTS))}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),e.fontScale.X*=.5,e.fontScale.Y*=.5,this.y+=16}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer);let e=J.CreateGUI_Button("<--",new B(1,1,1,1));e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(e),e.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}OnUpdate(t){}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class Zt{constructor(){this.y=64}OnInit(e){null==this.nav&&(this.nav=e),this.AddBackButton();let i=t.graphic.GetWebGL(),s=new L(i,16,16,5,p.R8),r=new I(i,16,16,p.R8,null),n=new Uint8Array(256);for(let t=0;t<256;t++)n[t]=t;let h=new Uint8Array(256);for(let t=0;t<256;t++)h[t]=255-t;this.AddLabel("tex1="+s.getWidth()+","+s.getHeight()+","+s.GetLayer()),s.UploadSubTexture(0,0,0,16,16,n),r.UploadTexture(0,0,16,16,h),this.AddLabel("tex2="+r.getWidth()+","+r.getHeight()),this.AddLabel("普通贴图传给texturearray不能正常渲染")}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),this.y+=16}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=3,X.GetViewList().AddDrawLayer(this.guilayer);let t=J.CreateGUI_Button("<--",new B(1,1,1,1));t.localRect.setHPosByLeftBorder(196,16),t.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(t),t.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}OnUpdate(t){}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class qt{constructor(){this.scale=1}SetTiledmap(e,i,s,r=1){this.scale=r;let n=t.graphic.GetWebGL();this.mat=new tt(J.GetShaderProgram("tiledmap")),this.mat.UpdateMatModel(),this.mesh=new nt,this.mesh.UpdateVertexFormat(n,rt.GetFormat_Vertex_UV_Color()),this.UpdateMesh(e.getWidth(),e.getHeight(),s*r),this.mat.uniformTexs.texTile.value=i,this.mat.uniformTexs.texIndex.value=e,this.mat.uniformFloats.tilesize.value=s,this.mat.uniformVecs.mapinfo.value=new Float32Array([e.getWidth(),e.getHeight(),i.getWidth(),i.getHeight()])}GetScale(){return this.scale}UpdateMesh(e,i,s){let r=t.graphic.GetWebGL(),n=this.mesh.GetVertexFormat().vbos[0].stride,h=new Uint8Array(6*n),l=new DataView(h.buffer);l.setFloat32(0*n,0,!0),l.setFloat32(0*n+4,0,!0),l.setFloat32(0*n+8,0,!0),l.setFloat32(0*n+12,0,!0),l.setFloat32(0*n+16,0,!0),l.setFloat32(1*n,e*s,!0),l.setFloat32(1*n+4,0,!0),l.setFloat32(1*n+8,0,!0),l.setFloat32(1*n+12,1,!0),l.setFloat32(1*n+16,0,!0),l.setFloat32(2*n,0,!0),l.setFloat32(2*n+4,i*s,!0),l.setFloat32(2*n+8,0,!0),l.setFloat32(2*n+12,0,!0),l.setFloat32(2*n+16,1,!0),l.setFloat32(3*n,0,!0),l.setFloat32(3*n+4,i*s,!0),l.setFloat32(3*n+8,0,!0),l.setFloat32(3*n+12,0,!0),l.setFloat32(3*n+16,1,!0),l.setFloat32(4*n,e*s,!0),l.setFloat32(4*n+4,0,!0),l.setFloat32(4*n+8,0,!0),l.setFloat32(4*n+12,1,!0),l.setFloat32(4*n+16,0,!0),l.setFloat32(5*n,e*s,!0),l.setFloat32(5*n+4,i*s,!0),l.setFloat32(5*n+8,0,!0),l.setFloat32(5*n+12,1,!0),l.setFloat32(5*n+16,1,!0),this.mesh.UploadVertexBuffer(r,0,h,!1,h.byteLength)}GetGUI(){return null}OnUpdate(t){}OnRender(e,i,s){if(null==this.mat||null==this.mesh)return;let r=t.graphic.GetWebGL();0==s&&(this.mat.UpdateMatProj(e),this.mat.UpdateMatView(i.GetViewMatrix()),nt.DrawMesh(r,this.mesh,this.mat))}}class Qt{static Init(){if(null==this.p){this.p=new Uint8Array(512);for(var t=0;t<512;t++)this.p[t]=this.permutation[t%this.permutation.length]}}static GenNoise(t,e,i,s,r){for(var n=0,h=1,l=1,a=0,o=0;o<s;o++)a+=this.Perlin(t*h,e*h,i*h)*l,n+=l,l*=r,h*=2;return a/n}static Perlin(t,e,i){this.Init();var s=255&t,r=255&e,n=255&i,h=t-(0|t),l=e-(0|e),a=i-(0|i),o=this.fade(h),d=this.fade(l),u=this.fade(a),c=this.p[this.p[this.p[s]+r]+n],p=this.p[this.p[this.p[s]+this.inc(r)]+n],f=this.p[this.p[this.p[s]+r]+this.inc(n)],_=this.p[this.p[this.p[s]+this.inc(r)]+this.inc(n)],m=this.p[this.p[this.p[this.inc(s)]+r]+n],g=this.p[this.p[this.p[this.inc(s)]+this.inc(r)]+n],v=this.p[this.p[this.p[this.inc(s)]+r]+this.inc(n)],w=this.p[this.p[this.p[this.inc(s)]+this.inc(r)]+this.inc(n)],y=this.lerp(this.grad(c,h,l,a),this.grad(m,h-1,l,a),o),R=this.lerp(this.grad(p,h,l-1,a),this.grad(g,h-1,l-1,a),o),b=this.lerp(y,R,d);y=this.lerp(this.grad(f,h,l,a-1),this.grad(v,h,l-1,a-1),o),R=this.lerp(this.grad(_,h,l-1,a-1),this.grad(w,h-1,l-1,a-1),o);var x=this.lerp(y,R,d);return.5*this.lerp(b,x,u)+.5}static inc(t){return t+1}static grad(t,e,i,s){switch(15&t){case 0:return e+i;case 1:return-e+i;case 2:return e-i;case 3:return-e-i;case 4:return e+s;case 5:return-e+s;case 6:return e-s;case 7:return-e-s;case 8:return i+s;case 9:case 13:return-i+s;case 10:return i-s;case 11:case 15:return-i-s;case 12:return i+e;case 14:return i-e;default:return 0}}static fade(t){return t*t*t*(t*(6*t-15)+10)}static lerp(t,e,i){return t*(1-i)+e*i}}Qt.permutation=new Uint8Array([151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180]),Qt.p=null;class Jt{}class $t{}class te extends I{constructor(t,e){super(t,e.width,e.height,p.RGBA32,null),this.tiles=[],this.tileLayer=[],this.tileSize=e.tileSize}GetTileLayers(){return this.tileLayer}GetTileLayerCount(){return this.tileLayer.length}GetTileLayer(t){return this.tileLayer[t]}GetTileSize(){return this.tileSize}GetTileCount(){return this.tiles.length}GetTile(t){return this.tiles[t]}GetEmpty(){return this.tileEmpty}AddEmpty(){if(null!=this.tileEmpty)return this.tileEmpty;let t=new Jt;return t.index=0,t.posU=0,t.posV=0,this.tiles.push(t),this.tileEmpty=t,t}AddTile(t){return this.SetTile(this.tiles.length,t)}SetTile(t,e){if(e.width!=this.tileSize||e.height!=this.tileSize)throw"错误的TileSize:"+e.width+","+e.height;let i=this._width/this.tileSize|0,s=t%i|0,r=t/i|0,n=this._height/this.tileSize|0;if(r<0||r>=n)throw"index 超出范围";for(;this.tiles.length<=t;)this.tiles.push(null);let h=new Jt;return h.posU=s,h.posV=r,h.index=t,this.tiles[t]=h,e.format!=p.RGBA32&&(e=e.ConvertToRGBA()),this.UploadTexture(h.posU*this.tileSize,h.posV*this.tileSize,this.tileSize,this.tileSize,e.data),h}AddLPCTile(t,e=A.Zero){let i=new $t;return this.tileLayer.push(i),i.smallpot=this.AddTile(t.Cut(0*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.bigpot=this.AddTile(t.Cut(0*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner=[],i.innerCorner[0]=this.AddTile(t.Cut(1*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[1]=this.AddTile(t.Cut(2*this.tileSize+e.X,0*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[2]=this.AddTile(t.Cut(1*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.innerCorner[3]=this.AddTile(t.Cut(2*this.tileSize+e.X,1*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner=[],i.outCorner[0]=this.AddTile(t.Cut(0*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[1]=this.AddTile(t.Cut(1*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[2]=this.AddTile(t.Cut(2*this.tileSize+e.X,2*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[3]=this.AddTile(t.Cut(0*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[4]=this.AddTile(t.Cut(1*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[5]=this.AddTile(t.Cut(2*this.tileSize+e.X,3*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[6]=this.AddTile(t.Cut(0*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[7]=this.AddTile(t.Cut(1*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.outCorner[8]=this.AddTile(t.Cut(2*this.tileSize+e.X,4*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled=[],i.tiled[0]=i.outCorner[4],i.tiled[1]=this.AddTile(t.Cut(0*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled[2]=this.AddTile(t.Cut(1*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i.tiled[3]=this.AddTile(t.Cut(2*this.tileSize+e.X,5*this.tileSize+e.Y,this.tileSize,this.tileSize)),i}ConvertTile2Sprite(t){null==this.tiledMaterial&&(this.tiledMaterial=new tt(J.GetShaderProgram("simple")),this.tiledMaterial.uniformTexs.tex.value=this);let e=new Ct(this.tiledMaterial);e.pixelwidth=this.tileSize,e.pixelheight=this.tileSize,e.effect=R.RGBA,e.uvlayer=0;let i=this._width/this.tileSize|0,s=this._height/this.tileSize|0;return e.uv=new T(t.posU/i,t.posV/s,(t.posU+1)/i,(t.posV+1)/s),e}}class ee extends I{constructor(t,e,i){super(t,e,i,p.RGBA32,null),this.data=new Uint8Array(e*i*4)}MarkDirty(){this.dirty=!0}DropData(){this.data=null}GetData(){return this.data}SetIndexLayer1(t,e,i,s){null==this.data&&(this.data=new Uint8Array(this._width*this._height*4)),this.data[4*(e*this._width+t)+0]=i,this.data[4*(e*this._width+t)+1]=s,this.dirty=!0}SetIndexLayer2(t,e,i,s){null==this.data&&(this.data=new Uint8Array(this._width*this._height*4)),this.data[4*(e*this._width+t)+2]=i,this.data[4*(e*this._width+t)+3]=s,this.dirty=!0}FillIndexLayer1(t){for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){let s=(100*Math.random()+.5|0)-97;s<0&&(s=0),s>3&&(s=3);let r=t.tiled[s];this.SetIndexLayer1(i,e,r.posU,r.posV)}}FillIndexLayer2WithData(t,e){for(var i=0;i<this._height;i+=2)for(var s=0;s<this._width;s+=2){let t=e[i*this._width+s]+e[i*this._width+s+1]+e[(i+1)*this._width+s]+e[(i+1)*this._width+s+1]>=2?1:0;e[i*this._width+s]=t,e[i*this._width+s+1]=t,e[(i+1)*this._width+s]=t,e[(i+1)*this._width+s+1]=t}for(i=0;i<this._height;i++)for(s=0;s<this._width;s++){let r=0,n=0,h=0;i>0&&(s>0&&(r=e[(i-1)*this._width+s-1]),n=e[(i-1)*this._width+s],s<this._width-1&&(h=e[(i-1)*this._width+s+1]));let l=0,a=0,o=0;s>0&&(l=e[i*this._width+s-1]),a=e[i*this._width+s],s<this._width-1&&(o=e[i*this._width+s+1]);let d=0,u=0,c=0;if(i<this._height-1&&(s>0&&(d=e[(i+1)*this._width+s-1]),u=e[(i+1)*this._width+s],s<this._width-1&&(c=e[(i+1)*this._width+s+1])),a>0){let e=0;if(n>0&&e++,l>0&&e++,o>0&&e++,u>0&&e++,0==e)this.SetIndexLayer2(s,i,t.smallpot.posU,t.smallpot.posV);else if(1==e)console.log("error count 2");else if(2==e)0==n&&0==l&&this.SetIndexLayer2(s,i,t.outCorner[0].posU,t.outCorner[0].posV),0==n&&0==o&&this.SetIndexLayer2(s,i,t.outCorner[2].posU,t.outCorner[2].posV),0==u&&0==l&&this.SetIndexLayer2(s,i,t.outCorner[6].posU,t.outCorner[6].posV),0==u&&0==o&&this.SetIndexLayer2(s,i,t.outCorner[8].posU,t.outCorner[8].posV);else if(3==e)0==n&&this.SetIndexLayer2(s,i,t.outCorner[1].posU,t.outCorner[1].posV),0==l&&this.SetIndexLayer2(s,i,t.outCorner[3].posU,t.outCorner[3].posV),0==o&&this.SetIndexLayer2(s,i,t.outCorner[5].posU,t.outCorner[5].posV),0==u&&this.SetIndexLayer2(s,i,t.outCorner[7].posU,t.outCorner[7].posV);else if(4==e){let e=0;if(r>0&&e++,h>0&&e++,d>0&&e++,c>0&&e++,3==e)0==r&&this.SetIndexLayer2(s,i,t.innerCorner[3].posU,t.innerCorner[3].posV),0==h&&this.SetIndexLayer2(s,i,t.innerCorner[2].posU,t.innerCorner[2].posV),0==d&&this.SetIndexLayer2(s,i,t.innerCorner[1].posU,t.innerCorner[1].posV),0==c&&this.SetIndexLayer2(s,i,t.innerCorner[0].posU,t.innerCorner[0].posV);else{let e=(100*Math.random()+.5|0)-97;e<0&&(e=0),e>3&&(e=3);let r=t.tiled[e];this.SetIndexLayer2(s,i,r.posU,r.posV)}}}else this.SetIndexLayer2(s,i,0,0)}}Apply(){if(this.dirty){if(null==this.data)throw"no data on IndexdTex";this.UploadTexture(0,0,this._width,this._height,this.data),this.dirty=!1}}}class ie{constructor(){this.y=64,this.timer=0}OnInit(e){null==this.nav&&(this.nav=e),this.tiledlayer=new D(f.Main),this.tiledlayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.tiledlayer),this.tiledrender=new qt,this.tiledlayer.AddRender(this.tiledrender),this.tiledtex=new te(t.graphic.GetWebGL(),{width:1024,height:1024,tileSize:32}),this.tiledtexIndex=new ee(t.graphic.GetWebGL(),256,256),this.tiledrender.SetTiledmap(this.tiledtexIndex,this.tiledtex,this.tiledtex.GetTileSize(),.25),this.AddBackButton(),this.AddLabel("LPC有个很好的Tiledmap 规则"),this.AddButton("随机地图",(()=>{this.RandomMap()})),this.initacync()}RandomMap(){let t=this.tiledtex.GetTileLayer(0),e=this.tiledtex.GetTileLayer(1);this.tiledtexIndex.FillIndexLayer1(e);let i=new A(Math.random(),Math.random()),s=new Uint8Array(this.tiledtexIndex.getWidth()*this.tiledtexIndex.getHeight());for(let t=0;t<this.tiledtexIndex.getHeight();t++)for(let e=0;e<this.tiledtexIndex.getWidth();e++){let r=Qt.GenNoise(e/this.tiledtexIndex.getWidth()/2+i.X,t/this.tiledtexIndex.getHeight()/2+i.Y,0,5,1);s[t*this.tiledtexIndex.getWidth()+e]=r>.5?1:0}this.tiledtexIndex.FillIndexLayer2WithData(t,s),this.tiledtexIndex.Apply()}initacync(){return e=this,i=void 0,r=function*(){let e=t.graphic.GetWebGL(),i=16;this.tiledtex.AddEmpty();{let s=new tt(J.GetShaderProgram("simple")),r=yield t.loader.LoadImageAsync("./ttsample/data/tiledrule.png"),n=new I(e,r.width,r.height,p.RGBA32,null);n.UploadImg(r),s.uniformTexs.tex.value=n;let h=new Ct(s),l=new Ot(h);l.localRect.setHPosByLeftBorder(96,i),i+=100,l.localRect.setVPosByTopBorder(192,this.y),this.guilayer.GetCanvas().addChild(l)}{let s=new tt(J.GetShaderProgram("simple")),r=yield t.loader.LoadImageDataAsync("./ttsample/data/grass.png"),n=new I(e,r.width,r.height,p.RGBA32,null);n.UploadImg(r),s.uniformTexs.tex.value=n;let h=new Ct(s),l=new Ot(h);l.localRect.setHPosByLeftBorder(96,i),i+=100,l.localRect.setVPosByTopBorder(192,this.y),this.guilayer.GetCanvas().addChild(l);let a=new j;a.format=p.RGBA32,a.data=r.data,a.width=r.width,a.height=r.height,this.tiledtex.AddLPCTile(a)}{let s=new tt(J.GetShaderProgram("simple")),r=yield t.loader.LoadImageDataAsync("./ttsample/data/dirt.png"),n=new I(e,r.width,r.height,p.RGBA32,null);n.UploadImg(r),s.uniformTexs.tex.value=n;let h=new Ct(s),l=new Ot(h);l.localRect.setHPosByLeftBorder(96,i),i+=100,l.localRect.setVPosByTopBorder(192,this.y),this.guilayer.GetCanvas().addChild(l);let a=new j;a.format=p.RGBA32,a.data=r.data,a.width=r.width,a.height=r.height,this.tiledtex.AddLPCTile(a)}this.y+=192,this.AddLabel("使用3x6的区块，表达地表的一层"),this.AddLabel("大点，小点，内角四块。"),this.AddLabel("外角八块，外角的最中间是平铺块"),this.AddLabel("最下边一行是替换的平铺块"),this.RandomMap()},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{a(r.next(t))}catch(t){n(t)}}function l(t){try{a(r.throw(t))}catch(t){n(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,l)}a((r=r.apply(e,i||[])).next())}));var e,i,s,r}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),e.fontScale.X*=.5,e.fontScale.Y*=.5,this.y+=16}AddButton(t,e){let i=J.CreateGUI_Button(t,new B(1,1,1,1));i.localRect.setHPosByLeftBorder(196,16),i.localRect.setVPosByTopBorder(20,this.y),this.guilayer.GetCanvas().addChild(i),i.OnClick=()=>{e()},this.y+=24}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer);let e=J.CreateGUI_Button("<--",new B(1,1,1,1));e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(e),e.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}OnUpdate(t){if(null==this.tiledlayer)return;this.timer+=t;let e=65*Math.sin(this.timer)+65,i=32*Math.cos(this.timer)+32;this.tiledlayer.GetCamera().LookAt.X=(2*e|0)/2,this.tiledlayer.GetCamera().LookAt.Y=(2*i|0)/2}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}var se=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}))};class re{GetName(){let t="";return null!=this.parent&&(t=this.parent.GetName()+"/"),t+this.handle.name}}class ne extends Yt{constructor(){super(),this.root=null,this.curDir=null,this.panel_File=new Wt(this.updateFileElem.bind(this)),this.panel_File.localRect.setAsFill(),this.addChild(this.panel_File),this.panel_File.OnPick=this.onPick.bind(this)}OpenFolder(t){return se(this,void 0,void 0,(function*(){let t=yield showDirectoryPicker({mode:"readwrite",startIn:"documents"});this.root=new re,this.root.handle=t,this.curDir=this.root,this.FillItems()}))}FillItems(){return se(this,void 0,void 0,(function*(){var t,e,i,s;let r=this.panel_File.getItems();if(r.splice(0),this.curDir!=this.root){let t=new re;t.parent=this.curDir.parent,t.handle=null,r.push(t)}let n=this.curDir.handle;try{for(var h,l=!0,a=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,i=t[Symbol.asyncIterator];return i?i.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},s("next"),s("throw"),s("return"),e[Symbol.asyncIterator]=function(){return this},e);function s(i){e[i]=t[i]&&function(e){return new Promise((function(s,r){!function(t,e,i,s){Promise.resolve(s).then((function(e){t({value:e,done:i})}),e)}(s,r,(e=t[i](e)).done,e.value)}))}}}(n.entries());!(t=(h=yield a.next()).done);l=!0){s=h.value,l=!1;let t=s,e=(t[0],t[1]),i=new re;i.parent=this.curDir,i.handle=e,"file"==e.kind&&null!=this.FileFilter?this.FileFilter(e.name)&&r.push(i):r.push(i)}}catch(t){e={error:t}}finally{try{l||t||!(i=a.return)||(yield i.call(a))}finally{if(e)throw e.error}}}))}onPick(t,e){return se(this,void 0,void 0,(function*(){if(null==e.handle)this.curDir=e.parent,this.FillItems(),this.panel_File.Pick(-1);else if("file"==e.handle.kind){if(null!=this.OnPickFile){let t=yield e.handle.getFile();this.OnPickFile(t)}}else this.curDir=e,this.FillItems(),this.panel_File.Pick(-1)}))}updateFileElem(t,e,i,s){if(null==e){e=new Yt;let t=new Xt,i=J.GetPackElement().ConvertElemToSprite(J.getWhiteBlock());t.ElemNormal=new Ot(i),t.ElemNormal.localRect.setAsFill(),e.addChild(t),e.addChild(new Vt(J.GetDefFont(),"")),e.localRect.setVPosByTopBorder(20,0),e.localRect.setHPosFill(4,4),e.getChild(0).localRect.setAsFill(),e.getChild(1).localRect.setAsFill()}let r=e.getChild(0);r.Tag=i.toString(),r.OnClick=()=>{this.panel_File.Pick(i)},r.alpha=s?.5:0;let n=e.getChild(1);null!=t&&(null==t.handle?n.text="..":"file"==t.handle.kind?n.text=t.handle.name:n.text="[Path]"+t.handle.name);let h=16/n.font.GetFontSize();return n.fontScale=new A(h,h),n.halign=ft.Left,e}}var he=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{a(s.next(t))}catch(t){n(t)}}function l(t){try{a(s.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,l)}a((s=s.apply(t,e||[])).next())}))};class le{constructor(){this.y=64}OnInit(e){null==this.nav&&(this.nav=e),this.AddBackButton();let i=t.graphic.GetWebGL();this.InitUI(),this.btn_Open.OnClick=this.event_open.bind(this),this.sprite_preview=new Ct(new tt(J.GetShaderProgram("simple"))),this.panel_File.FileFilter=t=>t.includes(".png")||t.includes(".jpg")||t.includes(".jpeg"),this.panel_File.OnPickFile=e=>he(this,void 0,void 0,(function*(){let s=new Blob([yield e.arrayBuffer()]),r=URL.createObjectURL(s),n=yield t.loader.LoadImageDataAsync(r);console.log("image size:"+n.width+","+n.height),null!=this.tex_preview&&this.tex_preview.Destory(),this.tex_preview=new I(i,n.width,n.height,p.RGBA32,n.data),this.sprite_preview.material.uniformTexs.tex.value=this.tex_preview,this.img_priview.sprite=this.sprite_preview,this.img_priview.localRect.setByRect(new C(0,0,n.width,n.height)),this.panel_Image.panelWidth=n.width,this.panel_Image.panelHeight=n.height}))}event_open(){return he(this,void 0,void 0,(function*(){yield this.panel_File.OpenFolder("documents")}))}InitUI(){let t=null,e=null;{let i=new Mt;i.splitPos=.3,i.splitSize=4,i.getBorder().XLeft=2,i.getBorder().XRight=2,i.getBorder().YTop=2,i.getBorder().YBottom=10,i.localRect.setAsFill(),i.localRect.offsetY1=32,i.getSplitButton().ElemNormal=new Dt(J.GetBorderScale()),i.getSplitButton().ElemNormal.localRect.setAsFill(),this.guilayer.GetCanvas().addChild(i),i.borderElement=new Dt(J.GetBorderScale()),t=new Yt,t.localRect.setAsFill(),t.borderElement=new Dt(J.GetBorderScale()),i.getPanel1().addChild(t),e=new Yt,e.localRect.setAsFill(),e.borderElement=new Dt(J.GetBorderScale()),i.getPanel2().addChild(e)}{let e=new Vt(J.GetDefFont(),"FileNames");e.localRect.setHPosFill(),e.localRect.setVPosByTopBorder(16);let i=16/e.font.GetFontSize();e.fontScale=new A(i,i),t.addChild(e),this.panel_File=new ne,this.panel_File.localRect.setAsFill(),this.panel_File.localRect.offsetY1=16,t.addChild(this.panel_File)}this.btn_Open=J.CreateGUI_Button("打开目录",new B(1,1,1,1)),this.btn_Open.localRect.setHPosByLeftBorder(100,100),this.btn_Open.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(this.btn_Open),this.btn_Save=J.CreateGUI_Button("保存",new B(1,1,1,1)),this.btn_Save.localRect.setHPosByLeftBorder(50,210),this.btn_Save.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(this.btn_Save),this.panel_Image=new kt,this.panel_Image.localRect.setAsFill(),this.panel_Image.dragDirection=ut.Both,e.addChild(this.panel_Image),this.img_priview=new Ot,this.img_priview.localRect.setAsFill(),this.panel_Image.addChild(this.img_priview)}AddLabel(t){let e=J.CreateGUI_Label(t);this.guilayer.GetCanvas().addChild(e),e.halign=ft.Left,e.localRect.setHPosByLeftBorder(196,16),e.localRect.setVPosByTopBorder(16,this.y),this.y+=16}AddBackButton(){this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer);let e=J.CreateGUI_Button("<--",new B(1,1,1,1));e.localRect.setHPosByLeftBorder(64,16),e.localRect.setVPosByTopBorder(20,8),this.guilayer.GetCanvas().addChild(e),e.OnClick=()=>{this.nav.Back()},this.nav.GetContextObj().TopUI2Top()}OnUpdate(t){}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class ae{constructor(){this.y=32,this.x=16}OnInit(e){null==this.nav&&(this.nav=e),this.guilayer=new lt,this.guilayer.GetCamera().Scale=2*t.graphic.getDevicePixelRadio(),X.GetViewList().AddDrawLayer(this.guilayer),e.GetContextObj().TopUI2Top(),this.x=32,this.y=16,this.AddButton("工具:本地看图",new le),this.AddButton("Test:Show GL Info",new Kt),this.AddButton("Test:TextureArray",new Zt),this.AddButton("Test:Element (UBO,废弃)",new jt),this.AddButton("Test:Element (TBO)",new Nt),this.AddButton("Test:Element Tilemap[欠]",null),this.AddButton("Test:TF 粒子系统[欠]",null),this.AddButton("Test:GUI[欠]"),this.AddButton("Test:Box2d[欠]"),this.AddButton("Test:Ani[欠]"),this.AddButton("Test:Tiledmap",new ie)}AddButton(t,e=null){let i=J.CreateGUI_Button(t,new B(1,1,1,1));i.localRect.setHPosByLeftBorder(196,this.x),i.localRect.setVPosByTopBorder(20,this.y),this.guilayer.GetCanvas().addChild(i),null!=e&&(i.OnClick=()=>{this.nav.NavigatorTo(e)}),this.y+=24,this.y>256&&(this.y=32,this.x+=200)}OnUpdate(t){}OnExit(){X.GetViewList().RemoveDrawLayers(this.guilayer)}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}class oe{TopUI2Top(){let t=X.GetViewList().GetDrawLayers(f.GUI),e=t.indexOf(this.topuiview);e!=t.length-1&&(t.splice(e,1),t.push(this.topuiview))}}class de{constructor(){this.frameCount=0,this.timer=0}OnInit(){this.nav=new x(new oe);let t=this.nav.GetContextObj();t.topuiview=new lt,X.GetViewList().AddDrawLayer(t.topuiview),this.InitTopUI(t),this.nav.NavigatorTo(new ae)}InitTopUI(e){{e.topuiview.GetCamera().Scale=2*t.graphic.getDevicePixelRadio();{let t=J.CreateGUI_Label("新TTAPI",new B(0,0,0,.5));e.topuiview.GetCanvas().addChild(t),t.localRect.setHPosFill(33,31),t.localRect.setVPosByTopBorder(16,9)}let i=J.CreateGUI_Label("新TTAPI",new B(.8,1,0,1));e.topuiview.GetCanvas().addChild(i),i.localRect.setHPosFill(32,32),i.localRect.setVPosByTopBorder(16,8);let s=J.GetPackElement().ConvertElemToSprite(J.GetRoundBlock()),r=new Ot(s);r.localRect.setHPosByLeftBorder(16,0),r.localRect.setVPosByTopBorder(16,0),e.topuiview.GetCanvas().addChild(r);let n=this.label_fps=J.CreateGUI_Label("FPS:");e.topuiview.GetCanvas().addChild(n),n.halign=ft.Left,n.localRect.setHPosByLeftBorder(100,16),n.localRect.setVPosByTopBorder(16,0)}}OnUpdate(t){var e;if(null===(e=this.nav.GetLast())||void 0===e||e.OnUpdate(t),this.frameCount++,this.timer+=t,this.timer>1){let t=((this.frameCount/this.timer*10+.5|0)/10).toString();t.indexOf(".")<0&&(t+=".0"),this.label_fps.text="FPS:"+t,this.timer=0,this.frameCount=0}}OnExit(){var t;null===(t=this.nav.GetLast())||void 0===t||t.OnExit()}OnResize(t,e){var i;null===(i=this.nav.GetLast())||void 0===i||i.OnResize(t,e)}OnKey(t,e){var i;null===(i=this.nav.GetLast())||void 0===i||i.OnKey(t,e)}OnPointAfterGUI(t,e,i,s,r){var n;null===(n=this.nav.GetLast())||void 0===n||n.OnPointAfterGUI(t,e,i,s,r)}}!function(){var e,i,s,r;e=this,i=void 0,r=function*(){var e=new c.ttimpl_browser,i=document.createElement("canvas");i.style.width="100%",i.style.height="100%",i.style.border="0px",i.style.margin="0px",document.body.appendChild(i),e.Init(i),console.log("hello world");let s=yield t.loader.LoadCustomFont("VonwaonBitmap-16px","./VonwaonBitmap-16px.ttf");console.log("add font:"+s);let r=new Q;r.defFontName="VonwaonBitmap-16px",r.defFontSize=32,r.packedGrayHeight=128,r.packedGrayWidth=128,X.Start(r,new de)},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{a(r.next(t))}catch(t){n(t)}}function l(t){try{a(r.throw(t))}catch(t){n(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,l)}a((r=r.apply(e,i||[])).next())}))}()})();