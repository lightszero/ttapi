(()=>{"use strict";var t,e;!function(t){t.sleep=function(t){return e=this,i=void 0,r=function*(){return new Promise((e=>setTimeout(e,t)))},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}l((r=r.apply(e,i||[])).next())}));var e,i,s,r};class e{constructor(){this.id=0,this.x=0,this.y=0,this.press=!1,this.move=!1}Clone(){let t=new e;return t.id=this.id,t.x=this.x,t.y=this.y,t.press=this.press,t}}t.InputPoint=e,t.ImageBuffer=class{constructor(){this.width=0,this.height=0,this.gray=!1,this.data=null}}}(t||(t={})),function(e){e.ttimpl_graphics=class{constructor(t,e){this._MainScreenScale=1,this.OnUpdate=null,this.OnResize=null,this.OnRender=null,this._webgl=t,this.c2d=e}GetBackGroundC2D(){return this.c2d}GetWebGL(){return this._webgl}getMainScreenScale(){return this._MainScreenScale}setMainScreenScale(t){this._MainScreenScale=t,this.UpdateScreenSize()}UpdateScreenSize(){let e=this._webgl.canvas;var i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height))}getDeviceScreenWidth(){return this._webgl.canvas.clientWidth}getDeviceScreenHeight(){return this._webgl.canvas.clientHeight}getDevicePixelRadio(){return window.devicePixelRatio}getFinalScale(){return this.getDevicePixelRadio()/this._MainScreenScale}}}(e||(e={}));var i,s=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};!function(e){e.Loader=class{LoadStringAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.text()}))}LoadBinaryAsync(t){return s(this,void 0,void 0,(function*(){let e=yield fetch(t);return yield e.arrayBuffer()}))}LoadImageAsync(t){return new Promise(((e,i)=>{let s=new Image;s.src=t;let r=!1;s.onload=t=>{r=!0,e(s)},s.onerror=t=>{r=!0,s=null,i("img error:"+t.toString())}}))}LoadImageDataAsync(e){return s(this,void 0,void 0,(function*(){let i=yield this.LoadImageAsync(e),s=t.graphic.GetBackGroundC2D();return s.canvas.width=i.width,s.canvas.height=i.height,s.clearRect(0,0,i.width,i.height),s.drawImage(i,0,0),s.getImageData(0,0,i.width,i.height)}))}LoadCustomFont(t,e){return s(this,void 0,void 0,(function*(){const i=new FontFace(t,"url("+e+")");let s=yield i.load();return document.fonts.add(s),s.family}))}}}(i||(i={}));var r,n=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};!function(t){class e{constructor(t,e,i){null!=e&&null==i?(this.loaded=!1,this.initByUrlAsync(t,e)):null!=i&&null==e&&this.initByDataAsync(t,i)}initByUrlAsync(t,e){return n(this,void 0,void 0,(function*(){let i=yield fetch(e),s=yield i.arrayBuffer();this.buffer=yield t.decodeAudioData(s)}))}initByDataAsync(t,e){return n(this,void 0,void 0,(function*(){this.buffer=yield t.decodeAudioData(e),this.loaded=!0}))}}class i{constructor(t,e){let i=new HTMLAudioElement;this.url=i.src=e,i.loop=!0,this.node=t.createMediaElementSource(i),this.loaded=!1,i.onload=()=>{this.loaded=!0},i.loop=!0,i.onended=()=>{null!=this.onEnd&&this.onEnd(this)}}setLoop(t){this.node.mediaElement.loop=t}getLoop(){return this.node.mediaElement.loop}}class s{constructor(t){this.sourceBGM=null,this.inBGM=!1,this.audioContext=t,this.vol=this.audioContext.createGain(),this.vol.gain.value=1,this.vol.connect(this.audioContext.destination)}SetBGM(t){this.inBGM&&(this.inBGM=!1,this.sourceBGM.disconnect(),this.sourceBGM=null),null!=t&&(this.sourceBGM=t.node,this.sourceBGM.connect(this.vol))}setVolume(t){this.vol.gain.value=t}getVolume(){return this.vol.gain.value}PlaySound(t){let e=this.audioContext.createBufferSource();e.buffer=t.buffer,e.connect(this.vol),e.loop=!1,e.start(),null!=t.onEnd&&(e.onended=()=>{t.onEnd(t)})}}t.Channel_Impl=s,t.AudioImpl=class{constructor(){this.channels=[];try{this.audioContext=new AudioContext,console.log("audio Context inited")}catch(t){throw console.error("!Your browser does not support AudioContext"),new Error("!Your browser does not support AudioContext")}this.Init()}GetChannel(t){if(t>16||t<0)throw new Error("error channel id.");for(;this.channels.length<=t;)this.channels.push(null);return null==this.channels[t]&&(this.channels[t]=new s(this.audioContext)),this.channels[t]}CreateBGM(t){return new i(this.audioContext,t)}CreateSound(t){return new e(this.audioContext,t,null)}CreateSoundFromArrayBuffer(t){return new e(this.audioContext,null,t)}Init(){if(null!=this.audioContext){var t=this.audioContext.createBuffer(1,1,22050),e=this.audioContext.createBufferSource();e.buffer=t,e.connect(this.audioContext.destination),e.start()}}ReInit(){this.Init()}}}(r||(r={}));var h,o;!function(e){e.Input=class{constructor(t){this._mousepress=!1,this.lasttouchx=-1,this.lasttouchy=-1,this._pressKeys=[],this.points=[],this.ishow=!1,this.Start(t)}Start(t){window.addEventListener("keydown",(t=>{this.UpdateKey(t.code,!0)})),window.addEventListener("keyup",(t=>{this.UpdateKey(t.code,!1)})),t.addEventListener("mousedown",(t=>{if(0==t.button){if(this.lasttouchx==t.x&&this.lasttouchy==t.y)return console.log("cancel sim mouse"),this.lasttouchx=-1,void(this.lasttouchy=-1);this.UpdateMouse(t,!0,!1),this._mousepress=!0}})),t.addEventListener("mouseup",(t=>{0==t.button&&(this.UpdateMouse(t,!1,!1),this._mousepress=!1)})),t.addEventListener("mousemove",(t=>{0==t.button&&this._mousepress&&this.UpdateMouse(t,!0,!0)})),t.addEventListener("touchstart",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!1)})),t.addEventListener("touchmove",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!0,!0)})),t.addEventListener("touchend",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)})),t.addEventListener("touchcancel",(t=>{for(var e=0;e<t.changedTouches.length;e++)this.UpdatePoint(t.changedTouches[e],!1,!1)}))}UpdateMouse(e,i,s){for(;this.points.length<=0;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[0].id=0,this.points[0].press=i,this.points[0].x=e.x,this.points[0].y=e.y,null!=this.OnPoint&&this.OnPoint(0,e.x,e.y,i,s)}UpdatePoint(e,i,s){let r=e.identifier+1;for(;this.points.length<=r;){let e=new t.InputPoint;e.id=this.points.length,e.press=!1,e.x=0,e.y=0,this.points.push(e)}this.points[r].press=i,this.points[r].x=e.clientX,this.points[r].y=e.clientY,i&&(this.lasttouchx=0|e.clientX,this.lasttouchy=0|e.clientY),null!=this.OnPoint&&this.OnPoint(r,e.clientX,e.clientY,i,s)}UpdateKey(t,e){if(e){if(this._pressKeys.indexOf(t)>=0)return;this._pressKeys.push(t)}else{let e=this._pressKeys.indexOf(t);e>=0&&this._pressKeys.splice(e,1)}console.log("Input Key:"+t+"="+e),null!=this.OnKey&&this.OnKey(t,e)}GetPressKeys(){return this._pressKeys}IsKeyDown(t){return this._pressKeys.indexOf(t)>=0}GetInputPoints(){return this.points}Prompt(t){return e=this,i=arguments,r=function*(t,e="",i=256){for(var s=0;s<this.points.length;s++)this.points[s].press=!1;return window.prompt(t,e)},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}l((r=r.apply(e,i||[])).next())}));var e,i,s,r}}}(h||(h={})),function(t){t.Platform=class{getPlatformName(){return"browser_"+window.navigator.userAgent}}}(o||(o={}));var l=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};class a{constructor(){this._loaded=0,this.InitAsync()}Init(){return l(this,void 0,void 0,(function*(){return 0!=this._loaded?1==this._loaded||(this._loaded,!1):(this._loaded=-1,this._loaded=yield d.OpenOrCreateDB("_ttstore_"),this.IsReady())}))}InitAsync(){return l(this,void 0,void 0,(function*(){}))}IsReady(){return 1==this._loaded}GetText(t){return l(this,void 0,void 0,(function*(){return yield d.GetStringValue(t)}))}GetBinary(t){return l(this,void 0,void 0,(function*(){return yield d.GetBinaryValue(t)}))}SaveText(t,e){return l(this,void 0,void 0,(function*(){yield d.SetStringValue(t,e)}))}SaveBinary(t,e){return l(this,void 0,void 0,(function*(){yield d.SetBinaryValue(t,e)}))}SaveDataToLocal(t,e){return l(this,void 0,void 0,(function*(){var i=document.createElement("a");i.download=t,i.style.display="none";var s=new Blob([e]);return i.href=URL.createObjectURL(s),document.body.appendChild(i),i.click(),document.body.removeChild(i),!0}))}}const c="__store__";class d{static DeleteDb(e){return l(this,void 0,void 0,(function*(){let i=indexedDB.deleteDatabase(e),s=0;for(i.onsuccess=()=>{console.log("db delete succ."),s=1},i.onerror=()=>{console.log("db delete error."),s=2};0==s;)yield t.sleep(1)}))}static OpenOrCreateDB(e){return l(this,void 0,void 0,(function*(){let i=0,s=indexedDB.open(e,1);for(s.onsuccess=t=>{console.log("db open"),i=1,this.db=s.result},s.onerror=()=>{console.log(" dbreq.onerror"),i=2,this.db=null},s.onupgradeneeded=t=>{console.log("db onupgradeneeded"),this.db=s.result,this.db.createObjectStore(c,{keyPath:["_id"]}).createIndex("_id","_id",{unique:!0}),console.log(" --create store--")};0==i;)yield t.sleep(1);return i}))}static SetStringValue(e,i){return l(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(c,"readwrite"),r=0,n=s.objectStore(c).put({_id:e,value:i,format:"text"});for(n.onsuccess=t=>{r=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},n.onerror=t=>{r=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==r;)yield t.sleep(1)}))}static SetBinaryValue(e,i){return l(this,void 0,void 0,(function*(){if(null==this.db)return;let s=this.db.transaction(c,"readwrite"),r=0,n=s.objectStore(c).put({_id:e,value:i,format:"hex"});for(n.onsuccess=t=>{r=1,console.log("SetValue  key:"+e+" data:"+JSON.stringify(i))},n.onerror=t=>{r=2,console.log("SetValue fail  key:"+e+" data:"+JSON.stringify(i))};0==r;)yield t.sleep(1)}))}static GetValue(e){return l(this,void 0,void 0,(function*(){if(null==this.db)return null;let i=this.db.transaction(c,"readonly").objectStore(c).index("_id").get(e),s=0;for(i.onsuccess=t=>{s=1,console.log("GetValue key:"+e+" data:"+JSON.stringify(i.result))},i.onerror=t=>{s=2,console.log("GetValue Fail key:"+JSON.stringify(i.result))};0==s;)yield t.sleep(1);return i.result}))}static GetBinaryValue(t){return l(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("hex"==e.format)return e.value;throw new Error("format is text.")}))}static GetStringValue(t){return l(this,void 0,void 0,(function*(){let e=yield this.GetValue(t);if(null==e)return null;if("text"==e.format)return e.value;throw new Error("format is text.")}))}}var u,f,p,_,g,v,m,w,x,y,R,b;d.db=null,function(s){s.ttimpl_browser=class{constructor(){this.timerMs=0}Init(s){if(this.webgl=s.getContext("webgl2",{antialias:!1}),null!=this.webgl){let i=new OffscreenCanvas(32,32).getContext("2d",{colorSpace:"srgb",willReadFrequently:!0});t.graphic=new e.ttimpl_graphics(this.webgl,i),this.timerMs=(new Date).getTime(),requestAnimationFrame(this.Update.bind(this))}else console.error("init webgl error.");t.loader=new i.Loader,t.audio=new r.AudioImpl,t.input=new h.Input(s),t.platform=new o.Platform,t.store=new a}ReInitAudio(){}SendEnvEventToUser(t,e){}Update(){if(null!=this.webgl){var e=this.webgl.canvas,i=t.graphic.getDeviceScreenWidth()*t.graphic.getFinalScale()|0,s=t.graphic.getDeviceScreenHeight()*t.graphic.getFinalScale()|0;t.graphic.getDevicePixelRadio(),e.width==i&&e.height==s||(console.log("--resize wantwidth = "+i+" ,wantheight="+s),e.width=i,e.height=s,null!=t.graphic.OnResize&&t.graphic.OnResize(e.width,e.height)),requestAnimationFrame(this.Update.bind(this));var r=(new Date).getTime(),n=(r-this.timerMs)/1e3;this.timerMs=r,null!=t.graphic.OnUpdate&&t.graphic.OnUpdate(n),null!=t.graphic.OnRender&&t.graphic.OnRender()}}}}(u||(u={}));class A{constructor(t,e,i,s=1){this.R=t,this.G=e,this.B=i,this.A=s}static get White(){return new A(1,1,1,1)}static get Black(){return new A(0,0,0,1)}static get Tran(){return new A(0,0,0,0)}Clone(){return new A(this.R,this.G,this.B,this.A)}static Lerp(t,e,i){return new A(t.R*(1-i)+e.R*i,t.G*(1-i)+e.G*i,t.B*(1-i)+e.B*i,t.A*(1-i)+e.A*i)}static FromH360(t){let e=A.White,i=t%120/120;i<0&&(i+=1);let s=.5*Math.sin(i*Math.PI);return i>.5&&(s=1-s),t<120?(s<=.5?(e.B=1,e.R=s/(1-s)):(e.R=1,e.B=1*(1-s)/s),e.G=0):t<240?(s<=.5?(e.R=1,e.G=1*s/(1-s)):(e.G=1,e.R=1*(1-s)/s),e.B=0):(e.R=0,s<=.5?(e.G=1,e.B=1*s/(1-s)):(e.B=1,e.G=1*(1-s)/s)),e}}class E{constructor(t,e){this.X=t,this.Y=e}Clone(){return new E(this.X,this.Y)}static get One(){return new E(1,1)}static get Zero(){return new E(0,0)}static Length(t){return Math.sqrt(t.X*t.X+t.Y*t.Y)}static Dist(t,e){return Math.sqrt((t.X-e.X)*(t.X-e.X)+(t.Y-e.Y)*(t.Y-e.Y))}static Dir(t,e){let i=E.Dist(t,e);return new E((e.X-t.X)/i,(e.Y-t.Y)/i)}static Add(t,e){return new E(t.X+e.X,t.Y+e.Y)}static Normal(t){let e=E.Length(t);return new E(t.X/e,t.Y/e)}}class B{constructor(t,e,i,s){this.X=t,this.Y=e,this.Width=i,this.Height=s}}class T{static Clone(t){return new B(t.X,t.Y,t.Width,t.Height)}static Intersect(t,e){let i=t.X,s=t.X+t.Width,r=t.Y,n=t.Y+t.Height,h=e.X,o=e.Y,l=h+e.Width,a=o+e.Height;if(i>=l||h>=s||r>=a||o>=n)return new B(0,0,0,0);let c=Math.max(i,h),d=Math.max(r,o),u=Math.min(s,l),f=Math.min(n,a);return new B(c,d,u-c,f-d)}}class G{constructor(t,e,i,s){this.XLeft=t,this.YTop=e,this.XRight=i,this.YBottom=s}}class S{constructor(t,e,i,s){this.U1=t,this.V1=e,this.U2=i,this.V2=s}}!function(t){t[t.R8=0]="R8",t[t.RGBA32=1]="RGBA32",t[t.F_R8=2]="F_R8",t[t.F_RGBA=3]="F_RGBA"}(f||(f={}));class U{IsArray(){return!1}GetLayer(){return 0}constructor(t,e,i,s,r){if(this._webgl=t,this._format=s,this._texobj=t.createTexture(),this._id=U.texid,this._width=e,this._height=i,U.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==f.F_R8||this._format==f.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==f.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==f.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),null==r)this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,null);else{let t=s==f.RGBA32?4:1;if(r.length!=this._width*this._height*t)throw new Error("wrong texSize");this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,e,i,0,this._formatGL,this._typeGL,r)}}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}ReSize(t,e){this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,t,e,0,this._formatGL,this._typeGL,null),this._width=t,this._height=e}UploadImg(t){this._width=t.width,this._height=t.height,this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texImage2D(this._webgl.TEXTURE_2D,0,this._formatInnerGL,this._formatGL,this._typeGL,t)}UploadTexture(t,e,i,s,r){this._webgl.bindTexture(this._webgl.TEXTURE_2D,this._texobj),this._webgl.texSubImage2D(this._webgl.TEXTURE_2D,0,t,e,i,s,this._formatGL,this._typeGL,r)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}U.texid=1;class C{IsArray(){return!0}GetLayer(){return this._layer}constructor(t,e,i,s,r){this._webgl=t,this._format=r,this._layer=s,this._texobj=t.createTexture(),this._texobj,this._id=U.texid,this._width=e,this._height=i,U.texid++,this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl.pixelStorei(this._webgl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._webgl.pixelStorei(this._webgl.UNPACK_FLIP_Y_WEBGL,0),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MIN_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_MAG_FILTER,this._webgl.NEAREST),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_S,this._webgl.CLAMP_TO_EDGE),this._webgl.texParameteri(this._webgl.TEXTURE_2D_ARRAY,this._webgl.TEXTURE_WRAP_T,this._webgl.CLAMP_TO_EDGE),this._format==f.F_R8||this._format==f.F_RGBA?(this._typeGL=this._webgl.FLOAT,this._format==f.F_RGBA?(this._formatInnerGL=this._webgl.RGBA32F,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R32F,this._formatGL=this._webgl.RED)):(this._typeGL=this._webgl.UNSIGNED_BYTE,this._format==f.RGBA32?(this._formatInnerGL=this._webgl.RGBA,this._formatGL=this._webgl.RGBA):(this._formatInnerGL=this._webgl.R8,this._formatGL=this._webgl.RED)),this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._webgl,this._webgl.texImage3D(this._webgl.TEXTURE_2D_ARRAY,0,this._formatInnerGL,e,i,this._layer,0,this._formatGL,this._typeGL,null)}getID(){return this._id}getGLTex(){return this._texobj}getFormat(){return this._format}getWidth(){return this._width}getHeight(){return this._height}IsTarget(){return!1}UploadSubTexture(t,e,i,s,r,n){this._webgl.bindTexture(this._webgl.TEXTURE_2D_ARRAY,this._texobj),this._format==f.RGBA32?this._webgl.RGBA:this._webgl.R8,this._webgl.UNSIGNED_BYTE,this._webgl.texSubImage3D(this._webgl.TEXTURE_2D_ARRAY,0,e,i,t,s,r,1,this._formatGL,this._typeGL,n)}Destory(){null!=this._texobj&&this._webgl.deleteTexture(this._texobj),this._texobj=null}}class L{constructor(t){this.rectLimit=[],this._webgl=t,console.log("webgl init size:"+t.canvas.width+","+t.canvas.height)}IsArray(){return!1}GetLayer(){return 0}IsMainOutput(){return!0}Begin(){this._webgl.bindFramebuffer(this._webgl.FRAMEBUFFER,null),this._webgl.viewport(0,0,this.getWidth(),this.getHeight()),this.ResetLimitRect()}Clear(t){this._webgl.clearColor(t.R,t.G,t.B,t.A),this._webgl.clear(this._webgl.COLOR_BUFFER_BIT)}End(){this._webgl.flush()}getID(){return 0}getGLTex(){return null}getFormat(){return f.RGBA32}getWidth(){return this._webgl.canvas.width}getHeight(){return this._webgl.canvas.height}getData(){throw new Error("not spport on MainScreen.")}IsStatic(){return!0}IsTarget(){return!0}UploadTexture(t,e,i,s,r){throw new Error("MainScreen Method not implemented.")}ApplyTexture(t){throw new Error("MainScreen Method not implemented.")}Destory(){throw new Error("MainScreen Method not implemented.")}Resize(t,e){throw new Error("MainScreen Method not implemented.")}PushLimitRect(t){let e=null;if(0==this.rectLimit.length)e=T.Clone(t);else{let i=this.rectLimit[this.rectLimit.length-1];e=T.Intersect(i,t)}this.rectLimit.push(e),this.ResetLimitRect()}PopLimitRect(){this.rectLimit.splice(this.rectLimit.length-1,1),this.ResetLimitRect()}ClearLimitRect(){this.rectLimit.splice(0,this.rectLimit.length),this.ResetLimitRect()}ResetLimitRect(){if(0==this.rectLimit.length)this._webgl.disable(this._webgl.SCISSOR_TEST);else{let t=this.rectLimit[this.rectLimit.length-1];this._webgl.enable(this._webgl.SCISSOR_TEST),this._webgl.scissor(t.X,this.getHeight()-t.Y-t.Height,t.Width,t.Height)}}}class X{constructor(){this.clearcolor=new A(0,0,0,1),this.maintarget=null}Render(t){null==this.maintarget&&(this.maintarget=P.GetMainScreen()),this.maintarget.Begin(),this.maintarget.Clear(this.clearcolor),t.RenderDrawLayers(p.Main,this.maintarget,0),t.RenderDrawLayers(p.GUI,this.maintarget,0),this.maintarget.End()}}!function(t){t[t.ERROR=0]="ERROR",t[t.Main=1]="Main",t[t.GUI=2]="GUI",t[t.PreRender=3]="PreRender",t[t.POSTRender=4]="POSTRender",t[t.CUSTOM=5]="CUSTOM"}(p||(p={}));class I{constructor(){this.LookAt=E.Zero,this.Scale=2,this._viewmatrix=new Float32Array(16),this._projmatrix=new Float32Array(16)}GetViewMatrix(){let t=this._viewmatrix,e=this.Scale,i=this.Scale,s=-this.LookAt.X,r=-this.LookAt.Y;return t[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1,this._viewmatrix}GetProjMatrix(t){let e=this._projmatrix,i=2/t.getWidth(),s=2/t.getHeight();return t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,e}}class D{constructor(t){this.camera=new I,this.renders=[],this.numbertag=t}GetTag(){return this.numbertag}GetCamera(){return this.camera}GetRenders(){return this.renders}GetGUIs(t){for(let e=0;e<this.renders.length;e++){let i=this.renders[e];null!=i.GetGUI()&&t.push(i.GetGUI())}}AddRender(t){this.renders.push(t)}Update(t){for(let e=0;e<this.renders.length;e++)this.renders[e].OnUpdate(t)}Render(t,e){for(let i=0;i<this.renders.length;i++)this.renders[i].OnRender(t,this.camera,e)}}class O{constructor(){this.mapviews={},this.pipeline=new X}AddDrawLayer(t){let e=t.GetTag();null==this.mapviews[e]&&(this.mapviews[e]=[]),this.mapviews[e].push(t)}RemoveDrawLayers(t){let e=t.GetTag(),i=this.GetDrawLayers(e),s=i.indexOf(t);s>=0&&i.splice(s,1)}GetDrawLayers(t){return null==this.mapviews[t]&&(this.mapviews[t]=[]),this.mapviews[t]}RenderDrawLayers(t,e,i){let s=this.GetDrawLayers(t);if(null!=s){for(let t=0;t<s.length;t++)s[t].Render(e,i);return s.length}return 0}GetDrawLayerTags(){let t=[];for(let e in this.mapviews)t.push(e);return t}Update(t){for(let e in this.mapviews){let i=this.mapviews[e];for(let e=0;e<i.length;e++)i[e].Update(t)}}Render(){this.pipeline.Render(this)}}class P{static Start(e,i){let s=t.graphic.GetWebGL();q.Init(e),this._mainscreen=new L(s),this._viewlist=new O,this.regevent(),this.SetUserLogic(i)}static regevent(){t.graphic.OnRender=this.OnRender.bind(this),t.graphic.OnUpdate=this.OnUpdate.bind(this),t.graphic.OnResize=this.OnResize.bind(this),t.input.OnPoint=this.OnPoint.bind(this),t.input.OnKey=this.OnKey.bind(this)}static Pause(t){this._pause=t}static SetUserLogic(t){null!=this._state&&this._state.OnExit(),this._state=t,null!=this._state&&this._state.OnInit()}static GetViewList(){return this._viewlist}static Fence(){return!this._willfence&&(this._willfence=!0,!0)}static CanFence(){return!this._willfence}static GetFenceID(){return this._fenceid}static GetMainScreen(){return this._mainscreen}static OnUpdate(t){this._pause||(this._viewlist.Update(t),null!=this._state&&this._state.OnUpdate(t))}static OnResize(t,e){this._pause||null!=this._state&&this._state.OnResize(t,e)}static OnRender(){if(this._pause)return;let e=t.graphic.GetWebGL();this._viewlist.Render(),this._willfence&&this.DoFence(e)}static DoFence(t){this._willfence=!1;let e=t.fenceSync(t.SYNC_GPU_COMMANDS_COMPLETE,0);t.flush();let i=()=>{let s=t.clientWaitSync(e,0,0);if(s==t.TIMEOUT_EXPIRED||s==t.WAIT_FAILED)return console.log("=>not signed."),void setTimeout(i,0);console.log("=>signed."),t.deleteSync(e),this._willfence=!1,this._fenceid++};setTimeout(i,0)}static OnPoint(t,e,i,s,r){if(this._pause)return;let n=this._viewlist.GetDrawLayers(p.GUI);if(null!=n)for(let h=n.length-1;h>=0;h--){let o=!1,l=n[h].GetRenders();for(let n=l.length-1;n>=0;n--){let h=l[n].GetGUI();if(null!=h&&(o=h.OnTouch(null,t,s,r,e,i),o))break}if(o)break}null!=this._state&&this._state.OnPointAfterGUI(t,e,i,s,r)}static OnKey(t,e){this._pause||null!=this._state&&this._state.OnKey(t,e)}}P._pause=!1,P._mainscreen=null,P._state=null,P._viewlist=null,P._willfence=!1,P._fenceid=0,function(t){t[t.VertexShader=0]="VertexShader",t[t.FragmentShader=1]="FragmentShader"}(_||(_={})),function(t){t[t.empty=0]="empty",t[t.unknown=1]="unknown",t[t.mat4=2]="mat4",t[t.sampler2D=3]="sampler2D",t[t.block=4]="block",t[t.float=5]="float",t[t.int=6]="int",t[t.vec4=7]="vec4",t[t.ivec4=8]="ivec4"}(g||(g={}));class F{constructor(t,e,i){this.type=t,this.name=e,this.shader=i}}class Y{constructor(t,e,i,s,r){this.name=e,this.program=i;var n=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES);for(let e=0;e<n;e++){var h=t.getActiveAttrib(i,e);t.getAttribLocation(i,h.name)}this.uniformInfos={};var o=t.getProgramParameter(i,t.ACTIVE_UNIFORMS);for(let e=0;e<o;e++){var l=t.getActiveUniform(i,e);let s=t.getUniformLocation(this.program,l.name);if(null==s)break;let r=g.empty;switch(l.type){case t.INT:r=g.int;break;case t.FLOAT:r=g.float;break;case 35666:r=g.vec4;break;case 35666:r=g.ivec4;break;case 35676:r=g.mat4;break;case 35678:case 36289:r=g.sampler2D;break;default:throw"ShaderProgram.ctor not supported."+l.type.toString(16)}this.uniformInfos[l.name]={loc:s,locblock:-1,type:r}}var a=t.getProgramParameter(i,t.ACTIVE_UNIFORM_BLOCKS);for(let e=0;e<a;e++){var c=t.getActiveUniformBlockName(i,e);let s=t.getUniformBlockIndex(this.program,c);null==s||s<0||(this.uniformInfos[c]={loc:null,locblock:s,type:g.block})}}AddUniform(t,e,i){if(i==g.block){let s=t.getUniformBlockIndex(this.program,e);if(null==s||s<0)return;this.uniformInfos[e]={loc:null,locblock:s,type:i}}else{let s=t.getUniformLocation(this.program,e);if(null==s)return;this.uniformInfos[e]={loc:s,locblock:-1,type:i}}}}class V{constructor(t=0,e=0,i=0,s=0,r=!1,n=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=t,this._height=e,this._x=i,this._y=s,this._data={},this._rot=r,this._allowRotation=n}static Collide(t,e){return t.collide(e)}static Contain(t,e){return t.contain(e)}area(){return this.width*this.height}collide(t){return t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y}contain(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._dirty++)}get height(){return this._height}set height(t){t!==this._height&&(this._height=t,this._dirty++)}get x(){return this._x}set x(t){t!==this._x&&(this._x=t,this._dirty++)}get y(){return this._y}set y(t){t!==this._y&&(this._y=t,this._dirty++)}get rot(){return this._rot}set rot(t){if(!1!==this._allowRotation&&this._rot!==t){const e=this.width;this.width=this.height,this.height=e,this._rot=t,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(t){this._allowRotation!==t&&(this._allowRotation=t,this._dirty++)}get data(){return this._data}set data(t){null!==t&&t!==this._data&&(this._data=t,"object"==typeof t&&t.hasOwnProperty("allowRotation")&&(this._allowRotation=t.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(t=!0){this._dirty=t?this._dirty+1:0}}(R=v||(v={}))[R.MAX_AREA=0]="MAX_AREA",R[R.MAX_EDGE=1]="MAX_EDGE";class W{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some((t=>t.dirty))}setDirty(t=!0){if(this._dirty=t?this._dirty+1:0,!t)for(let t of this.rects)t.setDirty&&t.setDirty(!1)}}class M extends W{constructor(t=4096,e=4096,i=0,s={}){super(),this.maxWidth=t,this.maxHeight=e,this.padding=i,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:v.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),s),this.width=this.options.smart?0:t,this.height=this.options.smart?0:e,this.border=this.options.border?this.options.border:0,this.freeRects.push(new V(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)),this.stage=new V(this.width,this.height)}add(...t){let e,i;if(1===t.length){if("object"!=typeof t[0])throw new Error("MacrectsBin.add(): Wrong parameters");i=t[0];let e=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==e)return}else{if(e=t.length>2?t[2]:null,this.options.tag&&this.options.exclusiveTag){if(e&&this.tag!==e.tag)return;if(!e&&this.tag)return}i=new V(t[0],t[1]),i.data=e,i.setDirty(!1)}const s=this.place(i);return s&&this.rects.push(s),s}repack(){let t=[];this.reset(),this.rects.sort(((t,e)=>{const i=Math.max(e.width,e.height)-Math.max(t.width,t.height);return 0===i&&t.hash&&e.hash?t.hash>e.hash?-1:1:i}));for(let e of this.rects)this.place(e)||t.push(e);for(let e of t)this.rects.splice(this.rects.indexOf(e),1);return t.length>0?t:void 0}reset(t=!1,e=!1){t&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],e&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new V(this.maxWidth+this.padding-2*this.border,this.maxHeight+this.padding-2*this.border,this.border,this.border)],this.stage=new V(this.width,this.height),this._dirty=0}clone(){let t=new M(this.maxWidth,this.maxHeight,this.padding,this.options);for(let e of this.rects)t.add(e);return t}place(t){let e,i,s=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;if(!this.options.tag||!this.options.exclusiveTag||this.tag===s){if(i=t.hasOwnProperty("_allowRotation")&&void 0!==t.allowRotation?t.allowRotation:this.options.allowRotation,e=this.findNode(t.width+this.padding,t.height+this.padding,i),e){this.updateBinSize(e);let i=this.freeRects.length,s=0;for(;s<i;)this.splitNode(this.freeRects[s],e)&&(this.freeRects.splice(s,1),i--,s--),s++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,t.x=e.x,t.y=e.y,void 0===t.rot&&(t.rot=!1),t.rot=e.rot?!t.rot:t.rot,this._dirty++,t}if(this.verticalExpand){if(this.updateBinSize(new V(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new V(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(t)}else if(this.updateBinSize(new V(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new V(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(t)}}findNode(t,e,i){let s,r,n,h=Number.MAX_VALUE;for(let o in this.freeRects)r=this.freeRects[o],r.width>=t&&r.height>=e&&(s=this.options.logic===v.MAX_AREA?r.width*r.height-t*e:Math.min(r.width-t,r.height-e),s<h&&(n=new V(t,e,r.x,r.y),h=s)),i&&r.width>=e&&r.height>=t&&(s=this.options.logic===v.MAX_AREA?r.width*r.height-e*t:Math.min(r.height-t,r.width-e),s<h&&(n=new V(e,t,r.x,r.y,!0),h=s));return n}splitNode(t,e){if(!t.collide(e))return!1;if(e.x<t.x+t.width&&e.x+e.width>t.x){if(e.y>t.y&&e.y<t.y+t.height){let i=new V(t.width,e.y-t.y,t.x,t.y);this.freeRects.push(i)}if(e.y+e.height<t.y+t.height){let i=new V(t.width,t.y+t.height-(e.y+e.height),t.x,e.y+e.height);this.freeRects.push(i)}}if(e.y<t.y+t.height&&e.y+e.height>t.y){if(e.x>t.x&&e.x<t.x+t.width){let i=new V(e.x-t.x,t.height,t.x,t.y);this.freeRects.push(i)}if(e.x+e.width<t.x+t.width){let i=new V(t.x+t.width-(e.x+e.width),t.height,e.x+e.width,t.y);this.freeRects.push(i)}}return!0}pruneFreeList(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;let s=this.freeRects[t];for(;e<i;){let r=this.freeRects[e];if(r.contain(s)){this.freeRects.splice(t,1),t--,i--;break}s.contain(r)&&(this.freeRects.splice(e,1),e--,i--),e++}t++}}updateBinSize(t){if(!this.options.smart)return!1;if(this.stage.contain(t))return!1;let e=Math.max(this.width,t.x+t.width-this.padding+this.border),i=Math.max(this.height,t.y+t.height-this.padding+this.border);if(this.options.allowRotation){const s=Math.max(this.width,t.x+t.height-this.padding+this.border),r=Math.max(this.height,t.y+t.width-this.padding+this.border);s*r<e*i&&(e=s,i=r)}return this.options.pot&&(e=Math.pow(2,Math.ceil(Math.log(e)*Math.LOG2E)),i=Math.pow(2,Math.ceil(Math.log(i)*Math.LOG2E))),this.options.square&&(e=i=Math.max(e,i)),!(e>this.maxWidth+this.padding||i>this.maxHeight+this.padding||(this.expandFreeRects(e+this.padding,i+this.padding),this.width=this.stage.width=e,this.height=this.stage.height=i,0))}expandFreeRects(t,e){this.freeRects.forEach(((i,s)=>{i.x+i.width>=Math.min(this.width+this.padding-this.border,t)&&(i.width=t-i.x-this.border),i.y+i.height>=Math.min(this.height+this.padding-this.border,e)&&(i.height=e-i.y-this.border)}),this),this.freeRects.push(new V(t-this.width-this.padding,e-2*this.border,this.width+this.padding-this.border,this.border)),this.freeRects.push(new V(t-2*this.border,e-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter((t=>!(t.width<=0||t.height<=0||t.x<this.border||t.y<this.border))),this.pruneFreeList()}}class k{constructor(){this.index=-1}}!function(t){t[t.R2Gray=0]="R2Gray",t[t.R2Alpha=1]="R2Alpha"}(m||(m={})),function(t){t[t.R=0]="R",t[t.GRAY=1]="GRAY",t[t.Alpha=2]="Alpha"}(w||(w={}));class N{constructor(){this.toRgba=m.R2Alpha,this.toR=w.GRAY,this.pivotX=0,this.pivotY=0}CopyPixel(t,e,i,s,r){if(i==f.R8&&this.format==f.R8){let i=this.data[r*this.width+s];t[e]=i}else if(i==f.RGBA32&&this.format==f.RGBA32){let i=this.data[4*(r*this.width+s)+0],n=this.data[4*(r*this.width+s)+1],h=this.data[4*(r*this.width+s)+2],o=this.data[4*(r*this.width+s)+3];t[e]=i,t[e+1]=n,t[e+2]=h,t[e+3]=o}else if(i==f.R8&&this.format==f.RGBA32){let i=0;this.toR==w.R?i=this.data[4*(r*this.width+s)+0]:this.toR==w.GRAY?i=.3*this.data[4*(r*this.width+s)+0]+.6*this.data[4*(r*this.width+s)+1]+.1*this.data[4*(r*this.width+s)+2]:this.toR==w.Alpha&&(i=this.data[4*(r*this.width+s)+3]),t[e]=i}else if(i==f.RGBA32&&this.format==f.R8){let i=this.data[r*this.width+s];this.toRgba==m.R2Gray?(t[e]=i,t[e+1]=i,t[e+2]=i,t[e+3]=255):(t[e]=255,t[e+1]=255,t[e+2]=255,t[e+3]=i)}}ConvertToR(){if(this.format!=f.RGBA32)throw"only rgba can convert to R";let t=new N;t.format=f.R8,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=e*this.width+i;this.CopyPixel(t.data,s,f.R8,i,e)}return t}ConvertToRGBA(){if(this.format!=f.R8)throw"only r8 can convert to Rgba";let t=new N;t.format=f.RGBA32,t.width=this.width,t.height=this.height,t.pivotX=this.pivotX,t.pivotY=this.pivotY,t.data=new Uint8Array(this.width*this.height);for(let e=0;e<this.height;e++)for(let i=0;i<this.width;i++){let s=4*(e*this.width+i);this.CopyPixel(t.data,s,f.RGBA32,i,e)}return t}Cut(t,e,i,s){let r=new N;r.format=this.format,r.toRgba=this.toRgba,r.toR=this.toR,r.width=i,r.height=s;let n=f.RGBA32?4:1;r.data=new Uint8Array(i*s*n);for(let h=0;h<s;h++)for(let s=0;s<i;s++){let o=h*i+s,l=(h+e)*this.width+(s+t);1==n?r.data[o]=this.data[l]:(r.data[4*o+0]=this.data[4*l+0],r.data[4*o+1]=this.data[4*l+1],r.data[4*o+2]=this.data[4*l+2],r.data[4*o+3]=this.data[4*l+3])}return r}}class H extends C{constructor(t,e,i,s,r,n=0){super(t,e,i,r,s),this.dirty=!1,this.curlayer=0,this.maxrect=new M(e,i,n),this.pixelbuf=new Uint8Array(e*i*(s==f.RGBA32?4:1)),this.dirty=!1}AddSprite(t,e){let i=this.maxrect.add(t.width,t.height,null);if(null==i&&(this.maxrect.reset(),i=this.maxrect.add(t.width,t.height,null),this.Apply(),this.curlayer++,this.curlayer>=this._layer))throw"AddSprite:Layer 满了";for(let e=0;e<t.height;e++)for(let s=0;s<t.width;s++){let r=(e+i.y)*this._width+(i.x+s);this._format==f.RGBA32?t.CopyPixel(this.pixelbuf,4*r,f.RGBA32,s,e):t.CopyPixel(this.pixelbuf,r,f.R8,s,e)}this.dirty=!0;let s=new k;s.sizeTL=new E(-t.pivotX,-t.pivotY),s.sizeRB=new E(t.width-t.pivotX,t.height-t.pivotY);let r=i.x/this._width,n=i.y/this._height,h=(i.x+t.width)/this._width,o=(i.y+t.height)/this._height;return s.uvCenter=new E(.5*(r+h),.5*(n+o)),s.uvHalfSize=new E(.5*(h-r),.5*(o-n)),s.uvLayer=this.curlayer,s.eff=e,s}Apply(t=!1){(this.dirty||t)&&(this.UploadSubTexture(this.curlayer,0,0,this._width,this._height,this.pixelbuf),this.dirty=!1)}}class z{AddSprite(t,e){return e==y.RGBA?this.packRGBA.AddSprite(t,e):this.packGray.AddSprite(t,e)}}class j{constructor(t){this.mapName2Index={},this.packTexDuo=t,this.ElemInit(512,512)}InitMat(){this.material=new Z(q.GetShaderProgram("default")),this.material.uniformTexs.texRGBA.value=this.packTexDuo.packRGBA,this.material.uniformTexs.texGray.value=this.packTexDuo.packGray}GetMaterial(){return this.material}ConvertElemToSprite(t){let e=new Et(this.material);return e.effect=t.eff,e.uv=new S(t.uvCenter.X-t.uvHalfSize.X,t.uvCenter.Y-t.uvHalfSize.Y,t.uvCenter.X+t.uvHalfSize.X,t.uvCenter.Y+t.uvHalfSize.Y),e.pixelwidth=t.sizeRB.X-t.sizeTL.X,e.pixelheight=t.sizeRB.Y-t.sizeTL.Y,e.uvlayer=t.uvLayer,e}ElemInit(e,i){this.elemBufData=new Float32Array(e*i*4);let s=t.graphic.GetWebGL();this.elemTex=new U(s,e,i,f.F_RGBA,null),this.maxElemCount=e/4*i,this.elemCount=0,this.elemDirty=!1}GetElemTex(){return this.elemTex}GetPackTexDuo(){return this.packTexDuo}GetElementCount(){return this.elemCount}GetMaxElementCount(){return this.maxElemCount}WriteElement(t,e){t.index=e;let i=16*e;this.elemBufData[i+0]=t.sizeTL.X,this.elemBufData[i+1]=t.sizeTL.Y,this.elemBufData[i+2]=t.sizeRB.X,this.elemBufData[i+3]=t.sizeRB.Y,this.elemBufData[i+4]=t.uvCenter.X,this.elemBufData[i+5]=t.uvCenter.Y,this.elemBufData[i+6]=t.uvHalfSize.X,this.elemBufData[i+7]=t.uvHalfSize.Y,this.elemBufData[i+8]=t.uvLayer,this.elemBufData[i+11]=t.eff,this.elemDirty=!0}GetElementByIndex(t){let e=16*t,i=new k;return i.index=t,i.sizeTL=new E(0,0),i.sizeRB=new E(0,0),i.uvCenter=new E(0,0),i.uvHalfSize=new E(0,0),i.sizeTL.X=this.elemBufData[e+0],i.sizeTL.Y=this.elemBufData[e+1],i.sizeRB.X=this.elemBufData[e+2],i.sizeRB.Y=this.elemBufData[e+3],i.uvCenter.X=this.elemBufData[e+4],i.uvCenter.Y=this.elemBufData[e+5],i.uvHalfSize.X=this.elemBufData[e+6],i.uvHalfSize.Y=this.elemBufData[e+7],i.uvLayer=this.elemBufData[e+8],i.eff=this.elemBufData[e+11],i}AddSprite(t,e,i){let s=this.packTexDuo.AddSprite(t,e);return this.AddElement(i,s)}AddElement(t,e){let i=this.mapName2Index[t];if(null==i){if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";i=this.elemCount,this.mapName2Index[t]=i,this.elemCount++}return this.WriteElement(e,i),this.GetElementByIndex(i)}AddElementNoname(t){let e=this.elemCount;if(65536==this.elemCount)throw"[NamedElementPacked.AddElement]full element";return e=this.elemCount,this.elemCount++,this.WriteElement(t,e),this.GetElementByIndex(e)}GetElementByName(t){let e=this.mapName2Index[t];return null!=e?this.GetElementByIndex(e):null}ApplyTextureData(){this.packTexDuo.packRGBA.Apply(),this.packTexDuo.packGray.Apply(),this.elemDirty&&(this.elemTex.UploadTexture(0,0,this.elemTex.getWidth(),this.elemTex.getHeight(),this.elemBufData),this.elemDirty=!1)}}class K{constructor(){this.defFontName="Arail",this.defFontSize=32,this.packedGrayWidth=1024,this.packedGrayHeight=1024,this.packedGrayLayerCount=8,this.packedRGBAWidth=1024,this.packedRGBAHeight=1024,this.packedRGBALayerCount=4}}class q{static Init(e){let i=t.graphic.GetWebGL();this.InitInnerResource(i,e)}static InitInnerResource(t,e){!function(t){var e=q.CompileShader(t,_.VertexShader,"inst_tbo",vt),i=q.CompileShader(t,_.VertexShader,"inst_ubo",mt),s=q.CompileShader(t,_.VertexShader,"default",gt),r=q.CompileShader(t,_.FragmentShader,"default",wt);null!=s&&null!=r&&q.AddProgram(t,"default",s,r);var n=q.CompileShader(t,_.VertexShader,"simple",xt),h=q.CompileShader(t,_.FragmentShader,"simple",yt);null!=n&&null!=h&&q.AddProgram(t,"simple",n,h);var o=q.CompileShader(t,_.VertexShader,"feedback",Rt),l=q.CompileShader(t,_.FragmentShader,"empty",bt);null!=o&&null!=l&&q.AddProgramFeedback(t,"feedback",o,l,["outPos","outNormal"]);var a=q.CompileShader(t,_.FragmentShader,"tiledmap",At);null!=s&&null!=a&&q.AddProgram(t,"tiledmap",n,a),null!=i&&null!=r&&q.AddProgram(t,"inst_ubo",i,r),null!=e&&null!=r&&q.AddProgram(t,"inst_tbo",e,r)}(t);let i=new z;i.packGray=new H(t,e.packedGrayWidth,e.packedGrayHeight,f.R8,e.packedGrayLayerCount,0),i.packRGBA=new H(t,e.packedRGBAWidth,e.packedRGBAHeight,f.RGBA32,e.packedRGBALayerCount,0),this.packedelem=new j(i),this.packedelem.InitMat(),this.deffont=new Bt(t,e.defFontName,e.defFontSize,this.packedelem);{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.data=new Uint8Array(64);for(var s=0;s<t.height;s++)for(var r=0;r<t.width;r++)t.data[s*t.width+r]=255;t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"white")}{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"border")}{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.data=new Uint8Array([255,255,255,255,255,255,255,255,255,0,0,0,0,0,0,255,255,0,255,255,255,255,0,255,255,0,255,0,0,255,0,255,255,0,255,0,0,255,0,255,255,0,255,255,255,255,0,255,255,0,0,0,0,0,0,255,255,255,255,255,255,255,255,255]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"border2")}{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.data=new Uint8Array([0,0,0,255,255,0,0,0,0,0,255,128,128,255,128,0,0,255,128,0,0,128,255,0,255,128,0,0,0,0,128,255,255,128,0,0,0,0,128,255,0,255,128,0,0,128,255,0,0,128,255,128,128,255,128,0,0,0,0,255,255,0,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"borderr")}{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.toR=w.Alpha,t.data=new Uint8Array([0,0,0,255,255,0,0,0,0,0,255,255,255,255,0,0,0,255,255,128,128,255,255,0,255,255,128,200,200,128,255,255,255,255,128,200,200,128,255,255,0,255,255,128,128,255,255,0,0,0,255,255,255,255,0,0,0,0,0,255,255,0,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"round")}{let t=new N;t.format=f.R8,t.width=8,t.height=8,t.toR=w.Alpha,t.data=new Uint8Array([255,255,255,255,255,0,0,0,255,0,128,255,0,0,0,0,255,128,0,128,255,0,0,0,255,255,128,0,128,255,0,0,255,0,255,128,0,128,255,0,0,0,0,255,128,0,128,255,0,0,0,0,255,128,255,0,0,0,0,0,0,255,0,0]),t.pivotX=4,t.pivotY=4,this.packedelem.AddSprite(t,y.GrayAsAlpha,"arrow")}this.packedelem.ApplyTextureData()}static GetPackElement(){return this.packedelem}static getWhiteBlock(){return this.packedelem.GetElementByName("white")}static GetRoundBlock(){return this.packedelem.GetElementByName("round")}static GetBorderBlock(){return this.packedelem.GetElementByName("border")}static GetBorder2Block(){return this.packedelem.GetElementByName("border2")}static GetBorderScale(){return null==this.scale_border&&(this.scale_border=new St(this.GetBorderBlock(),this.packedelem,new G(3,3,3,3))),this.scale_border}static GetBorder2Scale(){return null==this.scale_border2&&(this.scale_border2=new St(this.GetBorder2Block(),this.packedelem,new G(3,3,3,3))),this.scale_border2}static GetBorderScaleR(){return null==this.scale_borderr&&(this.scale_borderr=new St(this.packedelem.GetElementByName("borderr"),this.packedelem,new G(3,3,3,3))),this.scale_borderr}static CreateFont(e,i){return new Bt(t.graphic.GetWebGL(),e,i,this.packedelem)}static GetDefFont(){return this.deffont}static CreateGUI_Border(){let t=new It(this.GetBorderScale());return t.localRect.setAsFill(),t}static CreateGUI_Border2(){let t=new It(this.GetBorder2Scale());return t.localRect.setAsFill(),t}static CreateGUI_ImgWhite(t=new A(1,1,1,1)){let e=this.packedelem.ConvertElemToSprite(this.getWhiteBlock()),i=new Xt(e);return i.color=t,i.localRect.setAsFill(),i}static CreateGUI_Label(t,e=new A(1,1,1,1),i=1){let s=new Dt(this.deffont,t);s.color=e,s.localRect.setAsFill();let r=16/this.deffont.GetFontSize();return s.fontBorder=1/r,s.fontScale=new E(r*i,r*i),s.valign=ut.Middle,s.halign=dt.Middle,s}static CreateGUI_Button(t,e=new A(1,1,1,1),i=1){let s=new Ot,r=new It(this.GetBorderScaleR()),n=new It(this.GetBorderScaleR());{r.color=e,r.localRect.setAsFill();let s=new Dt(this.deffont,t);s.color=e,s.localRect.setAsFill();let n=16/this.deffont.GetFontSize();s.fontBorder=1/n,s.fontScale=new E(n*i,n*i),r.addChild(s)}{let s=e.Clone();s.R*=.5,s.G*=.5,s.B*=.5,n.color=s,n.localRect.setAsFill();let r=new Dt(this.deffont,t);r.color=s,r.localRect.setAsFill();let h=16/this.deffont.GetFontSize();r.fontScale=new E(h*i,h*i),n.addChild(r)}return s.ElemNormal=r,s.ElemPress=n,s.localRect.setHPosByLeftBorder(100,100),s.localRect.setVPosByTopBorder(25,100),s}static GetShaderProgram(t){return null==this.programs[t]?null:this.programs[t]}static CompileShader(t,e,i,s){var r=function(t,e,i,s){var r=t.createShader(e==_.VertexShader?t.VERTEX_SHADER:t.FRAGMENT_SHADER);return null==r?(console.error("AddShader error webgl.createShader:"+e+":"+i),null):(t.shaderSource(r,s),t.compileShader(r),0==t.getShaderParameter(r,t.COMPILE_STATUS)?(console.error("AddShader error webgl.compileShader:"+t.getShaderInfoLog(r)+":"+e+":"+i),null):(console.log("AddShader:"+_[e].toString()+":"+i),new F(e,i,r)))}(t,e,i,s);return r}static AddProgram(t,e,i,s){if(null!=this.programs[e])throw"have a shader program:"+e;let r=function(t,e,i,s){var r=t.createProgram();if(null!=r){if(t.attachShader(r,i.shader),t.attachShader(r,s.shader),t.linkProgram(r),0==t.getProgramParameter(r,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+e+" E:"+t.getProgramInfoLog(r)),null;var n=new Y(t,e,r,i,s);return console.log("LinkShader:"+e),n}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s);return this.programs[e]=r,r}static AddProgramFeedback(t,e,i,s,r){if(null!=this.programs[e])throw"have a shader program:"+e;let n=function(t,e,i,s,r){var n=t.createProgram();if(null!=n){if(t.attachShader(n,i.shader),t.attachShader(n,s.shader),t.transformFeedbackVaryings(n,r,t.INTERLEAVED_ATTRIBS),t.linkProgram(n),0==t.getProgramParameter(n,t.LINK_STATUS))return console.error("LinkShader error webgl.linkProgram:"+t.getProgramInfoLog(n)),null;var h=new Y(t,e,n,i,s);return console.log("LinkShader:"+e),h}return console.error("LinkShader error webgl.createProgram"),null}(t,e,i,s,r);return this.programs[e]=n,n}}q.scale_border=null,q.scale_border2=null,q.scale_borderr=null,q.deffont=null,q.programs={};class J{static GetEmpty(){if(null==this._empty){let e=t.graphic.GetWebGL();this._empty=new J(e)}return this._empty}static GetMax(){let e=t.graphic.GetWebGL(),i=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE);return null==i?-1:i}constructor(t){this.buf=t.createBuffer()}GetGLBuf(){return this.buf}UploadData(t,e,i){t.bindBuffer(t.UNIFORM_BUFFER,this.buf),t.bufferData(t.UNIFORM_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW)}}class Z{constructor(t){this.uniformFloats={},this.uniformInts={},this.uniformMats={},this.uniformTexs={},this.uniformVecs={},this.uniformIVecs={},this.uniformBlocks={};let e=new Float32Array(16);e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1;let i=new Float32Array(4);i[0]=0,i[1]=0,i[2]=0,i[3]=0;let s=new Int32Array(4);for(var r in s[0]=0,s[1]=0,s[2]=0,s[3]=0,this.shader=t,t.uniformInfos){let n=t.uniformInfos[r];switch(n.type){case g.sampler2D:this.uniformTexs[r]={loc:n.loc,value:q.GetPackElement().GetPackTexDuo().packRGBA};break;case g.block:this.uniformBlocks[r]={index:n.locblock,value:J.GetEmpty()};case g.mat4:this.uniformMats[r]={loc:n.loc,value:e};break;case g.vec4:this.uniformVecs[r]={loc:n.loc,value:i};break;case g.ivec4:this.uniformIVecs[r]={loc:n.loc,value:s};break;case g.float:this.uniformFloats[r]={loc:n.loc,value:0};break;case g.int:this.uniformInts[r]={loc:n.loc,value:0}}}}GetShader(){return this.shader}UpdateMatProj(t){let e=new Float32Array(16),i=2/t.getWidth(),s=2/t.getHeight();t.IsMainOutput()&&(s*=-1),e[0]=i,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=s,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1,this.uniformMats.matProj.value=e}UpdateMatModel(t=null){null==t&&((t=new Float32Array(16))[0]=1,t[4]=0,t[8]=0,t[12]=0,t[1]=0,t[5]=1,t[9]=0,t[13]=0,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1),this.uniformMats.matModel.value=t}UpdateMatView(t=null){if(null==t){let e=1,i=1,s=0,r=0;(t=new Float32Array(16))[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1}this.uniformMats.matView.value=t}Apply(t){for(var e in t.disable(t.CULL_FACE),t.depthMask(!1),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.SRC_ALPHA,t.ONE),t.useProgram(this.shader.program),this.uniformFloats){let i=this.uniformFloats[e];t.uniform1f(i.loc,i.value)}for(var e in this.uniformInts){let i=this.uniformInts[e];t.uniform1i(i.loc,i.value)}for(var e in this.uniformMats){let i=this.uniformMats[e];t.uniformMatrix4fv(i.loc,!1,i.value)}for(var e in this.uniformVecs){let i=this.uniformVecs[e];t.uniform4fv(i.loc,i.value)}for(var e in this.uniformIVecs){let i=this.uniformIVecs[e];t.uniform4iv(i.loc,i.value)}let i=0;for(var e in this.uniformTexs){let s=this.uniformTexs[e];t.activeTexture(t.TEXTURE0+i);let r=s.value;r.IsArray()?t.bindTexture(t.TEXTURE_2D_ARRAY,r.getGLTex()):t.bindTexture(t.TEXTURE_2D,r.getGLTex()),t.uniform1i(s.loc,i),i++}let s=0;for(var e in this.uniformBlocks){let i=this.uniformBlocks[e];t.bindBufferBase(t.UNIFORM_BUFFER,s,i.value.GetGLBuf()),t.uniformBlockBinding(this.shader.program,i.index,s),s++}}}(b=x||(x={}))[b.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",b[b.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",b[b.UNSIGNED_INT=5125]="UNSIGNED_INT",b[b.FLOAT=5126]="FLOAT";class Q{constructor(t,e,i){this.type=t,this.size=e,this.normalize=i}}class ${constructor(){this.vertexAttribDivisor=0,this.atrribs=[]}Update(){this.atrribsCount=this.atrribs.length,this.stride=0,this.hash="";for(var t=0;t<this.atrribs.length;t++){var e=this.atrribs[t];if(e.offset=this.stride,e.type==x.FLOAT)this.stride+=4*e.size;else if(e.type==x.UNSIGNED_BYTE)this.stride+=1*e.size;else if(e.type==x.UNSIGNED_SHORT)this.stride+=2*e.size;else{if(e.type!=x.UNSIGNED_INT)throw"unknown stride";this.stride+=4*e.size}this.hash+=e.type+"("+e.size+");"}}}class tt{constructor(t){this.id=t,this.vbos=[]}Update(){this.hash="";for(var t=0;t<this.vbos.length;t++){var e=this.vbos[t];e.Update(),this.hash+="{"+e.hash+"}"}}}class et{static RegFormat(t){t.Update();let e=t;return null==this.vertexFormats[t.hash]?this.vertexFormats[t.hash]=t:e=this.vertexFormats[t.hash],this.vertexFormatsID2Hash[t.id]=t.hash,e}static GetFormat(t){let e=this.vertexFormatsID2Hash[t];return this.vertexFormats[e]}static GetFormat_Vertex_Normal(){if(null==this.vertexFormat_Vertex_Normal){let t=new tt("Vertex_Normal");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!0)),this.vertexFormat_Vertex_Normal=this.RegFormat(t)}return this.vertexFormat_Vertex_Normal}static GetFormat_Vertex_Color(){if(null==this.vertexFormat_Vertex_Color){let t=new tt("Vertex_Color");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_Color}static GetFormat_Vertex_UV(){if(null==this.vertexFormat_Vertex_UV){let t=new tt("Vertex_UV_Color");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),this.vertexFormat_Vertex_UV=this.RegFormat(t)}return this.vertexFormat_Vertex_UV}static GetFormat_Vertex_UV_Color(){if(null==this.vertexFormat_Vertex_UV_Color){let t=new tt("Vertex_UV_Color");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color}static GetFormat_Vertex_UV_Color_Ext(){if(null==this.vertexFormat_Vertex_UV_Color_Color2){let t=new tt("Vertex_UV_Color_Color2");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!1)),this.vertexFormat_Vertex_UV_Color_Color2=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_Color2}static GetFormat_Vertex_UV_Color_InstPos(){if(null==this.vertexFormat_Vertex_UV_Color_InstPos){let t=new tt("Vertex_UV_Color_InstPos");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),t.vbos.push(new $),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new Q(x.FLOAT,3,!1)),this.vertexFormat_Vertex_UV_Color_InstPos=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPos}static GetFormat_Vertex_UV_Color_InstPosNormal(){if(null==this.vertexFormat_Vertex_UV_Color_InstPosNormal){let t=new tt("Vertex_UV_Color_InstPosNormal");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),t.vbos.push(new $),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[1].atrribs.push(new Q(x.FLOAT,3,!0)),this.vertexFormat_Vertex_UV_Color_InstPosNormal=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}static GetFormat_Vertex_InstFull(){if(null==this.vertexFormat_Vertex_InstFull){let t=new tt("Vertex_InstFull");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos.push(new $),t.vbos[1].vertexAttribDivisor=4,t.vbos[1].atrribs.push(new Q(x.FLOAT,4,!1)),t.vbos[1].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[1].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),t.vbos[1].atrribs.push(new Q(x.UNSIGNED_SHORT,2,!1)),this.vertexFormat_Vertex_InstFull=this.RegFormat(t)}return this.vertexFormat_Vertex_InstFull}static GetFormat_Vertex_UV_Color_InstXYZRUVRectColor(){if(null==this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor){let t=new tt("Vertex_UV_Color_InstXYZRUVRectColor");t.vbos.push(new $),t.vbos[0].atrribs.push(new Q(x.FLOAT,3,!1)),t.vbos[0].atrribs.push(new Q(x.FLOAT,2,!1)),t.vbos[0].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),t.vbos.push(new $),t.vbos[1].vertexAttribDivisor=1,t.vbos[1].atrribs.push(new Q(x.FLOAT,4,!1)),t.vbos[1].atrribs.push(new Q(x.FLOAT,4,!1)),t.vbos[1].atrribs.push(new Q(x.UNSIGNED_BYTE,4,!0)),this.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=this.RegFormat(t)}return this.vertexFormat_Vertex_UV_Color_InstPosNormal}}et.vertexFormats={},et.vertexFormatsID2Hash={},et.vertexFormat_Vertex_Normal=null,et.vertexFormat_Vertex_Color=null,et.vertexFormat_Vertex_UV=null,et.vertexFormat_Vertex_UV_Color=null,et.vertexFormat_Vertex_UV_Color_Color2=null,et.vertexFormat_Vertex_UV_Color_InstPos=null,et.vertexFormat_Vertex_UV_Color_InstPosNormal=null,et.vertexFormat_Vertex_UV_Color_InstXYZRUVRectColor=null,et.vertexFormat_Vertex_InstFull=null;class it{constructor(){this._vbos=null,this._ebo=null,this._vao=null,this.indexcount=0}GetVertexFormat(){return this.vertexFormat}UpdateVertexFormat(t,e){for(null==this._vao&&(this._vao=t.createVertexArray()),null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<e.vbos.length;)this._vbos.push(null);for(;this.vertexcount.length<e.vbos.length;)this.vertexcount.push(0);for(var i=0;i<e.vbos.length;i++)null==this._vbos[i]&&(this._vbos[i]=t.createBuffer());this.vertexFormat=e;{t.bindVertexArray(this._vao);let r=0;for(i=0;i<e.vbos.length;i++){let n=e.vbos[i];t.bindBuffer(t.ARRAY_BUFFER,this._vbos[i]);for(var s=0;s<n.atrribsCount;s++){let e=n.atrribs[s];t.enableVertexAttribArray(r),t.vertexAttribPointer(r,e.size,e.type,e.normalize,n.stride,e.offset),t.vertexAttribDivisor(r,n.vertexAttribDivisor),r++}}for(s=r;s<10;s++)t.disableVertexAttribArray(s);t.bindVertexArray(null)}}SetVertexBuffer(t,e,i,s){for(null==this._vbos&&(this._vbos=[],this.vertexcount=[]);this._vbos.length<=e;)this._vbos.push(null);for(;this.vertexcount.length<=e;)this.vertexcount.push(0);this._vbos[e]=i,this.vertexcount[e]=s}SetIndexBuffer(t,e,i,s){this._ebo=e,this.indexcount=s}UploadVertexBuffer(t,e,i,s,r){null==this._vbos[e]&&(this._vbos[e]=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this._vbos[e]),t.bufferData(t.ARRAY_BUFFER,i,s?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,r),this.vertexcount[e]=r/this.vertexFormat.vbos[e].stride,t.bindBuffer(t.ARRAY_BUFFER,null)}UploadIndexBuffer(t,e,i,s){null==this._ebo&&(this._ebo=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,i?t.DYNAMIC_DRAW:t.STATIC_DRAW,0,s),this.indexcount=s/2,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}Apply(t){t.bindVertexArray(this._vao),null!=this._ebo&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._ebo)}static DrawMesh(t,e,i){e.Apply(t),i.Apply(t),null==e._ebo?t.drawArrays(t.TRIANGLES,0,e.vertexcount[0]):t.drawElements(t.TRIANGLES,e.indexcount,t.UNSIGNED_SHORT,t.ZERO)}static DrawMeshInstanced(t,e,i){e.Apply(t),i.Apply(t),null==e._ebo?t.drawArraysInstanced(t.TRIANGLES,0,e.vertexcount[0],e.instancecount):t.drawElementsInstanced(t.TRIANGLES,e.indexcount,t.UNSIGNED_SHORT,t.ZERO,e.instancecount)}}class st{constructor(){this.canvas=new Ut(null)}GetGUI(){return this.canvas}OnUpdate(t){this.canvas.OnUpdate(null,t)}OnRender(t,e,i){0==i&&(this.canvas.scale=e.Scale,this.canvas.target=t,this.canvas.FIllTarget(),this.canvas.OnRender(null))}}class rt extends D{constructor(t=p.GUI){super(t);let e=new st;this.canvas=e.canvas,this.GetRenders().push(e)}GetCanvas(){return this.canvas}}class nt{static LoadTextPixel(e,i,s,r,n,h,o){let l=t.graphic.GetBackGroundC2D();l.canvas.width=r,l.canvas.height=n,l.scale(1,1),l.imageSmoothingEnabled=!1,l.shadowBlur=0,l.font=s+"px "+i,l.clearRect(0,0,r,n),l.textBaseline="top",l.textAlign="left",l.fillStyle="#ffffffff",l.globalAlpha=1,l.fillText(e,h,o);let a=l.measureText(e).width;return l.getImageData(0,0,a,n)}}!function(t){t[t.RGBA=0]="RGBA",t[t.Gray=1]="Gray",t[t.GrayAsAlpha=4]="GrayAsAlpha"}(y||(y={}));class ht{constructor(){this.x=0,this.y=0,this.z=0,this.r=1,this.g=1,this.b=1,this.a=1,this.u=0,this.v=0,this.uvlayer=0,this.e2=0,this.e3=0,this.eff=0}Clone(){var t=new ht;return t.x=this.x,t.y=this.y,t.z=this.z,t.u=this.u,t.v=this.v,t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t.uvlayer=this.uvlayer,t.e2=this.e2,t.e3=this.e3,t.eff=this.eff,t.x=this.x,t}}class ot{constructor(t){this._mesh=null,this._lastmat=null,this.matrixView=new Float32Array(16),this.matrixWorld=new Float32Array(16),this._webgl=t,this._target=null,this._lastmat=null,this._buffer=new Uint8Array(1835008),this._bufferView=new DataView(this._buffer.buffer,0,this._buffer.length),this._pointseek=0,this._lastMode=t.TRIANGLES,this.LookAt=new E(0,0),this.Scale=1,this._mesh=new it,this._mesh.UpdateVertexFormat(t,et.GetFormat_Vertex_UV_Color_Ext());let e=this.matrixWorld=new Float32Array(16);e[0]=1,e[4]=0,e[8]=0,e[12]=0,e[1]=0,e[5]=1,e[9]=0,e[13]=0,e[2]=0,e[6]=0,e[10]=1,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1}DrawQuads(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+6*i>=65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++)this._AddBuf(e[4*s+0]),this._AddBuf(e[4*s+1]),this._AddBuf(e[4*s+2]),this._AddBuf(e[4*s+2]),this._AddBuf(e[4*s+1]),this._AddBuf(e[4*s+3])}DrawTris(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.TRIANGLES||this._lastmat!=t||this._pointseek+3*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.TRIANGLES;for(var s=0;s<i;s++)this._AddBuf(e[3*s+0]),this._AddBuf(e[3*s+1]),this._AddBuf(e[3*s+2])}DrawLines(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.LINES||this._lastmat!=t||this._pointseek+2*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.LINES;for(var s=0;s<i;s++)this._AddBuf(e[2*s+0]),this._AddBuf(e[2*s+1])}DrawPoints(t,e,i){if(null==this._target)throw new Error("Render_Batcher Not in Begin-End.");(this._lastMode!=this._webgl.POINTS||this._lastmat!=t||this._pointseek+1*i>65536)&&(this._Render(),this._ApplySingle(t)),this._lastMode=this._webgl.POINTS;for(var s=0;s<i;s++)this._AddBuf(e[s])}getTarget(){return this._target}getName(){return"Batcher"}UpdateMatView(){let t=this.matrixView,e=this.Scale,i=this.Scale,s=-this.LookAt.X,r=-this.LookAt.Y;t[0]=e,t[4]=0,t[8]=0,t[12]=s*e,t[1]=0,t[5]=i,t[9]=0,t[13]=r*i,t[2]=0,t[6]=0,t[10]=1,t[14]=0,t[3]=0,t[7]=0,t[11]=0,t[15]=1}ResetMatrix(){this._Render(),this._lastmat.UpdateMatModel(),this._lastmat.UpdateMatView(),this._lastmat.UpdateMatProj(this._target)}ApplyBatch(){this._Render()}BeginDraw(t){this._target=t,this.UpdateMatView(),null!=this._lastmat&&(this._lastmat.UpdateMatModel(this.matrixWorld),this._lastmat.UpdateMatView(this.matrixView),this._lastmat.UpdateMatProj(this._target));let e=this._webgl;e.disable(e.CULL_FACE),e.depthMask(!1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendEquation(e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.SRC_ALPHA,e.ONE)}EndDraw(){this._Render(),this._target=null,this._ApplySingle(null)}_Render(){if(0==this._pointseek)return;let t=this._webgl;this._mesh.UploadVertexBuffer(t,0,this._buffer,!0,28*this._pointseek),this._pointseek=0,null!=this._lastmat&&it.DrawMesh(t,this._mesh,this._lastmat)}_AddBuf(t){this._bufferView.setFloat32(28*this._pointseek+0,t.x,!0),this._bufferView.setFloat32(28*this._pointseek+4,t.y,!0),this._bufferView.setFloat32(28*this._pointseek+8,t.z,!0),this._bufferView.setFloat32(28*this._pointseek+12,t.u,!0),this._bufferView.setFloat32(28*this._pointseek+16,t.v,!0),this._bufferView.setUint8(28*this._pointseek+20,255*t.r|0),this._bufferView.setUint8(28*this._pointseek+21,255*t.g|0),this._bufferView.setUint8(28*this._pointseek+22,255*t.b|0),this._bufferView.setUint8(28*this._pointseek+23,255*t.a|0),this._bufferView.setUint8(28*this._pointseek+24,t.uvlayer),this._bufferView.setUint8(28*this._pointseek+25,t.e2),this._bufferView.setUint8(28*this._pointseek+26,t.e3),this._bufferView.setUint8(28*this._pointseek+27,t.eff),this._pointseek++}_ApplySingle(t){this._lastmat=t,null!=this._lastmat&&(this._lastmat.UpdateMatModel(this.matrixWorld),this._lastmat.UpdateMatView(this.matrixView),this._lastmat.UpdateMatProj(this._target))}}var lt,at,ct,dt,ut,ft,pt,_t,gt="#version 300 es\n    precision highp float;\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n    layout(location = 3) in vec4 ext; \n\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void) \n    {\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        vExt = int(ext.w);\n        vLayer =int(ext.x);\n    }\n    ",vt="#version 300 es\n    precision highp float;\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    // layout(std140, column_major) uniform;\n    struct Sprite //结构体的基线是4n的倍数\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        float uvlayer;\n        float empty1;//占位，凑4N\n        float empty2;\n        float eff;\n       \n    };\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n    uniform sampler2D texelem;\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        int ext = int(ext.x);\n        int iuvx = ext%128 *4;\n        int iuvy = ext/128;\n\n        \n        vec4 v0 = texelFetch(texelem,ivec2(iuvx+0,iuvy),0);\n        vec4 v1 = texelFetch(texelem,ivec2(iuvx+1,iuvy),0);\n        vec4 v2 = texelFetch(texelem,ivec2(iuvx+2,iuvy),0);\n        //vec4 v3 =texelFetch(texelem,ivec2(iuvx+3,iuvy),0);\n        \n        Sprite s;\n        s.posLT = v0.xy;\n        s.posRB = v0.zw;\n        s.uvCenter = v1.xy;\n        s.uvHalfSize = v1.zw;\n        s.uvlayer = v2.x;\n        s.eff = v2.w;\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n    \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            //--begin rotate\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n            //--end rorate\n        }\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n       \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.eff);\n        vLayer=int(s.uvlayer);\n    }\n",mt="#version 300 es\n    precision highp float;\n    //form vbo1 as mesh\n    layout(location = 0) in vec2 elemuv; \n    //from vbo2 as inst\n    layout(location = 1) in vec4 posrotate;\n    layout(location = 2) in vec2 scale;\n    layout(location = 3) in vec4 color; //rgba32\n    layout(location = 4) in vec2 ext;\n\n    layout(std140, column_major) uniform;\n    struct Sprite //\n    {\n        vec2 posLT;\n        vec2 posRB;\n        vec2 uvCenter;\n        vec2 uvHalfSize;\n        vec4 ext;\n    };\n\n    uniform SpritesBlock {//\n        //\n        Sprite data[1023];    \n        int endtag; //\n    } sprites;\n    \n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;\n    out vec2 vUv;\n    flat out int vExt;\n    flat out int vLayer;\n    void main(void)\n    { \n        //get sprite\n        Sprite s = sprites.data[int(ext.x)];\n       \n      \n      \n        //----begin calc final pos\n        vec2 poslocal;\n        poslocal.x=elemuv.x<0.0?s.posLT.x:s.posRB.x;\n        poslocal.y=elemuv.y<0.0?s.posLT.y:s.posRB.y;\n        poslocal*=scale;\n\n        //poslocal is work\n\n\n        //--begin rotate\n       \n        float poslocallen = sqrt(dot(poslocal,poslocal));\n        if(poslocallen<0.001)   \n        {\n            //too near to zeropoint no rotate\n            //gl_Position =vec4(0,0,0,0);\n        }\n        else\n        {\n            float cosv = cos(posrotate.w);\n            float sinv = sin(posrotate.w);\n            \n            vec2 poslocalnor = poslocal / poslocallen;\n            poslocal.x = cosv*poslocalnor.x + -sinv*poslocalnor.y;\n            poslocal.y = sinv*poslocalnor.x + cosv*poslocalnor.y;\n            poslocal *= poslocallen;\n        }\n        //--end rorate\n\n        vec4 pos = vec4(posrotate.xyz,1);\n\n        //apply tran\n        pos.xy+=poslocal;\n        //----end finalpos\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * pos;\n        \n        //pass uv\n        vec2 uv =  s.uvCenter + elemuv*s.uvHalfSize;\n       \n        vUv = uv;\n        //pass color\n        vColor = color;\n        //pass ext\n        vExt=int(s.ext.w);\n        vLayer=int(s.ext.x);\n    }\n",wt="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    flat in int vExt;\n    flat in int vLayer;\n        \n    layout(location = 0) out vec4 fragColor;\n\n    \n    uniform sampler2DArray texRGBA;  //从外部设置的参数\n    uniform sampler2DArray texGray;\n    void main(void) \n    {\n        vec4 texc = vExt==0? texture(texRGBA,vec3(vUv,vLayer))\n        : texture(texGray,vec3(vUv,vLayer));\n        vec4 outc = vColor;\n        int effect = vExt;//int(vExt.w);\n        if(effect==0)//rgba model \n        {\n            outc = vColor*texc;\n        }\n        else if(effect==1)//gray model\n        {\n            vec4 c = vec4(texc.r,texc.r,texc.r,1);\n            outc = vColor * c;\n        }\n        else if(effect==4)//gray as alpha model\n        {\n            //outc.a *= texc.r;\n            outc = vColor;\n            outc.a *=texc.r; \n            //outc = vColor * 0.5;\n        }\n        fragColor =  outc;\n        \n    }\n    ",xt="#version 300 es\n    precision highp float;\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec2 uv; \n    layout(location = 2) in vec4 color; \n \n\n    uniform mat4 matModel;\n    uniform mat4 matView;\n    uniform mat4 matProj;\n\n    out vec4 vColor;//输出给fs的参数\n    out vec2 vUv;//输出给fs的参数2\n    //flat out vec4 vExt;\n    uniform sampler2D tex2;\n    void main(void) \n    {\n        vec4 t1 = texelFetch(tex2,ivec2(0, 0), 0);\n        mat4 matrix = matProj*matView*matModel;\n        gl_Position = matrix * vec4(position,1);// uViewProjMatrix * uModelMatrix * position;\n        vColor = color;\n        vUv = uv;\n        //vExt = ext;\n    }\n    ",yt="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n    in vec4 vColor;//从vs接收的参数\n    //flat in vec4 vExt;\n\n        \n    layout(location = 0) out vec4 fragColor;\n\n    uniform sampler2D tex;  //从外部设置的参数\n    void main(void) \n    {\n     \n        vec4 texc = texture(tex,vUv);\n        vec4 outc = vColor;\n       \n        outc = vColor * texc;\n       \n        fragColor =  outc;\n    }\n    ",Rt="#version 300 es\n    precision highp float;\n    layout(location = 0) in vec3 position;//顶点提供的数据\n    layout(location = 1) in vec3 normal;//顶点提供的数据\n    out vec3 outPos;\n    out vec3 outNormal;\n    void main(void) \n    {\n        outPos = position + normal;\n        outNormal = normal;\n    }\n",bt="#version 300 es\n    precision highp float;//指定浮点型精确度\n   \n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        fragColor =  vec4(0,0,0,1);\n    }\n    ",At="#version 300 es\n    precision highp float;//指定浮点型精确度\n    precision highp sampler2DArray;\n\n    in vec2 vUv;//从vs接收的参数\n \n    uniform sampler2D texIndex; \n    uniform sampler2D texTile; \n    uniform float   tilesize;\n    uniform vec4     mapinfo;//xy map size, zw=tile texturesize\n    layout(location = 0) out vec4 fragColor;\n\n    void main(void) \n    {\n        //抽取TiledIndex\n        vec4 texc = texture(texIndex,vUv);\n        float su =float(int(texc.r*255.0+0.9)); //tileindex x\n        float sv =float(int(texc.g*255.0+0.9)); //tileindex y\n\n        float su2 =float(int(texc.b*255.0+0.9)); //tileindex z\n        float sv2 =float(int(texc.a*255.0+0.9)); //tileindex w\n\n        //计算tileduv\n        float subu = mod(vUv.x * mapinfo.x, 1.0);\n        float subv = mod(vUv.y * mapinfo.y, 1.0);\n        vec2 tilescale =vec2(tilesize,tilesize)/mapinfo.zw;\n        //float tilescaleY =tiledsize/mapinfo.w;\n        vec2 tuv = vec2((su+subu)*tilescale.x,(sv+subv)*tilescale.y);\n        vec2 tuv2 = vec2((su2+subu)*tilescale.x,(sv2+subv)*tilescale.y);\n\n        //合成颜色\n        vec4 ttc = texture(texTile,tuv);\n        vec4 ttc2 = texture(texTile,tuv2);\n \n\n        vec4 outcolor = ttc2.a*ttc2 + (1.0-ttc2.a)*ttc;\n        \n        fragColor = outcolor;\n    }\n    ";class Et{constructor(t){this.uvlayer=0,this.material=t,this.effect=y.RGBA,this.uv=new S(0,0,1,1);let e=t.uniformTexs.tex;null==e&&(e=t.uniformTexs.texRGBA),null==e&&(e=t.uniformTexs.texGray),null!=e?(this.pixelwidth=e.value.getWidth(),this.pixelheight=e.value.getHeight()):(this.pixelwidth=16,this.pixelheight=16),this.uvlayer=0}RenderRectWithLimit(t,e,i,s=null,r=-1){let n=Et._rectbuf;for(;n.length<4;)n.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let h=null==s?Et._colorbuf:s,o=(e.Width,this.pixelwidth,e.Height,this.pixelheight,e.X),l=e.X+e.Width,a=e.Y,c=e.Y+e.Height,d=this.uv.U1,u=this.uv.V1,f=this.uv.U2,p=this.uv.V2,_=l-o,g=c-a;if(o>=i.X+i.Width||l<i.X||a>=i.Y+i.Height||c<i.Y)o=l=a=c=0;else if(0!=_&&0!=g){let t=o,e=l,s=a,r=c,n=!1;if(o<i.X&&(t=i.X,n=!0),l>i.X+i.Width&&(e=i.X+i.Width,n=!0),a<i.Y&&(s=i.Y,n=!0),c>i.Y+i.Height&&(r=i.Y+i.Height,n=!0),n){let i=f-d,n=p-u;d+=i*((t-o)/_),u+=n*((s-a)/g),f+=i*((e-l)/_),p+=n*((r-c)/g),o=t,a=s,l=e,c=r}}n[0].x=o,n[0].y=a,n[0].u=d,n[0].v=u,n[0].r=h.R,n[0].g=h.G,n[0].b=h.B,n[0].a=h.A,n[0].uvlayer=this.uvlayer,n[0].eff=this.effect,n[1].x=l,n[1].y=a,n[1].u=f,n[1].v=u,n[1].r=h.R,n[1].g=h.G,n[1].b=h.B,n[1].a=h.A,n[1].uvlayer=this.uvlayer,n[1].eff=this.effect,n[2].x=o,n[2].y=c,n[2].u=d,n[2].v=p,n[2].r=h.R,n[2].g=h.G,n[2].b=h.B,n[2].a=h.A,n[2].uvlayer=this.uvlayer,n[2].eff=this.effect,n[3].x=l,n[3].y=c,n[3].u=f,n[3].v=p,n[3].r=h.R,n[3].g=h.G,n[3].b=h.B,n[3].a=h.A,n[3].uvlayer=this.uvlayer,n[3].eff=this.effect,t.DrawQuads(this.material,n,1)}RenderRect(t,e,i=null,s=-1){let r=Et._rectbuf;for(;r.length<4;)r.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let n=null==i?Et._colorbuf:i;e.Width,this.pixelwidth,e.Height,this.pixelheight,r[0].x=e.X,r[0].y=e.Y,r[0].u=this.uv.U1,r[0].v=this.uv.V1,r[0].r=n.R,r[0].g=n.G,r[0].b=n.B,r[0].a=n.A,r[0].uvlayer=this.uvlayer,r[0].eff=this.effect,r[1].x=e.X+e.Width,r[1].y=e.Y,r[1].u=this.uv.U2,r[1].v=this.uv.V1,r[1].r=n.R,r[1].g=n.G,r[1].b=n.B,r[1].a=n.A,r[1].uvlayer=this.uvlayer,r[1].eff=this.effect,r[2].x=e.X,r[2].y=e.Y+e.Height,r[2].u=this.uv.U1,r[2].v=this.uv.V2,r[2].r=n.R,r[2].g=n.G,r[2].b=n.B,r[2].a=n.A,r[2].uvlayer=this.uvlayer,r[2].eff=this.effect,r[3].x=e.X+e.Width,r[3].y=e.Y+e.Height,r[3].u=this.uv.U2,r[3].v=this.uv.V2,r[3].r=n.R,r[3].g=n.G,r[3].b=n.B,r[3].a=n.A,r[3].uvlayer=this.uvlayer,r[3].eff=this.effect,t.DrawQuads(this.material,r,1)}RenderRect4Color(t,e,i=null){let s=Et._rectbuf;for(;s.length<4;)s.push(new ht);e.Width,this.pixelwidth,e.Height,this.pixelheight,s[0].x=e.X,s[0].y=e.Y,s[0].u=this.uv.U1,s[0].v=this.uv.V1,s[0].r=i[0].R,s[0].g=i[0].G,s[0].b=i[0].B,s[0].a=i[0].A,s[0].uvlayer=this.uvlayer,s[0].eff=this.effect,s[1].x=e.X+e.Width,s[1].y=e.Y,s[1].u=this.uv.U2,s[1].v=this.uv.V1,s[1].r=i[1].R,s[1].g=i[1].G,s[1].b=i[1].B,s[1].a=i[1].A,s[1].uvlayer=this.uvlayer,s[1].eff=this.effect,s[2].x=e.X,s[2].y=e.Y+e.Height,s[2].u=this.uv.U1,s[2].v=this.uv.V2,s[2].r=i[2].R,s[2].g=i[2].G,s[2].b=i[2].B,s[2].a=i[2].A,s[2].uvlayer=this.uvlayer,s[2].eff=this.effect,s[3].x=e.X+e.Width,s[3].y=e.Y+e.Height,s[3].u=this.uv.U2,s[3].v=this.uv.V2,s[3].r=i[3].R,s[3].g=i[3].G,s[3].b=i[3].B,s[3].a=i[3].A,s[3].uvlayer=this.uvlayer,s[3].eff=this.effect,t.DrawQuads(this.material,s,1)}RenderRect2(t,e,i,s,r,n=null,h=-1){let o=Et._rectbuf;for(;o.length<4;)o.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let l=null==n?Et._colorbuf:n;this.pixelwidth,this.pixelheight,o[0].x=e,o[0].y=i,o[0].u=this.uv.U1,o[0].v=this.uv.V1,o[0].r=l.R,o[0].g=l.G,o[0].b=l.B,o[0].a=l.A,o[0].uvlayer=this.uvlayer,o[0].eff=this.effect,o[1].x=s,o[1].y=i,o[1].u=this.uv.U2,o[1].v=this.uv.V1,o[1].r=l.R,o[1].g=l.G,o[1].b=l.B,o[1].a=l.A,o[1].uvlayer=this.uvlayer,o[1].eff=this.effect,o[2].x=e,o[2].y=r,o[2].u=this.uv.U1,o[2].v=this.uv.V2,o[2].r=l.R,o[2].g=l.G,o[2].b=l.B,o[2].a=l.A,o[2].uvlayer=this.uvlayer,o[2].eff=this.effect,o[3].x=s,o[3].y=r,o[3].u=this.uv.U2,o[3].v=this.uv.V2,o[3].r=l.R,o[3].g=l.G,o[3].b=l.B,o[3].a=l.A,o[3].uvlayer=this.uvlayer,o[3].eff=this.effect,t.DrawQuads(this.material,o,1)}Render(t,e,i,s=null,r=-1){let n=Et._rectbuf;for(;n.length<4;)n.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let h=null==s?Et._colorbuf:s;n[0].x=e.X,n[0].y=e.Y,n[0].u=this.uv.U1,n[0].v=this.uv.V1,n[0].r=h.R,n[0].g=h.G,n[0].b=h.B,n[0].a=h.A,n[0].uvlayer=this.uvlayer,n[0].eff=this.effect,n[1].x=e.X+i.X*this.pixelwidth,n[1].y=e.Y,n[1].u=this.uv.U2,n[1].v=this.uv.V1,n[1].r=h.R,n[1].g=h.G,n[1].b=h.B,n[1].a=h.A,n[1].uvlayer=this.uvlayer,n[1].eff=this.effect,n[2].x=e.X,n[2].y=e.Y+i.Y*this.pixelheight,n[2].u=this.uv.U1,n[2].v=this.uv.V2,n[2].r=h.R,n[2].g=h.G,n[2].b=h.B,n[2].a=h.A,n[2].uvlayer=this.uvlayer,n[2].eff=this.effect,n[3].x=e.X+i.X*this.pixelwidth,n[3].y=e.Y+i.Y*this.pixelheight,n[3].u=this.uv.U2,n[3].v=this.uv.V2,n[3].r=h.R,n[3].g=h.G,n[3].b=h.B,n[3].a=h.A,n[3].uvlayer=this.uvlayer,n[3].eff=this.effect,t.DrawQuads(this.material,n,1)}RenderWithRotate(t,e,i,s,r,n,h=null,o=-1){let l=Et._rectbuf;for(;l.length<4;)l.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let a=null==h?Et._colorbuf:h,c=e.X,d=e.X+i.X*this.pixelwidth,u=e.Y,f=e.Y+i.Y*this.pixelheight,p=e.X+r*i.X,_=e.Y+n*i.Y,g=c-p,v=u-_,m=d-p,w=f-_,x=Math.sin(s),y=Math.cos(s),R=p+g*y-v*x,b=_+g*x+v*y,E=p+m*y-v*x,B=_+m*x+v*y,T=p+g*y-w*x,G=_+g*x+w*y,S=p+m*y-w*x,U=_+m*x+w*y;l[0].x=R,l[0].y=b,l[0].u=this.uv.U1,l[0].v=this.uv.V1,l[0].r=a.R,l[0].g=a.G,l[0].b=a.B,l[0].a=a.A,l[0].uvlayer=this.uvlayer,l[0].eff=this.effect,l[1].x=E,l[1].y=B,l[1].u=this.uv.U2,l[1].v=this.uv.V1,l[1].r=a.R,l[1].g=a.G,l[1].b=a.B,l[1].a=a.A,l[1].uvlayer=this.uvlayer,l[1].eff=this.effect,l[2].x=T,l[2].y=G,l[2].u=this.uv.U1,l[2].v=this.uv.V2,l[2].r=a.R,l[2].g=a.G,l[2].b=a.B,l[2].a=a.A,l[2].uvlayer=this.uvlayer,l[2].eff=this.effect,l[3].x=S,l[3].y=U,l[3].u=this.uv.U2,l[3].v=this.uv.V2,l[3].r=a.R,l[3].g=a.G,l[3].b=a.B,l[3].a=a.A,l[3].uvlayer=this.uvlayer,l[3].eff=this.effect,t.DrawQuads(this.material,l,1)}}Et._rectbuf=[];class Bt{constructor(t,e,i,s){this.fonttex=s,this.fontsize=i,this.fontname=e}GetFont(){return this.fontname}GetFontSize(){return this.fontsize}GetCharSprite(t){let e=this._CacheCharSprite(t);return null!=e&&this.fonttex.ApplyTextureData(),e}_CacheCharSprite(t){let e=String.fromCharCode(t),i=this.fonttex.GetElementByName(e);if(null!=i)return this.fonttex.ConvertElemToSprite(i);try{let t=nt.LoadTextPixel(e,this.fontname,this.fontsize,this.fontsize+2,this.fontsize+2,0,0);if(0==t.height||0==t.width)return null;let s=new N;s.format=f.RGBA32,s.toR=w.Alpha,s.data=t.data,s.width=t.width,s.height=t.height;let r=s.ConvertToR();return r.toR=w.Alpha,i=this.fonttex.AddSprite(r,y.GrayAsAlpha,e),this.fonttex.ConvertElemToSprite(i)}catch(i){return console.error("cache char error:"+i),null}}SureText(t){let e=0;for(var i=0;i<t.length;i++){let s=this._CacheCharSprite(t.charCodeAt(i));e+=null!=s?s.pixelwidth:this.fontsize/2}return this.fonttex.ApplyTextureData(),e}RenderText(t,e,i,s,r){let n=0;for(var h=0;h<e.length;h++){let o=this.GetCharSprite(e.charCodeAt(h));null!=o?(o.Render(t,new E(i.X+n,i.Y),s,r),n+=o.pixelwidth*s.X):n+=this.fontsize/2*s.X}}RenderTextWithLimit(t,e,i,s,r,n){let h=0;for(var o=0;o<e.length;o++){let l=this.GetCharSprite(e.charCodeAt(o));if(null!=l){let e=new B(i.X+h,i.Y,l.pixelwidth*s.X,l.pixelheight*s.Y);l.RenderRectWithLimit(t,e,n,r),h+=l.pixelwidth*s.X}else h+=this.fontsize/2*s.X}}}!function(t){t[t.None=0]="None",t[t.LeftToRight=1]="LeftToRight",t[t.UpToDown=2]="UpToDown",t[t.Both=3]="Both"}(lt||(lt={})),function(t){t[t.LeftToRight=0]="LeftToRight",t[t.UpToDown=1]="UpToDown",t[t.RightToLeft=2]="RightToLeft",t[t.DownToUp=3]="DownToUp"}(at||(at={})),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(ct||(ct={})),function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"}(dt||(dt={})),function(t){t[t.Top=0]="Top",t[t.Middle=1]="Middle",t[t.Bottom=2]="Bottom"}(ut||(ut={}));class Tt{Clone(){let t=new Tt;return t.radioX1=this.radioX1,t.radioX2=this.radioX2,t.radioY1=this.radioY1,t.radioY2=this.radioY2,t.offsetX1=this.offsetX1,t.offsetX2=this.offsetX2,t.offsetY1=this.offsetY1,t.offsetY2=this.offsetY2,t}getFinalRect(t){let e=t.X,i=t.X+t.Width,s=t.Y,r=t.Y+t.Height,n=e+this.radioX1*(i-e)+this.offsetX1,h=s+this.radioY1*(r-s)+this.offsetY1,o=e+this.radioX2*(i-e)+this.offsetX2,l=s+this.radioY2*(r-s)+this.offsetY2;return new B(n,h,o-n,l-h)}getFinalRectScale(t,e){let i=t.X,s=t.X+t.Width,r=t.Y,n=t.Y+t.Height,h=(i+this.radioX1*(s-i)+this.offsetX1)*e,o=(r+this.radioY1*(n-r)+this.offsetY1)*e,l=(i+this.radioX2*(s-i)+this.offsetX2)*e,a=(r+this.radioY2*(n-r)+this.offsetY2)*e;return new B(h,o,l-h,a-o)}setAsFill(){this.radioX1=0,this.radioY1=0,this.radioX2=1,this.radioY2=1,this.offsetX1=0,this.offsetX2=0,this.offsetY1=0,this.offsetY2=0}setByRect(t){this.radioX1=0,this.radioY1=0,this.radioX2=0,this.radioY2=0,this.offsetX1=t.X,this.offsetX2=t.X+t.Width,this.offsetY1=t.Y,this.offsetY2=t.Y+t.Height}setHPosByLeftBorder(t,e=0){this.radioX1=0,this.radioX2=0,this.offsetX1=e,this.offsetX2=e+t}setHPosByCenter(t){this.radioX1=.5,this.radioX2=.5,this.offsetX1=-.5*t,this.offsetX2=.5*t}setHPosByRightBorder(t,e=0){this.radioX1=1,this.radioX2=1,this.offsetX1=-e-t,this.offsetX2=-e}setHPosFill(t=0,e=0){this.radioX1=0,this.radioX2=1,this.offsetX1=t,this.offsetX2=-e}setVPosByTopBorder(t,e=0){this.radioY1=0,this.radioY2=0,this.offsetY1=e,this.offsetY2=e+t}setVPosByCenter(t){this.radioY1=.5,this.radioY2=.5,this.offsetY1=-.5*t,this.offsetY2=.5*t}setVPosByBottomBorder(t,e=0){this.radioY1=1,this.radioY2=1,this.offsetY1=-e-t,this.offsetY2=-e}setVPosFill(t=0,e=0){this.radioY1=0,this.radioY2=1,this.offsetY1=t,this.offsetY2=-e}}!function(t){t[t.Element_Canvas=0]="Element_Canvas",t[t.Element_Container=1]="Element_Container",t[t.Element_Container_AutoFill=2]="Element_Container_AutoFill",t[t.Element_RenderContainer=3]="Element_RenderContainer",t[t.Element_Image=4]="Element_Image",t[t.Element_Image_Scale9=5]="Element_Image_Scale9",t[t.Element_Label=6]="Element_Label",t[t.Element_Button=7]="Element_Button",t[t.Element_DropButton=8]="Element_DropButton",t[t.Element_Joystick=9]="Element_Joystick",t[t.Element_TouchBar=10]="Element_TouchBar",t[t.Element_TextBox_Prompt=11]="Element_TextBox_Prompt",t[t.Element_DragButton=12]="Element_DragButton",t[t.Element_Overlay=13]="Element_Overlay",t[t.Element_Toggle=14]="Element_Toggle",t[t.Element_Bar=15]="Element_Bar",t[t.Element_ScrollBar=16]="Element_ScrollBar",t[t.Element_Panel=17]="Element_Panel",t[t.Element_Panel_Scroll=18]="Element_Panel_Scroll",t[t.Element_Panel_Split=19]="Element_Panel_Split",t[t.Element_Panel_Scroll_Unlimit=20]="Element_Panel_Scroll_Unlimit"}(ft||(ft={}));class Gt{constructor(){this.Tag=null,this.localRect=new Tt,this._parent=null,this.Enable=!0,this.alpha=1}getParent(){return this._parent}CancelTouch(){if(null!=this._children)for(var t=this._children.length-1;t>=0;t--){let e=this._children[t];e.Enable&&e.CancelTouch()}}OnTouch(t,e,i,s,r,n){if(null!=this._children)for(var h=this._children.length-1;h>=0;h--){let o=this._children[h];if(o.Enable&&o.OnTouch(t,e,i,s,r,n))return!0}return!1}OnRender(t){if(null!=this._children)for(var e=0;e<this._children.length;e++){let i=this._children[e];i.Enable&&i.OnRender(t)}}OnUpdate(t,e){if(null!=this._children)for(var i=0;i<this._children.length;i++){let s=this._children[i];s.Enable&&s.OnUpdate(t,e)}}getChildCount(){return null==this._children?0:this._children.length}getChild(t){return null==this._children||t>=this._children.length?null:this._children[t]}addChild(t){if(null==this._children&&(this._children=[]),this._children.indexOf(t)>=0)return;let e=t._parent;null!=e&&e.removeChild(e),this._children.push(t),t._parent=this}removeChild(t){if(null==this._children)return;let e=this._children.indexOf(t);e<0||(this._children.splice(e,1),t._parent=null)}removeChildAt(t){null!=this._children&&this._children.splice(t,1)}removeChildAll(){if(null!=this._children){for(var t=0;t<this._children.length;t++)this._children[t]._parent=null;this._children.splice(0,this._children.length)}}removeChildBegin(t){if(null!=this._children){for(var e=t;e<this._children.length;e++)this._children[e]._parent=null;this._children.splice(t)}}getWorldRect(){if(null==this._parent){let t=this.localRect.offsetX1,e=this.localRect.offsetY1,i=this.localRect.offsetX2,s=this.localRect.offsetY2;return new B(t,e,i-t,s-e)}{let t=this._parent.getWorldRect();return this.localRect.getFinalRect(t)}}getWorldRectScale(t){if(null==this._parent){let e=this.localRect.offsetX1*t,i=this.localRect.offsetY1*t,s=this.localRect.offsetX2*t,r=this.localRect.offsetY2*t;return new B(e,i,s-e,r-i)}{let e=this._parent.getWorldRect();return this.localRect.getFinalRectScale(e,t)}}}class St{constructor(t,e,i,s=0,r=0){this.sprite=e.ConvertElemToSprite(t),this.l=i.XLeft,this.r=i.XRight,this.t=i.YTop,this.b=i.YBottom;let n=(this.sprite.uv.U2-this.sprite.uv.U1)/this.sprite.pixelwidth,h=(this.sprite.uv.V2-this.sprite.uv.V1)/this.sprite.pixelheight,o=this.sprite.uv;if(this.u0=o.U1,this.u3=o.U2,this.u1=this.u0+i.XLeft*n,this.u2=this.u3-i.XRight*n,!(this.u0<=this.u1&&this.u1<this.u2&&this.u2<=this.u3))throw new Error("U尺寸不对，无法形成九宫");if(this.v0=o.V1,this.v3=o.V2,this.v1=this.v0+i.YTop*h,this.v2=this.v3-i.YBottom*h,!(this.v0<=this.v1&&this.v1<this.v2&&this.v2<=this.v3))throw new Error("U尺寸不对，无法形成九宫");0==s&&(s=this.u3-this.u0),0==r&&(r=this.v3-this.v0),this._minwidth=s,this._minheight=r}getElementType(){return ft.Element_Image_Scale9}getMinWidth(){return this._minwidth}getMinHeight(){return this._minheight}_Render1RectWithLimit(t,e,i,s,r,n,h,o,l=-1){let a=Et._rectbuf;for(;a.length<4;)a.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let c=null==o?Et._colorbuf:o,d=n.X,u=n.X+n.Width,f=n.Y,p=n.Y+n.Height,_=u-d,g=p-f;if(d>=h.X+h.Width||u<h.X||f>=h.Y+h.Height||p<h.Y)d=u=f=p=0;else if(0!=_&&0!=g){let r=d,n=u,o=f,l=p,a=!1;if(d<h.X&&(r=h.X,a=!0),u>h.X+h.Width&&(n=h.X+h.Width,a=!0),f<h.Y&&(o=h.Y,a=!0),p>h.Y+h.Height&&(l=h.Y+h.Height,a=!0),a){let h=e-t,a=s-i;t+=h*((r-d)/_),i+=a*((o-f)/g),e+=h*((n-u)/_),s+=a*((l-p)/g),d=r,f=o,u=n,p=l}}a[0].x=d,a[0].y=f,a[0].u=t,a[0].v=i,a[0].r=c.R,a[0].g=c.G,a[0].b=c.B,a[0].a=c.A,a[0].uvlayer=this.sprite.uvlayer,a[0].eff=this.sprite.effect,a[1].x=u,a[1].y=f,a[1].u=e,a[1].v=i,a[1].r=c.R,a[1].g=c.G,a[1].b=c.B,a[1].a=c.A,a[1].uvlayer=this.sprite.uvlayer,a[1].eff=this.sprite.effect,a[2].x=d,a[2].y=p,a[2].u=t,a[2].v=s,a[2].r=c.R,a[2].g=c.G,a[2].b=c.B,a[2].a=c.A,a[2].uvlayer=this.sprite.uvlayer,a[2].eff=this.sprite.effect,a[3].x=u,a[3].y=p,a[3].u=e,a[3].v=s,a[3].r=c.R,a[3].g=c.G,a[3].b=c.B,a[3].a=c.A,a[3].uvlayer=this.sprite.uvlayer,a[3].eff=this.sprite.effect,r.DrawQuads(this.sprite.material,a,1)}_Render1Rect(t,e,i,s,r,n,h,o=-1){if(t==e||i==s)return;let l=Et._rectbuf;for(;l.length<4;)l.push(new ht);null==Et._colorbuf&&(Et._colorbuf=A.White);let a=null==h?Et._colorbuf:h;l[0].x=n.X,l[0].y=n.Y,l[0].u=t,l[0].v=i,l[0].r=a.R,l[0].g=a.G,l[0].b=a.B,l[0].a=a.A,l[0].uvlayer=this.sprite.uvlayer,l[0].eff=this.sprite.effect,l[1].x=n.X+n.Width,l[1].y=n.Y,l[1].u=e,l[1].v=i,l[1].r=a.R,l[1].g=a.G,l[1].b=a.B,l[1].a=a.A,l[1].uvlayer=this.sprite.uvlayer,l[1].eff=this.sprite.effect,l[2].x=n.X,l[2].y=n.Y+n.Height,l[2].u=t,l[2].v=s,l[2].r=a.R,l[2].g=a.G,l[2].b=a.B,l[2].a=a.A,l[2].uvlayer=this.sprite.uvlayer,l[2].eff=this.sprite.effect,l[3].x=n.X+n.Width,l[3].y=n.Y+n.Height,l[3].u=e,l[3].v=s,l[3].r=a.R,l[3].g=a.G,l[3].b=a.B,l[3].a=a.A,l[3].uvlayer=this.sprite.uvlayer,l[3].eff=this.sprite.effect,r.DrawQuads(this.sprite.material,l,1)}RenderRect(t,e,i=null,s=-1,r){let n=this.l*r,h=this.r*r,o=this.t*r,l=this.b*r,a=new B(0,0,1,1);a.Y=e.Y,a.Height=o,a.X=e.X,a.Width=n,this._Render1Rect(this.u0,this.u1,this.v0,this.v1,t,a,i,s),a.X=e.X+n,a.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v0,this.v1,t,a,i,s),a.X=e.X+e.Width-h,a.Width=h,this._Render1Rect(this.u2,this.u3,this.v0,this.v1,t,a,i,s),a.Y=e.Y+o,a.Height=e.Height-o-l,a.X=e.X,a.Width=n,this._Render1Rect(this.u0,this.u1,this.v1,this.v2,t,a,i,s),a.X=e.X+n,a.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v1,this.v2,t,a,i,s),a.X=e.X+e.Width-h,a.Width=h,this._Render1Rect(this.u2,this.u3,this.v1,this.v2,t,a,i,s),a.Y=e.Y+e.Height-l,a.Height=l,a.X=e.X,a.Width=n,this._Render1Rect(this.u0,this.u1,this.v2,this.v3,t,a,i,s),a.X=e.X+n,a.Width=e.Width-n-h,this._Render1Rect(this.u1,this.u2,this.v2,this.v3,t,a,i,s),a.X=e.X+e.Width-h,a.Width=h,this._Render1Rect(this.u2,this.u3,this.v2,this.v3,t,a,i,s)}RenderRectWithLimit(t,e,i,s=null,r=-1,n){let h=this.l*n,o=this.r*n,l=this.t*n,a=this.b*n,c=new B(0,0,1,1);c.Y=e.Y,c.Height=l,c.X=e.X,c.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v0,this.v1,t,c,i,s,r),c.X=e.X+h,c.Width=e.Width-h-l,this._Render1RectWithLimit(this.u1,this.u2,this.v0,this.v1,t,c,i,s,r),c.X=e.X+e.Width-o,c.Width=o,this._Render1RectWithLimit(this.u2,this.u3,this.v0,this.v1,t,c,i,s,r),c.Y=e.Y+l,c.Height=e.Height-l-a,c.X=e.X,c.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v1,this.v2,t,c,i,s,r),c.X=e.X+h,c.Width=e.Width-h-l,this._Render1RectWithLimit(this.u1,this.u2,this.v1,this.v2,t,c,i,s,r),c.X=e.X+e.Width-o,c.Width=o,this._Render1RectWithLimit(this.u2,this.u3,this.v1,this.v2,t,c,i,s,r),c.Y=e.Y+e.Height-a,c.Height=a,c.X=e.X,c.Width=h,this._Render1RectWithLimit(this.u0,this.u1,this.v2,this.v3,t,c,i,s,r),c.X=e.X+h,c.Width=e.Width-h-l,this._Render1RectWithLimit(this.u1,this.u2,this.v2,this.v3,t,c,i,s,r),c.X=e.X+e.Width-o,c.Width=o,this._Render1RectWithLimit(this.u2,this.u3,this.v2,this.v3,t,c,i,s,r)}}class Ut extends Gt{constructor(e){super(),this.scale=1,this._event=[],this.target=e,this.batcherUI=new ot(t.graphic.GetWebGL()),this.FIllTarget()}FIllTarget(){if(null==this.target)return;this.batcherUI.LookAt.X=this.target.getWidth()/2,this.batcherUI.LookAt.Y=this.target.getHeight()/2;let t=this.target.getWidth()/this.scale,e=this.target.getHeight()/this.scale;this.localRect.setByRect(new B(0,0,t,e))}Clone(){throw new Error("can not clone canvas.")}getElementType(){return ft.Element_Canvas}OnUpdate(t,e){if(this.Enable){if(null!=this.target){this.batcherUI.LookAt.X=this.target.getWidth()/2,this.batcherUI.LookAt.Y=this.target.getHeight()/2;let t=this.target.getWidth()/this.scale,e=this.target.getHeight()/this.scale;this.localRect.setByRect(new B(0,0,t,e))}if(super.OnUpdate(this,e),this._event.length>0){for(let t=0;t<this._event.length;t++)this._event[t]();this._event.splice(0)}}}OnRender(t){this.Enable&&(this.batcherUI.BeginDraw(this.target),super.OnRender(this),this.batcherUI.EndDraw())}OnTouch(e,i,s,r,n,h){let o=t.graphic.getFinalScale()/this.scale,l=n*o,a=h*o;return super.OnTouch(this,i,s,r,l,a)}InvokeEvent(t){this._event.push(t)}}class Ct extends Gt{getElementType(){return ft.Element_Container}}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Both=2]="Both"}(pt||(pt={}));class Lt extends Gt{constructor(){super(...arguments),this.fillway=pt.Both,this.halign=dt.Middle,this.valign=ut.Middle,this.autosizeASPMax=1,this.autosizeASPMin=1}setAsp(t,e){this.autosizeASPMin=Math.min(t,e),this.autosizeASPMax=Math.max(t,e)}getElementType(){return ft.Element_Container_AutoFill}OnUpdate(t,e){let i=this.getParent().getWorldRect(),s=i.Width/i.Height,r=!1,n=!1;if(s<this.autosizeASPMin?(s=this.autosizeASPMin,r=!0):s>this.autosizeASPMax&&(s=this.autosizeASPMax,n=!0),this.fillway==pt.Both&&r||this.fillway==pt.Vertical){this.localRect.setHPosFill();let t=i.Width/s;this.valign==ut.Top?this.localRect.setVPosByTopBorder(t):this.valign==ut.Middle?this.localRect.setVPosByCenter(t):this.localRect.setVPosByBottomBorder(t)}if(this.fillway==pt.Both&&n||this.fillway==pt.Horizontal){let t=i.Height*s;this.localRect.setVPosFill(),this.halign==dt.Left?this.localRect.setHPosByLeftBorder(t):this.halign==dt.Middle?this.localRect.setHPosByCenter(t):this.localRect.setHPosByRightBorder(t)}this.fillway!=pt.Both||n||r||this.localRect.setAsFill(),super.OnUpdate(t,e)}}class Xt extends Gt{constructor(t=null){super(),this.color=A.White,this.sprite=t,null!=this.sprite?this.localRect.setByRect(new B(0,0,this.sprite.pixelwidth,this.sprite.pixelheight)):this.localRect.setByRect(new B(0,0,100,100))}getElementType(){return ft.Element_Image}OnRender(t){this.color.A=this.alpha,null!=this.sprite&&this.sprite.RenderRect(t.batcherUI,this.getWorldRectScale(t.scale),this.color,-1),super.OnRender(t)}}class It extends Gt{constructor(t=null){super(),this.color=A.White,this.scale9=t,null!=t?this.localRect.setByRect(new B(0,0,t.getMinWidth(),t.getMinHeight())):this.localRect.setByRect(new B(0,0,128,128))}getElementType(){return ft.Element_Image_Scale9}OnRender(t){null!=this.scale9&&this.scale9.RenderRect(t.batcherUI,this.getWorldRectScale(t.scale),this.color,-1,t.scale),super.OnRender(t)}}class Dt extends Gt{constructor(t=null,e=""){super(),this.color=A.White,this.withShadow=!0,this.colorShadow=new A(0,0,0,.5),this.fontScale=new E(1,1),this.fontBorder=1,this.cut=!1,this.halign=dt.Middle,this.valign=ut.Middle,this._pos=new E(0,0),this.font=t,this.text=e,this.localRect.setByRect(new B(0,0,100,100))}getElementType(){return ft.Element_Label}OnRender(t){if(this.color.A=this.alpha,null!=this.font){let e=this.getWorldRectScale(t.scale),i=this.font.GetFontSize()*this.fontScale.Y*t.scale,s=this.font.SureText(this.text)*this.fontScale.X*t.scale;this.halign==dt.Left?this._pos.X=e.X:this.halign==dt.Middle?this._pos.X=e.X+(e.Width-s)/2:this.halign==dt.Right&&(this._pos.X=e.X+(e.Width-s)),this.valign==ut.Top?this._pos.Y=e.Y:this.valign==ut.Middle?this._pos.Y=e.Y+(e.Height-i)/2:this.valign==ut.Bottom&&(this._pos.Y=e.Y+(e.Height-i));let r=this.fontBorder*this.fontScale.Y*t.scale,n=new E(this.fontScale.X*t.scale,this.fontScale.Y*t.scale);this.cut?(this.withShadow&&this.font.RenderTextWithLimit(t.batcherUI,this.text,new E(this._pos.X+r,this._pos.Y+r),n,this.colorShadow,e),this.font.RenderTextWithLimit(t.batcherUI,this.text,this._pos,n,this.color,e)):(this.withShadow&&this.font.RenderText(t.batcherUI,this.text,new E(this._pos.X+r,this._pos.Y+r),n,this.colorShadow),this.font.RenderText(t.batcherUI,this.text,this._pos,n,this.color))}super.OnRender(t)}}class Ot extends Gt{constructor(){super(),this.ElemNormal=null,this.ElemPress=null,this.BindKey=null,this._press=!1,this._keypress=!1,this._pressid=-1,this.OnClick=null,this.OnPressDown=null,this.OnPressUp=null,this.localRect.setByRect(new B(0,0,100,100))}getElementType(){return ft.Element_Button}UsePress(t){-1==this._pressid&&(this._pressid=t,this._press=!0)}CancelTouch(){this._press=!1,this._pressid=-1,super.CancelTouch()}OnTouch(t,e,i,s,r,n){if(super.OnTouch(t,e,i,s,r,n))return!0;let h=this.getWorldRect(),o=h.X+h.Width,l=h.Y+h.Height;return 0==this._press&&1==i&&0==s&&r>=h.X&&r<o&&n>=h.Y&&n<l?(this._press=!0,this._pressid=e,console.log("btn down."+e),null!=this.OnPressDown&&t.InvokeEvent((()=>{this.OnPressDown(e)})),!0):1==this._press&&1==i&&this._pressid==e||1==this._press&&0==i&&this._pressid==e&&(this._press=!1,this._pressid=-1,console.log("btn up."+e),null!=this.OnPressUp&&t.InvokeEvent((()=>{this.OnPressUp()})),r>=h.X&&r<o&&n>=h.Y&&n<l)&&(console.log("btn click."),null!=this.OnClick&&t.InvokeEvent((()=>{this.OnClick()})),!0)}OnRender(t){this._press?null!=this.ElemPress&&(this.ElemPress._parent=this,this.ElemPress.alpha=this.alpha,this.ElemPress.OnRender(t)):null!=this.ElemNormal&&(this.ElemNormal._parent=this,this.ElemNormal.alpha=this.alpha,this.ElemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(e,i){if(null!=this.BindKey){let e=t.input.IsKeyDown(this.BindKey);this._keypress&&!e?(this._keypress=!1,this._press=!1,null!=this.OnPressDown&&this.OnPressUp()):0==this._keypress&&e&&(this._keypress=!0,this._press=!0,null!=this.OnPressDown&&this.OnPressDown(0))}this._press?null!=this.ElemPress&&this.ElemPress.OnUpdate(e,i):null!=this.ElemNormal&&this.ElemNormal.OnUpdate(e,i),super.OnUpdate(e,i)}}class Pt extends Gt{constructor(){super(),this.ids=[],this.localRect.setByRect(new B(0,0,100,100))}getElementType(){return ft.Element_Overlay}OnTouch(t,e,i,s,r,n){if(super.OnTouch(t,e,i,s,r,n))return!0;let h=this.getWorldRect(),o=h.X+h.Width,l=h.Y+h.Height;if(1==i&&0==s&&r>=h.X&&r<o&&n>=h.Y&&n<l)return this.ids.indexOf(e)<0&&this.ids.push(e),null!=this.OnPress&&t.InvokeEvent((()=>{this.OnPress()})),!0;if(1==i&&1==s&&this.ids.indexOf(e)>=0)return!0;if(0==i&&this.ids.indexOf(e)>=0){let t=this.ids.indexOf(e);return this.ids.splice(t,1),!0}return!1}}!function(t){t[t.DoNotScroll=0]="DoNotScroll",t[t.ScrollByTouchDrag=1]="ScrollByTouchDrag",t[t.ScrollByTouchDrag_LoopValue=2]="ScrollByTouchDrag_LoopValue"}(_t||(_t={}));class Ft extends Gt{constructor(){super(),this.localRect.setByRect(new B(0,0,250,250)),this.container=new Ct,this.container._parent=this,this.container.localRect.setAsFill(),this._border=new G(2,2,2,2)}getElementType(){return ft.Element_Panel}getBorder(){return this._border}OnRender(t){null!=this.backElement&&this.backElement.OnRender(t);let e=t.batcherUI,i=t.scale,s=this.getWorldRectScale(i);s.X+=this._border.XLeft*i,s.Y+=this._border.YTop*i,s.Width-=(this._border.XLeft+this._border.XRight)*i,s.Height-=(this._border.YTop+this._border.YBottom)*i;let r=e.getTarget();e.EndDraw(),r.PushLimitRect(s),e.BeginDraw(r),this.container.OnRender(t),e.EndDraw(),r.PopLimitRect(),e.BeginDraw(r),null!=this.borderElement&&this.borderElement.OnRender(t)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=1,this.container.localRect.radioY2=1,this.container.localRect.offsetX1=this._border.XLeft,this.container.localRect.offsetX2=-this._border.XRight,this.container.localRect.offsetY1=this._border.YTop,this.container.localRect.offsetY2=-this._border.YBottom}OnUpdate(t,e){null!=this.backElement&&(this.backElement._parent=this,this.backElement.localRect.setAsFill(),this.backElement.OnUpdate(t,e)),this.updateContainerPos(),this.container.OnUpdate(t,e),null!=this.borderElement&&(this.borderElement._parent=this,this.borderElement.localRect.setAsFill(),this.borderElement.OnUpdate(t,e)),super.OnUpdate(t,e)}OnTouch(t,e,i,s,r,n){if(1==i&&0==s){let t=this.getWorldRect(),e=t.X+this._border.XLeft,i=t.Y+this._border.YTop,s=t.X+t.Width-this._border.XRight,h=t.Y+t.Height-this._border.YBottom;if(!(r>=e&&r<=s&&n>=i&&n<=h))return!1}return this.container.OnTouch(t,e,i,s,r,n)}getChildCount(){return this.container.getChildCount()}getChild(t){return this.container.getChild(t)}addChild(t){this.container.addChild(t)}removeChild(t){this.container.removeChild(t)}removeChildAll(){this.container.removeChildAll()}removeChildBegin(t){this.container.removeChildBegin(t)}removeChildAt(t){this.container.removeChildAt(t)}}class Yt extends Ft{constructor(){super(),this.dragDist=32,this.dragDirection=lt.UpToDown,this._press=!1,this._pressid=0,this._drag=!1,this._dragy=0,this._dragx=0,this.dragout=!0,this.panelOffsetX=this.panelOffsetWantX=0,this.panelOffsetY=this.panelOffsetWantY=0,this.panelWidth=250,this.panelHeight=250}getElementType(){return ft.Element_Panel_Scroll}Scroll(t,e){this.panelOffsetWantX+=t,this.panelOffsetWantX+=e;let i=this.getWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,r=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-r)&&(this.panelOffsetWantY=-(this.panelHeight-r)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0)}updateContainerPos(){this.container.localRect.radioX1=0,this.container.localRect.radioY1=0,this.container.localRect.radioX2=0,this.container.localRect.radioY2=0,this.container.localRect.offsetX1=this.panelOffsetX,this.container.localRect.offsetY1=this.panelOffsetY,this.container.localRect.offsetX2=this.panelOffsetX+this.panelWidth,this.container.localRect.offsetY2=this.panelOffsetY+this.panelHeight}CancelTouch(){this._press=!1,this._pressid=-1,super.CancelTouch()}OnTouch(e,i,s,r,n,h){if(this.dragDirection==lt.None)return super.OnTouch(e,i,s,r,n,h);if(0==this._press&&1==s&&0==r){let t=this.getWorldRect(),e=t.X+this._border.XLeft,s=t.Y+this._border.YTop,r=t.X+t.Width-this._border.XRight,o=t.Y+t.Height-this._border.YBottom;n>=e&&n<=r&&h>=s&&h<=o&&(this._press=!0,this._pressid=i,this._pressx=n,this._pressy=h)}return this._pressid==i&&1==this._press&&1==s&&1==r&&(this._drag?this._dragPanel(n,h):this._calcDragDist(n,h)>this.dragDist*t.graphic.getDevicePixelRadio()&&(this._drag=!0,this._dragx=this.panelOffsetX,this._dragy=this.panelOffsetY,this._pressy=h,this._pressx=n)),this._pressid==i&&1==this._press&&0==s&&(this._press=!1,this._pressid=0,this._drag=!1),this._drag?(this.container.CancelTouch(),!0):super.OnTouch(e,i,s,r,n,h)}_calcDragDist(t,e){if(this.dragDirection==lt.None)return 0;if(this.dragDirection==lt.LeftToRight)return Math.abs(t-this._pressx);if(this.dragDirection==lt.UpToDown)return Math.abs(e-this._pressy);let i=t-this._pressx,s=e-this._pressy;return Math.sqrt(i*i+s*s)}_dragPanel(t,e){if(this.dragDirection==lt.None)return;this.dragDirection!=lt.UpToDown&&this.dragDirection!=lt.Both||(this.panelOffsetY=this._dragy+(e-this._pressy)),this.dragDirection!=lt.LeftToRight&&this.dragDirection!=lt.Both||(this.panelOffsetX=this._dragx+(t-this._pressx));let i=this.getWorldRect(),s=i.Width-this._border.XLeft-this._border.XRight,r=i.Height-this._border.YTop-this._border.YBottom;this.panelOffsetWantX=this.panelOffsetX,this.panelOffsetWantY=this.panelOffsetY,this.panelOffsetWantX<-(this.panelWidth-s)&&(this.panelOffsetWantX=-(this.panelWidth-s)),this.panelOffsetWantY<-(this.panelHeight-r)&&(this.panelOffsetWantY=-(this.panelHeight-r)),this.panelOffsetWantX>0&&(this.panelOffsetWantX=0),this.panelOffsetWantY>0&&(this.panelOffsetWantY=0),0==this.dragout&&(this.panelOffsetX=this.panelOffsetWantX,this.panelOffsetY=this.panelOffsetWantY)}OnUpdate(t,e){0==this._drag&&(this.panelOffsetX=this.panelOffsetX+.5*(this.panelOffsetWantX-this.panelOffsetX),this.panelOffsetY=this.panelOffsetY+.5*(this.panelOffsetWantY-this.panelOffsetY)),super.OnUpdate(t,e)}}class Vt extends Ct{Show(t,e){this._caretouchid=e,Vt.PassPress(this,e),this.timer=0,this.action=1,console.log("...show..."+e),null==this._parent&&t.addChild(this),this.OnShow()}static PassPress(t,e){for(let i=0;i<t.getChildCount();i++){let s=t.getChild(i);s.getElementType()==ft.Element_DropButton?s.UsePress(e):this.PassPress(s,e)}}constructor(){super(),this._caretouchid=-1,this.action=0,this.timer=0,this.fadeintime=.15,this.fadeouttime=.15,this.localRect.setAsFill();let t=this.img=new Xt(q.GetPackElement().ConvertElemToSprite(q.getWhiteBlock()));t.color=new A(0,0,0,.5),t.alpha=.5,t.localRect.setAsFill(),this.addChild(t);let e=new Pt;e.localRect.setAsFill(),this.addChild(e),this.action=0,this.timer=0}Close(){console.log("...close..."+this._caretouchid),this.action=2,this.timer=0}OnUpdate(t,e){if(super.OnUpdate(t,e),1==this.action){this.timer<this.fadeintime&&(this.timer+=e);let t=this.timer/this.fadeintime;t>1&&(t=1),this.img.alpha=.75*t}if(2==this.action){this.timer<=this.fadeouttime&&(this.timer+=e);let t=this.timer/this.fadeouttime;t>=1&&(t=1,this.OnClose(),console.log("hide drop"+this._caretouchid)),this.img.alpha=.75*(1-t)}}OnTouch(t,e,i,s,r,n){let h=super.OnTouch(t,e,i,s,r,n);return 0==i&&(console.log("release..."+e),e==this._caretouchid&&this.Close()),h}}class Wt extends Vt{constructor(){super(),this.y=32,this.localRect.setAsFill(),this.AddLabelCenter("像素编辑器"),this.AddLabelLeft("这是一个为移动平台和触摸操作准备的像素编辑器",.5),this.AddLabelLeft("关于摇杆的想法，是来自于dotpict",.5),this.AddLabelLeft("按住别动，松手关闭",.5)}AddLabelCenter(t,e=1){var i=q.CreateGUI_Label(t);i.fontScale.X*=e,i.fontScale.Y*=e,i.localRect.setVPosByTopBorder(20,this.y),this.addChild(i),this.y+=24*e}AddLabelLeft(t,e=1){var i=q.CreateGUI_Label(t);i.fontScale.X*=e,i.fontScale.Y*=e,i.localRect.setVPosByTopBorder(20,this.y),i.localRect.setHPosFill(16,16),i.halign=dt.Left,this.addChild(i),this.y+=24*e}OnShow(){Wt._ishow=!0}OnClose(){this._parent.removeChild(this),Wt._ishow=!1}static Show(t,e){this._ishow||(new Wt).Show(t,e)}}Wt._ishow=!1;class Mt extends Gt{constructor(t){super(),this.ElemNormal=null,this.ElemActive=null,this.BindKey=null,this._active=!1,this._pressid=-1,this.OnPressUp=null,this._pressid=t,this.localRect.setByRect(new B(0,0,100,100))}getElementType(){return ft.Element_DropButton}UsePress(t){-1==this._pressid&&(this._pressid=t,this._active=!1)}CancelTouch(){this._active=!1,this._pressid=-1,super.CancelTouch()}OnTouch(t,e,i,s,r,n){if(super.OnTouch(t,e,i,s,r,n))return!0;let h=this.getWorldRect(),o=h.X+h.Width,l=h.Y+h.Height;return 1==i&&this._pressid==e&&(r>=h.X&&r<o&&n>=h.Y&&n<l?this._active=!0:this._active=!1),0==i&&this._pressid==e&&(this._active=!1,this._pressid=-1,r>=h.X&&r<o&&n>=h.Y&&n<l&&null!=this.OnPressUp&&this.OnPressUp()),!1}OnRender(t){this._active?null!=this.ElemActive&&(this.ElemActive._parent=this,this.ElemActive.alpha=this.alpha,this.ElemActive.OnRender(t)):null!=this.ElemNormal&&(this.ElemNormal._parent=this,this.ElemNormal.alpha=this.alpha,this.ElemNormal.OnRender(t)),super.OnRender(t)}OnUpdate(t,e){this._active?null!=this.ElemActive&&this.ElemActive.OnUpdate(t,e):null!=this.ElemNormal&&this.ElemNormal.OnUpdate(t,e),super.OnUpdate(t,e)}}var kt=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};class Nt{static OpenFileAsDataUrl(){return kt(this,arguments,void 0,(function*(t="image/png"){return null==this.input&&(this.input=document.createElement("input"),document.body.appendChild(this.input),this.input.type="file",this.input.style.visibility="hidden"),this.input.accept=t,new Promise((t=>{this.input.onchange=()=>{console.log("input.onchange");var e=this.input.files[0];if(null!=e){console.log("file name:"+e.name+" size:"+e.size);let i=new FileReader;i.onload=()=>{console.log("file="+i.result),t(i.result)},i.readAsDataURL(this.input.files[0])}else t(null)},this.input.click(),console.log("input.click")}))}))}static SpriteDataToPngDataUrl(t){return kt(this,void 0,void 0,(function*(){let e=yield this.SpriteDataToPngBlob(t);return URL.createObjectURL(e)}))}static SpriteDataToPngBlob(t){return kt(this,void 0,void 0,(function*(){null==this.canvas&&(this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.style.visibility="hidden",this.c2d=this.canvas.getContext("2d"));var e=new ImageData(t.width,t.height);for(let i=0;i<t.data.length;i++)e.data[i]=t.data[i];return this.canvas.width=t.width,this.canvas.height=t.height,this.c2d.putImageData(e,0,0),new Promise((t=>{this.canvas.toBlob((e=>{t(e)}),"png")}))}))}static DataURLToBlob(t){let e=t.split(";base64,"),i=e[0].split(":")[1],s=window.atob(e[1]),r=s.length,n=new Uint8Array(r);for(let t=0;t<r;++t)n[t]=s.charCodeAt(t);return new window.Blob([n],{type:i})}static SaveData(t,e){return kt(this,void 0,void 0,(function*(){null==this.a&&(this.a=document.createElement("a"),document.body.appendChild(this.a),this.a.style.visibility="hidden"),this.a.href=e,this.a.download=t,this.a.click()}))}}Nt.input=null,Nt.canvas=null,Nt.c2d=null,Nt.a=null;var Ht=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};class zt extends Vt{constructor(t){super(),this.y=32,this.localRect.setAsFill(),this.InitMenu(),this.editor=t}InitMenu(){this.AddLabelCenter("菜单"),this.AddButton("open",(()=>Ht(this,void 0,void 0,(function*(){let e=yield Nt.OpenFileAsDataUrl("Image");console.log("getdata="+e.length);let i=yield t.loader.LoadImageDataAsync(e);console.log("img load:"+i.width+"X"+i.height);let s=new N;s.width=i.width,s.height=i.height,s.format=f.RGBA32,s.data=i.data,this.editor.SetPixelData(s),this.Close()})))),this.AddButton("save img",(()=>Ht(this,void 0,void 0,(function*(){let t=this.editor.GetPixelData(),e=yield Nt.SpriteDataToPngDataUrl(t);yield Nt.SaveData("1.png",e),this.Close()})))),this.AddButton("save package",(()=>{this.Close()})),this.AddText("打开文件，从本地选一个图片编辑，不能太大",.5),this.AddText("保存，如果是浏览器则是下载",.5),this.AddText("打包保存，这是将来的事情",.5),this.AddText("按住别动，移动到想要的功能松手。",.5)}AddLabelCenter(t,e=1){var i=q.CreateGUI_Label(t);i.fontScale.X*=e,i.fontScale.Y*=e,i.localRect.setVPosByTopBorder(20,this.y),this.addChild(i),this.y+=24*e}AddText(t,e=1){var i=q.CreateGUI_Label(t,A.White,e);i.localRect.setVPosByTopBorder(24*e,this.y),i.localRect.setHPosFill(16,16),i.halign=dt.Left,this.addChild(i),this.y+=24*e}AddButton(t,e,i=1){var s=q.CreateGUI_Button(t,A.White,i);let r=new Mt(-1);r.ElemNormal=s.ElemPress,r.ElemActive=s.ElemNormal,r.localRect.setVPosByTopBorder(24*i,this.y),r.localRect.setHPosFill(16,16),r.OnPressUp=e,this.addChild(r),this.y+=28*i}OnShow(){zt._ishow=!0}OnClose(){this._parent.removeChild(this),zt._ishow=!1}static Show(t,e,i){this._ishow||new zt(i).Show(t,e)}}zt._ishow=!1;var jt=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function h(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(h,o)}l((s=s.apply(t,e||[])).next())}))};class Kt extends Ct{constructor(){super(),this.InitUI()}InitUI(){let t=q.CreateGUI_Label("主菜单 02");this.addChild(t),t.localRect.setHPosByCenter(100),t.localRect.setVPosByTopBorder(24,16);{let t=q.CreateGUI_Label("首先你需要一个Group",A.White,.5);this.addChild(t),t.localRect.setHPosFill(16,16),t.halign=dt.Left,t.localRect.setVPosByTopBorder(24,32)}{let t=q.CreateGUI_Label("一个group能包含多个图片、角色或动画",A.White,.5);this.addChild(t),t.localRect.setHPosFill(16,16),t.halign=dt.Left,t.localRect.setVPosByTopBorder(24,44)}{let t=q.CreateGUI_Label("这样我们能更方便的管理资源",A.White,.5);this.addChild(t),t.localRect.setHPosFill(16,16),t.halign=dt.Left,t.localRect.setVPosByTopBorder(24,56)}let e=this.scroll=new Yt;e.borderElement=q.CreateGUI_Border(),this.addChild(e),e.localRect.setAsFill(),e.localRect.offsetY1=76,e.localRect.offsetY2=-16,this.UpdateGroup()}OnUpdate(t,e){this.scroll.panelWidth=this.scroll.getWorldRect().Width,super.OnUpdate(t,e)}GetGroupNames(){return jt(this,void 0,void 0,(function*(){let e=yield t.store.GetText("groupnames");if(null!=e){let t=JSON.parse(e),r={};for(var i=0;i<t.length;i++)r[t[i]]=1;let n=[];for(var s in r)n.push(s);return n}return[]}))}SetGroupMames(e){return jt(this,void 0,void 0,(function*(){let i=JSON.stringify(e);yield t.store.SaveText("groupnames",i)}))}UpdateGroup(){return jt(this,void 0,void 0,(function*(){yield t.store.Init(),this.scroll.removeChildAll();let e=0,i=yield this.GetGroupNames();if(0==i.length)return void(yield this.NewGroup("newGroup"));console.log("update groups:"+i);for(let t=0;t<i.length;t++){let s=q.CreateGUI_Button("Group:"+i[t],A.White,.75);s.localRect.setHPosFill(16,64),s.localRect.setVPosByTopBorder(20,e),this.scroll.addChild(s);let r=q.CreateGUI_Button("del",new A(1,.3,.3,1),.75);r.localRect.setHPosByRightBorder(48,16),r.localRect.setVPosByTopBorder(20,e),this.scroll.addChild(r);let n=i[t];r.OnClick=()=>jt(this,void 0,void 0,(function*(){yield this.RemoveGroup(n)})),e+=24}let s=q.CreateGUI_Button("Create Group",new A(1,1,.3,1),.75);s.localRect.setHPosFill(16,16),s.localRect.setVPosByTopBorder(24,e),e+=24,this.scroll.addChild(s),s.OnClick=()=>jt(this,void 0,void 0,(function*(){let e=yield t.input.Prompt("为Group取个名字","newGroup",32);yield this.NewGroup(e)}))}))}NewGroup(t){return jt(this,void 0,void 0,(function*(){if(null==t||""==t)return;let e=yield this.GetGroupNames();e.push(t),yield this.SetGroupMames(e),yield this.UpdateGroup()}))}RemoveGroup(t){return jt(this,void 0,void 0,(function*(){if(null==t||""==t)return;let e=yield this.GetGroupNames(),i=e.indexOf(t);i<0||(e.splice(i,1),yield this.SetGroupMames(e),yield this.UpdateGroup())}))}}class qt{OnInit(){this.InitAsync()}InitAsync(){return e=this,i=void 0,r=function*(){this.layergui=new rt,P.GetViewList().AddDrawLayer(this.layergui),this.layergui.GetCamera().Scale=2*t.graphic.getDevicePixelRadio();let e=new Lt;e.setAsp(9/21,1),this.layergui.GetCanvas().addChild(e);{let t=new Kt;return t.localRect.setAsFill(),void e.addChild(t)}},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}l((r=r.apply(e,i||[])).next())}));var e,i,s,r}OnUpdate(t){}OnExit(){}OnResize(t,e){}OnKey(t,e){}OnPointAfterGUI(t,e,i,s,r){}}!function(){var e,i,s,r;e=this,i=void 0,r=function*(){document.title="TTEngine 像素编辑器";var e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",e.style.border="0px",e.style.margin="0px",document.body.appendChild(e),(new u.ttimpl_browser).Init(e),console.log("TTAPI has init."),t.audio.ReInit();let i=yield t.loader.LoadCustomFont("VonwaonBitmap-16px","./data/VonwaonBitmap-16pxLite.ttf");console.log("add font:"+i);let s=new K;s.defFontName=i,s.defFontSize=32,P.Start(s,new qt)},new((s=void 0)||(s=Promise))((function(t,n){function h(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(h,o)}l((r=r.apply(e,i||[])).next())}))}()})();