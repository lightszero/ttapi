(()=>{"use strict";var e,t;!function(e){e.sleep=function(e){return t=this,n=void 0,o=function*(){return new Promise((t=>setTimeout(t,e)))},new((i=void 0)||(i=Promise))((function(e,r){function s(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,a)}l((o=o.apply(t,n||[])).next())}));var t,n,i,o};class t{constructor(){this.id=0,this.x=0,this.y=0,this.press=!1,this.move=!1}Clone(){let e=new t;return e.id=this.id,e.x=this.x,e.y=this.y,e.press=this.press,e}}e.InputPoint=t,e.ImageBuffer=class{constructor(){this.width=0,this.height=0,this.gray=!1,this.data=null}}}(e||(e={})),function(t){t.ttimpl_graphics=class{constructor(e,t){this._MainScreenScale=1,this.OnUpdate=null,this.OnResize=null,this.OnRender=null,this._webgl=e,this.c2d=t}GetBackGroundC2D(){return this.c2d}GetWebGL(){return this._webgl}getMainScreenScale(){return this._MainScreenScale}setMainScreenScale(e){this._MainScreenScale=e,this.UpdateScreenSize()}UpdateScreenSize(){let t=this._webgl.canvas;var n=e.graphic.getDeviceScreenWidth()*e.graphic.getFinalScale()|0,i=e.graphic.getDeviceScreenHeight()*e.graphic.getFinalScale()|0;t.width==n&&t.height==i||(console.log("--resize wantwidth = "+n+" ,wantheight="+i),t.width=n,t.height=i,null!=e.graphic.OnResize&&e.graphic.OnResize(t.width,t.height))}getDeviceScreenWidth(){return this._webgl.canvas.clientWidth}getDeviceScreenHeight(){return this._webgl.canvas.clientHeight}getDevicePixelRadio(){return window.devicePixelRatio}getFinalScale(){return this.getDevicePixelRadio()/this._MainScreenScale}}}(t||(t={}));var n,i=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))};!function(t){t.Loader=class{LoadStringAsync(e){return i(this,void 0,void 0,(function*(){let t=yield fetch(e);return yield t.text()}))}LoadBinaryAsync(e){return i(this,void 0,void 0,(function*(){let t=yield fetch(e);return yield t.arrayBuffer()}))}LoadImageAsync(e){return new Promise(((t,n)=>{let i=new Image;i.src=e;let o=!1;i.onload=e=>{o=!0,t(i)},i.onerror=e=>{o=!0,i=null,n("img error:"+e.toString())}}))}LoadImageDataAsync(t){return i(this,void 0,void 0,(function*(){let n=yield this.LoadImageAsync(t),i=e.graphic.GetBackGroundC2D();return i.canvas.width=n.width,i.canvas.height=n.height,i.clearRect(0,0,n.width,n.height),i.drawImage(n,0,0),i.getImageData(0,0,n.width,n.height)}))}LoadCustomFont(e,t){return i(this,void 0,void 0,(function*(){const n=new FontFace(e,"url("+t+")");let i=yield n.load();return document.fonts.add(i),i.family}))}}}(n||(n={}));var o,r=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))};!function(e){class t{constructor(e,t,n){null!=t&&null==n?(this.loaded=!1,this.initByUrlAsync(e,t)):null!=n&&null==t&&this.initByDataAsync(e,n)}initByUrlAsync(e,t){return r(this,void 0,void 0,(function*(){let n=yield fetch(t),i=yield n.arrayBuffer();this.buffer=yield e.decodeAudioData(i)}))}initByDataAsync(e,t){return r(this,void 0,void 0,(function*(){this.buffer=yield e.decodeAudioData(t),this.loaded=!0}))}}class n{constructor(e,t){let n=new HTMLAudioElement;this.url=n.src=t,n.loop=!0,this.node=e.createMediaElementSource(n),this.loaded=!1,n.onload=()=>{this.loaded=!0},n.loop=!0,n.onended=()=>{null!=this.onEnd&&this.onEnd(this)}}setLoop(e){this.node.mediaElement.loop=e}getLoop(){return this.node.mediaElement.loop}}class i{constructor(e){this.sourceBGM=null,this.inBGM=!1,this.audioContext=e,this.vol=this.audioContext.createGain(),this.vol.gain.value=1,this.vol.connect(this.audioContext.destination)}SetBGM(e){this.inBGM&&(this.inBGM=!1,this.sourceBGM.disconnect(),this.sourceBGM=null),null!=e&&(this.sourceBGM=e.node,this.sourceBGM.connect(this.vol))}setVolume(e){this.vol.gain.value=e}getVolume(){return this.vol.gain.value}PlaySound(e){let t=this.audioContext.createBufferSource();t.buffer=e.buffer,t.connect(this.vol),t.loop=!1,t.start(),null!=e.onEnd&&(t.onended=()=>{e.onEnd(e)})}}e.Channel_Impl=i,e.AudioImpl=class{constructor(){this.channels=[];try{this.audioContext=new AudioContext,console.log("audio Context inited")}catch(e){throw console.error("!Your browser does not support AudioContext"),new Error("!Your browser does not support AudioContext")}this.Init()}GetChannel(e){if(e>16||e<0)throw new Error("error channel id.");for(;this.channels.length<=e;)this.channels.push(null);return null==this.channels[e]&&(this.channels[e]=new i(this.audioContext)),this.channels[e]}CreateBGM(e){return new n(this.audioContext,e)}CreateSound(e){return new t(this.audioContext,e,null)}CreateSoundFromArrayBuffer(e){return new t(this.audioContext,null,e)}Init(){if(null!=this.audioContext){var e=this.audioContext.createBuffer(1,1,22050),t=this.audioContext.createBufferSource();t.buffer=e,t.connect(this.audioContext.destination),t.start()}}ReInit(){this.Init()}}}(o||(o={}));var s,a;!function(t){t.Input=class{constructor(e){this._mousepress=!1,this._pressKeys=[],this.points=[],this.ishow=!1,this.Start(e)}Start(e){window.addEventListener("keydown",(e=>{this.UpdateKey(e.code,!0)})),window.addEventListener("keyup",(e=>{this.UpdateKey(e.code,!1)})),e.addEventListener("mousedown",(e=>{0==e.button&&(this.UpdateMouse(e,!0,!1),this._mousepress=!0)})),e.addEventListener("mouseup",(e=>{0==e.button&&(this.UpdateMouse(e,!1,!1),this._mousepress=!1)})),e.addEventListener("mousemove",(e=>{0==e.button&&this._mousepress&&this.UpdateMouse(e,!0,!0)})),e.addEventListener("touchstart",(e=>{for(var t=0;t<e.changedTouches.length;t++)this.UpdatePoint(e.changedTouches[t],!0,!1)})),e.addEventListener("touchmove",(e=>{for(var t=0;t<e.changedTouches.length;t++)this.UpdatePoint(e.changedTouches[t],!0,!0)})),e.addEventListener("touchend",(e=>{for(var t=0;t<e.changedTouches.length;t++)this.UpdatePoint(e.changedTouches[t],!1,!1)})),e.addEventListener("touchcancel",(e=>{for(var t=0;t<e.changedTouches.length;t++)this.UpdatePoint(e.changedTouches[t],!1,!1)}))}UpdateMouse(t,n,i){for(;this.points.length<=0;){let t=new e.InputPoint;t.id=this.points.length,t.press=!1,t.x=0,t.y=0,this.points.push(t)}this.points[0].id=0,this.points[0].press=n,this.points[0].x=t.x,this.points[0].y=t.y,null!=this.OnPoint&&this.OnPoint(0,t.x,t.y,n,i)}UpdatePoint(t,n,i){let o=t.identifier+1;for(;this.points.length<=o;){let t=new e.InputPoint;t.id=this.points.length,t.press=!1,t.x=0,t.y=0,this.points.push(t)}this.points[o].press=n,this.points[o].x=t.clientX,this.points[o].y=t.clientY,null!=this.OnPoint&&this.OnPoint(o,t.clientX,t.clientY,n,i)}UpdateKey(e,t){if(t){if(this._pressKeys.indexOf(e)>=0)return;this._pressKeys.push(e)}else{let t=this._pressKeys.indexOf(e);t>=0&&this._pressKeys.splice(t,1)}console.log("Input Key:"+e+"="+t),null!=this.OnKey&&this.OnKey(e,t)}GetPressKeys(){return this._pressKeys}IsKeyDown(e){return this._pressKeys.indexOf(e)>=0}GetInputPoints(){return this.points}Prompt(){return e=this,t=arguments,i=function*(e="",t=256){for(var n=0;n<this.points.length;n++)this.points[n].press=!1;return window.prompt("",e)},new((n=void 0)||(n=Promise))((function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}));var e,t,n,i}}}(s||(s={})),function(e){e.Platform=class{getPlatformName(){return"browser_"+window.navigator.userAgent}}}(a||(a={}));var l=function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))};class c{constructor(){this._loaded=!1,this.InitAsync()}InitAsync(){return l(this,void 0,void 0,(function*(){yield h.OpenOrCreateDB("_ttstore_"),this._loaded=!0}))}IsReady(){return this._loaded}GetText(e){return l(this,void 0,void 0,(function*(){return yield h.GetStringValue(e)}))}GetBinary(e){return l(this,void 0,void 0,(function*(){return yield h.GetBinaryValue(e)}))}SaveText(e,t){return l(this,void 0,void 0,(function*(){yield h.SetStringValue(e,t)}))}SaveBinary(e,t){return l(this,void 0,void 0,(function*(){yield h.SetBinaryValue(e,t)}))}SaveDataToLocal(e,t){return l(this,void 0,void 0,(function*(){var n=document.createElement("a");n.download=e,n.style.display="none";var i=new Blob([t]);return n.href=URL.createObjectURL(i),document.body.appendChild(n),n.click(),document.body.removeChild(n),!0}))}}const u="__store__";class h{static DeleteDb(t){return l(this,void 0,void 0,(function*(){let n=indexedDB.deleteDatabase(t),i=0;for(n.onsuccess=()=>{console.log("db delete succ."),i=1},n.onerror=()=>{console.log("db delete error."),i=2};0==i;)yield e.sleep(1)}))}static OpenOrCreateDB(t){return l(this,void 0,void 0,(function*(){let n=0,i=indexedDB.open(t,1);for(i.onsuccess=e=>{console.log("db open"),n=1,this.db=i.result},i.onerror=()=>{console.log(" dbreq.onerror"),n=2,this.db=null},i.onupgradeneeded=e=>{console.log("db onupgradeneeded"),this.db=i.result,this.db.createObjectStore(u,{keyPath:["_id"]}).createIndex("_id","_id",{unique:!0}),console.log(" --create store--")};0==n;)yield e.sleep(1)}))}static SetStringValue(t,n){return l(this,void 0,void 0,(function*(){if(null==this.db)return;let i=this.db.transaction(u,"readwrite"),o=0,r=i.objectStore(u).put({_id:t,value:n,format:"text"});for(r.onsuccess=e=>{o=1,console.log("SetValue  key:"+t+" data:"+JSON.stringify(n))},r.onerror=e=>{o=2,console.log("SetValue fail  key:"+t+" data:"+JSON.stringify(n))};0==o;)yield e.sleep(1)}))}static SetBinaryValue(t,n){return l(this,void 0,void 0,(function*(){if(null==this.db)return;let i=this.db.transaction(u,"readwrite"),o=0,r=i.objectStore(u).put({_id:t,value:n,format:"hex"});for(r.onsuccess=e=>{o=1,console.log("SetValue  key:"+t+" data:"+JSON.stringify(n))},r.onerror=e=>{o=2,console.log("SetValue fail  key:"+t+" data:"+JSON.stringify(n))};0==o;)yield e.sleep(1)}))}static GetValue(t){return l(this,void 0,void 0,(function*(){if(null==this.db)return null;let n=this.db.transaction(u,"readonly").objectStore(u).index("_id").get(t),i=0;for(n.onsuccess=e=>{i=1,console.log("GetValue key:"+t+" data:"+JSON.stringify(n.result))},n.onerror=e=>{i=2,console.log("GetValue Fail key:"+JSON.stringify(n.result))};0==i;)yield e.sleep(1);return n.result}))}static GetBinaryValue(e){return l(this,void 0,void 0,(function*(){let t=yield this.GetValue(e);if(null==t)return null;if("hex"==t.format)return t.value;throw new Error("format is text.")}))}static GetStringValue(e){return l(this,void 0,void 0,(function*(){let t=yield this.GetValue(e);if(null==t)return null;if("text"==t.format)return t.value;throw new Error("format is text.")}))}}var d;h.db=null,function(i){i.ttimpl_browser=class{constructor(){this.timerMs=0}Init(i){if(this.webgl=i.getContext("webgl2",{antialias:!1}),null!=this.webgl){let n=new OffscreenCanvas(32,32).getContext("2d",{colorSpace:"srgb",willReadFrequently:!0});e.graphic=new t.ttimpl_graphics(this.webgl,n),this.timerMs=(new Date).getTime(),requestAnimationFrame(this.Update.bind(this))}else console.error("init webgl error.");e.loader=new n.Loader,e.audio=new o.AudioImpl,e.input=new s.Input(i),e.platform=new a.Platform,e.store=new c}ReInitAudio(){}SendEnvEventToUser(e,t){}Update(){if(null!=this.webgl){var t=this.webgl.canvas,n=e.graphic.getDeviceScreenWidth()*e.graphic.getFinalScale()|0,i=e.graphic.getDeviceScreenHeight()*e.graphic.getFinalScale()|0;e.graphic.getDevicePixelRadio(),t.width==n&&t.height==i||(console.log("--resize wantwidth = "+n+" ,wantheight="+i),t.width=n,t.height=i,null!=e.graphic.OnResize&&e.graphic.OnResize(t.width,t.height)),requestAnimationFrame(this.Update.bind(this));var o=(new Date).getTime(),r=(o-this.timerMs)/1e3;this.timerMs=o,null!=e.graphic.OnUpdate&&e.graphic.OnUpdate(r),null!=e.graphic.OnRender&&e.graphic.OnRender()}}}}(d||(d={}));!function(){var e,t,n,i;e=this,t=void 0,i=function*(){new d.ttimpl_browser;var e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",e.style.border="0px",e.style.margin="0px",document.body.appendChild(e),console.log("hello world")},new((n=void 0)||(n=Promise))((function(o,r){function s(e){try{l(i.next(e))}catch(e){r(e)}}function a(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}l((i=i.apply(e,t||[])).next())}))}()})();